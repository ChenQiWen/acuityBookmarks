# 书签分享功能需求文档

## 简介

AcuityBookmarks 书签分享功能允许用户将收藏的书签或文件夹以美观的海报形式分享给他人。用户可以生成包含书签信息的图片海报，并通过多种方式分享（复制图片、下载、分享链接等）。

## 术语表

- **BookmarkNode**: 书签节点，包含书签或文件夹的完整信息
- **ShareDialog**: 分享弹窗组件，用于展示分享选项和预览
- **SharePoster**: 分享海报，包含书签信息的可视化图片
- **Canvas API**: HTML5 Canvas API，用于生成海报图片
- **IndexedDB**: 本地数据库，存储书签数据
- **SidePanel**: 侧边栏页面，书签管理的主要界面
- **FavoriteSection**: 收藏区域组件
- **BookmarkTree**: 书签树组件

## 需求

### 需求 1：分享收藏书签

**用户故事：** 作为用户，我想要分享我收藏的书签列表，以便与他人分享我的精选内容。

#### 验收标准

1. WHEN 用户在收藏区域点击"分享"按钮 THEN 系统应打开分享弹窗并显示所有收藏书签的预览
2. WHEN 分享弹窗打开 THEN 系统应生成包含所有收藏书签的海报预览
3. WHEN 收藏书签数量超过 20 个 THEN 系统应提示用户选择部分书签进行分享
4. WHEN 用户选择要分享的书签 THEN 系统应实时更新海报预览
5. WHEN 收藏书签列表为空 THEN 系统应禁用分享按钮并显示提示信息

### 需求 2：分享文件夹

**用户故事：** 作为用户，我想要分享整个书签文件夹，以便与他人分享某个主题的书签集合。

#### 验收标准

1. WHEN 用户在文件夹节点上点击"分享"按钮 THEN 系统应打开分享弹窗并显示该文件夹下所有书签的预览
2. WHEN 文件夹包含子文件夹 THEN 系统应递归收集所有子文件夹中的书签
3. WHEN 文件夹中书签数量超过 20 个 THEN 系统应提示用户选择部分书签进行分享
4. WHEN 文件夹为空（不包含任何书签） THEN 系统应禁用分享按钮并显示提示信息
5. WHEN 文件夹只包含子文件夹但没有书签 THEN 系统应递归查找子文件夹中的书签

### 需求 3：生成分享海报

**用户故事：** 作为用户，我想要生成美观的书签分享海报，以便在社交媒体或聊天工具中分享。

#### 验收标准

1. WHEN 系统生成海报 THEN 海报应包含书签标题、URL、favicon 图标和描述信息
2. WHEN 海报生成 THEN 海报应使用 Material Design 3 主题色（薄荷绿色系）
3. WHEN 海报包含多个书签 THEN 海报应以列表形式展示，每个书签占据一行
4. WHEN 书签标题过长 THEN 系统应截断标题并添加省略号
5. WHEN 书签 URL 过长 THEN 系统应截断 URL 并添加省略号
6. WHEN 书签没有 favicon THEN 系统应显示默认图标
7. WHEN 海报生成完成 THEN 系统应在弹窗中显示海报预览
8. WHEN 海报尺寸 THEN 海报宽度应为 800px，高度根据书签数量自动调整
9. WHEN 海报生成 THEN 海报应包含二维码，扫码后跳转到分享落地页
10. WHEN 二维码生成 THEN 二维码应包含完整的分享链接（`https://acuitybookmarks.com/share?data=<encoded_data>`）
11. WHEN 二维码显示 THEN 二维码应位于海报右下角或底部中央
12. WHEN 海报生成 THEN 海报应包含 AcuityBookmarks Logo 和品牌标识

### 需求 4：海报样式定制

**用户故事：** 作为用户，我想要定制海报的样式，以便生成符合我个人喜好的分享图片。

#### 验收标准

1. WHEN 用户打开分享弹窗 THEN 系统应提供主题选择选项（深色/浅色）
2. WHEN 用户切换主题 THEN 海报预览应实时更新
3. WHEN 用户选择深色主题 THEN 海报应使用深色背景和浅色文字
4. WHEN 用户选择浅色主题 THEN 海报应使用浅色背景和深色文字
5. WHEN 海报使用深色主题 THEN 背景色应为 `--md-sys-color-surface`，文字色应为 `--md-sys-color-on-surface`

### 需求 5：复制海报图片

**用户故事：** 作为用户，我想要将海报图片复制到剪贴板，以便快速粘贴到其他应用中。

#### 验收标准

1. WHEN 用户点击"复制图片"按钮 THEN 系统应将海报图片复制到剪贴板
2. WHEN 图片复制成功 THEN 系统应显示成功提示消息
3. WHEN 图片复制失败 THEN 系统应显示错误提示消息并记录错误日志
4. WHEN 浏览器不支持剪贴板 API THEN 系统应显示不支持提示并提供下载选项
5. WHEN 图片复制到剪贴板 THEN 图片格式应为 PNG

### 需求 6：下载海报图片

**用户故事：** 作为用户，我想要下载海报图片到本地，以便保存或通过其他方式分享。

#### 验收标准

1. WHEN 用户点击"下载图片"按钮 THEN 系统应触发浏览器下载海报图片
2. WHEN 图片下载 THEN 文件名应包含时间戳（格式：`bookmarks-share-YYYYMMDD-HHmmss.png`）
3. WHEN 图片下载 THEN 图片格式应为 PNG
4. WHEN 图片下载成功 THEN 系统应显示成功提示消息
5. WHEN 图片下载失败 THEN 系统应显示错误提示消息并记录错误日志

### 需求 7：桌面端分享落地页（精细化导入）

**用户故事：** 作为用户，我想要在桌面端打开分享链接后，选择部分书签并指定导入文件夹，以便精细化管理我的书签。

#### 验收标准

1. WHEN 用户在安装了 AcuityBookmarks 扩展的桌面端 Chrome 打开分享链接 THEN 系统应显示书签选择界面
2. WHEN 用户查看书签列表 THEN 每个书签应显示复选框、标题、URL 和 favicon
3. WHEN 用户勾选/取消勾选书签 THEN 系统应实时更新选中计数（如"已选 3/10"）
4. WHEN 用户点击"全选"按钮 THEN 所有书签应被选中
5. WHEN 用户点击"取消全选"按钮 THEN 所有书签应被取消选中
6. WHEN 用户点击"选择文件夹"下拉框 THEN 系统应显示用户的书签文件夹树
7. WHEN 用户选择目标文件夹 THEN 系统应记住用户的选择
8. WHEN 用户点击"导入选中的书签"按钮 THEN 系统应调用 `chrome.bookmarks.create` API 批量创建书签到指定文件夹
9. WHEN 书签导入成功 THEN 系统应显示成功提示并显示导入数量（如"成功导入 3 个书签"）
10. WHEN 书签导入失败 THEN 系统应显示错误提示并记录错误日志
11. WHEN 用户未安装 AcuityBookmarks 扩展 THEN 系统应显示"请先安装扩展"提示和 Chrome Web Store 下载链接
12. WHEN 用户未选择任何书签 THEN "导入"按钮应被禁用
13. WHEN 用户未选择目标文件夹 THEN 系统应默认导入到"书签栏"文件夹
14. WHEN 导入过程中 THEN 系统应显示进度指示器（如"正在导入 2/3..."）

### 需求 8：移动端只读展示页面

**用户故事：** 作为移动端用户，我想要查看分享的书签列表并直接访问感兴趣的书签，以便快速浏览分享内容。

#### 验收标准

1. WHEN 用户在移动端打开分享链接 THEN 系统应显示只读书签列表页面
2. WHEN 页面加载 THEN 系统应显示"请在电脑上打开此链接以使用完整导入功能"提示
3. WHEN 用户查看书签列表 THEN 每个书签应显示标题、URL 和 favicon
4. WHEN 用户点击书签 THEN 系统应在当前标签页打开该书签的 URL
5. WHEN 用户长按书签 THEN 系统应显示浏览器原生的链接操作菜单（在新标签页打开、复制链接等）
6. WHEN 页面显示 THEN 应提供"分享给朋友"按钮，调用系统分享 API
7. WHEN 页面显示 THEN 应提供"复制链接"按钮，复制当前分享链接
8. WHEN 书签列表为空 THEN 系统应显示"没有可显示的书签"提示
9. WHEN 页面加载失败 THEN 系统应显示错误提示和重试按钮

### 需求 9：分享弹窗交互

**用户故事：** 作为用户，我想要在分享弹窗中方便地操作，以便快速完成分享流程。

#### 验收标准

1. WHEN 分享弹窗打开 THEN 弹窗应居中显示并带有遮罩层
2. WHEN 用户点击遮罩层或关闭按钮 THEN 弹窗应关闭
3. WHEN 用户按下 ESC 键 THEN 弹窗应关闭
4. WHEN 弹窗打开 THEN 系统应自动聚焦到第一个可操作元素
5. WHEN 弹窗内容超出视口高度 THEN 弹窗内容应可滚动
6. WHEN 海报生成中 THEN 系统应显示加载指示器
7. WHEN 海报生成失败 THEN 系统应显示错误信息和重试按钮

### 需求 10：书签选择功能

**用户故事：** 作为用户，当书签数量较多时，我想要选择部分书签进行分享，以便生成更精简的海报。

#### 验收标准

1. WHEN 书签数量超过 20 个 THEN 系统应在弹窗中显示书签列表和复选框
2. WHEN 用户勾选/取消勾选书签 THEN 海报预览应实时更新
3. WHEN 用户点击"全选"按钮 THEN 所有书签应被选中
4. WHEN 用户点击"取消全选"按钮 THEN 所有书签应被取消选中
5. WHEN 用户未选择任何书签 THEN "生成海报"按钮应被禁用
6. WHEN 用户选择的书签数量超过 50 个 THEN 系统应显示警告提示

### 需求 11：性能优化

**用户故事：** 作为用户，我想要分享功能快速响应，以便获得流畅的使用体验。

#### 验收标准

1. WHEN 海报生成 THEN 生成时间应小于 2 秒（书签数量 ≤ 20）
2. WHEN 海报生成 THEN 生成时间应小于 5 秒（书签数量 ≤ 50）
3. WHEN 海报预览更新 THEN 更新应使用防抖（debounce），延迟 300ms
4. WHEN 用户快速切换主题 THEN 系统应取消上一次未完成的生成任务
5. WHEN 海报生成 THEN 系统应使用 Web Worker 进行图片处理（如果浏览器支持）

### 需求 12：错误处理

**用户故事：** 作为用户，当分享功能出现错误时，我想要看到清晰的错误提示，以便了解问题并采取行动。

#### 验收标准

1. WHEN Canvas API 不可用 THEN 系统应显示"浏览器不支持海报生成"错误提示
2. WHEN 图片生成失败 THEN 系统应显示"海报生成失败，请重试"错误提示
3. WHEN 剪贴板 API 不可用 THEN 系统应隐藏"复制图片"按钮
4. WHEN 网络请求失败（获取 favicon） THEN 系统应使用默认图标并继续生成海报
5. WHEN 书签数据为空 THEN 系统应显示"没有可分享的书签"提示

### 需求 13：国际化支持

**用户故事：** 作为用户，我想要分享功能支持多语言，以便在不同语言环境下使用。

#### 验收标准

1. WHEN 系统语言为中文 THEN 分享弹窗和海报中的文本应显示为中文
2. WHEN 系统语言为英文 THEN 分享弹窗和海报中的文本应显示为英文
3. WHEN 海报包含日期时间 THEN 日期时间格式应根据系统语言自动调整
4. WHEN 海报包含数量统计 THEN 数量格式应根据系统语言自动调整
5. WHEN 用户切换系统语言 THEN 已打开的分享弹窗应自动更新语言

### 需求 14：可访问性

**用户故事：** 作为使用辅助技术的用户，我想要分享功能具有良好的可访问性，以便我也能使用该功能。

#### 验收标准

1. WHEN 分享按钮渲染 THEN 按钮应包含 `aria-label` 属性
2. WHEN 分享弹窗打开 THEN 弹窗应包含 `role="dialog"` 和 `aria-modal="true"` 属性
3. WHEN 弹窗打开 THEN 焦点应自动移动到弹窗内
4. WHEN 弹窗关闭 THEN 焦点应返回到触发按钮
5. WHEN 用户使用键盘导航 THEN 所有交互元素应可通过 Tab 键访问
6. WHEN 海报生成中 THEN 加载指示器应包含 `aria-live="polite"` 属性
7. WHEN 操作完成 THEN 成功/错误消息应通过屏幕阅读器播报

### 需求 15：数据隐私

**用户故事：** 作为用户，我想要确保分享功能不会泄露我的隐私数据，以便安全地使用该功能。

#### 验收标准

1. WHEN 生成分享链接 THEN 链接中不应包含用户的个人身份信息
2. WHEN 生成海报 THEN 海报中不应包含用户的浏览历史或访问时间
3. WHEN 生成海报 THEN 所有数据处理应在本地完成，不应发送到服务器
4. WHEN 用户关闭分享弹窗 THEN 系统应清理临时生成的图片数据
5. WHEN 生成分享链接 THEN 链接应使用 Base64 或 LZ-String 压缩编码，不应包含明文敏感信息
6. WHEN 书签数据编码 THEN 只应包含书签的标题、URL 和描述，不应包含用户 ID、设备信息等

### 需求 16：分享链接数据格式

**用户故事：** 作为开发者，我想要定义清晰的分享链接数据格式，以便前后端协作和未来扩展。

#### 验收标准

1. WHEN 生成分享链接 THEN 数据格式应为 JSON 结构
2. WHEN 数据编码 THEN 应包含版本号字段（`v: 1`），以便未来兼容性升级
3. WHEN 数据编码 THEN 应包含书签列表字段（`bookmarks: Array<{title, url, description?}>`）
4. WHEN 数据编码 THEN 可选包含分享标题字段（`shareTitle?: string`）
5. WHEN 数据编码 THEN 可选包含分享者信息字段（`sharedBy?: string`，仅显示昵称，不包含敏感信息）
6. WHEN 数据编码 THEN 应使用 LZ-String 压缩算法压缩 JSON 字符串
7. WHEN 数据压缩后 THEN 应使用 Base64 URL-safe 编码
8. WHEN 编码后的数据超过 2000 字符 THEN 系统应提示用户减少书签数量
9. WHEN 解码分享链接 THEN 系统应验证数据格式和版本号
10. WHEN 解码失败 THEN 系统应显示"分享链接无效或已损坏"错误提示
