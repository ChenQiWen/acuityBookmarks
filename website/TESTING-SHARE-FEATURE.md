# 书签分享功能测试指南

## 测试环境准备

### 1. 启动开发服务器

```bash
# 启动官网开发服务器
cd website
bun run dev
# 访问 http://localhost:3000

# 启动扩展开发构建
cd frontend
bun run build:watch
# 在 Chrome 中加载未打包的扩展（chrome://extensions）
```

### 2. 确认扩展配置

确保 `frontend/public/manifest.json` 中的 `externally_connectable` 配置正确：

```json
{
  "externally_connectable": {
    "matches": [
      "http://localhost:3000/*",
      "https://localhost:3000/*",
      "https://acuitybookmarks.com/*",
      "https://*.acuitybookmarks.com/*"
    ]
  }
}
```

## 测试流程

### 测试 1：生成分享链接（扩展端）

1. 打开 Chrome 扩展的管理页面（Alt+B）
2. 在书签列表中选择 1-20 个书签
3. 点击右上角的"分享"按钮
4. 在分享弹窗中：
   - 查看书签列表是否正确显示
   - 选择主题（深色/浅色）
   - 查看海报预览是否正确生成
   - 点击"生成分享链接"按钮
5. 确认链接已复制到剪贴板
6. 粘贴链接，格式应为：
   ```
   https://acuitybookmarks.com/share?data=<encoded_data>
   ```

**预期结果：**

- ✅ 分享弹窗正确显示所有书签
- ✅ 海报预览正确渲染（包含书签列表、二维码、品牌标识）
- ✅ 分享链接成功复制到剪贴板
- ✅ 链接格式正确

### 测试 2：打开分享链接（未安装扩展）

1. 在隐身模式或其他浏览器中打开分享链接
2. 或者在 Chrome 中禁用 AcuityBookmarks 扩展后打开

**预期结果：**

- ✅ 页面正确加载分享内容
- ✅ 显示书签列表（标题、URL、描述）
- ✅ 显示"安装 AcuityBookmarks 扩展"提示
- ✅ 点击"立即安装"按钮跳转到 Chrome Web Store
- ✅ 点击书签 URL 可以在新标签页打开
- ✅ 不显示复选框和导入按钮

### 测试 3：打开分享链接（已安装扩展）

1. 在已安装 AcuityBookmarks 扩展的 Chrome 中打开分享链接
2. 等待页面加载

**预期结果：**

- ✅ 页面正确加载分享内容
- ✅ 显示书签列表（标题、URL、描述）
- ✅ 不显示"安装扩展"提示
- ✅ 显示文件夹选择下拉框
- ✅ 默认选中"书签栏"文件夹
- ✅ 显示"清除选择"和"导入选中"按钮
- ✅ 所有书签默认被选中

### 测试 4：选择书签

1. 点击书签项，切换选中状态
2. 观察选中计数是否更新
3. 点击"清除选择"按钮

**预期结果：**

- ✅ 点击书签项可以切换选中状态
- ✅ 选中的书签显示高亮背景和边框
- ✅ 选中计数实时更新
- ✅ "清除选择"按钮清空所有选择
- ✅ 未选中任何书签时，"导入选中"按钮禁用

### 测试 5：选择目标文件夹

1. 点击文件夹选择下拉框
2. 查看文件夹列表
3. 选择不同的文件夹

**预期结果：**

- ✅ 下拉框显示所有书签文件夹
- ✅ 文件夹按层级缩进显示
- ✅ 默认选中"书签栏"（ID 为 "1"）
- ✅ 可以选择任意文件夹

### 测试 6：导入书签（少量书签）

1. 选择 1-5 个书签
2. 选择目标文件夹
3. 点击"导入选中"按钮
4. 等待导入完成

**预期结果：**

- ✅ 按钮文字变为"导入中... (1/5)"
- ✅ 进度实时更新
- ✅ 导入完成后显示成功提示："✅ 成功导入 5 个书签！"
- ✅ 在 Chrome 书签管理器中可以看到导入的书签
- ✅ 书签位于选择的目标文件夹中
- ✅ 书签标题和 URL 正确

### 测试 7：导入书签（大量书签）

1. 选择 10-20 个书签
2. 选择目标文件夹
3. 点击"导入选中"按钮
4. 观察导入进度

**预期结果：**

- ✅ 进度指示器正确显示（例如："导入中... (5/20)"）
- ✅ 导入过程不阻塞 UI（页面仍可滚动）
- ✅ 导入完成后显示成功提示
- ✅ 所有书签都成功导入到目标文件夹

### 测试 8：导入失败处理

1. 选择包含无效 URL 的书签（如果有）
2. 或者在导入过程中断网
3. 点击"导入选中"按钮

**预期结果：**

- ✅ 部分成功的书签仍然被导入
- ✅ 失败的书签显示错误提示
- ✅ 错误提示包含失败原因
- ✅ 显示成功和失败的数量统计

### 测试 9：数据解码错误处理

1. 手动修改分享链接中的 `data` 参数（破坏数据）
2. 打开修改后的链接

**预期结果：**

- ✅ 显示错误提示："无法加载分享内容"
- ✅ 错误消息："分享链接无效或已损坏，请检查链接是否完整"
- ✅ 显示"重试"按钮
- ✅ 点击"重试"按钮重新尝试加载

### 测试 10：空数据处理

1. 访问 `/share` 页面（不带 `data` 参数）
2. 或者访问 `/share?data=`（空数据）

**预期结果：**

- ✅ 显示空状态提示："没有找到分享内容"
- ✅ 提示消息："请检查分享链接是否完整"

## 边界条件测试

### 测试 11：最大书签数量（20 个）

1. 在扩展中选择 20 个书签
2. 生成分享链接
3. 打开分享链接
4. 导入所有书签

**预期结果：**

- ✅ 分享链接生成成功
- ✅ 链接长度在 2000 字符以内
- ✅ 所有 20 个书签正确显示
- ✅ 所有 20 个书签成功导入

### 测试 12：超过最大书签数量（>20 个）

1. 在扩展中选择超过 20 个书签
2. 尝试生成分享链接

**预期结果：**

- ✅ 显示错误提示："分享数据过大，请减少书签数量"
- ✅ 提示当前书签数量和建议数量

### 测试 13：特殊字符处理

1. 选择包含特殊字符的书签（如：中文、emoji、特殊符号）
2. 生成分享链接
3. 打开分享链接
4. 导入书签

**预期结果：**

- ✅ 特殊字符正确编码和解码
- ✅ 书签标题和 URL 显示正确
- ✅ 导入后的书签保持原始字符

### 测试 14：长 URL 处理

1. 选择包含超长 URL 的书签（>500 字符）
2. 生成分享链接
3. 打开分享链接

**预期结果：**

- ✅ URL 正确编码和解码
- ✅ URL 在列表中正确显示（可能被截断）
- ✅ 点击 URL 可以正常打开

## 性能测试

### 测试 15：海报生成性能

1. 选择 20 个书签
2. 打开分享弹窗
3. 观察海报生成时间

**预期结果：**

- ✅ 海报生成时间 < 2 秒
- ✅ 显示加载指示器
- ✅ 生成完成后自动显示预览

### 测试 16：导入性能

1. 选择 20 个书签
2. 导入到目标文件夹
3. 观察导入时间

**预期结果：**

- ✅ 导入时间 < 5 秒
- ✅ 进度指示器流畅更新
- ✅ UI 不卡顿

## 兼容性测试

### 测试 17：浏览器兼容性

1. 在不同浏览器中打开分享链接：
   - Chrome（最新版本）
   - Chrome（旧版本，最近 2 个版本）
   - Edge（基于 Chromium）

**预期结果：**

- ✅ 所有浏览器都能正确显示分享内容
- ✅ Chrome 和 Edge 可以检测扩展并导入书签
- ✅ 其他浏览器显示"安装扩展"提示

### 测试 18：移动端兼容性

1. 在移动设备上打开分享链接
2. 或者使用 Chrome DevTools 的移动设备模拟器

**预期结果：**

- ✅ 页面响应式布局正确
- ✅ 书签列表可以滚动
- ✅ 显示"请在电脑上打开"提示（如果实现了移动端检测）
- ✅ 点击书签可以在新标签页打开

## 安全性测试

### 测试 19：XSS 防护

1. 创建包含 HTML/JavaScript 代码的书签标题
2. 生成分享链接
3. 打开分享链接

**预期结果：**

- ✅ HTML/JavaScript 代码被转义，不会执行
- ✅ 显示为纯文本

### 测试 20：CSP 合规性

1. 打开浏览器开发者工具
2. 打开分享链接
3. 查看控制台是否有 CSP 错误

**预期结果：**

- ✅ 没有 CSP 错误
- ✅ 所有资源加载成功

## 用户体验测试

### 测试 21：加载状态

1. 打开分享链接
2. 观察加载过程

**预期结果：**

- ✅ 显示加载指示器（转圈圈）
- ✅ 显示"正在加载分享内容..."文字
- ✅ 加载完成后自动显示内容

### 测试 22：错误恢复

1. 在导入过程中刷新页面
2. 或者在导入过程中关闭标签页

**预期结果：**

- ✅ 已导入的书签保留在浏览器中
- ✅ 重新打开链接可以继续导入剩余书签

### 测试 23：多次导入

1. 导入一次书签
2. 不刷新页面，再次点击"导入选中"按钮

**预期结果：**

- ✅ 可以多次导入
- ✅ 每次导入都会创建新的书签（可能产生重复）
- ✅ 或者显示"书签已存在"提示（如果实现了重复检测）

## 测试工具

### 生成测试链接

在浏览器控制台运行：

```javascript
// 方法 1：使用测试工具
import { generateTestShareLink } from '@/utils/test-share-link'
console.log(generateTestShareLink())

// 方法 2：手动构造
const testData = {
  bookmarks: [
    { title: 'Google', url: 'https://google.com' },
    { title: 'GitHub', url: 'https://github.com' }
  ],
  title: '测试分享',
  timestamp: Date.now(),
  version: 1
}
const encoded = btoa(LZString.compressToUTF16(JSON.stringify(testData)))
console.log(`http://localhost:3000/share?data=${encodeURIComponent(encoded)}`)
```

### 检查扩展是否安装

在浏览器控制台运行：

```javascript
import { detectExtension } from '@/utils/extension-detector'
const installed = await detectExtension()
console.log('扩展已安装:', installed)
```

## 问题排查

### 问题 1：扩展检测失败

**症状：** 已安装扩展，但页面显示"安装扩展"提示

**排查步骤：**

1. 检查 `manifest.json` 中的 `externally_connectable` 配置
2. 确认扩展已重新加载（chrome://extensions）
3. 检查浏览器控制台是否有错误
4. 确认官网 URL 在 `externally_connectable.matches` 中

### 问题 2：导入失败

**症状：** 点击"导入选中"按钮后没有反应

**排查步骤：**

1. 检查浏览器控制台是否有错误
2. 确认已选择目标文件夹
3. 确认至少选中了一个书签
4. 检查 Chrome Bookmarks API 权限

### 问题 3：数据解码失败

**症状：** 打开分享链接显示"无法加载分享内容"

**排查步骤：**

1. 检查 URL 中的 `data` 参数是否完整
2. 尝试手动解码数据：
   ```javascript
   const encoded = new URLSearchParams(window.location.search).get('data')
   const decoded = LZString.decompressFromEncodedURIComponent(encoded)
   console.log(JSON.parse(decoded))
   ```
3. 确认编码和解码使用相同的方法（`compressToEncodedURIComponent`）

## 测试清单

- [ ] 测试 1：生成分享链接
- [ ] 测试 2：打开分享链接（未安装扩展）
- [ ] 测试 3：打开分享链接（已安装扩展）
- [ ] 测试 4：选择书签
- [ ] 测试 5：选择目标文件夹
- [ ] 测试 6：导入书签（少量）
- [ ] 测试 7：导入书签（大量）
- [ ] 测试 8：导入失败处理
- [ ] 测试 9：数据解码错误处理
- [ ] 测试 10：空数据处理
- [ ] 测试 11：最大书签数量
- [ ] 测试 12：超过最大书签数量
- [ ] 测试 13：特殊字符处理
- [ ] 测试 14：长 URL 处理
- [ ] 测试 15：海报生成性能
- [ ] 测试 16：导入性能
- [ ] 测试 17：浏览器兼容性
- [ ] 测试 18：移动端兼容性
- [ ] 测试 19：XSS 防护
- [ ] 测试 20：CSP 合规性
- [ ] 测试 21：加载状态
- [ ] 测试 22：错误恢复
- [ ] 测试 23：多次导入

---

**最后更新**: 2025-01-13  
**版本**: 1.0.0
