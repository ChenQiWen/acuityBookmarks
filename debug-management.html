<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Management - AcuityBookmarks</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .debug-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .debug-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .debug-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 8px;
        }
        .debug-info {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #007bff;
            white-space: pre-wrap;
            font-size: 13px;
            line-height: 1.4;
        }
        .error {
            border-left-color: #dc3545;
            background: #fff5f5;
            color: #721c24;
        }
        .success {
            border-left-color: #28a745;
            background: #f0fff4;
            color: #155724;
        }
        .warning {
            border-left-color: #ffc107;
            background: #fffbf0;
            color: #856404;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn.secondary {
            background: #6c757d;
        }
        .btn.success {
            background: #28a745;
        }
        .btn.danger {
            background: #dc3545;
        }
        .data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .tree-view {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        .tree-item {
            margin-left: 20px;
            padding: 4px 0;
        }
        .tree-folder {
            font-weight: bold;
            color: #495057;
        }
        .tree-bookmark {
            color: #007bff;
            text-decoration: none;
        }
        .tree-bookmark:hover {
            text-decoration: underline;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <div class="debug-panel">
            <div class="debug-title">ğŸ” AcuityBookmarks è°ƒè¯•é¢æ¿</div>
            <div>
                <button class="btn" onclick="testChromeAPI()">æµ‹è¯• Chrome API</button>
                <button class="btn secondary" onclick="testBackgroundConnection()">æµ‹è¯• Background è¿æ¥</button>
                <button class="btn success" onclick="loadBookmarksData()">åŠ è½½ä¹¦ç­¾æ•°æ®</button>
                <button class="btn danger" onclick="clearDebugData()">æ¸…é™¤è°ƒè¯•æ•°æ®</button>
            </div>
        </div>

        <div class="debug-panel">
            <div class="debug-title">ğŸ“Š ç³»ç»ŸçŠ¶æ€</div>
            <div id="system-status" class="debug-info">æ­£åœ¨æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...</div>
        </div>

        <div class="debug-panel">
            <div class="debug-title">ğŸ“¨ Background Script é€šä¿¡</div>
            <div id="background-status" class="debug-info">ç­‰å¾…æµ‹è¯•...</div>
        </div>

        <div class="debug-panel">
            <div class="debug-title">ğŸ’¾ æ•°æ®å­˜å‚¨çŠ¶æ€</div>
            <div id="storage-status" class="debug-info">ç­‰å¾…æ£€æŸ¥...</div>
        </div>

        <div class="debug-panel">
            <div class="debug-title">ğŸ“š ä¹¦ç­¾æ•°æ®å¯¹æ¯”</div>
            <div class="data-grid">
                <div>
                    <h4>å·¦ä¾§é¢æ¿æ•°æ® (originalTree)</h4>
                    <div id="original-tree" class="tree-view">ç­‰å¾…åŠ è½½...</div>
                </div>
                <div>
                    <h4>å³ä¾§é¢æ¿æ•°æ® (newProposalTree)</h4>
                    <div id="proposal-tree" class="tree-view">ç­‰å¾…åŠ è½½...</div>
                </div>
            </div>
        </div>

        <div class="debug-panel">
            <div class="debug-title">ğŸ“ å®æ—¶æ—¥å¿—</div>
            <div id="debug-log" class="debug-info">è°ƒè¯•æ—¥å¿—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
        </div>
    </div>

    <script>
        let debugLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            debugLog.push({ timestamp, message, type });
            
            const logElement = document.getElementById('debug-log');
            if (logElement) {
                logElement.textContent = debugLog.map(entry => 
                    `[${entry.timestamp}] ${entry.message}`
                ).join('\n');
                logElement.scrollTop = logElement.scrollHeight;
            }
            
            console.log(logEntry);
        }

        function updateStatus(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = content;
                element.className = `debug-info ${type}`;
            }
        }

        async function testChromeAPI() {
            log('å¼€å§‹æµ‹è¯• Chrome API...');
            
            try {
                // æµ‹è¯•ä¹¦ç­¾API
                if (typeof chrome !== 'undefined' && chrome.bookmarks) {
                    log('âœ… Chrome Bookmarks API å¯ç”¨');
                    
                    chrome.bookmarks.getTree((tree) => {
                        if (chrome.runtime.lastError) {
                            log(`âŒ è·å–ä¹¦ç­¾æ ‘å¤±è´¥: ${chrome.runtime.lastError.message}`, 'error');
                            updateStatus('system-status', `Chrome API é”™è¯¯: ${chrome.runtime.lastError.message}`, 'error');
                        } else {
                            log(`âœ… æˆåŠŸè·å–ä¹¦ç­¾æ ‘ï¼Œæ ¹èŠ‚ç‚¹æ•°é‡: ${tree.length}`);
                            updateStatus('system-status', `Chrome API æ­£å¸¸\nä¹¦ç­¾æ ¹èŠ‚ç‚¹: ${tree.length} ä¸ª\næ‰©å±•ID: ${chrome.runtime.id}`, 'success');
                            
                            // æ˜¾ç¤ºä¹¦ç­¾æ ‘ç»“æ„
                            displayBookmarkTree(tree, 'original-tree');
                        }
                    });
                } else {
                    log('âŒ Chrome Bookmarks API ä¸å¯ç”¨', 'error');
                    updateStatus('system-status', 'Chrome API ä¸å¯ç”¨ - è¯·ç¡®ä¿åœ¨æ‰©å±•ç¯å¢ƒä¸­è¿è¡Œ', 'error');
                }

                // æµ‹è¯•å­˜å‚¨API
                if (typeof chrome !== 'undefined' && chrome.storage) {
                    log('âœ… Chrome Storage API å¯ç”¨');
                    
                    chrome.storage.local.get(null, (data) => {
                        if (chrome.runtime.lastError) {
                            log(`âŒ è¯»å–å­˜å‚¨å¤±è´¥: ${chrome.runtime.lastError.message}`, 'error');
                        } else {
                            const keys = Object.keys(data);
                            log(`âœ… å­˜å‚¨ä¸­æœ‰ ${keys.length} ä¸ªé”®: ${keys.join(', ')}`);
                            updateStatus('storage-status', 
                                `å­˜å‚¨çŠ¶æ€: æ­£å¸¸\n` +
                                `é”®æ•°é‡: ${keys.length}\n` +
                                `é”®åˆ—è¡¨: ${keys.join(', ')}\n` +
                                `æ•°æ®å¤§å°: ${JSON.stringify(data).length} å­—ç¬¦`, 
                                'success'
                            );
                        }
                    });
                } else {
                    log('âŒ Chrome Storage API ä¸å¯ç”¨', 'error');
                }

            } catch (error) {
                log(`âŒ Chrome API æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                updateStatus('system-status', `API æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testBackgroundConnection() {
            log('å¼€å§‹æµ‹è¯• Background Script è¿æ¥...');
            
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                try {
                    // æµ‹è¯•å¥åº·æ£€æŸ¥
                    chrome.runtime.sendMessage({ action: 'healthCheck' }, (response) => {
                        if (chrome.runtime.lastError) {
                            log(`âŒ Background Script è¿æ¥å¤±è´¥: ${chrome.runtime.lastError.message}`, 'error');
                            updateStatus('background-status', `è¿æ¥å¤±è´¥: ${chrome.runtime.lastError.message}`, 'error');
                        } else if (response) {
                            log(`âœ… Background Script è¿æ¥æˆåŠŸ`);
                            updateStatus('background-status', 
                                `Background Script çŠ¶æ€: ${response.status}\n` +
                                `ç‰ˆæœ¬: ${response.version}\n` +
                                `Service Worker æ´»è·ƒ: ${response.serviceWorkerActive}\n` +
                                `è½®è¯¢æ´»è·ƒ: ${response.pollingActive}\n` +
                                `å½“å‰ä»»åŠ¡ID: ${response.currentJobId || 'æ— '}\n` +
                                `æ—¶é—´æˆ³: ${response.timestamp}`, 
                                'success'
                            );
                        } else {
                            log(`âŒ Background Script æ— å“åº”`, 'error');
                            updateStatus('background-status', 'Background Script æ— å“åº”', 'error');
                        }
                    });

                    // æµ‹è¯•æ•°æ®å‡†å¤‡
                    setTimeout(() => {
                        chrome.runtime.sendMessage({ action: 'prepareManagementData' }, (response) => {
                            if (chrome.runtime.lastError) {
                                log(`âŒ æ•°æ®å‡†å¤‡è¯·æ±‚å¤±è´¥: ${chrome.runtime.lastError.message}`, 'error');
                            } else {
                                log(`âœ… æ•°æ®å‡†å¤‡è¯·æ±‚å·²å‘é€`);
                            }
                        });
                    }, 1000);

                } catch (error) {
                    log(`âŒ Background Script æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
                    updateStatus('background-status', `æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
                }
            } else {
                log('âŒ Chrome Runtime API ä¸å¯ç”¨', 'error');
                updateStatus('background-status', 'Chrome Runtime API ä¸å¯ç”¨', 'error');
            }
        }

        async function loadBookmarksData() {
            log('å¼€å§‹åŠ è½½ä¹¦ç­¾æ•°æ®...');
            
            try {
                // æ¨¡æ‹Ÿ Management.vue ä¸­çš„æ•°æ®åŠ è½½é€»è¾‘
                chrome.storage.local.get(['originalTree', 'newProposal', 'isGenerating'], (data) => {
                    if (chrome.runtime.lastError) {
                        log(`âŒ åŠ è½½å­˜å‚¨æ•°æ®å¤±è´¥: ${chrome.runtime.lastError.message}`, 'error');
                        return;
                    }

                    log(`ğŸ“Š å­˜å‚¨æ•°æ®çŠ¶æ€:`);
                    log(`  - originalTree: ${data.originalTree ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
                    log(`  - newProposal: ${data.newProposal ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
                    log(`  - isGenerating: ${data.isGenerating ? 'æ˜¯' : 'å¦'}`);

                    if (data.originalTree) {
                        log(`âœ… æ‰¾åˆ° originalTree æ•°æ®ï¼Œé•¿åº¦: ${data.originalTree.length}`);
                        displayBookmarkTree(data.originalTree, 'original-tree');
                    } else {
                        log(`âš ï¸ originalTree æ•°æ®ä¸å­˜åœ¨ï¼Œå°è¯•ä» Chrome API è·å–`, 'warning');
                        chrome.bookmarks.getTree((tree) => {
                            if (tree && tree.length > 0) {
                                log(`âœ… ä» Chrome API è·å–åˆ°ä¹¦ç­¾æ ‘`);
                                displayBookmarkTree(tree, 'original-tree');
                            }
                        });
                    }

                    if (data.newProposal) {
                        log(`âœ… æ‰¾åˆ° newProposal æ•°æ®`);
                        displayProposalData(data.newProposal, 'proposal-tree');
                    } else {
                        log(`âš ï¸ newProposal æ•°æ®ä¸å­˜åœ¨`, 'warning');
                        document.getElementById('proposal-tree').textContent = 'æ— ææ¡ˆæ•°æ®';
                    }
                });

            } catch (error) {
                log(`âŒ åŠ è½½ä¹¦ç­¾æ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function displayBookmarkTree(tree, elementId) {
            const element = document.getElementById(elementId);
            if (!element) return;

            let html = '';
            
            function renderNode(node, depth = 0) {
                const indent = '  '.repeat(depth);
                
                if (node.children) {
                    html += `${indent}<div class="tree-folder">ğŸ“ ${node.title || 'æœªå‘½åæ–‡ä»¶å¤¹'} (${node.children.length})</div>\n`;
                    node.children.forEach(child => renderNode(child, depth + 1));
                } else if (node.url) {
                    html += `${indent}<div class="tree-bookmark">ğŸ”– ${node.title || 'æœªå‘½åä¹¦ç­¾'}</div>\n`;
                }
            }

            if (Array.isArray(tree)) {
                tree.forEach(node => renderNode(node));
            } else {
                renderNode(tree);
            }

            element.innerHTML = html || 'æ— æ•°æ®';
        }

        function displayProposalData(proposal, elementId) {
            const element = document.getElementById(elementId);
            if (!element) return;

            let html = '';
            
            if (typeof proposal === 'object' && proposal !== null) {
                for (const [key, value] of Object.entries(proposal)) {
                    html += `<div class="tree-folder">ğŸ“ ${key}</div>\n`;
                    if (Array.isArray(value)) {
                        value.forEach(item => {
                            html += `  <div class="tree-bookmark">ğŸ”– ${item.title || 'æœªå‘½å'}</div>\n`;
                        });
                    } else if (typeof value === 'object') {
                        for (const [subKey, subValue] of Object.entries(value)) {
                            html += `  <div class="tree-folder">ğŸ“ ${subKey}</div>\n`;
                            if (Array.isArray(subValue)) {
                                subValue.forEach(item => {
                                    html += `    <div class="tree-bookmark">ğŸ”– ${item.title || 'æœªå‘½å'}</div>\n`;
                                });
                            }
                        }
                    }
                }
            }

            element.innerHTML = html || 'æ— ææ¡ˆæ•°æ®';
        }

        function clearDebugData() {
            log('æ¸…é™¤è°ƒè¯•æ•°æ®...');
            debugLog = [];
            
            document.getElementById('debug-log').textContent = 'è°ƒè¯•æ—¥å¿—å·²æ¸…é™¤';
            document.getElementById('system-status').textContent = 'ç­‰å¾…æ£€æŸ¥...';
            document.getElementById('background-status').textContent = 'ç­‰å¾…æµ‹è¯•...';
            document.getElementById('storage-status').textContent = 'ç­‰å¾…æ£€æŸ¥...';
            document.getElementById('original-tree').textContent = 'ç­‰å¾…åŠ è½½...';
            document.getElementById('proposal-tree').textContent = 'ç­‰å¾…åŠ è½½...';
            
            // æ¸…é™¤æ‰€æœ‰æ ·å¼ç±»
            ['system-status', 'background-status', 'storage-status'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.className = 'debug-info';
                }
            });
        }

        // ç›‘å¬æ¥è‡ª background script çš„æ¶ˆæ¯
        if (typeof chrome !== 'undefined' && chrome.runtime) {
            chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
                log(`ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${request.action}`);
                
                if (request.action === 'dataReady') {
                    log(`âœ… æ•°æ®å‡†å¤‡å®Œæˆï¼Œæ¥æº: ${request.fromCache ? 'ç¼“å­˜' : 'å¤„ç†'}`);
                    if (request.localData) {
                        log(`  - çŠ¶æ€: ${request.localData.status}`);
                        log(`  - ä¹¦ç­¾æ•°é‡: ${request.localData.bookmarkCount || 'æœªçŸ¥'}`);
                    }
                    // é‡æ–°åŠ è½½æ•°æ®
                    setTimeout(loadBookmarksData, 500);
                } else if (request.action === 'dataRefreshed') {
                    log(`ğŸ”„ æ•°æ®å·²åˆ·æ–°`);
                    setTimeout(loadBookmarksData, 500);
                }
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡ŒåŸºæœ¬æµ‹è¯•
        document.addEventListener('DOMContentLoaded', () => {
            log('ğŸš€ è°ƒè¯•é¢æ¿å·²åŠ è½½');
            setTimeout(() => {
                testChromeAPI();
                setTimeout(testBackgroundConnection, 1000);
            }, 500);
        });
    </script>
</body>
</html>