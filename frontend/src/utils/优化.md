您询问的是该插件是否完全使用了 **Manifest V3** 的特性，以及是否还有优化空间。<cite/>让我基于 `frontend/public/manifest.json` 和 `background.js` 的实际实现来分析。<cite/>

## 当前 Manifest V3 使用情况

项目已经使用 Manifest V3，配置位于 [1](#4-0) ，但并未完全利用所有 V3 特性。<cite/>

### 已使用的 V3 特性

1. **Service Worker** [2](#4-1)
   - ✅ 使用 `service_worker` 替代 V2 的 `background.scripts`
   - ✅ 设置 `type: "module"` 支持 ES 模块

2. **Action API** [3](#4-2)
   - ✅ 使用 `action` 替代 V2 的 `browser_action`
   - ✅ 配置 `default_popup` 和图标

3. **Host Permissions** [4](#4-3)
   - ✅ 独立的 `host_permissions` 字段（V3 要求）

4. **Commands API** [5](#4-4)
   - ✅ 快捷键配置（Alt+A/B/C/S）

5. **Side Panel API** [6](#4-5)
   - ✅ 使用 `sidePanel` 权限和配置

## 未充分利用的 V3 特性

### 1. Alarms API 使用不完整

当前代码中 `chrome.alarms` 已配置但被注释掉： [7](#4-6)

**问题**：<cite/>

- 定期同步逻辑被注释（`AcuityBookmarksPeriodicSync`）
- 回退到 `setInterval`，但 Service Worker 可能被浏览器休眠导致定时器失效

**优化建议**：<cite/>

```typescript
// 完全启用 Alarms API
chrome.alarms.create('AcuityBookmarksPeriodicSync', {
  periodInMinutes: 1 // 60秒同步
})

chrome.alarms.onAlarm.addListener(async alarm => {
  if (alarm.name === 'AcuityBookmarksPeriodicSync') {
    await bookmarkManager.checkAndSync()
  }
})
```

### 2. 缺少 Offscreen Documents API

当前 Service Worker 直接处理 DOM 操作和 HTML 解析（如爬取元数据），这在 V3 中不推荐：<cite/>

**问题**：<cite/>

- Service Worker 无法访问 DOM API
- 爬取逻辑可能在某些场景下失败

**优化建议**：<cite/>

```typescript
// 使用 Offscreen Documents 处理 DOM 操作
async function createOffscreenDocument() {
  if (await chrome.offscreen.hasDocument()) return

  await chrome.offscreen.createDocument({
    url: 'offscreen.html',
    reasons: ['DOM_SCRAPING'],
    justification: 'Parse bookmark metadata from HTML'
  })
}

// 在 offscreen document 中解析 HTML
chrome.runtime.sendMessage({
  type: 'PARSE_HTML',
  html: responseText
})
```

### 3. 未使用 Declarative Net Request

当前使用 `host_permissions` 进行网络请求，但可以用 `declarativeNetRequest` 优化：<cite/>

**优化建议**：<cite/>

```json
{
  "permissions": [
    "declarativeNetRequest",
    "declarativeNetRequestWithHostAccess"
  ],
  "declarative_net_request": {
    "rule_resources": [
      {
        "id": "ruleset_1",
        "enabled": true,
        "path": "rules.json"
      }
    ]
  }
}
```

### 4. 缺少 Storage API 配额管理

当前使用 `unlimitedStorage` 权限 [8](#4-7) ，但未监控配额使用：<cite/>

**优化建议**：<cite/>

```typescript
// 监控存储配额
async function checkStorageQuota() {
  if (navigator.storage && navigator.storage.estimate) {
    const estimate = await navigator.storage.estimate()
    const percentUsed = (estimate.usage / estimate.quota) * 100

    if (percentUsed > 80) {
      // 触发清理或警告
      logger.warn('Storage quota exceeds 80%', { percentUsed })
    }
  }
}
```

### 5. 未使用 Scripting API 的新特性

当前有 `scripting` 权限 [9](#4-8) ，但未充分利用：<cite/>

**优化建议**：<cite/>

```typescript
// 使用 chrome.scripting.executeScript 替代旧的 tabs.executeScript
chrome.scripting.executeScript({
  target: { tabId: tab.id },
  func: () => {
    // 提取页面元数据
    return {
      title: document.title,
      description: document.querySelector('meta[name="description"]')?.content
    }
  }
})
```

### 6. 缺少 Service Worker 生命周期管理

当前 Service Worker 可能因浏览器休眠而丢失状态：<cite/>

**优化建议**：<cite/>

```typescript
// 监听 Service Worker 激活
chrome.runtime.onStartup.addListener(() => {
  logger.info('Extension startup, reinitializing...')
  bookmarkManager.initialize()
})

// 监听 Service Worker 安装
chrome.runtime.onInstalled.addListener(details => {
  if (details.reason === 'install') {
    // 首次安装逻辑
    chrome.tabs.create({ url: 'welcome.html' })
  } else if (details.reason === 'update') {
    // 更新逻辑
    logger.info('Extension updated to', chrome.runtime.getManifest().version)
  }
})
```

## Manifest V3 最佳实践对比

| 特性         | V3 最佳实践                | 当前实现              | 优化建议           |
| ------------ | -------------------------- | --------------------- | ------------------ |
| **后台脚本** | Service Worker             | ✅ 已使用             | 添加生命周期管理   |
| **定时任务** | chrome.alarms              | ⚠️ 部分使用（被注释） | 完全启用 alarms    |
| **DOM 操作** | Offscreen Documents        | ❌ 未使用             | 迁移 HTML 解析逻辑 |
| **网络请求** | declarativeNetRequest      | ❌ 未使用             | 考虑迁移部分请求   |
| **存储管理** | 配额监控                   | ❌ 未监控             | 添加配额检查       |
| **脚本注入** | chrome.scripting           | ⚠️ 有权限但未充分使用 | 使用新 API         |
| **消息传递** | chrome.runtime.sendMessage | ✅ 已使用             | 保持现状           |

## 具体优化方案

### 方案一：完善 Service Worker 生命周期（立即实施） [10](#4-9)

**问题**：<cite/>

- 缺少 `onStartup` 和 `onInstalled` 监听
- Service Worker 休眠后状态丢失

**优化**：<cite/>

```typescript
// 在 background.js 顶部添加
chrome.runtime.onInstalled.addListener(async details => {
  logger.info('Extension installed/updated', details)

  if (details.reason === 'install') {
    // 首次安装：初始化数据库
    await bookmarkManager.loadBookmarkData()
    chrome.tabs.create({ url: 'management.html' })
  } else if (details.reason === 'update') {
    // 更新：检查数据库版本
    const prevVersion = details.previousVersion
    const currVersion = chrome.runtime.getManifest().version
    logger.info(`Updated from ${prevVersion} to ${currVersion}`)
  }
})

chrome.runtime.onStartup.addListener(async () => {
  logger.info('Browser startup, reinitializing extension')
  await bookmarkManager.initialize()
})
```

### 方案二：启用 Offscreen Documents（短期优化）

**新增文件**：`frontend/public/offscreen.html`

```html
<!DOCTYPE html>
<html>
  <head>
    <script src="offscreen.js"></script>
  </head>
  <body></body>
</html>
```

**新增文件**：`frontend/public/offscreen.js`

```typescript
chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
  if (message.type === 'PARSE_HTML') {
    const parser = new DOMParser()
    const doc = parser.parseFromString(message.html, 'text/html')

    const metadata = {
      title: doc.querySelector('title')?.textContent,
      description: doc.querySelector('meta[name="description"]')?.content,
      ogImage: doc.querySelector('meta[property="og:image"]')?.content
    }

    sendResponse(metadata)
  }
  return true
})
```

**修改 manifest.json**：

```json
{
  "permissions": ["offscreen"],
  "web_accessible_resources": [
    {
      "resources": ["offscreen.html"],
      "matches": ["<all_urls>"]
    }
  ]
}
```

### 方案三：优化 Alarms 使用（立即实施）

当前代码： [11](#4-10)

**问题**：<cite/>

- 回退到 `setInterval`，Service Worker 休眠后失效

**优化**：<cite/>

```typescript
// 移除 setInterval 回退逻辑
startPeriodicSync() {
  const periodMinutes = Math.max(1, Math.floor(SYNC_INTERVAL / 60000))

  chrome.alarms.create('AcuityBookmarksPeriodicSync', {
    periodInMinutes: periodMinutes
  })

  logger.info(`Periodic sync started (${periodMinutes} min interval)`)
}

// 取消注释 alarms 监听器
chrome.alarms.onAlarm.addListener(async (alarm) => {
  if (alarm.name === 'AcuityBookmarksPeriodicSync') {
    try {
      await bookmarkManager.checkAndSync()
    } catch (error) {
      logger.warn('Periodic sync failed:', error)
    }
  }
})
```

### 方案四：添加存储配额监控（短期优化）

**新增功能**：<cite/>

```typescript
class StorageQuotaMonitor {
  private readonly WARNING_THRESHOLD = 0.8 // 80%
  private readonly CRITICAL_THRESHOLD = 0.95 // 95%

  async checkQuota(): Promise<void> {
    if (!navigator.storage?.estimate) return

    const estimate = await navigator.storage.estimate()
    const percentUsed = (estimate.usage || 0) / (estimate.quota || 1)

    if (percentUsed > this.CRITICAL_THRESHOLD) {
      chrome.notifications.create({
        type: 'basic',
        title: 'Storage Critical',
        message: `Storage usage: ${(percentUsed * 100).toFixed(1)}%`,
        iconUrl: 'images/icon48.png'
      })
    } else if (percentUsed > this.WARNING_THRESHOLD) {
      logger.warn('Storage quota warning', {
        usage: estimate.usage,
        quota: estimate.quota,
        percentUsed
      })
    }
  }
}

// 定期检查（每小时）
chrome.alarms.create('StorageQuotaCheck', { periodInMinutes: 60 })
```

## 实施优先级

### 立即实施（1-2 天）

1. **完善 Service Worker 生命周期**：添加 `onStartup`/`onInstalled` 监听<cite/>
2. **启用 Alarms API**：移除 `setInterval` 回退逻辑<cite/>
3. **添加存储配额监控**：防止超出配额<cite/>

### 短期优化（1 周）

1. **Offscreen Documents**：迁移 HTML 解析逻辑<cite/>
2. **Scripting API**：使用新的脚本注入 API<cite/>
3. **优化消息传递**：添加超时和重试机制<cite/>

### 长期优化（1 个月）

1. **Declarative Net Request**：迁移部分网络请求<cite/>
2. **完善权限管理**：使用 `optional_permissions` 按需请求<cite/>
3. **性能监控**：添加 Service Worker 性能指标<cite/>

## Notes

项目已经基本符合 Manifest V3 规范：<cite/>

- ✅ 使用 Service Worker 替代 background pages
- ✅ 使用 `action` API 替代 `browser_action`
- ✅ 独立的 `host_permissions` 配置
- ✅ 使用 `sidePanel` API（Chrome 114+）

主要问题：<cite/>

- ⚠️ Alarms API 未完全启用（被注释） [12](#4-11)
- ❌

Wiki pages you might want to explore:

- [Architecture (ChenQiWen/acuityBookmarks)](/wiki/ChenQiWen/acuityBookmarks#2)
- [Chrome Extension Frontend (ChenQiWen/acuityBookmarks)](/wiki/ChenQiWen/acuityBookmarks#2.1)

### Citations

**File:** frontend/public/manifest.json (L2-2)

```json
  "manifest_version": 3,
```

**File:** frontend/public/manifest.json (L9-9)

```json
    "unlimitedStorage",
```

**File:** frontend/public/manifest.json (L11-11)

```json
    "scripting",
```

**File:** frontend/public/manifest.json (L20-27)

```json
  "host_permissions": [
    "http://127.0.0.1:8787/*",
    "http://localhost:8787/*",
    "https://api.acuitybookmarks.com/*",
    "https://*/*",
    "http://*/*",
    "https://acuitybookmarks.cqw547847.workers.dev/*"
  ],
```

**File:** frontend/public/manifest.json (L28-35)

```json
  "action": {
    "default_popup": "popup.html",
    "default_icon": {
      "16": "images/icon16.png",
      "48": "images/icon48.png",
      "128": "images/icon128.png"
    }
  },
```

**File:** frontend/public/manifest.json (L36-39)

```json
  "background": {
    "service_worker": "background.js",
    "type": "module"
  },
```

**File:** frontend/public/manifest.json (L43-45)

```json
  "side_panel": {
    "default_path": "side-panel.html"
  },
```

**File:** frontend/public/manifest.json (L46-75)

```json
  "commands": {
    "_execute_action": {
      "suggested_key": {
        "default": "Alt+A",
        "mac": "Alt+A"
      },
      "description": "激活该扩展程序（按一次弹出，再按一次收起）"
    },
    "open-side-panel": {
      "suggested_key": {
        "default": "Alt+C",
        "mac": "Alt+C"
      },
      "description": "切换书签侧边栏"
    },
    "open-management": {
      "suggested_key": {
        "default": "Alt+B",
        "mac": "Alt+B"
      },
      "description": "打开书签管理"
    },
    "open-settings": {
      "suggested_key": {
        "default": "Alt+S",
        "mac": "Alt+S"
      },
      "description": "打开设置"
    }
  },
```

**File:** background.js (L2147-2171)

```javascript
  startPeriodicSync() {
    const periodMinutes = Math.max(1, Math.floor(SYNC_INTERVAL / 60000))
    try {
      chrome.alarms.create('AcuityBookmarksPeriodicSync', {
        periodInMinutes: periodMinutes
      })
      logger.info(
        'ServiceWorker',
        `🔄 [书签管理服务] 定期同步已启动（chrome.alarms），间隔: ${periodMinutes} 分钟`
      )
    } catch (error) {
      logger.warn(
        'ServiceWorker',
        '⚠️ [书签管理服务] 创建 alarms 失败，回退至 setInterval:',
        error
      )
      setInterval(async () => {
        try {
          await this.checkAndSync()
        } catch (err) {
          logger.warn('ServiceWorker', '⚠️ [书签管理服务] 定期同步失败:', err)
        }
      }, SYNC_INTERVAL)
    }
  }
```

**File:** background.js (L4240-4257)

```javascript
chrome.alarms.onAlarm.addListener(async alarm => {
  /*
  if (alarm?.name === 'AcuityBookmarksPeriodicSync') {
    try {
      await bookmarkManager.checkAndSync()
    } catch (error) {
      logger.warn('ServiceWorker', '⚠️ [书签管理服务] alarms 同步失败:', error)
    }
  }
  */
  if (alarm?.name === 'AcuityBookmarksAutoEmbedding') {
    try {
      await maybeRunAutoEmbeddingJob()
    } catch (error) {
      logger.warn('ServiceWorker', '⚠️ [嵌入自动] alarms 任务失败:', error)
    }
  }
})
```

**File:** background.js (L4259-4262)

```javascript
logger.info(
  'ServiceWorker',
  '✅ [Service Worker] AcuityBookmarks Service Worker 已启动'
)
```
