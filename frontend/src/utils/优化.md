æ‚¨è¯¢é—®çš„æ˜¯è¯¥æ’ä»¶æ˜¯å¦å®Œå…¨ä½¿ç”¨äº† **Manifest V3** çš„ç‰¹æ€§ï¼Œä»¥åŠæ˜¯å¦è¿˜æœ‰ä¼˜åŒ–ç©ºé—´ã€‚<cite/>è®©æˆ‘åŸºäº `frontend/public/manifest.json` å’Œ `background.js` çš„å®é™…å®ç°æ¥åˆ†æã€‚<cite/>

## å½“å‰ Manifest V3 ä½¿ç”¨æƒ…å†µ

é¡¹ç›®å·²ç»ä½¿ç”¨ Manifest V3ï¼Œé…ç½®ä½äº [1](#4-0) ï¼Œä½†å¹¶æœªå®Œå…¨åˆ©ç”¨æ‰€æœ‰ V3 ç‰¹æ€§ã€‚<cite/>

### å·²ä½¿ç”¨çš„ V3 ç‰¹æ€§

1. **Service Worker** [2](#4-1)
   - âœ… ä½¿ç”¨ `service_worker` æ›¿ä»£ V2 çš„ `background.scripts`
   - âœ… è®¾ç½® `type: "module"` æ”¯æŒ ES æ¨¡å—

2. **Action API** [3](#4-2)
   - âœ… ä½¿ç”¨ `action` æ›¿ä»£ V2 çš„ `browser_action`
   - âœ… é…ç½® `default_popup` å’Œå›¾æ ‡

3. **Host Permissions** [4](#4-3)
   - âœ… ç‹¬ç«‹çš„ `host_permissions` å­—æ®µï¼ˆV3 è¦æ±‚ï¼‰

4. **Commands API** [5](#4-4)
   - âœ… å¿«æ·é”®é…ç½®ï¼ˆAlt+A/B/C/Sï¼‰

5. **Side Panel API** [6](#4-5)
   - âœ… ä½¿ç”¨ `sidePanel` æƒé™å’Œé…ç½®

## æœªå……åˆ†åˆ©ç”¨çš„ V3 ç‰¹æ€§

### 1. Alarms API ä½¿ç”¨ä¸å®Œæ•´

å½“å‰ä»£ç ä¸­ `chrome.alarms` å·²é…ç½®ä½†è¢«æ³¨é‡Šæ‰ï¼š [7](#4-6)

**é—®é¢˜**ï¼š<cite/>

- å®šæœŸåŒæ­¥é€»è¾‘è¢«æ³¨é‡Šï¼ˆ`AcuityBookmarksPeriodicSync`ï¼‰
- å›é€€åˆ° `setInterval`ï¼Œä½† Service Worker å¯èƒ½è¢«æµè§ˆå™¨ä¼‘çœ å¯¼è‡´å®šæ—¶å™¨å¤±æ•ˆ

**ä¼˜åŒ–å»ºè®®**ï¼š<cite/>

```typescript
// å®Œå…¨å¯ç”¨ Alarms API
chrome.alarms.create('AcuityBookmarksPeriodicSync', {
  periodInMinutes: 1 // 60ç§’åŒæ­¥
})

chrome.alarms.onAlarm.addListener(async alarm => {
  if (alarm.name === 'AcuityBookmarksPeriodicSync') {
    await bookmarkManager.checkAndSync()
  }
})
```

### 2. ç¼ºå°‘ Offscreen Documents API

å½“å‰ Service Worker ç›´æ¥å¤„ç† DOM æ“ä½œå’Œ HTML è§£æï¼ˆå¦‚çˆ¬å–å…ƒæ•°æ®ï¼‰ï¼Œè¿™åœ¨ V3 ä¸­ä¸æ¨èï¼š<cite/>

**é—®é¢˜**ï¼š<cite/>

- Service Worker æ— æ³•è®¿é—® DOM API
- çˆ¬å–é€»è¾‘å¯èƒ½åœ¨æŸäº›åœºæ™¯ä¸‹å¤±è´¥

**ä¼˜åŒ–å»ºè®®**ï¼š<cite/>

```typescript
// ä½¿ç”¨ Offscreen Documents å¤„ç† DOM æ“ä½œ
async function createOffscreenDocument() {
  if (await chrome.offscreen.hasDocument()) return

  await chrome.offscreen.createDocument({
    url: 'offscreen.html',
    reasons: ['DOM_SCRAPING'],
    justification: 'Parse bookmark metadata from HTML'
  })
}

// åœ¨ offscreen document ä¸­è§£æ HTML
chrome.runtime.sendMessage({
  type: 'PARSE_HTML',
  html: responseText
})
```

### 3. æœªä½¿ç”¨ Declarative Net Request

å½“å‰ä½¿ç”¨ `host_permissions` è¿›è¡Œç½‘ç»œè¯·æ±‚ï¼Œä½†å¯ä»¥ç”¨ `declarativeNetRequest` ä¼˜åŒ–ï¼š<cite/>

**ä¼˜åŒ–å»ºè®®**ï¼š<cite/>

```json
{
  "permissions": [
    "declarativeNetRequest",
    "declarativeNetRequestWithHostAccess"
  ],
  "declarative_net_request": {
    "rule_resources": [
      {
        "id": "ruleset_1",
        "enabled": true,
        "path": "rules.json"
      }
    ]
  }
}
```

### 4. ç¼ºå°‘ Storage API é…é¢ç®¡ç†

å½“å‰ä½¿ç”¨ `unlimitedStorage` æƒé™ [8](#4-7) ï¼Œä½†æœªç›‘æ§é…é¢ä½¿ç”¨ï¼š<cite/>

**ä¼˜åŒ–å»ºè®®**ï¼š<cite/>

```typescript
// ç›‘æ§å­˜å‚¨é…é¢
async function checkStorageQuota() {
  if (navigator.storage && navigator.storage.estimate) {
    const estimate = await navigator.storage.estimate()
    const percentUsed = (estimate.usage / estimate.quota) * 100

    if (percentUsed > 80) {
      // è§¦å‘æ¸…ç†æˆ–è­¦å‘Š
      logger.warn('Storage quota exceeds 80%', { percentUsed })
    }
  }
}
```

### 5. æœªä½¿ç”¨ Scripting API çš„æ–°ç‰¹æ€§

å½“å‰æœ‰ `scripting` æƒé™ [9](#4-8) ï¼Œä½†æœªå……åˆ†åˆ©ç”¨ï¼š<cite/>

**ä¼˜åŒ–å»ºè®®**ï¼š<cite/>

```typescript
// ä½¿ç”¨ chrome.scripting.executeScript æ›¿ä»£æ—§çš„ tabs.executeScript
chrome.scripting.executeScript({
  target: { tabId: tab.id },
  func: () => {
    // æå–é¡µé¢å…ƒæ•°æ®
    return {
      title: document.title,
      description: document.querySelector('meta[name="description"]')?.content
    }
  }
})
```

### 6. ç¼ºå°‘ Service Worker ç”Ÿå‘½å‘¨æœŸç®¡ç†

å½“å‰ Service Worker å¯èƒ½å› æµè§ˆå™¨ä¼‘çœ è€Œä¸¢å¤±çŠ¶æ€ï¼š<cite/>

**ä¼˜åŒ–å»ºè®®**ï¼š<cite/>

```typescript
// ç›‘å¬ Service Worker æ¿€æ´»
chrome.runtime.onStartup.addListener(() => {
  logger.info('Extension startup, reinitializing...')
  bookmarkManager.initialize()
})

// ç›‘å¬ Service Worker å®‰è£…
chrome.runtime.onInstalled.addListener(details => {
  if (details.reason === 'install') {
    // é¦–æ¬¡å®‰è£…é€»è¾‘
    chrome.tabs.create({ url: 'welcome.html' })
  } else if (details.reason === 'update') {
    // æ›´æ–°é€»è¾‘
    logger.info('Extension updated to', chrome.runtime.getManifest().version)
  }
})
```

## Manifest V3 æœ€ä½³å®è·µå¯¹æ¯”

| ç‰¹æ€§         | V3 æœ€ä½³å®è·µ                | å½“å‰å®ç°              | ä¼˜åŒ–å»ºè®®           |
| ------------ | -------------------------- | --------------------- | ------------------ |
| **åå°è„šæœ¬** | Service Worker             | âœ… å·²ä½¿ç”¨             | æ·»åŠ ç”Ÿå‘½å‘¨æœŸç®¡ç†   |
| **å®šæ—¶ä»»åŠ¡** | chrome.alarms              | âš ï¸ éƒ¨åˆ†ä½¿ç”¨ï¼ˆè¢«æ³¨é‡Šï¼‰ | å®Œå…¨å¯ç”¨ alarms    |
| **DOM æ“ä½œ** | Offscreen Documents        | âŒ æœªä½¿ç”¨             | è¿ç§» HTML è§£æé€»è¾‘ |
| **ç½‘ç»œè¯·æ±‚** | declarativeNetRequest      | âŒ æœªä½¿ç”¨             | è€ƒè™‘è¿ç§»éƒ¨åˆ†è¯·æ±‚   |
| **å­˜å‚¨ç®¡ç†** | é…é¢ç›‘æ§                   | âŒ æœªç›‘æ§             | æ·»åŠ é…é¢æ£€æŸ¥       |
| **è„šæœ¬æ³¨å…¥** | chrome.scripting           | âš ï¸ æœ‰æƒé™ä½†æœªå……åˆ†ä½¿ç”¨ | ä½¿ç”¨æ–° API         |
| **æ¶ˆæ¯ä¼ é€’** | chrome.runtime.sendMessage | âœ… å·²ä½¿ç”¨             | ä¿æŒç°çŠ¶           |

## å…·ä½“ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šå®Œå–„ Service Worker ç”Ÿå‘½å‘¨æœŸï¼ˆç«‹å³å®æ–½ï¼‰ [10](#4-9)

**é—®é¢˜**ï¼š<cite/>

- ç¼ºå°‘ `onStartup` å’Œ `onInstalled` ç›‘å¬
- Service Worker ä¼‘çœ åçŠ¶æ€ä¸¢å¤±

**ä¼˜åŒ–**ï¼š<cite/>

```typescript
// åœ¨ background.js é¡¶éƒ¨æ·»åŠ 
chrome.runtime.onInstalled.addListener(async details => {
  logger.info('Extension installed/updated', details)

  if (details.reason === 'install') {
    // é¦–æ¬¡å®‰è£…ï¼šåˆå§‹åŒ–æ•°æ®åº“
    await bookmarkManager.loadBookmarkData()
    chrome.tabs.create({ url: 'management.html' })
  } else if (details.reason === 'update') {
    // æ›´æ–°ï¼šæ£€æŸ¥æ•°æ®åº“ç‰ˆæœ¬
    const prevVersion = details.previousVersion
    const currVersion = chrome.runtime.getManifest().version
    logger.info(`Updated from ${prevVersion} to ${currVersion}`)
  }
})

chrome.runtime.onStartup.addListener(async () => {
  logger.info('Browser startup, reinitializing extension')
  await bookmarkManager.initialize()
})
```

### æ–¹æ¡ˆäºŒï¼šå¯ç”¨ Offscreen Documentsï¼ˆçŸ­æœŸä¼˜åŒ–ï¼‰

**æ–°å¢æ–‡ä»¶**ï¼š`frontend/public/offscreen.html`

```html
<!DOCTYPE html>
<html>
  <head>
    <script src="offscreen.js"></script>
  </head>
  <body></body>
</html>
```

**æ–°å¢æ–‡ä»¶**ï¼š`frontend/public/offscreen.js`

```typescript
chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
  if (message.type === 'PARSE_HTML') {
    const parser = new DOMParser()
    const doc = parser.parseFromString(message.html, 'text/html')

    const metadata = {
      title: doc.querySelector('title')?.textContent,
      description: doc.querySelector('meta[name="description"]')?.content,
      ogImage: doc.querySelector('meta[property="og:image"]')?.content
    }

    sendResponse(metadata)
  }
  return true
})
```

**ä¿®æ”¹ manifest.json**ï¼š

```json
{
  "permissions": ["offscreen"],
  "web_accessible_resources": [
    {
      "resources": ["offscreen.html"],
      "matches": ["<all_urls>"]
    }
  ]
}
```

### æ–¹æ¡ˆä¸‰ï¼šä¼˜åŒ– Alarms ä½¿ç”¨ï¼ˆç«‹å³å®æ–½ï¼‰

å½“å‰ä»£ç ï¼š [11](#4-10)

**é—®é¢˜**ï¼š<cite/>

- å›é€€åˆ° `setInterval`ï¼ŒService Worker ä¼‘çœ åå¤±æ•ˆ

**ä¼˜åŒ–**ï¼š<cite/>

```typescript
// ç§»é™¤ setInterval å›é€€é€»è¾‘
startPeriodicSync() {
  const periodMinutes = Math.max(1, Math.floor(SYNC_INTERVAL / 60000))

  chrome.alarms.create('AcuityBookmarksPeriodicSync', {
    periodInMinutes: periodMinutes
  })

  logger.info(`Periodic sync started (${periodMinutes} min interval)`)
}

// å–æ¶ˆæ³¨é‡Š alarms ç›‘å¬å™¨
chrome.alarms.onAlarm.addListener(async (alarm) => {
  if (alarm.name === 'AcuityBookmarksPeriodicSync') {
    try {
      await bookmarkManager.checkAndSync()
    } catch (error) {
      logger.warn('Periodic sync failed:', error)
    }
  }
})
```

### æ–¹æ¡ˆå››ï¼šæ·»åŠ å­˜å‚¨é…é¢ç›‘æ§ï¼ˆçŸ­æœŸä¼˜åŒ–ï¼‰

**æ–°å¢åŠŸèƒ½**ï¼š<cite/>

```typescript
class StorageQuotaMonitor {
  private readonly WARNING_THRESHOLD = 0.8 // 80%
  private readonly CRITICAL_THRESHOLD = 0.95 // 95%

  async checkQuota(): Promise<void> {
    if (!navigator.storage?.estimate) return

    const estimate = await navigator.storage.estimate()
    const percentUsed = (estimate.usage || 0) / (estimate.quota || 1)

    if (percentUsed > this.CRITICAL_THRESHOLD) {
      chrome.notifications.create({
        type: 'basic',
        title: 'Storage Critical',
        message: `Storage usage: ${(percentUsed * 100).toFixed(1)}%`,
        iconUrl: 'images/icon48.png'
      })
    } else if (percentUsed > this.WARNING_THRESHOLD) {
      logger.warn('Storage quota warning', {
        usage: estimate.usage,
        quota: estimate.quota,
        percentUsed
      })
    }
  }
}

// å®šæœŸæ£€æŸ¥ï¼ˆæ¯å°æ—¶ï¼‰
chrome.alarms.create('StorageQuotaCheck', { periodInMinutes: 60 })
```

## å®æ–½ä¼˜å…ˆçº§

### ç«‹å³å®æ–½ï¼ˆ1-2 å¤©ï¼‰

1. **å®Œå–„ Service Worker ç”Ÿå‘½å‘¨æœŸ**ï¼šæ·»åŠ  `onStartup`/`onInstalled` ç›‘å¬<cite/>
2. **å¯ç”¨ Alarms API**ï¼šç§»é™¤ `setInterval` å›é€€é€»è¾‘<cite/>
3. **æ·»åŠ å­˜å‚¨é…é¢ç›‘æ§**ï¼šé˜²æ­¢è¶…å‡ºé…é¢<cite/>

### çŸ­æœŸä¼˜åŒ–ï¼ˆ1 å‘¨ï¼‰

1. **Offscreen Documents**ï¼šè¿ç§» HTML è§£æé€»è¾‘<cite/>
2. **Scripting API**ï¼šä½¿ç”¨æ–°çš„è„šæœ¬æ³¨å…¥ API<cite/>
3. **ä¼˜åŒ–æ¶ˆæ¯ä¼ é€’**ï¼šæ·»åŠ è¶…æ—¶å’Œé‡è¯•æœºåˆ¶<cite/>

### é•¿æœŸä¼˜åŒ–ï¼ˆ1 ä¸ªæœˆï¼‰

1. **Declarative Net Request**ï¼šè¿ç§»éƒ¨åˆ†ç½‘ç»œè¯·æ±‚<cite/>
2. **å®Œå–„æƒé™ç®¡ç†**ï¼šä½¿ç”¨ `optional_permissions` æŒ‰éœ€è¯·æ±‚<cite/>
3. **æ€§èƒ½ç›‘æ§**ï¼šæ·»åŠ  Service Worker æ€§èƒ½æŒ‡æ ‡<cite/>

## Notes

é¡¹ç›®å·²ç»åŸºæœ¬ç¬¦åˆ Manifest V3 è§„èŒƒï¼š<cite/>

- âœ… ä½¿ç”¨ Service Worker æ›¿ä»£ background pages
- âœ… ä½¿ç”¨ `action` API æ›¿ä»£ `browser_action`
- âœ… ç‹¬ç«‹çš„ `host_permissions` é…ç½®
- âœ… ä½¿ç”¨ `sidePanel` APIï¼ˆChrome 114+ï¼‰

ä¸»è¦é—®é¢˜ï¼š<cite/>

- âš ï¸ Alarms API æœªå®Œå…¨å¯ç”¨ï¼ˆè¢«æ³¨é‡Šï¼‰ [12](#4-11)
- âŒ

Wiki pages you might want to explore:

- [Architecture (ChenQiWen/acuityBookmarks)](/wiki/ChenQiWen/acuityBookmarks#2)
- [Chrome Extension Frontend (ChenQiWen/acuityBookmarks)](/wiki/ChenQiWen/acuityBookmarks#2.1)

### Citations

**File:** frontend/public/manifest.json (L2-2)

```json
  "manifest_version": 3,
```

**File:** frontend/public/manifest.json (L9-9)

```json
    "unlimitedStorage",
```

**File:** frontend/public/manifest.json (L11-11)

```json
    "scripting",
```

**File:** frontend/public/manifest.json (L20-27)

```json
  "host_permissions": [
    "http://127.0.0.1:8787/*",
    "http://localhost:8787/*",
    "https://api.acuitybookmarks.com/*",
    "https://*/*",
    "http://*/*",
    "https://acuitybookmarks.cqw547847.workers.dev/*"
  ],
```

**File:** frontend/public/manifest.json (L28-35)

```json
  "action": {
    "default_popup": "popup.html",
    "default_icon": {
      "16": "images/icon16.png",
      "48": "images/icon48.png",
      "128": "images/icon128.png"
    }
  },
```

**File:** frontend/public/manifest.json (L36-39)

```json
  "background": {
    "service_worker": "background.js",
    "type": "module"
  },
```

**File:** frontend/public/manifest.json (L43-45)

```json
  "side_panel": {
    "default_path": "side-panel.html"
  },
```

**File:** frontend/public/manifest.json (L46-75)

```json
  "commands": {
    "_execute_action": {
      "suggested_key": {
        "default": "Alt+A",
        "mac": "Alt+A"
      },
      "description": "æ¿€æ´»è¯¥æ‰©å±•ç¨‹åºï¼ˆæŒ‰ä¸€æ¬¡å¼¹å‡ºï¼Œå†æŒ‰ä¸€æ¬¡æ”¶èµ·ï¼‰"
    },
    "open-side-panel": {
      "suggested_key": {
        "default": "Alt+C",
        "mac": "Alt+C"
      },
      "description": "åˆ‡æ¢ä¹¦ç­¾ä¾§è¾¹æ "
    },
    "open-management": {
      "suggested_key": {
        "default": "Alt+B",
        "mac": "Alt+B"
      },
      "description": "æ‰“å¼€ä¹¦ç­¾ç®¡ç†"
    },
    "open-settings": {
      "suggested_key": {
        "default": "Alt+S",
        "mac": "Alt+S"
      },
      "description": "æ‰“å¼€è®¾ç½®"
    }
  },
```

**File:** background.js (L2147-2171)

```javascript
  startPeriodicSync() {
    const periodMinutes = Math.max(1, Math.floor(SYNC_INTERVAL / 60000))
    try {
      chrome.alarms.create('AcuityBookmarksPeriodicSync', {
        periodInMinutes: periodMinutes
      })
      logger.info(
        'ServiceWorker',
        `ğŸ”„ [ä¹¦ç­¾ç®¡ç†æœåŠ¡] å®šæœŸåŒæ­¥å·²å¯åŠ¨ï¼ˆchrome.alarmsï¼‰ï¼Œé—´éš”: ${periodMinutes} åˆ†é’Ÿ`
      )
    } catch (error) {
      logger.warn(
        'ServiceWorker',
        'âš ï¸ [ä¹¦ç­¾ç®¡ç†æœåŠ¡] åˆ›å»º alarms å¤±è´¥ï¼Œå›é€€è‡³ setInterval:',
        error
      )
      setInterval(async () => {
        try {
          await this.checkAndSync()
        } catch (err) {
          logger.warn('ServiceWorker', 'âš ï¸ [ä¹¦ç­¾ç®¡ç†æœåŠ¡] å®šæœŸåŒæ­¥å¤±è´¥:', err)
        }
      }, SYNC_INTERVAL)
    }
  }
```

**File:** background.js (L4240-4257)

```javascript
chrome.alarms.onAlarm.addListener(async alarm => {
  /*
  if (alarm?.name === 'AcuityBookmarksPeriodicSync') {
    try {
      await bookmarkManager.checkAndSync()
    } catch (error) {
      logger.warn('ServiceWorker', 'âš ï¸ [ä¹¦ç­¾ç®¡ç†æœåŠ¡] alarms åŒæ­¥å¤±è´¥:', error)
    }
  }
  */
  if (alarm?.name === 'AcuityBookmarksAutoEmbedding') {
    try {
      await maybeRunAutoEmbeddingJob()
    } catch (error) {
      logger.warn('ServiceWorker', 'âš ï¸ [åµŒå…¥è‡ªåŠ¨] alarms ä»»åŠ¡å¤±è´¥:', error)
    }
  }
})
```

**File:** background.js (L4259-4262)

```javascript
logger.info(
  'ServiceWorker',
  'âœ… [Service Worker] AcuityBookmarks Service Worker å·²å¯åŠ¨'
)
```
