<template>
  <App class="app-container">
    <Overlay :show="isPageLoading" persistent :opacity="0.12" :blur="true">
      <div class="overlay-loading">
        <Spinner color="primary" size="xl" class="loading-spinner" />
        <div class="loading-text" data-testid="progress-text">
          {{ loadingMessage }}
        </div>
      </div>
    </Overlay>

    <!-- üìä ÂÖ®Â±Ä‰π¶Á≠æÂêåÊ≠•ËøõÂ∫¶ÂØπËØùÊ°Ü -->
    <GlobalSyncProgress />

    <!-- üîç ÂÅ•Â∫∑Êâ´ÊèèËøõÂ∫¶ÂØπËØùÊ°Ü -->
    <Dialog
      :show="showHealthScanProgress"
      title="ÂÅ•Â∫∑Â∫¶Êâ´Êèè"
      persistent
      max-width="500px"
    >
      <div class="health-scan-progress">
        <div class="progress-info">
          <div class="progress-message">{{ healthScanProgress.message }}</div>
          <div class="progress-stats">
            {{ healthScanProgress.current }} / {{ healthScanProgress.total }}
          </div>
        </div>
        <ProgressBar
          :value="healthScanProgress.percentage"
          :show-label="true"
          color="primary"
          :height="8"
        />
      </div>
    </Dialog>

    <AppHeader :show-side-panel-toggle="false" />

    <Main padding class="main-content">
      <Grid is="container" fluid class="fill-height management-container">
        <Grid is="row" class="fill-height" align="stretch">
          <!-- Left Panel -->
          <Grid is="col" :cols="5" class="panel-col">
            <Card class="panel-card" elevation="medium">
              <template #header>
                <div class="panel-header">
                  <div class="panel-title-section">
                    <Icon name="icon-folder" color="primary" />
                    <span class="panel-title">ÊàëÁöÑ‰π¶Á≠æ</span>
                  </div>
                  <div class="panel-title-section">
                    <Button
                      variant="text"
                      size="sm"
                      icon
                      :title="
                        leftExpandAll ? 'Êî∂Ëµ∑ÂÖ®ÈÉ®Êñá‰ª∂Â§π' : 'Â±ïÂºÄÂÖ®ÈÉ®Êñá‰ª∂Â§π'
                      "
                      :disabled="isPageLoading"
                      @click="toggleLeftExpandAll"
                    >
                      <span
                        class="expand-toggle-icon"
                        :class="{
                          expanded: leftExpandAll,
                          expanding: isPageLoading
                        }"
                      >
                        <Icon
                          :name="
                            leftExpandAll
                              ? 'icon-collapse-All'
                              : 'icon-expand-All'
                          "
                        />
                      </span>
                    </Button>
                  </div>
                </div>
              </template>
              <div class="panel-content">
                <BookmarkTree
                  ref="leftTreeRef"
                  :nodes="originalTree"
                  :selected-desc-counts="new Map()"
                  source="management"
                  height="100%"
                  size="comfortable"
                  :loading="isPageLoading"
                  :editable="false"
                  :show-toolbar="false"
                  :highlight-matches="false"
                  :initial-expanded="Array.from(originalExpandedFolders)"
                  :virtual="true"
                  @ready="handleLeftTreeReady"
                />
              </div>
            </Card>
          </Grid>

          <!-- Middle Divider -->
          <Grid is="col" :cols="1" class="panel-col divider-col">
            <div class="panel-divider">
              <Icon name="icon-arrow-right-double" :size="24" color="muted" />
            </div>
          </Grid>

          <!-- Right Panel -->
          <Grid is="col" :cols="6" class="panel-col">
            <Card
              class="panel-card right-panel-card"
              elevation="medium"
              :footer-visible="
                selectedCounts.bookmarks > 0 || selectedCounts.folders > 0
              "
              footer-transition="card-footer-slide"
            >
              <template #header>
                <div class="panel-header">
                  <div class="panel-title-section">
                    <Icon
                      :name="getProposalPanelIcon()"
                      :color="getProposalPanelColor()"
                    />
                    <span class="panel-title">{{
                      getProposalPanelTitle()
                    }}</span>
                  </div>
                  <div class="panel-title-section">
                    <div class="panel-actions">
                      <Button
                        variant="primary"
                        size="sm"
                        :disabled="isCleanupLoading || isPageLoading"
                        title="Â∫îÁî®Êï¥ÁêÜÂª∫ËÆÆÂà∞ÊàëÁöÑ‰π¶Á≠æ"
                        @click="handleApply"
                      >
                        <Icon name="icon-approval" />
                        <span>Â∫îÁî®</span>
                      </Button>
                      <div class="panel-actions-divider"></div>
                      <Button
                        variant="text"
                        size="sm"
                        icon
                        :disabled="isCleanupLoading || isPageLoading"
                        :title="isCleanupLoading ? 'ÂêåÊ≠•‰∏≠...' : 'ÂêåÊ≠•ÂÅ•Â∫∑Ê†áÁ≠æ'"
                        @click="handleCleanupRefreshClick"
                      >
                        <Icon name="icon-refresh" :spin="isCleanupLoading" />
                      </Button>
                      <Button
                        variant="text"
                        size="sm"
                        icon
                        :title="
                          rightExpandAll ? 'Êî∂Ëµ∑ÂÖ®ÈÉ®Êñá‰ª∂Â§π' : 'Â±ïÂºÄÂÖ®ÈÉ®Êñá‰ª∂Â§π'
                        "
                        :disabled="isCleanupLoading || isPageLoading"
                        @click="toggleRightExpandAll"
                      >
                        <span
                          class="expand-toggle-icon"
                          :class="{
                            expanded: rightExpandAll,
                            expanding: isCleanupLoading
                          }"
                        >
                          <Icon
                            :name="
                              rightExpandAll
                                ? 'icon-collapse-All'
                                : 'icon-expand-All'
                            "
                          />
                        </span>
                      </Button>
                    </div>
                  </div>
                  <!-- Â∞ÜÂø´Êç∑Ê†áÁ≠æÊµÆÂ±ÇÊîæÂà∞ header ÂÜÖÔºåÁªùÂØπÂÆö‰ΩçÂà∞Âè≥‰∏äËßí -->
                  <transition name="tag-quick-fade">
                    <div
                      v-show="
                        newProposalTree.children &&
                        newProposalTree.children.length > 0
                      "
                      class="quick-tags-popover"
                      @mouseenter="onQuickTagsMouseEnter"
                      @mouseleave="onQuickTagsMouseLeave"
                    >
                      <CleanupTagPicker :floating="true" />
                    </div>
                  </transition>
                </div>
              </template>
              <div class="panel-content">
                <div v-if="cleanupState" class="cleanup-summary"></div>
                <BookmarkTree
                  ref="rightTreeRef"
                  :nodes="filteredProposalTree"
                  :selected-desc-counts="rightTreeSelectedDescCounts"
                  height="100%"
                  size="comfortable"
                  :loading="isCleanupLoading"
                  :editable="true"
                  :show-toolbar="true"
                  selectable="multiple"
                  :show-selection-checkbox="true"
                  :toolbar-expand-collapse="false"
                  :highlight-matches="false"
                  :initial-expanded="Array.from(proposalExpandedFolders)"
                  :virtual="true"
                  :show-favorite-button="true"
                  :show-edit-button="true"
                  :show-delete-button="true"
                  :show-add-button="true"
                  :show-open-new-tab-button="true"
                  :show-copy-url-button="true"
                  @request-clear-filters="cleanupStore.clearFilters()"
                  @node-edit="handleNodeEdit"
                  @node-delete="handleNodeDelete"
                  @folder-add="handleFolderAdd"
                  @selection-change="onRightSelectionChange"
                  @bookmark-open-new-tab="handleBookmarkOpenNewTab"
                  @bookmark-copy-url="handleBookmarkCopyUrl"
                  @bookmark-toggle-favorite="handleBookmarkToggleFavorite"
                  @node-hover="handleRightNodeHover"
                  @node-hover-leave="handleRightNodeHoverLeave"
                />
              </div>
              <template #footer>
                <!-- Âè≥‰æßÈù¢ÊùøÂÜÖÂ∫ïÈÉ®ÊâπÈáèÊìç‰ΩúÊù°Ôºà‰ªÖÂú®ÈÄâÊã©Êó∂Âá∫Áé∞Ôºâ -->
                <div class="bulk-delete-in-panel">
                  <div class="selection-summary">
                    <span class="text">Â∑≤ÈÄâÊã©</span>
                    <span class="count"
                      ><AnimatedNumber :value="selectedCounts.bookmarks"
                    /></span>
                    <span class="text">Êù°‰π¶Á≠æ</span>
                    <span class="gap"></span>
                    <span class="count"
                      ><AnimatedNumber :value="selectedCounts.folders"
                    /></span>
                    <span class="text">‰∏™Êñá‰ª∂Â§π</span>
                  </div>
                  <div class="bulk-actions">
                    <Button
                      variant="text"
                      size="sm"
                      class="clear-selection"
                      @click="clearRightSelection"
                    >
                      Ê∏ÖÈô§ÈÄâÊã© ({{ rightSelectedIds.length }})
                    </Button>
                    <Button
                      color="error"
                      variant="primary"
                      size="lg"
                      class="bulk-delete-btn"
                      :disabled="
                        selectedCounts.bookmarks === 0 &&
                        selectedCounts.folders === 0
                      "
                      @click="openConfirmBulkDelete"
                    >
                      <template #prepend>
                        <Icon name="icon-delete" />
                      </template>
                      Âà†Èô§
                    </Button>
                  </div>
                </div>
              </template>
            </Card>
          </Grid>
        </Grid>
      </Grid>
    </Main>

    <Toast
      v-model:show="snackbar.show"
      :text="snackbar.text"
      :color="snackbar.color"
      :timeout="snackbar.timeout"
    />

    <!-- Edit Bookmark Dialog -->
    <ConfirmableDialog
      :show="dialogStore.editBookmarkDialog.isOpen"
      title="ÁºñËæë‰π¶Á≠æ"
      icon="icon-edit-bookmark"
      :persistent="true"
      :esc-to-close="true"
      :enable-cancel-guard="false"
      :confirm-message="MSG_CANCEL_EDIT"
      :is-dirty="isEditDirty"
      max-width="500px"
      min-width="500px"
      @update:show="
        (v: boolean) =>
          v
            ? dialogStore.openEditBookmarkDialog(
                dialogStore.editBookmarkDialog.bookmark!
              )
            : dialogStore.closeEditBookmarkDialog()
      "
      @confirm="confirmEditBookmark"
    >
      <div class="edit-form">
        <Input
          v-model="dialogStore.editBookmarkDialog.title"
          label="‰π¶Á≠æÊ†áÈ¢ò"
          variant="outlined"
          class="form-field"
          :error="!!editFormErrors.title"
          :error-message="editFormErrors.title"
        />
        <UrlInput
          v-model="dialogStore.editBookmarkDialog.url"
          label="‰π¶Á≠æÈìæÊé•"
          variant="outlined"
          density="compact"
          :error="!!editFormErrors.url"
          :error-message="editFormErrors.url"
        />
      </div>
      <template #actions="{ requestClose }">
        <Button variant="text" @click="requestClose(false)">ÂèñÊ∂à</Button>
        <Button
          color="primary"
          :disabled="!isEditDirty"
          @click="confirmEditBookmark"
          >Êõ¥Êñ∞</Button
        >
      </template>
    </ConfirmableDialog>

    <!-- Bulk Delete Confirm Dialog -->
    <ConfirmableDialog
      :show="isConfirmBulkDeleteDialogOpen"
      title="Á°ÆËÆ§ÊâπÈáèÂà†Èô§"
      icon="icon-delete-sweep"
      :persistent="true"
      :esc-to-close="true"
      :enable-cancel-guard="false"
      max-width="480px"
      min-width="480px"
      @update:show="(v: boolean) => (isConfirmBulkDeleteDialogOpen = v)"
      @confirm="confirmBulkDeleteSelected"
    >
      <div class="confirm-content">
        ÊòØÂê¶Á°ÆËÆ§Âà†Èô§ÊâÄÈÄâÁöÑ {{ selectedCounts.bookmarks }} Êù°‰π¶Á≠æ„ÄÅ{{
          selectedCounts.folders
        }}
        ‰∏™Êñá‰ª∂Â§πÔºü
      </div>
      <template #actions="{ requestClose }">
        <Button variant="text" @click="requestClose(false)">ÂèñÊ∂à</Button>
        <Button color="error" @click="confirmBulkDeleteSelected"
          >Á°ÆËÆ§Âà†Èô§</Button
        >
      </template>
    </ConfirmableDialog>

    <!-- Edit Folder Dialog -->
    <ConfirmableDialog
      :show="dialogStore.editFolderDialog.isOpen"
      title="ÁºñËæëÊñá‰ª∂Â§π"
      icon="icon-folder-edit"
      :persistent="true"
      :esc-to-close="true"
      :enable-cancel-guard="false"
      :confirm-message="MSG_CANCEL_EDIT"
      :is-dirty="isEditFolderDirty"
      max-width="500px"
      min-width="500px"
      @update:show="
        (v: boolean) =>
          v
            ? dialogStore.openEditFolderDialog(
                dialogStore.editFolderDialog.folder!
              )
            : dialogStore.closeEditFolderDialog()
      "
      @confirm="confirmEditFolder"
    >
      <div class="edit-form">
        <Input
          v-model="dialogStore.editFolderDialog.title"
          label="Êñá‰ª∂Â§πÊ†áÈ¢ò"
          variant="outlined"
          class="form-field"
          :error="!!folderEditFormErrors.title"
          :error-message="folderEditFormErrors.title"
        />
      </div>
      <template #actions="{ requestClose }">
        <Button variant="text" @click="requestClose(false)">ÂèñÊ∂à</Button>
        <Button
          color="primary"
          :disabled="!isEditFolderDirty"
          @click="confirmEditFolder"
          >Êõ¥Êñ∞</Button
        >
      </template>
    </ConfirmableDialog>

    <!-- Delete Folder Confirm Dialog (Áªü‰∏Ä‰∏∫ ConfirmableDialog) -->
    <ConfirmableDialog
      :show="isConfirmDeleteDialogOpen"
      :esc-to-close="true"
      title="Á°ÆËÆ§Âà†Èô§"
      icon="icon-delete"
      :persistent="true"
      :enable-cancel-guard="false"
      max-width="480px"
      min-width="480px"
      @update:show="(v: boolean) => (isConfirmDeleteDialogOpen = v)"
      @confirm="confirmDeleteFolder"
    >
      <div class="confirm-content">
        ÊòØÂê¶Á°ÆËÆ§Âà†Èô§ËØ•ÁõÆÂΩïÂèäÂÖ∂ÂåÖÂê´ÁöÑ {{ deleteFolderBookmarkCount }} Êù°‰π¶Á≠æÔºü
      </div>
      <template #actions="{ requestClose }">
        <Button variant="text" @click="requestClose(false)">ÂèñÊ∂à</Button>
        <Button color="error" @click="confirmDeleteFolder">Á°ÆËÆ§Âà†Èô§</Button>
      </template>
    </ConfirmableDialog>

    <!-- Add New Item Dialog -->
    <ConfirmableDialog
      :show="dialogStore.addItemDialog.isOpen"
      :title="addDialogTitle"
      :icon="addDialogIcon"
      :persistent="true"
      :esc-to-close="true"
      :enable-cancel-guard="false"
      :confirm-message="MSG_CANCEL_ADD"
      :is-dirty="isAddDirty"
      :body-min-height="addDialogMinHeight"
      max-width="500px"
      min-width="500px"
      @update:show="
        (v: boolean) =>
          v
            ? dialogStore.openAddItemDialog(
                dialogStore.addItemDialog.type,
                dialogStore.addItemDialog.parentFolder || undefined
              )
            : dialogStore.closeAddItemDialog()
      "
      @confirm="confirmAddNewItem"
    >
      <div ref="addDialogContentRef" class="add-item-form">
        <Tabs
          v-model="dialogStore.addItemDialog.type"
          :tabs="[
            { value: 'bookmark', text: '‰π¶Á≠æ' },
            { value: 'folder', text: 'Êñá‰ª∂Â§π' }
          ]"
          grow
        />
        <div class="form-fields">
          <Input
            v-model="dialogStore.addItemDialog.title"
            label="Ê†áÈ¢ò"
            variant="outlined"
            class="form-field"
            autofocus
            :error="!!addFormErrors.title"
            :error-message="addFormErrors.title"
          />
          <UrlInput
            v-if="dialogStore.addItemDialog.type === 'bookmark'"
            v-model="dialogStore.addItemDialog.url"
            label="ÈìæÊé•Âú∞ÂùÄ"
            variant="outlined"
            density="compact"
            class="form-field"
            :error="!!addFormErrors.url"
            :error-message="addFormErrors.url"
          />
        </div>
      </div>
      <template #actions="{ requestClose }">
        <Button variant="text" @click="requestClose(false)">ÂèñÊ∂à</Button>
        <Button color="primary" @click="confirmAddNewItem">{{
          addConfirmText
        }}</Button>
      </template>
    </ConfirmableDialog>

    <!-- External Update Prompt (‰∏çÂèØÂèñÊ∂à) -->
    <Dialog
      :show="showUpdatePrompt"
      title="‚ö†Ô∏è Ê£ÄÊµãÂà∞Â§ñÈÉ®‰π¶Á≠æÂèòÊõ¥"
      icon="icon-sync"
      :persistent="true"
      :close-on-overlay="false"
      :esc-to-close="false"
      :enter-to-confirm="false"
      :hide-close="true"
      :cancelable="false"
      max-width="520px"
      min-width="520px"
    >
      <div class="update-prompt-content">
        <p style="font-size: 15px; line-height: 1.6; margin-bottom: 12px">
          {{ updatePromptMessage }}
        </p>
        <div
          v-if="pendingUpdateDetail"
          class="update-detail"
          style="
            padding: 12px;
            background: var(--color-surface-variant);
            border-radius: 6px;
            margin-top: 12px;
          "
        >
          <div style="font-size: 13px; color: var(--color-text-secondary)">
            <div>
              <strong>ÂèòÊõ¥Á±ªÂûãÔºö</strong>{{ pendingUpdateDetail.eventType }}
            </div>
            <div style="margin-top: 4px">
              <strong>‰π¶Á≠æ IDÔºö</strong>{{ pendingUpdateDetail.id }}
            </div>
          </div>
        </div>
        <div
          style="
            margin-top: 16px;
            padding: 12px;
            background: var(--color-warning-surface, #fff3cd);
            border-left: 4px solid var(--color-warning, #ffc107);
            border-radius: 4px;
          "
        >
          <strong style="color: var(--color-warning-text, #856404)"
            >‚ö†Ô∏è Ê≥®ÊÑèÔºö</strong
          >
          <span
            style="color: var(--color-warning-text, #856404); font-size: 13px"
          >
            ÊÇ®ÂøÖÈ°ªÂà∑Êñ∞Êï∞ÊçÆÊâçËÉΩÁªßÁª≠Êìç‰ΩúÔºå‰ª•ÈÅøÂÖçÊï∞ÊçÆÂÜ≤Á™Å„ÄÇ
          </span>
        </div>
      </div>
      <template #actions>
        <Button
          variant="primary"
          color="primary"
          size="lg"
          @click="confirmExternalUpdate"
        >
          üîÑ Á´ãÂç≥Âà∑Êñ∞È°µÈù¢
        </Button>
      </template>
    </Dialog>
  </App>
</template>

<script setup lang="ts">
import { schedulerService } from '@/application/scheduler/scheduler-service'
import {
  computed,
  defineOptions,
  h,
  nextTick,
  onMounted,
  onUnmounted,
  ref,
  shallowRef,
  watch
} from 'vue'

defineOptions({
  name: 'ManagementPage'
})
import { storeToRefs } from 'pinia'
// useManagementStore Â∑≤ËøÅÁßªÂà∞Êñ∞ÁöÑ‰∏ì‰∏öÂåñ Store
import {
  useDialogStore,
  useBookmarkManagementStore,
  useCleanupStore,
  useUIStore
} from '@/stores'
import type { HealthTag } from '@/stores/cleanup/cleanup-store'
import { type CleanupProblem } from '@/core/bookmark/domain/cleanup-problem'
import type { HealthScanProgress } from '@/services/health-scan-worker-service'
import {
  App,
  AppHeader,
  Button,
  Card,
  Dialog,
  Grid,
  Icon,
  Input,
  Main,
  Overlay,
  ProgressBar,
  Spinner,
  Tabs,
  Toast,
  UrlInput
} from '@/components'
import { AB_EVENTS } from '@/constants/events'
import { notificationService } from '@/application/notification/notification-service'
import { ConfirmableDialog } from '@/components'
import { onEvent } from '@/infrastructure/events/event-bus'
import BookmarkTree from '@/components/composite/BookmarkTree/BookmarkTree.vue'
import { useEventListener, useDebounceFn, useTimeoutFn } from '@vueuse/core'
// ÁßªÈô§È°∂ÈÉ®/ÂÖ®Â±ÄÊêúÁ¥¢Ôºå‰∏çÂÜçÂºïÂÖ•ÊêúÁ¥¢Áõí‰∏é‰∏ãÊãâ
import CleanupTagPicker from './cleanup/CleanupTagPicker.vue'
import { bookmarkAppService } from '@/application/bookmark/bookmark-app-service'
import { searchWorkerAdapter } from '@/services/query-worker-adapter'
// ÂØºÂÖ•Áé∞‰ª£‰π¶Á≠æÊúçÂä°Ôºö‰ª• side-effect ÊñπÂºèÂàùÂßãÂåñÂπ∂ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨‰∏éÊ∂àÊÅØÊ°•Êé•
import '@/services/modern-bookmark-service'
import { DataValidator } from '@/core/common/store-error'
import { useBookmarkStore } from '@/stores/bookmarkStore'
import { logger } from '@/infrastructure/logging/logger'
import type { BookmarkNode } from '@/types'
import { checkOnPageLoad } from '@/services/data-health-client'
import GlobalSyncProgress from '@/components/GlobalSyncProgress.vue'

// managementStore Â∑≤ËøÅÁßªÂà∞Êñ∞ÁöÑ‰∏ì‰∏öÂåñ Store
const dialogStore = useDialogStore()
const bookmarkManagementStore = useBookmarkManagementStore()
const cleanupStore = useCleanupStore()

// UI Áä∂ÊÄÅ‰ªé UIStore Ëé∑Âèñ
const uiStore = useUIStore()
const { snackbar } = storeToRefs(uiStore)

// ‰π¶Á≠æÊ†ëÂ±ïÂºÄÁä∂ÊÄÅ‰ªé BookmarkManagementStore Ëé∑Âèñ
const { originalExpandedFolders, proposalExpandedFolders, hasUnsavedChanges } =
  storeToRefs(bookmarkManagementStore)

// Ê∏ÖÁêÜÁä∂ÊÄÅ‰ªéÊñ∞ÁöÑ CleanupStore Ëé∑Âèñ
const { cleanupState } = storeToRefs(cleanupStore)

// ÂÅ•Â∫∑Êâ´ÊèèËøõÂ∫¶Áä∂ÊÄÅ
const healthScanProgress = ref({
  current: 0,
  total: 0,
  percentage: 0,
  message: 'ÂáÜÂ§áÊâ´Êèè...'
})
const showHealthScanProgress = ref(false)

/**
 * Ê∏ÖÁêÜÈù¢Êùø‰∏ìÁî®ÁöÑÂä†ËΩΩÊÄÅÔºåÂΩìÂÅ•Â∫∑Êâ´ÊèèËøõË°å‰∏≠Êó∂‰ªÖÈîÅÂÆöÂè≥‰æßÊ†ëÂíåÁõ∏ÂÖ≥Êìç‰Ωú„ÄÇ
 */
/**
 * Ê∏ÖÁêÜÈù¢Êùø‰∏ìÁî®ÁöÑÂä†ËΩΩÁä∂ÊÄÅ„ÄÇ
 *
 * - ‰∏éÂÖ®Â±Ä `isPageLoading` Âå∫ÂàÜÔºåÈÅøÂÖçÂ∑¶‰æßÊ†ëÁ≠âÊó†ÂÖ≥Âå∫ÂüüË¢´ËíôÂ±ÇÈòªÂ°û„ÄÇ
 * - Áõ¥Êé•‰æùÊçÆ CleanupStore ÁöÑÊâ´ÊèèÊ†áËÆ∞ÔºåÁ°Æ‰øù‰∏éÂêéÁ´ØÂêåÊ≠•ËøõÂ∫¶‰øùÊåÅ‰∏ÄËá¥„ÄÇ
 */
const isCleanupLoading = computed(() => cleanupState.value?.isScanning ?? false)

/**
 * ÁÇπÂáªÂÅ•Â∫∑ÂêåÊ≠•Êó∂ÁöÑÂ∞ÅË£ÖÂ§ÑÁêÜÔºö‰ΩøÁî® Worker ÈÅøÂÖçÈòªÂ°û UI
 */
const handleCleanupRefreshClick = async () => {
  if (isCleanupLoading.value) return

  try {
    // ÊòæÁ§∫ËøõÂ∫¶ÂØπËØùÊ°Ü
    showHealthScanProgress.value = true
    healthScanProgress.value = {
      current: 0,
      total: 0,
      percentage: 0,
      message: 'ÂáÜÂ§áÊâ´Êèè...'
    }

    // ‰ΩøÁî® Worker ÁâàÊú¨Êâ´ÊèèÔºà‰∏çÈòªÂ°û‰∏ªÁ∫øÁ®ãÔºâ
    await cleanupStore.startHealthScanWorker({
      onProgress: (progress: HealthScanProgress) => {
        healthScanProgress.value = progress
      }
    })

    // ÂÆåÊàê
    uiStore.showSuccess('ÂÅ•Â∫∑Â∫¶Êâ´ÊèèÂÆåÊàê')
  } catch (error) {
    logger.error('Management', 'Âà∑Êñ∞ÂÅ•Â∫∑Ê†áÁ≠æÂ§±Ë¥•', error)
    uiStore.showError('Âà∑Êñ∞ÂÅ•Â∫∑Ê†áÁ≠æÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï')
  } finally {
    showHealthScanProgress.value = false
  }
}

// ‰π¶Á≠æÁÆ°ÁêÜÁä∂ÊÄÅ‰ªéÊñ∞ÁöÑ BookmarkManagementStore Ëé∑Âèñ
const { originalTree, newProposalTree, isPageLoading, loadingMessage } =
  storeToRefs(bookmarkManagementStore)

// ‚úÖ SimpleBookmarkTree ÂøÖÈúÄÁöÑ propsÔºàÁ∫Ø UI ÁªÑ‰ª∂Ôºâ
// Ëøô‰∫õÂÄºÁî±ÁªÑ‰ª∂ÂÜÖÈÉ®Áª¥Êä§ÔºåÁà∂ÁªÑ‰ª∂Âè™ÈúÄÊèê‰æõÁ©∫ÂÆπÂô®
const rightTreeSelectedDescCounts = shallowRef(new Map<string, number>())

const {
  getProposalPanelTitle,
  getProposalPanelIcon,
  getProposalPanelColor,
  initialize: initializeStore,
  editBookmark,
  editFolder,
  deleteBookmark,
  deleteFolder,
  bulkDeleteByIds
} = bookmarkManagementStore

// openAddNewItemDialog Â∑≤ËøÅÁßªÂà∞ DialogStore
const { openAddItemDialog } = dialogStore

// Áªü‰∏ÄÁöÑÁ°ÆËÆ§ÊñáÊ°àÔºàÂáèÂ∞ëÈáçÂ§ç‰∏é‰æø‰∫éÁª¥Êä§Ôºâ
const MSG_CANCEL_EDIT = 'ÊÇ®ÊúâÊõ¥ÊîπÂ∞öÊú™‰øùÂ≠òÔºåÁ°ÆÂÆöÂèñÊ∂àÂπ∂‰∏¢ÂºÉÊõ¥ÊîπÂêóÔºü'
const MSG_CANCEL_ADD = 'ÊÇ®ÊúâÊõ¥ÊîπÂ∞öÊú™Ê∑ªÂä†ÔºåÁ°ÆÂÆöÂèñÊ∂àÂπ∂‰∏¢ÂºÉËæìÂÖ•ÂêóÔºü'

// Áªü‰∏ÄÊñáÊ°àÁî± ConfirmableDialog ‰ΩøÁî®ÔºåÂ∑≤ÁßªÈô§ÊóßÁöÑÈÄöÁî®Â§ÑÁêÜÂáΩÊï∞
// === Ê∑ªÂä†Êñ∞È°πÁõÆÂØπËØùÊ°ÜÔºöÊ†áÈ¢ò/ÂõæÊ†áÈöè TabÔºå‰ΩÜÂ∫ïÈÉ®ÊåâÈíÆÂõ∫ÂÆöÊñáÊ°à ===
const addDialogTitle = computed(() =>
  dialogStore.addItemDialog.type === 'bookmark' ? 'Ê∑ªÂä†Êñ∞‰π¶Á≠æ' : 'Ê∑ªÂä†Êñ∞Êñá‰ª∂Â§π'
)
const addDialogIcon = computed(() =>
  dialogStore.addItemDialog.type === 'bookmark'
    ? 'icon-bookmark'
    : 'icon-folder'
)
// ÊåâÈúÄÊ±ÇÂõ∫ÂÆö‰∏∫"Ê∑ªÂä†"Ôºå‰∏çÈöè Tab ÂàáÊç¢ÂèòÂåñ
const addConfirmText = computed(() => 'Ê∑ªÂä†')

// ‰∏∫Âõ∫ÂÆöÂºπÁ™óÈ´òÂ∫¶Ôºö‰ª•"‰π¶Á≠æ"Tab ÁöÑÂÜÖÂÆπÈ´òÂ∫¶‰∏∫ÂáÜ
const addDialogContentRef = ref<HTMLElement | null>(null)
const addDialogMinHeight = ref<string | undefined>(undefined)

// Âú®ÂºπÁ™óÊâìÂºÄÂêéÊµãÈáèÂΩìÂâçÂÜÖÂÆπÈ´òÂ∫¶ÔºàÈÄöÂ∏∏‰∏∫"‰π¶Á≠æ"TabÔºâÂπ∂Âõ∫ÂÆö
watch(
  () => dialogStore.addItemDialog.isOpen,
  async open => {
    if (open) {
      await nextTick()
      requestAnimationFrame(() => {
        const el = addDialogContentRef.value
        if (el) {
          const h = el.offsetHeight
          if (h && h > 0) {
            addDialogMinHeight.value = `${h}px`
          }
        }
      })
    } else {
      // ÂÖ≥Èó≠Êó∂ÊÅ¢Â§çÈªòËÆ§ÔºåÈÅøÂÖçÊÆãÁïôÂΩ±Âìç‰∏ãÊ¨°ÂºπÁ™ó
      addDialogMinHeight.value = undefined
    }
  }
)

// Â∑≤ÁßªÈô§Êú™‰ΩøÁî®ÁöÑ leftPanelRefÔºåÂáèÂ∞ëÊó†ÊÑè‰πâÁöÑÂìçÂ∫îÂºèÁä∂ÊÄÅ
// È°∂ÈÉ®ÂÖ®Â±ÄÊêúÁ¥¢Â∑≤ÁßªÈô§
// ÈÖçÁΩÆÂäüËÉΩÂ∑≤ËøÅÁßªÂà∞ËÆæÁΩÆÈ°µÔºåÊ≠§Â§Ñ‰∏çÂÜçÂåÖÂê´ÂµåÂÖ•/ÂêëÈáèÁõ∏ÂÖ≥ÊéßÂà∂
// üîî Â§ñÈÉ®ÂèòÊõ¥Êõ¥Êñ∞ÊèêÁ§∫
const showUpdatePrompt = ref(false)
const pendingUpdateDetail = ref<Record<string, unknown> | null>(null)
const pendingTagSelection = ref<HealthTag[] | null>(null)
const updatePromptMessage = ref(
  'ÂÖ∂‰ªñÊµèËßàÂô®Á™óÂè£ÊàñÂ§ñÈÉ®Â∑•ÂÖ∑Â∑≤‰øÆÊîπ‰∫Ü‰π¶Á≠æÊï∞ÊçÆ„ÄÇ‰∏∫‰∫ÜÈÅøÂÖçÊï∞ÊçÆÂÜ≤Á™ÅÂíå‰∏¢Â§±Êõ¥ÊîπÔºåÊÇ®ÂΩìÂâçÈ°µÈù¢ÁöÑÊï∞ÊçÆÂ∑≤ËøáÊúüÔºåÂøÖÈ°ªÁ´ãÂç≥Âà∑Êñ∞Âà∞ÊúÄÊñ∞ÁâàÊú¨„ÄÇ'
)

// üìä ÂêåÊ≠•ËøõÂ∫¶Áä∂ÊÄÅÁî±ÂÖ®Â±Ä GlobalSyncProgress ÁªÑ‰ª∂ÁÆ°ÁêÜ

/**
 * üÜï ‰ΩøÁî® VueUse useTimeoutFn ÁÆ°ÁêÜÂ§ñÈÉ®ÂèòÊõ¥Ëá™Âä®Âà∑Êñ∞
 *
 * ‰ºòÂäøÔºöËá™Âä®Ê∏ÖÁêÜ„ÄÅÊõ¥Áõ¥ËßÇÁöÑ API (start/stop)
 */
const { start: startAutoRefreshTimer, stop: stopAutoRefreshTimer } =
  useTimeoutFn(
    () => {
      notificationService.notify('Ê£ÄÊµãÂà∞Â§ñÈÉ®Êõ¥Êñ∞ÔºåÊ≠£Âú®Âà∑Êñ∞Êï∞ÊçÆ...', {
        level: 'info'
      })
      void confirmExternalUpdate()
    },
    200,
    { immediate: false }
  )

// ‰∏ÄÈîÆÂ±ïÂºÄ/Êî∂Ëµ∑ - Áä∂ÊÄÅ‰∏éÂºïÁî®
const leftTreeRef = ref<InstanceType<typeof BookmarkTree> | null>(null)
const rightTreeRef = ref<InstanceType<typeof BookmarkTree> | null>(null)
// ÁªÑ‰ª∂ÂåñÂêé‰∏çÂÜçÁõ¥Êé•ÂºïÁî®ÂÜÖÈÉ® input ÂÖÉÁ¥†
const rightSelectedIds = ref<string[]>([])
// ÊâπÈáèÂà†Èô§Á°ÆËÆ§ÂºπÁ™óÂºÄÂÖ≥
const isConfirmBulkDeleteDialogOpen = ref(false)
// ‰∏éÊµÆÂä®Âø´Êç∑Ê†áÁ≠æ‰∫§‰∫íÊó∂ÔºåÈÅøÂÖç input Â§±ÁÑ¶Á´ãÂàªÊî∂Ëµ∑
const isInteractingWithQuickTags = ref(false)

// Âè≥‰æßÊèêÊ°àÊ†ëÁ¥¢ÂºïÔºöid => nodeÔºàÁî®‰∫éÈÄâÊã©ÁªüËÆ°‰∏éÂø´ÈÄüÊ£ÄÁ¥¢Ôºâ
const proposalIndex = computed(() => {
  const map = new Map<string, BookmarkNode>()
  const walk = (nodes: BookmarkNode[] | undefined) => {
    if (!Array.isArray(nodes)) return
    for (const n of nodes) {
      if (!n || !n.id) continue
      map.set(String(n.id), n)
      if (n.children && n.children.length) walk(n.children)
    }
  }
  try {
    walk(newProposalTree.value?.children as BookmarkNode[])
  } catch {}
  return map
})

// Â∑≤ÈÄâÊã©ËÆ°Êï∞ÔºàÊñá‰ª∂Â§π=ÂåÖÂê´ÂÖ∂‰∏ãÊâÄÊúâ‰π¶Á≠æÔºâÔºåÂéªÈáç
const selectedCounts = computed(() => {
  const bookmarkIds = new Set<string>()
  const selectedFolderIds = new Set<string>()
  const addBookmarksUnder = (node: BookmarkNode) => {
    if (!node) return
    if (node.url) {
      bookmarkIds.add(String(node.id))
      return
    }
    if (Array.isArray(node.children)) {
      for (const c of node.children) addBookmarksUnder(c)
    }
  }
  for (const rawId of rightSelectedIds.value) {
    const id = String(rawId)
    const node = proposalIndex.value.get(id)
    if (!node) continue
    if (node.url) bookmarkIds.add(id)
    else {
      selectedFolderIds.add(id)
      addBookmarksUnder(node)
    }
  }
  return { bookmarks: bookmarkIds.size, folders: selectedFolderIds.size }
})

const onQuickTagsMouseEnter = () => {
  isInteractingWithQuickTags.value = true
}
const onQuickTagsMouseLeave = () => {
  // Âª∂Ëøü‰∏Ä‰∏™tickÔºåÁ°Æ‰øùÁÇπÂáª‰∫ã‰ª∂ÂÖàÂ§ÑÁêÜÂÆåÊàêÂÜçÂÖÅËÆ∏ËæìÂÖ•Ê°ÜÊî∂Ëµ∑
  setTimeout(() => {
    isInteractingWithQuickTags.value = false
  }, 0)
}

watch(
  () => bookmarkManagementStore.newProposalTree,
  async newTree => {
    if (!newTree || !pendingTagSelection.value?.length) return
    await nextTick()
    const tags = pendingTagSelection.value
    pendingTagSelection.value = null
    const ids = cleanupStore.findProblemNodesByTags(tags)
    if (!ids.length || !rightTreeRef.value) return
    try {
      const instance = rightTreeRef.value
      if (!instance) return
      if (typeof instance.selectNodesByIds === 'function') {
        instance.selectNodesByIds(ids, { append: false })
      }
      const firstId = ids[0]
      if (firstId && typeof instance.focusNodeById === 'function') {
        await instance.focusNodeById(firstId, {
          scrollIntoViewCenter: true
        })
      }
    } catch (error) {
      console.warn('Management', 'Ëá™Âä®ÈÄâ‰∏≠ÂÅ•Â∫∑ÈóÆÈ¢òËäÇÁÇπÂ§±Ë¥•', error)
    }
  },
  { deep: false }
)
const leftExpandAll = ref(false)
const rightExpandAll = ref(false)

// Â±ïÂºÄ/Êî∂Ëµ∑ÊêúÁ¥¢Âπ∂Ëá™Âä®ËÅöÁÑ¶Âà∞ËæìÂÖ•Ê°ÜÔºõÂêåÊó∂ËÆ©ÊåâÈíÆÂ§±ÁÑ¶ÔºåÈÅøÂÖçÂá∫Áé∞ËÅöÁÑ¶ËæπÊ°Ü
// ÂàáÊç¢ÈÄªËæëÁî± PanelInlineSearch ÂÜÖÈÉ®ÊâòÁÆ°

// ÊÇ¨ÂÅúÊéí‰ªñÂ±ïÂºÄÔºöÈªòËÆ§ÂêØÁî®
const hoverExclusiveCollapse = ref(true)
// Âè≥‰æßÊÇ¨ÂÅú -> Â∑¶‰æßËÅîÂä®ÔºöÈò≤Ê≠¢È¢ëÁπÅÊ∏≤ÊüìÂíåÊªöÂä®ÊäñÂä®
let lastHoverId: string | null = null
// Èò≤Ê≠¢Âπ∂ÂèëËß¶ÂèëÂØºËá¥Áä∂ÊÄÅÈîô‰π±ÊàñËßÜËßâÂºÇÂ∏∏ÔºàÂ¶ÇËíôÂ±ÇÊòæÂæóÂä†Ê∑±Ôºâ
const isExpanding = ref(false)
// Â±ÄÈÉ®ËíôÂ±ÇÂ∑≤ÁßªÈô§ÔºåÁªü‰∏ÄÂ§çÁî®ÂÖ®Â±Ä isPageLoading

// Â∑≤ÁßªÈô§È°∂ÈÉ®Êï∞ÈáèÂ±ïÁ§∫ÔºåÁõ∏ÂÖ≥ÁªüËÆ°ËÆ°ÁÆó‰∏çÂÜçÈúÄË¶Å

// === Ë°®ÂçïÂÜÖËÅîÈîôËØØÁä∂ÊÄÅÔºàÈ°∂Â±ÇÔºâ ===
const editFormErrors = ref<{ title: string; url: string }>({
  title: '',
  url: ''
})
const addFormErrors = ref<{ title: string; url: string }>({
  title: '',
  url: ''
})

// ËæìÂÖ•Êó∂Âä®ÊÄÅÊ∏ÖÈô§ÈîôËØØÊèêÁ§∫
watch(
  () => dialogStore.editBookmarkDialog.url,
  val => {
    if (editFormErrors.value.url && (val || '').trim()) {
      editFormErrors.value.url = ''
    }
  }
)
watch(
  () => dialogStore.addItemDialog.url,
  val => {
    if (addFormErrors.value.url && (val || '').trim()) {
      addFormErrors.value.url = ''
    }
  }
)
// Ê†áÈ¢òËæìÂÖ•Êó∂Ê∏ÖÈô§ÈîôËØØ
watch(
  () => dialogStore.editBookmarkDialog.title,
  val => {
    if (editFormErrors.value.title && (val || '').trim()) {
      editFormErrors.value.title = ''
    }
  }
)
watch(
  () => dialogStore.addItemDialog.title,
  val => {
    if (addFormErrors.value.title && (val || '').trim()) {
      addFormErrors.value.title = ''
    }
  }
)
// Tab ÂàáÊç¢Êó∂Ê∏ÖÁ©∫ËæìÂÖ•ÂÜÖÂÆπ‰∏éÈîôËØØ
watch(
  () => dialogStore.addItemDialog.type,
  () => {
    if (!dialogStore.addItemDialog.isOpen) return
    dialogStore.addItemDialog.title = ''
    dialogStore.addItemDialog.url = ''
    addFormErrors.value.title = ''
    addFormErrors.value.url = ''
  }
)

const filteredProposalTree = computed(() => {
  const all = newProposalTree.value.children || []
  const cs = cleanupState.value
  if (
    !cs ||
    !cs.isFiltering ||
    !Array.isArray(cs.activeFilters) ||
    cs.activeFilters.length === 0
  ) {
    return all
  }
  const active = new Set<string>(cs.activeFilters as unknown as string[])
  // ÂÖÅËÆ∏ÁöÑËäÇÁÇπÔºöÂ≠òÂú®‰∏é‰ªª‰∏ÄËøáÊª§Á±ªÂûãÂåπÈÖçÁöÑÈóÆÈ¢ò
  const matchedIds = new Set<string>()
  try {
    for (const [nodeId, problems] of cs.filterResults.entries()) {
      if (!problems || problems.length === 0) continue
      let hit = false
      for (const p of problems as CleanupProblem[]) {
        if (active.has(String(p.type))) {
          hit = true
          // Ëã•‰∏∫ÈáçÂ§çÔºåÂåÖÂê´Áõ∏ÂÖ≥ËäÇÁÇπÔºå‰ΩøÊï¥ÁªÑÈÉΩÂèØËßÅ
          if (p.type === 'duplicate' && Array.isArray(p.relatedNodeIds)) {
            for (const rid of p.relatedNodeIds) matchedIds.add(String(rid))
          }
        }
      }
      if (hit) matchedIds.add(String(nodeId))
    }
  } catch {}

  // ‰ªéÊ†πÈÄíÂΩíÊã∑Ë¥ù‰ªÖÂåÖÂê´ÂåπÈÖçËäÇÁÇπÊâÄÂú®ÂàÜÊîØ
  const cloneFiltered = (nodes: BookmarkNode[]): BookmarkNode[] => {
    const out: BookmarkNode[] = []
    for (const n of nodes) {
      const id = String(n.id)
      const children = Array.isArray(n.children) ? n.children : []
      const filteredChildren = children.length ? cloneFiltered(children) : []
      if (matchedIds.has(id) || filteredChildren.length > 0) {
        out.push({ ...n, children: filteredChildren })
      }
    }
    return out
  }
  return cloneFiltered(all)
})

// ÁªÑ‰ª∂Â∞±Áª™Ôºö‰ªÖÂú®ÂéüÂßãÊ†ëÂ∑≤ÊúâÊï∞ÊçÆÊó∂Ëß£Èô§Âä†ËΩΩÊÄÅÔºåÈÅøÂÖçÁ©∫Êï∞ÊçÆÊó∂ËøáÊó©ÈöêËóèËíôÂ±Ç
const handleLeftTreeReady = () => {
  try {
    const hasData =
      Array.isArray(originalTree.value) && originalTree.value.length > 0
    if (isPageLoading.value && hasData) {
      isPageLoading.value = false
    }
  } catch (error) {
    logger.error('Management', '‚ùå handleLeftTreeReady Â§±Ë¥•', error)
  }
}

// === Êñ∞Â¢ûÂØπËØùÊ°ÜËÑèÁä∂ÊÄÅÔºö‰ªÖËæìÂÖ•ÂÜÖÂÆπÂèëÁîüÂèòÂåñÊó∂ÊèêÁ§∫‰∫åÊ¨°Á°ÆËÆ§ ===
const isAddDirty = computed(() => {
  const t = (dialogStore.addItemDialog.title || '').trim()
  const u = (dialogStore.addItemDialog.url || '').trim()
  if (dialogStore.addItemDialog.type === 'bookmark') {
    return !!t || !!u
  }
  // Êñá‰ª∂Â§π‰ªÖÊ†áÈ¢ò
  return !!t
})

// === ÁºñËæëÂØπËØùÊ°ÜËÑèÁä∂ÊÄÅÔºö‰ªÖÂΩìÊ†áÈ¢òÊàñÈìæÊé•ÂèëÁîüÂèòÂåñÊó∂ËßÜ‰∏∫Â∑≤Êõ¥Êîπ ===
const isEditDirty = computed(() => {
  const originalTitle = (
    dialogStore.editBookmarkDialog.bookmark?.title || ''
  ).trim()
  const originalUrl = (
    dialogStore.editBookmarkDialog.bookmark?.url || ''
  ).trim()
  const curTitle = (dialogStore.editBookmarkDialog.title || '').trim()
  const curUrl = (dialogStore.editBookmarkDialog.url || '').trim()
  return originalTitle !== curTitle || originalUrl !== curUrl
})

// === ÁºñËæëÊñá‰ª∂Â§πÂØπËØùÊ°ÜËÑèÁä∂ÊÄÅ‰∏éÈîôËØØ ===
const isEditFolderDirty = computed(() => {
  const originalTitle = (
    dialogStore.editFolderDialog.folder?.title || ''
  ).trim()
  const curTitle = (dialogStore.editFolderDialog.title || '').trim()
  return originalTitle !== curTitle
})
const folderEditFormErrors = ref<{ title: string }>({ title: '' })
watch(
  () => dialogStore.editFolderDialog.title,
  val => {
    if (folderEditFormErrors.value.title && (val || '').trim()) {
      folderEditFormErrors.value.title = ''
    }
  }
)

// üóëÔ∏è Âà†Èô§Á°ÆËÆ§ÂØπËØùÊ°ÜÁä∂ÊÄÅ
const isConfirmDeleteDialogOpen = ref(false)
const deleteTargetFolder = ref<BookmarkNode | null>(null)
const deleteFolderBookmarkCount = ref(0)

const handleNodeEdit = (node: BookmarkNode) => {
  if (node?.url) {
    editBookmark({
      id: node.id,
      title: node.title,
      url: node.url || '',
      parentId: node.parentId
    })
  } else {
    editFolder({
      id: node.id,
      title: node.title,
      url: '',
      parentId: node.parentId
    })
  }
}

const handleNodeDelete = (node: BookmarkNode) => {
  if (node.children) {
    // ÁªüËÆ°ËØ•ÁõÆÂΩï‰∏ãÁöÑ‰π¶Á≠æÊï∞ÈáèÔºàÈÄíÂΩíÔºâ
    const countBookmarks = (nodes: BookmarkNode[]): number => {
      if (!Array.isArray(nodes)) return 0
      let total = 0
      for (const n of nodes) {
        if (n?.url) total++
        if (n?.children && n.children.length)
          total += countBookmarks(n.children)
      }
      return total
    }
    const count = countBookmarks(node.children || [])
    if (count > 0) {
      deleteTargetFolder.value = node
      deleteFolderBookmarkCount.value = count
      isConfirmDeleteDialogOpen.value = true
    } else {
      deleteFolder(node.id)
    }
  } else {
    deleteBookmark(node.id)
  }
}

const handleFolderAdd = (node: BookmarkNode) => {
  openAddItemDialog('bookmark', node)
}

const handleBookmarkOpenNewTab = (node: BookmarkNode) => {
  if (node.url) {
    window.open(node.url, '_blank')
  }
}

// === ÂØπËØùÊ°ÜÈîÆÁõòÁªëÂÆö‰∏éÊèê‰∫§/ÂèñÊ∂à ===
const confirmAddNewItem = async () => {
  // Ê†áÈ¢òÂøÖÂ°´Ê†°È™åÔºà‰π¶Á≠æ‰∏éÊñá‰ª∂Â§πÈÄöÁî®Ôºâ
  const title = (dialogStore.addItemDialog.title || '').trim()
  if (!title) {
    addFormErrors.value.title = 'Ê†áÈ¢ò‰∏çËÉΩ‰∏∫Á©∫'
    return
  }
  // Ë°®ÂçïÊ†°È™åÔºö‰ªÖÂú®‰π¶Á≠æÊ®°Âºè‰∏ãÊ†°È™å URL
  if (dialogStore.addItemDialog.type === 'bookmark') {
    const url = (dialogStore.addItemDialog.url || '').trim()
    if (!DataValidator.validateUrl(url)) {
      // ÊòæÁ§∫ÂÜÖËÅîÈîôËØØÂπ∂ÈòªÊ≠¢‰øùÂ≠ò
      addFormErrors.value.url =
        'ÈìæÊé•Âú∞ÂùÄÊ†ºÂºè‰∏çÊ≠£Á°Æ„ÄÇÁ§∫‰æãÔºöhttps://example.com/path'
      return
    }
  }
  // Ê∑ªÂä†Êñ∞‰π¶Á≠æ
  const res = await bookmarkManagementStore.addBookmark({
    type: dialogStore.addItemDialog.type,
    title: dialogStore.addItemDialog.title,
    url: dialogStore.addItemDialog.url,
    parentId: dialogStore.addItemDialog.parentFolder?.id
  })
  // Ëá™Âä®ÊªöÂä®Âπ∂È´ò‰∫ÆÂÆö‰ΩçÂà∞Êñ∞ËäÇÁÇπ
  if (
    res &&
    rightTreeRef.value &&
    typeof rightTreeRef.value.focusNodeById === 'function'
  ) {
    await nextTick()
    try {
      await rightTreeRef.value.focusNodeById(res.id, {
        collapseOthers: true,
        scrollIntoViewCenter: true
      })
    } catch (e) {
      console.error('Êñ∞Â¢ûÂêéÂÆö‰ΩçÂ§±Ë¥•:', e)
    }
  }
}

// ÂèñÊ∂à‰∏éÂÖ≥Èó≠ÈÄªËæëÂ∑≤Áî± ConfirmableDialog Áªü‰∏ÄÂ§ÑÁêÜ

const confirmEditBookmark = async () => {
  // Êú™ÂèëÁîüÊõ¥ÊîπÂàô‰∏çÊèê‰∫§
  if (!isEditDirty.value) return
  // Ê†áÈ¢òÂøÖÂ°´Ê†°È™å
  const title = (dialogStore.editBookmarkDialog.title || '').trim()
  if (!title) {
    editFormErrors.value.title = 'Ê†áÈ¢ò‰∏çËÉΩ‰∏∫Á©∫'
    return
  }
  // Ë°®ÂçïÊ†°È™åÔºöÁºñËæë‰π¶Á≠æÊó∂Ê†°È™å URL
  const url = (dialogStore.editBookmarkDialog.url || '').trim()
  if (!DataValidator.validateUrl(url)) {
    editFormErrors.value.url =
      'ÈìæÊé•Âú∞ÂùÄÊ†ºÂºè‰∏çÊ≠£Á°Æ„ÄÇÁ§∫‰æãÔºöhttps://example.com/path'
    return
  }
  await bookmarkManagementStore.editBookmark({
    id: dialogStore.editBookmarkDialog.bookmark!.id,
    title: dialogStore.editBookmarkDialog.title,
    url: dialogStore.editBookmarkDialog.url,
    parentId: dialogStore.editBookmarkDialog.parentId
  })
}

const confirmEditFolder = async () => {
  if (!isEditFolderDirty.value) return
  const title = (dialogStore.editFolderDialog.title || '').trim()
  if (!title) {
    folderEditFormErrors.value.title = 'Ê†áÈ¢ò‰∏çËÉΩ‰∏∫Á©∫'
    return
  }
  await bookmarkManagementStore.editBookmark({
    id: dialogStore.editFolderDialog.folder!.id,
    title: dialogStore.editFolderDialog.title,
    url: '', // Êñá‰ª∂Â§πÊ≤°Êúâ URL
    parentId: undefined
  })
}

// ÂèñÊ∂à‰∏éÂÖ≥Èó≠ÈÄªËæëÂ∑≤Áî± ConfirmableDialog Áªü‰∏ÄÂ§ÑÁêÜ

// Áªü‰∏ÄÂÖ≥Èó≠Á°ÆËÆ§Áî± ConfirmableDialog ÊâòÁÆ°

// === Âà†Èô§Á°ÆËÆ§ÂØπËØùÊ°ÜÔºöÁ°ÆËÆ§‰∏éÂèñÊ∂à ===
const confirmDeleteFolder = () => {
  if (deleteTargetFolder.value) {
    deleteFolder(deleteTargetFolder.value.id)
  }
  isConfirmDeleteDialogOpen.value = false
  deleteTargetFolder.value = null
  deleteFolderBookmarkCount.value = 0
}

const handleBookmarkCopyUrl = (node: BookmarkNode) => {
  if (node.url) {
    navigator.clipboard.writeText(node.url)
    notificationService.notify('URL copied!', { level: 'success' })
  }
}

/**
 * Â§ÑÁêÜÊî∂Ëóè/ÂèñÊ∂àÊî∂Ëóè‰π¶Á≠æ
 */
const handleBookmarkToggleFavorite = async (
  node: BookmarkNode,
  isFavorite: boolean
) => {
  logger.info(
    'Management',
    `${isFavorite ? '‚≠ê Êî∂Ëóè' : 'üóëÔ∏è ÂèñÊ∂àÊî∂Ëóè'}‰π¶Á≠æ:`,
    node.title
  )
  try {
    const { favoriteAppService } = await import(
      '@/application/bookmark/favorite-app-service'
    )
    const bookmarkStore = useBookmarkStore()
    const success = isFavorite
      ? await favoriteAppService.addToFavorites(node.id)
      : await favoriteAppService.removeFromFavorites(node.id)

    if (success) {
      notificationService.notify(isFavorite ? `‰π¶Á≠æÂ∑≤Êî∂Ëóè` : `‰π¶Á≠æÂ∑≤ÂèñÊ∂àÊî∂Ëóè`, {
        level: 'success'
      })
      // Âà∑Êñ∞‰π¶Á≠æÊ†ë‰ª•Êõ¥Êñ∞ UI
      await bookmarkStore.loadFromIndexedDB()
    } else {
      notificationService.notify('Êìç‰ΩúÂ§±Ë¥•ÔºåËØ∑ÈáçËØï', { level: 'error' })
    }
  } catch (error) {
    logger.error('Component', 'Management', '‚ùå ÂàáÊç¢Êî∂ËóèÁä∂ÊÄÅÂ§±Ë¥•:', error)
    notificationService.notify('Êìç‰ΩúÂ§±Ë¥•ÔºåËØ∑ÈáçËØï', { level: 'error' })
  }
}

// ÈîÆÁõòË°å‰∏∫Áªü‰∏ÄÁî± Dialog ÁªÑ‰ª∂Â§ÑÁêÜÔºàEnter=confirmÔºåEsc=closeÔºâ

// === Á≤æÁªÜÂåñÊõ¥Êñ∞ËæÖÂä©ÂáΩÊï∞ ===

/**
 * Âà∑Êñ∞Âçï‰∏™‰π¶Á≠æËäÇÁÇπÔºàÂàõÂª∫ÊàñÁßªÂä®ÂêéÔºâ
 *
 * @param bookmarkId - ‰π¶Á≠æID
 */
async function refreshSingleBookmark(bookmarkId: string | undefined) {
  if (!bookmarkId) {
    console.warn(
      '[Management] refreshSingleBookmark: Áº∫Â∞ë bookmarkIdÔºåÂõûÈÄÄÂà∞ÂÖ®ÈáèÂà∑Êñ∞'
    )
    await initializeStore()
    return
  }

  try {
    // ‚úÖ ÈÄöËøá Application Service ‰ªé IndexedDB ËØªÂèñÊúÄÊñ∞ËäÇÁÇπÊï∞ÊçÆ
    const result = await bookmarkAppService.getBookmarkById(bookmarkId)
    if (!result.ok || !result.value) {
      console.warn('[Management] ‰π¶Á≠æ‰∏çÂ≠òÂú®ÔºåÂèØËÉΩÂ∑≤Ë¢´Âà†Èô§:', bookmarkId)
      return
    }

    const bookmark = result.value

    // ËΩ¨Êç¢‰∏∫ BookmarkNode Ê†ºÂºè
    const node: BookmarkNode = {
      id: bookmark.id,
      parentId: bookmark.parentId,
      title: bookmark.title || '',
      url: bookmark.url,
      dateAdded: bookmark.dateAdded,
      dateGroupModified: bookmark.dateGroupModified,
      index: bookmark.index,
      isFolder: !bookmark.url,
      childrenCount: bookmark.childrenCount || 0,
      bookmarksCount: bookmark.bookmarksCount || 0
    }

    // Êõ¥Êñ∞Âà∞ bookmarkStore
    const bookmarkStore = useBookmarkStore()
    bookmarkStore.upsertNode(node)

    console.log('[Management] ‚úÖ Âçï‰∏™‰π¶Á≠æÂ∑≤Âà∑Êñ∞:', bookmark.title)
  } catch (error) {
    console.error('[Management] refreshSingleBookmark Â§±Ë¥•:', error)
    // Â§±Ë¥•Êó∂ÂõûÈÄÄÂà∞ÂÖ®ÈáèÂà∑Êñ∞
    await initializeStore()
  }
}

/**
 * Êõ¥Êñ∞Âçï‰∏™‰π¶Á≠æËäÇÁÇπÔºà‰øÆÊîπÂêéÔºâ
 *
 * @param bookmarkId - ‰π¶Á≠æID
 */
async function updateSingleBookmark(bookmarkId: string | undefined) {
  if (!bookmarkId) {
    console.warn(
      '[Management] updateSingleBookmark: Áº∫Â∞ë bookmarkIdÔºåÂõûÈÄÄÂà∞ÂÖ®ÈáèÂà∑Êñ∞'
    )
    await initializeStore()
    return
  }

  try {
    // ‚úÖ ÈÄöËøá Application Service ‰ªé IndexedDB ËØªÂèñÊúÄÊñ∞ËäÇÁÇπÊï∞ÊçÆ
    const result = await bookmarkAppService.getBookmarkById(bookmarkId)
    if (!result.ok || !result.value) {
      console.warn('[Management] ‰π¶Á≠æ‰∏çÂ≠òÂú®ÔºåÂèØËÉΩÂ∑≤Ë¢´Âà†Èô§:', bookmarkId)
      return
    }

    const bookmark = result.value

    // Âè™Êõ¥Êñ∞ÂèòÂåñÁöÑÂ≠óÊÆµ
    const bookmarkStore = useBookmarkStore()
    bookmarkStore.updateNode(bookmarkId, {
      title: bookmark.title || '',
      url: bookmark.url,
      dateGroupModified: bookmark.dateGroupModified
    })

    console.log('[Management] ‚úÖ Âçï‰∏™‰π¶Á≠æÂ∑≤Êõ¥Êñ∞:', bookmark.title)
  } catch (error) {
    console.error('[Management] updateSingleBookmark Â§±Ë¥•:', error)
    // Â§±Ë¥•Êó∂ÂõûÈÄÄÂà∞ÂÖ®ÈáèÂà∑Êñ∞
    await initializeStore()
  }
}

/**
 * Âà†Èô§Âçï‰∏™‰π¶Á≠æËäÇÁÇπ
 *
 * @param bookmarkId - ‰π¶Á≠æID
 */
async function removeSingleBookmark(bookmarkId: string | undefined) {
  if (!bookmarkId) {
    console.warn(
      '[Management] removeSingleBookmark: Áº∫Â∞ë bookmarkIdÔºåÂõûÈÄÄÂà∞ÂÖ®ÈáèÂà∑Êñ∞'
    )
    await initializeStore()
    return
  }

  try {
    const bookmarkStore = useBookmarkStore()
    bookmarkStore.removeNode(bookmarkId)

    console.log('[Management] ‚úÖ Âçï‰∏™‰π¶Á≠æÂ∑≤Âà†Èô§:', bookmarkId)
  } catch (error) {
    console.error('[Management] removeSingleBookmark Â§±Ë¥•:', error)
    // Â§±Ë¥•Êó∂ÂõûÈÄÄÂà∞ÂÖ®ÈáèÂà∑Êñ∞
    await initializeStore()
  }
}

/**
 * Â§ÑÁêÜÊï∞ÊçÆÂêåÊ≠•‰∫ã‰ª∂
 *
 * üÜï ‰ΩøÁî® Event Bus Êõø‰ª£Áõ¥Êé•ÁõëÂê¨ Chrome Ê∂àÊÅØ
 *
 * ÂêéÂè∞Â∑≤ÂÆåÊàê IndexedDB ÂêåÊ≠•Êó∂ÁöÑÂø´ÈÄüÂà∑Êñ∞Ôºö
 * Ê†πÊçÆ‰∫ã‰ª∂Á±ªÂûãÊâßË°åÁ≤æÁªÜÂåñÊàñÂÖ®ÈáèÊõ¥Êñ∞
 */
const handleDbSynced = async (data: {
  eventType: 'created' | 'changed' | 'moved' | 'removed' | 'full-sync' | string
  bookmarkId: string
  timestamp: number
}) => {
  const { eventType, bookmarkId } = data

  // Â¶ÇÊûúÊúâÊú™‰øùÂ≠òÁöÑÊõ¥ÊîπÔºåÊòæÁ§∫Â§ñÈÉ®ÂèòÊõ¥ÊèêÁ§∫ËÄå‰∏çÊòØÁõ¥Êé•ËøîÂõû
  if (hasUnsavedChanges.value) {
    pendingUpdateDetail.value = data
    showUpdatePrompt.value = true
    notificationService.notify('Ê£ÄÊµãÂà∞Â§ñÈÉ®‰π¶Á≠æÂèòÊõ¥', { level: 'warning' })
    return
  }

  // üÜï ‰ΩøÁî® VueUse ÁöÑ stop APIÔºåÊó†ÈúÄÊâãÂä®ÁÆ°ÁêÜÂÆöÊó∂Âô®
  stopAutoRefreshTimer()

  // ÂàõÂª∫Âª∂ËøüÊâßË°åÁöÑÂêåÊ≠•Â§ÑÁêÜ
  const syncTimeoutFn = useTimeoutFn(
    async () => {
      try {
        // ‚úÖ IndexedDB ÂàùÂßãÂåñÁî± Application Service ÂÜÖÈÉ®Â§ÑÁêÜÔºåÊó†ÈúÄÁõ¥Êé•Ë∞ÉÁî®

        // Ê†πÊçÆ‰∫ã‰ª∂Á±ªÂûãÊâßË°å‰∏çÂêåÁöÑÊõ¥Êñ∞Á≠ñÁï•
        switch (eventType) {
          case 'created': {
            console.log('[Management] üìù Âçï‰∏™‰π¶Á≠æÂàõÂª∫ÔºåÁ≤æÁªÜÂåñÊõ¥Êñ∞:', bookmarkId)
            await refreshSingleBookmark(bookmarkId)
            notificationService.notify('‰π¶Á≠æÂ∑≤ÂàõÂª∫', { level: 'success' })
            break
          }

          case 'changed': {
            console.log('[Management] ‚úèÔ∏è Âçï‰∏™‰π¶Á≠æ‰øÆÊîπÔºåÁ≤æÁªÜÂåñÊõ¥Êñ∞:', bookmarkId)
            await updateSingleBookmark(bookmarkId)
            notificationService.notify('‰π¶Á≠æÂ∑≤Êõ¥Êñ∞', { level: 'success' })
            break
          }

          case 'removed': {
            console.log('[Management] üóëÔ∏è Âçï‰∏™‰π¶Á≠æÂà†Èô§ÔºåÁ≤æÁªÜÂåñÊõ¥Êñ∞:', bookmarkId)
            await removeSingleBookmark(bookmarkId)
            notificationService.notify('‰π¶Á≠æÂ∑≤Âà†Èô§', { level: 'success' })
            break
          }

          case 'moved': {
            console.log('[Management] üìÅ Âçï‰∏™‰π¶Á≠æÁßªÂä®ÔºåÁ≤æÁªÜÂåñÊõ¥Êñ∞:', bookmarkId)
            await refreshSingleBookmark(bookmarkId)
            notificationService.notify('‰π¶Á≠æÂ∑≤ÁßªÂä®', { level: 'success' })
            break
          }

          case 'full-sync':
          default: {
            // ÂÖ®ÈáèÂêåÊ≠•ÊàñÊú™Áü•‰∫ã‰ª∂Á±ªÂûãÔºåÊâßË°åÂÆåÊï¥Âà∑Êñ∞
            console.log('[Management] üîÑ ÂÖ®ÈáèÂêåÊ≠•ÔºåÂà∑Êñ∞ÊâÄÊúâÊï∞ÊçÆ')
            notificationService.notify('Êï∞ÊçÆÂ∑≤ÂêåÊ≠•ÔºåÂà∑Êñ∞‰∏≠...', {
              level: 'info'
            })
            await initializeStore()
            // ÊêúÁ¥¢Á¥¢ÂºïÈÄöÂ∏∏‰æùËµñ‰π¶Á≠æÂÖ®ÈõÜÂèòÂåñÔºåÊåâÈúÄÂà∑Êñ∞
            try {
              await searchWorkerAdapter.initFromIDB()
            } catch {}
            notificationService.notify('Â∑≤ÂêåÊ≠•ÊúÄÊñ∞‰π¶Á≠æ', { level: 'success' })
            break
          }
        }
      } catch (e) {
        notificationService.notify('ÂêåÊ≠•Â§±Ë¥•', { level: 'error' })
        console.error('handleDbSynced error:', e)
      }
    },
    100,
    { immediate: false }
  )

  // üÜï Á´ãÂç≥ÂêØÂä®ÂêåÊ≠•ÂÆöÊó∂Âô®
  syncTimeoutFn.start()
}

/**
 * üÜï ‰ΩøÁî® Event Bus ÁõëÂê¨Êï∞ÊçÆÂêåÊ≠•‰∫ã‰ª∂
 *
 * Âú®ÁªÑ‰ª∂ËÆæÁΩÆÈò∂ÊÆµËÆ¢ÈòÖ‰∫ã‰ª∂ÔºåÁ°Æ‰øùÁîüÂëΩÂë®ÊúüÈí©Â≠êÂú®ÂêåÊ≠•‰ª£Á†Å‰∏≠Ê≥®ÂÜå
 */
const unsubscribeDbSynced = onEvent('data:synced', handleDbSynced)

/**
 * ÁªÑ‰ª∂Âç∏ËΩΩÊó∂Ê∏ÖÁêÜÁõëÂê¨Âô®
 *
 * Ê≥®ÊÑèÔºö
 * - useEventListener ‰ºöËá™Âä®Ê∏ÖÁêÜ window ‰∫ã‰ª∂ÁõëÂê¨Âô®
 * - useTimeoutFn ‰ºöËá™Âä®Ê∏ÖÁêÜÂÆöÊó∂Âô®
 * - Âè™ÈúÄÊâãÂä®Ê∏ÖÁêÜ Event Bus ËÆ¢ÈòÖ
 */
onUnmounted(() => {
  // üÜï Ê∏ÖÁêÜ Event Bus ËÆ¢ÈòÖ
  unsubscribeDbSynced()

  // üìä ÂÖ®Â±ÄËøõÂ∫¶ËÆ¢ÈòÖÁî± GlobalSyncProgress ÁÆ°ÁêÜÔºåÊó†ÈúÄÊâãÂä®Ê∏ÖÁêÜ

  // ÊöÇÂ≠òÊõ¥Êîπ‰øùÊä§Â∑≤ËøÅÁßªÂà∞ BookmarkManagementStore
  // bookmarkManagementStore.detachUnsavedChangesGuard()
})

onMounted(async () => {
  // üìä ÂêåÊ≠•ËøõÂ∫¶Áî±ÂÖ®Â±Ä GlobalSyncProgress ÁªÑ‰ª∂ÁÆ°ÁêÜÔºåÊó†ÈúÄÊú¨Âú∞ËÆ¢ÈòÖ

  // È¶ñÂÖàËøõË°åÊï∞ÊçÆÂÅ•Â∫∑Ê£ÄÊü•ÔºåÁ°Æ‰øùÊï∞ÊçÆÂÆåÊï¥ÊÄß
  await checkOnPageLoad({ autoRecover: true, showNotification: false })

  initializeStore()

  // ÂêéÂè∞ÈùôÈªòÊâ´ÊèèÂÅ•Â∫∑Â∫¶Ôºà‰ΩøÁî® WorkerÔºå‰∏çÈòªÂ°û UIÔºâ
  cleanupStore.startHealthScanWorker().catch((error: unknown) => {
    logger.error('Management', 'ÂêéÂè∞ÂÅ•Â∫∑Êâ´ÊèèÂ§±Ë¥•', error)
  })

  // Ëß£ÊûêÊù•Ëá™ Popup ÁöÑÊêúÁ¥¢ÂèÇÊï∞Âπ∂ÂêØÂä®Ê∏ÖÁêÜÊâ´Êèè
  try {
    const params = new URLSearchParams(window.location.search)
    const tagsParam = params.get('tags')
    const tagList = tagsParam
      ? tagsParam
          .split(',')
          .map(tag => tag.trim())
          .filter((tag): tag is HealthTag =>
            ['404', 'duplicate', 'empty', 'invalid'].includes(tag)
          )
      : []

    if (tagList.length > 0) {
      cleanupStore.initializeCleanupState()
      cleanupStore.setActiveFilters(tagList)
      pendingTagSelection.value = tagList
    }
  } catch {}

  // Êú™‰øùÂ≠òÊõ¥ÊîπÁ¶ªÂºÄÊèêÈÜí
  // ÊöÇÂ≠òÊõ¥Êîπ‰øùÊä§Â∑≤ËøÅÁßªÂà∞ BookmarkManagementStore
  // bookmarkManagementStore.attachUnsavedChangesGuard()

  // ‚úÖ ÂÆûÊó∂ÂêåÊ≠•ÔºöÁõëÂê¨Êù•Ëá™ÂêéÂè∞/‰π¶Á≠æAPIÁöÑÂèòÊõ¥‰∫ã‰ª∂ÔºàÊèêÁ§∫Á°ÆËÆ§Ôºâ
  const handleBookmarkUpdated = (evt: Event) => {
    const detail = (evt as CustomEvent)?.detail ?? {}
    pendingUpdateDetail.value = detail
    // Ëã•Ê≤°ÊúâÊú™‰øùÂ≠òÁöÑÊõ¥ÊîπÔºåËá™Âä®Âà∑Êñ∞ÔºàÂéªÊäñÂêàÂπ∂ËøûÁª≠‰∫ã‰ª∂Ôºâ
    if (!hasUnsavedChanges.value) {
      // üÜï ‰ΩøÁî® VueUse ÁöÑ stop/start APIÔºåÊó†ÈúÄÊâãÂä®ÁÆ°ÁêÜÂÆöÊó∂Âô®
      stopAutoRefreshTimer()
      startAutoRefreshTimer()
      return
    }
    // ÊúâÊú™‰øùÂ≠òÊõ¥ÊîπÊó∂ÔºåÊèêÁ§∫Áî®Êà∑ÊâãÂä®Á°ÆËÆ§Âà∑Êñ∞
    showUpdatePrompt.value = true
    notificationService.notify('Ê£ÄÊµãÂà∞Â§ñÈÉ®‰π¶Á≠æÂèòÊõ¥', { level: 'info' })
  }

  /**
   * üÜï ‰ΩøÁî® VueUse useEventListener Êõø‰ª£ window.addEventListener
   *
   * ‰ºòÂäøÔºöËá™Âä®Ê∏ÖÁêÜ„ÄÅÊõ¥ÁÆÄÊ¥ÅÁöÑ API
   */
  useEventListener(
    window,
    AB_EVENTS.BOOKMARK_UPDATED,
    handleBookmarkUpdated as (e: Event) => void
  )

  // Êö¥Èú≤ÂÖ®Â±ÄÊµãËØïÊñπÊ≥ïÔºå‰æø‰∫éÂú®ÊµèËßàÂô®ÊéßÂà∂Âè∞Áõ¥Êé•Ë∞ÉÁî®
  const g = window as unknown as Record<string, unknown>
  g.AB_setFolderExpanded = (id: string, expanded?: boolean) => {
    const comp = leftTreeRef.value
    if (!comp) return
    const sid = String(id)
    // Êú™‰º†Á¨¨‰∫å‰∏™ÂèÇÊï∞Êó∂ÔºåÈªòËÆ§ÂèñÂèçÔºàÂàáÊç¢Ôºâ
    if (expanded === undefined) {
      if (typeof comp.toggleFolderById === 'function')
        comp.toggleFolderById(sid)
      return
    }
    if (expanded) {
      if (typeof comp.expandFolderById === 'function')
        comp.expandFolderById(sid)
    } else {
      if (typeof comp.collapseFolderById === 'function')
        comp.collapseFolderById(sid)
    }
  }
  g.AB_toggleFolder = (id: string) => {
    const comp = leftTreeRef.value
    if (!comp) return
    const sid = String(id)
    if (typeof comp.toggleFolderById === 'function') comp.toggleFolderById(sid)
  }
  g.AB_focusBookmark = (
    id: string,
    opts?: {
      collapseOthers?: boolean
      scrollIntoViewCenter?: boolean
      pathIds?: string[]
    }
  ) => {
    const comp = leftTreeRef.value
    if (!comp || !comp.focusNodeById) return
    comp.focusNodeById(
      String(id),
      opts || { collapseOthers: true, scrollIntoViewCenter: true }
    )
  }
})

// ‰∏ÄÈîÆÂ±ïÂºÄ/Êî∂Ëµ∑ - ‰∫ã‰ª∂Â§ÑÁêÜ
const toggleLeftExpandAll = async () => {
  if (!leftTreeRef.value) return
  if (isExpanding.value) return
  isExpanding.value = true
  schedulerService.scheduleUIUpdate(() => {
    isPageLoading.value = true
    loadingMessage.value = leftExpandAll.value ? 'Ê≠£Âú®Êî∂Ëµ∑...' : 'Ê≠£Âú®Â±ïÂºÄ...'
  })
  // ËÆ©Âá∫‰∏§Â∏ß‰ª•Á°Æ‰øùËíôÂ±ÇÂÖàÁªòÂà∂ÔºàÂ§ÑÁêÜ‰∏ªÁ∫øÁ®ãÈòªÂ°ûÂØºËá¥ÁöÑÊôöÂá∫Áé∞Ôºâ
  await nextTick()
  await new Promise(r => requestAnimationFrame(r))
  await new Promise(r => requestAnimationFrame(r))
  await new Promise(r => setTimeout(r, 0))
  if (leftExpandAll.value) {
    leftTreeRef.value.collapseAll()
    leftExpandAll.value = false
  } else {
    leftTreeRef.value.expandAll()
    leftExpandAll.value = true
  }
  schedulerService.scheduleUIUpdate(() => {
    isPageLoading.value = false
    isExpanding.value = false
  })
}

const toggleRightExpandAll = async () => {
  if (!rightTreeRef.value) return
  if (isExpanding.value) return
  isExpanding.value = true
  isPageLoading.value = true
  loadingMessage.value = rightExpandAll.value ? 'Ê≠£Âú®Êî∂Ëµ∑...' : 'Ê≠£Âú®Â±ïÂºÄ...'
  // ËÆ©Âá∫‰∏§Â∏ß‰ª•Á°Æ‰øùËíôÂ±ÇÂÖàÁªòÂà∂ÔºàÂ§ÑÁêÜ‰∏ªÁ∫øÁ®ãÈòªÂ°ûÂØºËá¥ÁöÑÊôöÂá∫Áé∞Ôºâ
  await nextTick()
  await new Promise(r => requestAnimationFrame(r))
  await new Promise(r => requestAnimationFrame(r))
  await new Promise(r => setTimeout(r, 0))
  if (rightExpandAll.value) {
    rightTreeRef.value.collapseAll()
    rightExpandAll.value = false
  } else {
    rightTreeRef.value.expandAll()
    rightExpandAll.value = true
  }
  requestAnimationFrame(() => {
    isPageLoading.value = false
    isExpanding.value = false
  })
}

// Âè≥‰æßÈÄâÊã©ÂèòÂåñÔºöÁî®‰∫éÊâπÈáèÂà†Èô§
const onRightSelectionChange = (ids: string[]) => {
  rightSelectedIds.value = Array.isArray(ids) ? ids.map(String) : []
}

// ÊòéÁ°ÆÁöÑÊ∏ÖÁ©∫ÈÄâÊã©ÔºöË∞ÉÁî®Ê†ëAPIÂπ∂ÂêåÊ≠•Êú¨Âú∞Áä∂ÊÄÅÔºåÈÅøÂÖç‰∏çËß¶Âèë selection-change Êó∂Áä∂ÊÄÅ‰∏çÂêåÊ≠•
const clearRightSelection = () => {
  try {
    rightTreeRef.value?.clearSelection?.()
  } catch {}
  rightSelectedIds.value = []
}

// üì£ Êõ¥Êñ∞ÊèêÁ§∫Âä®‰ΩúÔºàÁÆÄÂåñ‰∏∫"ÂêåÊ≠• + ÈáçÊñ∞ÂàùÂßãÂåñÈ°µÈù¢"Ôºâ
const confirmExternalUpdate = async () => {
  try {
    showUpdatePrompt.value = false
    // ÂàáÊç¢‰∏∫Êú¨Âú∞Âà∑Êñ∞ÔºöÈáçÊñ∞ÂàùÂßãÂåñ StoreÔºàÂÜÖÈÉ®‰ºöÈÄöËøá Application Service ÂàùÂßãÂåñ IndexedDBÔºâ
    notificationService.notify('Ê≠£Âú®Âà∑Êñ∞Êú¨Âú∞Êï∞ÊçÆ...', { level: 'info' })
    await initializeStore()
    // ÂêåÊ≠•Âà∑Êñ∞ÊêúÁ¥¢Á¥¢ÂºïÔºàWorkerÔºâ
    try {
      await searchWorkerAdapter.initFromIDB()
    } catch {}
    notificationService.notify('Êï∞ÊçÆÂ∑≤Êõ¥Êñ∞', { level: 'success' })
  } catch (e) {
    console.error('confirmExternalUpdate error:', e)
    notificationService.notify('Êõ¥Êñ∞Â§±Ë¥•', { level: 'error' })
  }
}

/**
 * üÜï ‰ΩøÁî® VueUse useDebounceFn ÂàõÂª∫Èò≤ÊäñÁöÑÊÇ¨ÂÅúÂ§ÑÁêÜÂáΩÊï∞
 *
 * ‰ºòÂäøÔºöËá™Âä®Èò≤Êäñ„ÄÅÊó†ÈúÄÊâãÂä®ÁÆ°ÁêÜÂÆöÊó∂Âô®
 */
const debouncedFocusNode = useDebounceFn((id: string, pathIds?: string[]) => {
  try {
    const comp = leftTreeRef.value
    if (!comp || typeof comp.focusNodeById !== 'function') return
    // Â¶ÇÊûúÂ∑¶‰æßÊ≠£Âú®ÊªöÂä®ÔºåË∑≥ËøáÊú¨Ê¨°ÔºåÈÅøÂÖçÊªöÂä®Â†ÜÁßØ
    if (comp.isScrolling) return

    // ‚úÖ Áé∞Âú®Â∑¶Âè≥‰∏§‰æßÈÉΩ‰ªé IndexedDB Âä†ËΩΩÔºåpathIds ÂèØ‰ª•Áõ¥Êé•‰ΩøÁî®
    comp.focusNodeById(id, {
      collapseOthers: hoverExclusiveCollapse.value,
      scrollIntoViewCenter: true,
      pathIds // Áõ¥Êé•‰º†ÈÄí pathIdsÔºåÈÅøÂÖçÈáçÂ§çËÆ°ÁÆó
    })
  } catch (err) {
    console.warn('[handleRightNodeHover] ÂÆö‰ΩçÂ§±Ë¥•:', err)
  }
}, 100)

// Âè≥‰æßÊÇ¨ÂÅúËÅîÂä®ÔºöËÆ©Â∑¶‰æßÂè™ËØªÊ†ëÊåâ pathIds Â±ïÂºÄÁà∂ÈìæÂπ∂È´ò‰∫ÆÂØπÂ∫îIDÔºåÊªöÂä®Â±Ö‰∏≠
// ÊÄßËÉΩ‰ºòÂåñÔºöÈò≤Êäñ‰∏éÂéªÈáç + ÊÇ¨ÂÅú‰∏çÊäòÂè†ÂÖ∂ÂÆÉÂàÜÊîØÔºåÂáèÂ∞ëÈáçÊ∏≤Êüì
const handleRightNodeHover = (node: BookmarkNode) => {
  const id = node?.id != null ? String(node.id) : ''
  if (!id || !leftTreeRef.value) return
  if (lastHoverId === id) return
  lastHoverId = id

  // Â¶ÇÊûúÂè≥‰æßËäÇÁÇπÂ∏¶Êúâ IndexedDB È¢ÑÂ§ÑÁêÜÁöÑ pathIdsÔºåÁõ¥Êé•Â§çÁî®Á•ñÂÖàÈìæ
  const pathIds = Array.isArray(node?.pathIds)
    ? node.pathIds.map((x: string | number) => String(x))
    : undefined

  try {
    performance.mark('hover_to_scroll_start')
  } catch {}

  // üÜï Ë∞ÉÁî®Èò≤ÊäñÂáΩÊï∞ÔºåÊó†ÈúÄÊâãÂä®ÁÆ°ÁêÜÂÆöÊó∂Âô®
  debouncedFocusNode(id, pathIds)
}

// Âè≥‰æßÊÇ¨ÂÅúÁßªÂá∫ÔºöÊ∏ÖÈô§Â∑¶‰æßÁöÑÁ®ãÂ∫èÂåñ hover È´ò‰∫Æ
const handleRightNodeHoverLeave = () => {
  const comp = leftTreeRef.value
  if (comp && typeof comp.clearHoverAndActive === 'function') {
    try {
      comp.clearHoverAndActive()
    } catch {}
  }
}

// Â∑≤ÁßªÈô§ÔºöÊâπÈáèÁîüÊàêÂµåÂÖ•Á≠âÊìç‰ΩúËøÅÁßªÂà∞ËÆæÁΩÆÈ°µ

// Ëá™Âä®ÂµåÂÖ•ËÆæÁΩÆ‰∏éÁä∂ÊÄÅ
// Â∑≤ÁßªÈô§ÔºöËá™Âä®ÂµåÂÖ•ËÆæÁΩÆÂ±ïÁ§∫‰∏éÂºÄÂÖ≥

// Vectorize Ëá™Âä®ÂêåÊ≠•ËÆæÁΩÆ‰∏éÁä∂ÊÄÅ
// Â∑≤ÁßªÈô§ÔºöVectorize Ëá™Âä®ÂêåÊ≠•ËÆæÁΩÆÂ±ïÁ§∫‰∏éÂºÄÂÖ≥

// Á´ãÂç≥ Vectorize ÂêåÊ≠•
// Â∑≤ÁßªÈô§ÔºöVectorize ÂêåÊ≠•‰∏é‰∏ÄÈîÆÁîüÊàê+ÂêåÊ≠•ÔºõËØ∑ÂâçÂæÄËÆæÁΩÆÈ°µ

// ÊúÄËøë‰∏ÄÊ¨°ÊâãÂä® Vectorize ÁªüËÆ°ÔºàÁî± SW ÂÜôÂÖ• settingsÔºâ
// Â∑≤ÁßªÈô§ÔºöÊâãÂä® Vectorize ÁªüËÆ°Â±ïÁ§∫

// Ë¶ÜÁõñÁéáÁªüËÆ°ÔºàÂæÖÂµåÂÖ•Êï∞ÈáèÔºâ
// Â∑≤ÁßªÈô§ÔºöË¶ÜÁõñÁéáÁªüËÆ°Â±ïÁ§∫

// Ëá™Âä®‰ªªÂä°ÂèÇÊï∞ËÆæÁΩÆ
// Â∑≤ÁßªÈô§ÔºöËá™Âä®‰ªªÂä°ÂèÇÊï∞ÂÜÖËÅîË°®Âçï

// Ê†áÈ¢òÂå∫Êñ∞Â¢ûÔºöÂà†Èô§ÊâÄÈÄâÔºàÊâπÈáèÊöÇÂ≠òÂà†Èô§Ôºâ
const openConfirmBulkDelete = () => {
  if (!rightSelectedIds.value.length) return
  isConfirmBulkDeleteDialogOpen.value = true
}

const confirmBulkDeleteSelected = () => {
  const ids = rightSelectedIds.value.filter(Boolean)
  if (!ids.length) {
    isConfirmBulkDeleteDialogOpen.value = false
    return
  }
  bulkDeleteByIds(ids)
  isConfirmBulkDeleteDialogOpen.value = false
  // Ê∏ÖÁ©∫ÈÄâÊã©ÔºåÈÅøÂÖçÂÜçÊ¨°ËØØÂà†
  try {
    rightTreeRef.value?.clearSelection?.()
  } catch {}
}

// Â±ÄÈÉ®ËΩªÈáèÊï∞Â≠óÂä®ÁîªÔºà‰∏é Popup Âêå‰∏ÄÂÆûÁé∞ÊÄùË∑ØÔºâ
const AnimatedNumber = {
  name: 'AnimatedNumber',
  props: {
    value: { type: Number, required: true },
    duration: { type: Number, default: 500 }
  },
  setup(props: { value: number; duration: number }) {
    const display = ref(0)
    let startVal = 0
    let start = 0
    let raf: number | null = null
    const animate = (to: number) => {
      if (raf !== null) window.cancelAnimationFrame(raf)
      startVal = display.value
      start = performance.now()
      const delta = to - startVal
      const tick = () => {
        const p = Math.min(1, (performance.now() - start) / props.duration)
        const eased = 1 - Math.pow(1 - p, 3)
        display.value = Math.round(startVal + delta * eased)
        if (p < 1) raf = window.requestAnimationFrame(tick)
      }
      raf = window.requestAnimationFrame(tick)
    }
    onMounted(() => animate(props.value))
    watch(
      () => props.value,
      (nv: number) => animate(nv)
    )
    return () => h('span', display.value.toString())
  }
} as Record<string, unknown>

const handleApply = async () => {
  try {
    await bookmarkManagementStore.applyStagedChanges()
    notificationService.notify('Â∑≤Â∫îÁî®Êõ¥Êîπ', { level: 'success' })
  } catch (e) {
    console.error('handleApply failed:', e)
    notificationService.notify('Â∫îÁî®Â§±Ë¥•', { level: 'error' })
  }
}

// =============================
// Â∑≤ÁßªÈô§ÔºöÊâπÈáèÊï∞ÊçÆÁîüÊàê/Âà†Èô§ÊµãËØï‰ª£Á†Å
// =============================
</script>

<style scoped>
/* ÂÅ•Â∫∑Êâ´ÊèèËøõÂ∫¶ÂØπËØùÊ°ÜÊ†∑Âºè */
.health-scan-progress {
  padding: var(--spacing-4);
}

.progress-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--spacing-3);
}

.progress-message {
  font-size: var(--font-size-body-medium);
  color: var(--color-text-primary);
}

.progress-stats {
  font-size: var(--font-size-body-small);
  color: var(--color-text-secondary);
  font-family: var(--font-family-mono);
}
</style>
<style scoped>
.ai-status-right {
  margin-left: var(--spacing-3);
}
</style>
<style scoped>
.mt-sm {
  margin-top: var(--spacing-2);
}
.expand-toggle-icon {
  display: inline-flex;
  transition:
    transform var(--md-sys-motion-duration-short4)
      var(--md-sys-motion-easing-standard),
    opacity var(--md-sys-motion-duration-short4)
      var(--md-sys-motion-easing-standard);
}

.expand-toggle-icon.expanded {
  transform: rotate(180deg);
}

.expand-toggle-icon.expanding {
  opacity: 0.85;
}
</style>

<style scoped>
.quick-tags-popover {
  position: absolute;
  /* ÈîöÂÆöÂú®Âè≥‰æßÈù¢Êùø header ÁöÑÂè≥‰∏äËßí */
  top: 51px;
  right: var(--spacing-sm);
  z-index: 40; /* ‰øùËØÅÊµÆÂ±ÇÂú®‰∏äÂ±Ç */
  background: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  padding: var(--spacing-1-5) var(--spacing-sm);
  box-shadow: var(--shadow-lg, 0 6px 20px rgba(0, 0, 0, 0.16));
}
.tag-quick-fade-enter-active,
.tag-quick-fade-leave-active {
  transition:
    opacity var(--md-sys-motion-duration-short3)
      var(--md-sys-motion-easing-standard),
    transform var(--md-sys-motion-duration-short3)
      var(--md-sys-motion-easing-standard);
}
.tag-quick-fade-enter-from,
.tag-quick-fade-leave-to {
  opacity: 0;
  transform: translateY(calc(-1 * var(--spacing-1)));
}

.bulk-delete-in-panel {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: var(--spacing-3);
  background: var(--color-error-subtle);
}
/* ÈÄâÊã©ÁªüËÆ°ÔºöÈÅøÂÖçÊï∞Â≠óÂèòÂåñÂØºËá¥ÊñáÊú¨Êï¥‰Ωì"ÊäñÂä®" */
.selection-summary {
  font-weight: 600;
  display: inline-flex;
  align-items: baseline; /* ËÆ©Êï∞Â≠ó‰∏éÊ±âÂ≠óÂü∫Á∫øÂØπÈΩêÔºåÈÅøÂÖç‰∏ä‰∏ãË∑≥Âä® */
  /* Ê∂àÈô§Ê®°ÊùøÁ©∫ÁôΩÂ∏¶Êù•ÁöÑÂ≠óÁ¨¶Èó¥Ë∑ù */
  font-size: 0;
}
.selection-summary .text {
  font-size: 1rem; /* ÊÅ¢Â§çÊ≠£Â∏∏Â≠óÂè∑ */
}
.selection-summary .count {
  /* ÁßªÈô§Â§ñËæπË∑ùÔºåÁî±ÊòæÂºè gap ÊéßÂà∂Á©∫Èöô */
  margin: 0;
  font-weight: 800;
  font-size: 1rem; /* ÊÅ¢Â§çÊ≠£Â∏∏Â≠óÂè∑ */
  /* ‰ΩøÁî®Á≠âÂÆΩÊï∞Â≠óÂíåÂõ∫ÂÆöÂÆΩÂ∫¶ÈÅøÂÖçÊ®™Âêë‰ΩçÁßª */
  font-variant-numeric: tabular-nums;
  -webkit-font-smoothing: antialiased;
  /* Ëá≥Â∞ë‰∏§‰ΩçÂÆΩÂ∫¶ÔºàÊåâÂ≠óÁ¨¶Âçï‰ΩçÔºâÔºåÂè≥ÂØπÈΩê‰ª•‰øùÊåÅÊñáÊ°àÁ®≥ÂÆö */
  min-width: 3ch;
  text-align: center;
  display: inline-block;
}
.selection-summary .gap {
  display: inline-block;
  width: var(--spacing-2-5);
  height: 1em;
}
.bulk-delete-btn {
  background: var(--color-error);
  color: var(--color-text-on-primary);
  border: 1px solid var(--color-error);
}
.bulk-actions {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}
.clear-selection {
  color: var(--color-text-secondary);
}
.app-container {
  height: 100vh;
  width: 100vw;
  display: flex;
  flex-direction: column;
}
/* ‰ΩøÁî® Overlay ÁªÑ‰ª∂Ëá™Ë∫´ÁöÑÂÖ®Â±èËíôÁâàÔºåÂ∑≤ÈÄöËøá props Áªü‰∏ÄÈÄèÊòéÂ∫¶‰∏éÊ®°Á≥ä */

.loading-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--spacing-6);
}

.loading-text {
  font-size: 1.2rem;
  font-weight: 500;
}

.loading-subtitle {
  font-size: 0.9rem;
  color: var(--color-text-secondary);
}

.main-content {
  flex: none;
  height: calc(100vh - var(--spacing-16));
  overflow: hidden;
}

.management-container {
  height: 100%;
}

.panel-col {
  height: 100%;
  display: flex;
  flex-direction: column;
  /* ÂÖÅËÆ∏Â≠êÈ°πÂú® Flex Â∏ÉÂ±Ä‰∏≠Êî∂Áº©Ôºå‰ªéËÄå‰ΩøÂÜÖÈÉ®‰∫ßÁîüÊªöÂä® */
  min-height: 0;
}

.panel-card {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  /* ÂÖÅËÆ∏ÂÜÖÂÆπÂå∫ÂüüËÆ°ÁÆóÈ´òÂ∫¶Âπ∂ÊªöÂä® */
  min-height: 0;
  transition: background-color var(--md-sys-motion-duration-short2)
    var(--md-sys-motion-easing-standard);
}

/* Â∑¶‰æßÈù¢ÊùøÔºöÂ¢ûÂä†ËßÜËßâÊùÉÈáçÔºå‰ΩøÁî®Êõ¥Ê∑±ÁöÑËÉåÊôØ */
.panel-col:first-child .panel-card {
  flex: 1.2;
  background: var(--color-bg-primary);
}

/* Âè≥‰æßÂç°ÁâáÔºöÂº±ÂåñËÉåÊôØÔºåÁ™ÅÂá∫ÂÜÖÂÆπ */
.right-panel-card {
  overflow: hidden;
  flex: 1;
  background: var(--color-bg-secondary);
}

.panel-header {
  width: 100%;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: var(--spacing-4);
  position: relative; /* ‰Ωú‰∏∫ÊµÆÂ±ÇÂÆö‰ΩçÂèÇÁÖß */
  overflow: visible; /* ÊîæË°åÊµÆÂ±Ç */
  flex-wrap: nowrap; /* Èò≤Ê≠¢ÊåâÈíÆÊç¢Ë°å */
}

.panel-title-section {
  display: flex;
  align-items: center;
  gap: var(--spacing-3);
}

/* Ê†áÈ¢òÂå∫ÂüüÔºöÂèØ‰ª•ÁÅµÊ¥ªÁº©Â∞è */
.panel-title-section:first-child {
  flex: 1 1 auto;
  min-width: 0; /* ÂÖÅËÆ∏ÊñáÂ≠óÁº©Áï• */
}

/* ÊåâÈíÆÂå∫ÂüüÔºö‰øùÊåÅÂõ∫ÂÆöÂÆΩÂ∫¶ */
.panel-title-section:last-child {
  flex: 0 0 auto;
}

.panel-actions {
  display: flex;
  align-items: center;
  gap: var(--spacing-2);
  flex-wrap: nowrap;
}

.panel-title {
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.panel-stats {
  font-size: 0.8rem;
  color: var(--color-text-secondary);
}

.stats-separator {
  margin: 0 var(--spacing-1);
}

.stats-change {
  margin-left: var(--spacing-sm);
  font-weight: 500;
}

.stats-increase {
  color: var(--color-success);
}

.stats-decrease {
  color: var(--color-error);
}

.panel-content {
  flex: 1;
  min-height: 0; /* ÂÖÅËÆ∏ÂÜÖÈÉ®Â≠êÂÖÉÁ¥†ËÆ°ÁÆóÈ´òÂ∫¶ÔºåÈÅøÂÖçË∂ÖÂá∫Êó†Ê≥ïÊªöÂä® */
  display: flex;
  flex-direction: column;
  /* ‰ΩøÂ∑¶Âè≥Èù¢ÊùøÂÜÖÂÆπÂèØÊªöÂä®ÔºàÂåÖÂê´ legend ÂíåÊ†ëÔºâ */
  overflow-y: auto;
}

/* ‰∏≠Èó¥ÂàÜÈöîÂå∫Ê†∑Âºè */
.divider-col {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
}

.panel-divider {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  opacity: 0.3;
  transition: opacity var(--md-sys-motion-duration-short2)
    var(--md-sys-motion-easing-standard);
}

.panel-divider:hover {
  opacity: 0.6;
}

/* Âè≥‰æßÈù¢ÊùøÊìç‰ΩúÂå∫ÁöÑÂàÜÈöîÁ¨¶ */
.panel-actions-divider {
  width: 1px;
  height: 20px;
  background: var(--color-border);
  opacity: 0.5;
}

/* ‰ºòÂåñ"Â∫îÁî®"ÊåâÈíÆÊ†∑Âºè */
.panel-actions .btn:first-child {
  padding-left: var(--spacing-3);
  padding-right: var(--spacing-3);
}

.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: var(--color-text-secondary);
  gap: var(--spacing-4);
}

.edit-form,
.add-item-form {
  padding: var(--spacing-4);
  display: flex;
  flex-direction: column;
  gap: var(--spacing-4);
}

.form-fields {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-4);
}

/* ËØ≠‰πâÊêúÁ¥¢Ê†∑Âºè */
.semantic-search-panel {
  padding: var(--spacing-sm) var(--spacing-3);
  border-bottom: 1px solid var(--color-border);
}

.semantic-controls {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  flex-wrap: wrap;
}

.semantic-input {
  flex: 1;
  min-width: 160px;
}

.semantic-topk {
  width: 120px;
}

.semantic-minsim {
  width: 140px;
}

.semantic-loading {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding: var(--spacing-1-5) 0;
}

.semantic-loading-text {
  font-size: 0.85rem;
  color: var(--color-text-secondary);
}

.semantic-results {
  padding: var(--spacing-sm) 0;
  display: grid;
  grid-template-columns: 1fr;
  gap: var(--spacing-1-5);
}

.semantic-item {
  padding: var(--spacing-sm);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-sm);
  cursor: pointer;
}

.semantic-item:hover {
  background: var(--color-surface-hover);
}

.semantic-title {
  font-weight: 500;
}

.semantic-url {
  font-size: 0.85rem;
  color: var(--color-text-secondary);
}

.semantic-score {
  font-size: 0.8rem;
  color: var(--color-text-secondary);
}

/* Â±ÄÈÉ®ÔºöÂ∫ïÈÉ®ÊâπÈáèÊìç‰ΩúÊù°ÂÖ•Âú∫/Âá∫Âú∫Âä®ÁîªÔºàÂá∫Áé∞ÔºöËá™‰∏ãËÄå‰∏äÔºõÊ∂àÂ§±ÔºöÂêë‰∏ãÔºâ*/
.card-footer-slide-enter-active,
.card-footer-slide-leave-active {
  transition:
    transform var(--md-sys-motion-duration-short4)
      var(--md-sys-motion-easing-standard),
    opacity var(--md-sys-motion-duration-short4)
      var(--md-sys-motion-easing-standard);
  will-change: transform, opacity;
}
.card-footer-slide-enter-from {
  transform: translateY(var(--spacing-4));
  opacity: 0;
}
.card-footer-slide-leave-to {
  transform: translateY(var(--spacing-4));
  opacity: 0;
}

.control-btn--icon {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  padding: 0;
}

.control-btn--icon .btn__icon {
  margin: 0;
}
</style>
