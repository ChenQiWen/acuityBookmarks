# ===============================================
# ğŸ”§ AcuityBookmarks åŸºç¡€CI/CDç®¡é“
# ===============================================
# 
# ğŸ¯ ç”¨é€”ï¼šåŸºç¡€çš„æŒç»­é›†æˆå’Œéƒ¨ç½²æµç¨‹
# ğŸ“‹ åŠŸèƒ½ï¼š
#   - ä»£ç è´¨é‡æ£€æŸ¥ (æµ‹è¯• + æ„å»º)
#   - è‡ªåŠ¨åŒ–éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
# 
# âš ï¸ çŠ¶æ€ï¼šåŸºç¡€ç‰ˆæœ¬ (å·²è¢«å¢å¼ºç‰ˆæœ¬æ›¿ä»£)
# ğŸ’¡ å»ºè®®ï¼šä½¿ç”¨ dual-deployment-ci.yml è·å¾—æ›´å®Œæ•´çš„åŠŸèƒ½
# ===============================================

name: CI/CD Pipeline (Basic Version)

# ğŸš€ è§¦å‘æ¡ä»¶ï¼šä»£ç æ¨é€å’Œæ‹‰å–è¯·æ±‚
on:
  push:
    branches: [ main, bun ]  # æ¨é€åˆ°mainæˆ–bunåˆ†æ”¯æ—¶è§¦å‘
  pull_request:
    branches: [ main, bun ]  # åˆ›å»ºPRåˆ°mainæˆ–bunåˆ†æ”¯æ—¶è§¦å‘

jobs:
  # ===============================
  # ğŸ§ª æµ‹è¯•å’Œæ„å»ºä»»åŠ¡
  # ===============================
  test:
    name: ğŸ§ª Test & Build (Frontend + Backend)
    runs-on: ubuntu-latest  # ä½¿ç”¨Ubuntuæœ€æ–°ç‰ˆæœ¬è¿è¡Œå™¨

    # ğŸ“Š æ„å»ºçŸ©é˜µï¼šæ”¯æŒå¤šä¸ªNode.jsç‰ˆæœ¬
    strategy:
      matrix:
        node-version: [20.x]  # ç›®å‰åªæµ‹è¯•Node.js 20.xç‰ˆæœ¬

    steps:
    # ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4  # ä½¿ç”¨GitHub Actions v4æ£€å‡ºä»£ç 

    # ğŸ”§ è®¾ç½®Bunè¿è¡Œæ—¶ç¯å¢ƒ
    - name: ğŸ”§ Setup Bun Runtime
      uses: oven-sh/setup-bun@v1  # ä½¿ç”¨å®˜æ–¹Bunå®‰è£…Action
      with:
        bun-version: latest  # å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„Bun

    # ğŸŸ¢ è®¾ç½®Node.jsç¯å¢ƒï¼ˆå¤‡ç”¨å…¼å®¹æ€§ï¼‰
    - name: ğŸŸ¢ Setup Node.js Environment
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}  # ä½¿ç”¨çŸ©é˜µä¸­å®šä¹‰çš„Node.jsç‰ˆæœ¬
        cache: 'npm'  # å¯ç”¨npmç¼“å­˜ä»¥åŠ é€Ÿå®‰è£…

    # ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–
    - name: ğŸ“¦ Install Frontend Dependencies
      run: |
        echo "ğŸ“¦ Installing frontend dependencies with Bun..."
        cd frontend
        bun install  # ä½¿ç”¨Bunå®‰è£…å‰ç«¯ä¾èµ–

    # ğŸ“¦ å®‰è£…åç«¯ä¾èµ–
    - name: ğŸ“¦ Install Backend Dependencies
      run: |
        echo "ğŸ“¦ Installing backend dependencies with Bun..."
        cd backend
        bun install  # ä½¿ç”¨Bunå®‰è£…åç«¯ä¾èµ–

    # ğŸ§ª è¿è¡Œå‰ç«¯æµ‹è¯•
    - name: ğŸ§ª Run Frontend Tests
      run: |
        echo "ğŸ§ª Running frontend test suite..."
        cd frontend
        # âš ï¸ æ³¨æ„ï¼šæ­¤æµ‹è¯•è„šæœ¬å¯èƒ½ä¸å­˜åœ¨ï¼Œéœ€è¦éªŒè¯package.json
        bun run test:run

    # ğŸ§ª è¿è¡Œåç«¯æµ‹è¯•
    - name: ğŸ§ª Run Backend Tests
      run: |
        echo "ğŸ§ª Running backend test suite..."
        cd backend
        # âš ï¸ æ³¨æ„ï¼šæ­¤æµ‹è¯•è„šæœ¬å¯èƒ½ä¸å­˜åœ¨ï¼Œéœ€è¦éªŒè¯package.json
        bun run test:run

    # ğŸ”¨ æ„å»ºå‰ç«¯é¡¹ç›®
    - name: ğŸ”¨ Build Frontend Project
      run: |
        echo "ğŸ”¨ Building frontend for production..."
        cd frontend
        bun run build  # æ„å»ºVue.js Chromeæ‰©å±•

    # ğŸ”¨ æ„å»ºåç«¯é¡¹ç›®
    - name: ğŸ”¨ Build Backend Project
      run: |
        echo "ğŸ”¨ Building backend for production..."
        cd backend
        bun run build  # æ„å»ºåç«¯APIæœåŠ¡

  # ===============================
  # ğŸš€ éƒ¨ç½²ä»»åŠ¡ (ä»…é™mainåˆ†æ”¯)
  # ===============================
  deploy:
    name: ğŸš€ Deploy to Production
    needs: test  # ä¾èµ–äºtestä»»åŠ¡æˆåŠŸå®Œæˆ
    runs-on: ubuntu-latest
    # ğŸ¯ éƒ¨ç½²æ¡ä»¶ï¼šåªæœ‰æ¨é€åˆ°mainåˆ†æ”¯ä¸”ä¸æ˜¯PRæ—¶æ‰éƒ¨ç½²
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    # ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    # ğŸ”§ è®¾ç½®Bunè¿è¡Œæ—¶ç¯å¢ƒ
    - name: ğŸ”§ Setup Bun Runtime
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    # ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–
    - name: ğŸ“¦ Install Project Dependencies
      run: |
        echo "ğŸ“¦ Installing all dependencies for deployment..."
        cd frontend && bun install
        cd ../backend && bun install

    # ğŸ”¨ ç”Ÿäº§ç¯å¢ƒæ„å»º
    - name: ğŸ”¨ Build for Production Environment
      run: |
        echo "ğŸ”¨ Building both frontend and backend for production..."
        cd frontend && bun run build  # æ„å»ºChromeæ‰©å±•
        cd ../backend && bun run build  # æ„å»ºServerless API

    # ğŸš€ éƒ¨ç½²åˆ°Vercel
    - name: ğŸš€ Deploy to Vercel Platform
      run: |
        echo "ğŸš€ Preparing for Vercel deployment..."
        # âš ï¸ æ³¨æ„ï¼šè¿™é‡Œåªæ˜¯å ä½ç¬¦ï¼Œå®é™…éƒ¨ç½²éœ€è¦é…ç½®Vercel CLI
        # å»ºè®®ï¼š
        # 1. å®‰è£…Vercel CLI: npm i -g vercel
        # 2. é…ç½®Vercel Tokenä½œä¸ºGitHub Secret
        # 3. æ‰§è¡Œ: vercel --prod --token ${{ secrets.VERCEL_TOKEN }}
        echo "âœ… Ready for Vercel deployment (manual configuration required)"
        
        # ğŸ“‹ éƒ¨ç½²æ¸…å•ï¼š
        echo "ğŸ“‹ Deployment checklist:"
        echo "   - Chrome Extension: frontend/dist â†’ Chrome Web Store"
        echo "   - Backend API: backend â†’ Vercel Serverless Functions"
