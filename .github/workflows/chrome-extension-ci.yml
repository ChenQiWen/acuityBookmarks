# ===============================================
# ğŸ”— AcuityBookmarks Chromeæ‰©å±•ä¸“ç”¨CI/CDç®¡é“
# ===============================================
# 
# ğŸ¯ ä¸“é—¨è®¾è®¡ç›®æ ‡ï¼š
#   ä¸“ä¸ºChromeæ‰©å±•é¡¹ç›®ä¼˜åŒ–çš„CI/CDæµç¨‹
#   ä¸»è¦å…³æ³¨å‰ç«¯æ„å»ºã€æ‰©å±•éªŒè¯å’ŒChrome Web Storeå‘å¸ƒ
# 
# ğŸ“‹ æ ¸å¿ƒåŠŸèƒ½ï¼š
#   âœ… Vue 3 + TypeScript Chromeæ‰©å±•æ„å»º
#   âœ… Chromeæ‰©å±•ç»“æ„å’Œå¤§å°éªŒè¯
#   âœ… Manifest V3è§„èŒƒæ£€æŸ¥
#   âœ… è‡ªåŠ¨å‘å¸ƒåˆ°Chrome Web Store
#   âœ… åç«¯å¼€å‘æœåŠ¡å™¨æ”¯æŒ (å¯é€‰)
# 
# ğŸ”§ æŠ€æœ¯ç‰¹ç‚¹ï¼š
#   - é’ˆå¯¹Chromeæ‰©å±•ç”Ÿæ€ç³»ç»Ÿä¼˜åŒ–
#   - å®Œæ•´çš„æ‰©å±•åŒ…éªŒè¯æµç¨‹
#   - Chrome Web Store APIé›†æˆ
#   - å¼€å‘å’Œç”Ÿäº§ç¯å¢ƒåˆ†ç¦»
# 
# ğŸ’¡ é€‚ç”¨åœºæ™¯ï¼š
#   - çº¯Chromeæ‰©å±•é¡¹ç›®
#   - éœ€è¦Chrome Web Storeè‡ªåŠ¨å‘å¸ƒ
#   - æ³¨é‡æ‰©å±•è´¨é‡å’Œç”¨æˆ·ä½“éªŒ
# ===============================================

name: ğŸ”— Chrome Extension Specialized CI/CD

# ğŸš€ å·¥ä½œæµè§¦å‘äº‹ä»¶ï¼šä»£ç å˜æ›´æ—¶è‡ªåŠ¨æ‰§è¡Œ
on:
  push:
    branches: [main, develop]  # æ¨é€åˆ°ä¸»åˆ†æ”¯æˆ–å¼€å‘åˆ†æ”¯æ—¶è§¦å‘
  pull_request:
    branches: [main]  # åˆ›å»ºæŒ‡å‘mainåˆ†æ”¯çš„PRæ—¶è§¦å‘

# ğŸŒ å…¨å±€ç¯å¢ƒå˜é‡ï¼šæ•´ä¸ªå·¥ä½œæµä¸­çš„ç»Ÿä¸€é…ç½®
env:
  BUN_VERSION: "latest"    # BunåŒ…ç®¡ç†å™¨ç‰ˆæœ¬ (é«˜æ€§èƒ½JSè¿è¡Œæ—¶)
  NODE_VERSION: "20.x"     # Node.jsç‰ˆæœ¬ (å¤‡ç”¨å…¼å®¹æ€§æ”¯æŒ)

jobs:
  # ===============================
  # ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
  # ===============================
  quality-gate:
    name: ğŸ” Chrome Extension Quality Gate & Security Audit
    runs-on: ubuntu-latest  # ä½¿ç”¨GitHubæ‰˜ç®¡çš„Ubuntuè¿è¡Œå™¨
    
    steps:
      # ğŸ“¥ è·å–æºä»£ç ï¼šæ£€å‡ºå®Œæ•´çš„é¡¹ç›®ä»£ç åº“
      - name: ğŸ“¥ Checkout Project Repository
        uses: actions/checkout@v4  # ä½¿ç”¨GitHub Actionsæœ€æ–°ç‰ˆæœ¬
        
      # ğŸ”§ é…ç½®æ„å»ºç¯å¢ƒï¼šè®¾ç½®é«˜æ€§èƒ½çš„Bunè¿è¡Œæ—¶
      - name: ğŸ”§ Setup Bun Runtime Environment
        uses: oven-sh/setup-bun@v1  # å®˜æ–¹Bunå®‰è£…Action
        with:
          bun-version: ${{ env.BUN_VERSION }}  # ä½¿ç”¨å…¨å±€å®šä¹‰çš„ç‰ˆæœ¬
          
      # ğŸ“¦ å®‰è£…Chromeæ‰©å±•ä¾èµ–ï¼šVue 3 + TypeScriptç”Ÿæ€ç³»ç»Ÿ
      - name: ğŸ“¦ Install Chrome Extension Dependencies
        run: |
          echo "ğŸ“¦ Installing Chrome Extension build dependencies..."
          cd frontend
          # frozen-lockfile: ç¡®ä¿CIç¯å¢ƒä¸å¼€å‘ç¯å¢ƒä¾èµ–ç‰ˆæœ¬å®Œå…¨ä¸€è‡´
          # é¿å…å› ä¾èµ–ç‰ˆæœ¬å˜åŒ–å¯¼è‡´çš„æ„å»ºå·®å¼‚
          bun install --frozen-lockfile
          echo "âœ… Chrome Extension dependencies installed"
          
      # ğŸ“¦ å®‰è£…åç«¯å¼€å‘æ”¯æŒä¾èµ– (å¯é€‰)
      - name: ğŸ“¦ Install Backend Development Support (Optional)
        run: |
          echo "ğŸ“¦ Installing backend development support dependencies..."
          cd backend
          # åç«¯ä¸»è¦ç”¨äºæœ¬åœ°å¼€å‘æ—¶çš„AI LLMæµ‹è¯•å’Œæ•°æ®å¤„ç†
          # åœ¨CIä¸­ä¸»è¦ç”¨äºä»£ç è´¨é‡æ£€æŸ¥
          bun install --frozen-lockfile
          echo "âœ… Backend support dependencies installed"
          
      # ğŸ” å‰ç«¯å®‰å…¨æ¼æ´æ‰«æï¼šChromeæ‰©å±•ç‰¹æœ‰çš„å®‰å…¨æ£€æŸ¥
      - name: ğŸ” Chrome Extension Security Audit
        run: |
          echo "ğŸ” Running Chrome Extension security vulnerability scan..."
          cd frontend
          # moderateçº§åˆ«ï¼šæ£€æŸ¥ä¸­ç­‰åŠä»¥ä¸Šä¸¥é‡æ€§çš„å®‰å…¨æ¼æ´
          # ç‰¹åˆ«å…³æ³¨ï¼šDOMæ“ä½œã€å†…å®¹è„šæœ¬ã€è·¨ç«™è„šæœ¬ç­‰Chromeæ‰©å±•ç›¸å…³é£é™©
          bun audit --audit-level moderate
          echo "âœ… Chrome Extension security audit passed"
          
      # ğŸ” åç«¯å®‰å…¨å®¡è®¡ï¼šå¼€å‘æ”¯æŒæœåŠ¡çš„å®‰å…¨æ€§
      - name: ğŸ” Backend Development Support Security Audit
        run: |
          echo "ğŸ” Running backend development support security audit..."
          cd backend
          # æ£€æŸ¥AI LLMé›†æˆã€ç½‘ç»œè¯·æ±‚å¤„ç†ç­‰ç›¸å…³çš„å®‰å…¨é£é™©
          bun audit --audit-level moderate
          echo "âœ… Backend security audit completed"
          
      # ğŸ“ TypeScriptç±»å‹å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿Chromeæ‰©å±•ä»£ç çš„ç±»å‹æ­£ç¡®æ€§
      - name: ğŸ“ TypeScript Type Safety Validation
        run: |
          echo "ğŸ“ Running TypeScript type safety check for Chrome Extension..."
          cd frontend
          # Vue 3 + TypeScript + Chrome Extension APIsçš„ç±»å‹æ£€æŸ¥
          # ç¡®ä¿Chrome APIsè°ƒç”¨ã€ç»„ä»¶propsã€storeçŠ¶æ€ç­‰ç±»å‹æ­£ç¡®
          bun run type-check
          echo "âœ… TypeScript type safety validation passed"
          
      # ğŸ§¹ å‰ç«¯ä»£ç è´¨é‡æ£€æŸ¥ï¼šChromeæ‰©å±•æœ€ä½³å®è·µéªŒè¯
      - name: ğŸ§¹ Chrome Extension Code Quality Check
        run: |
          echo "ğŸ§¹ Running Chrome Extension code quality and best practices check..."
          cd frontend
          # ESLintè§„åˆ™åŒ…æ‹¬ï¼š
          # - Vue 3ç»„ä»¶ç¼–å†™è§„èŒƒ
          # - Chrome Extension APIä½¿ç”¨æœ€ä½³å®è·µ
          # - TypeScriptä»£ç é£æ ¼å’Œå®‰å…¨æ€§
          # - æ€§èƒ½ä¼˜åŒ–å»ºè®®
          bun run lint:check
          echo "âœ… Chrome Extension code quality check passed"
          
      # ğŸ§¹ åç«¯ä»£ç è´¨é‡æ£€æŸ¥ï¼šå¼€å‘æ”¯æŒæœåŠ¡çš„ä»£ç è§„èŒƒ
      - name: ğŸ§¹ Backend Development Support Code Quality  
        run: |
          echo "ğŸ§¹ Running backend code quality check for development support..."
          cd backend
          # æ£€æŸ¥Bun/Node.jsä»£ç è´¨é‡ï¼š
          # - AI LLMé›†æˆä»£ç è§„èŒƒ
          # - ç½‘ç»œè¯·æ±‚å¤„ç†æœ€ä½³å®è·µ
          # - é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
          # - APIè®¾è®¡å’Œå®‰å…¨æ€§
          bun run lint:check
          echo "âœ… Backend code quality check passed"

  # ===============================
  # ğŸ”¨ æ„å»ºéªŒè¯ä¸åˆ†æ
  # ===============================
  build-validation:
    name: ğŸ”¨ Build & Chrome Extension Validation
    runs-on: ubuntu-latest
    needs: quality-gate
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Bun Runtime
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
          
      - name: ğŸ“¦ Install Frontend Dependencies
        run: |
          cd frontend
          bun install --frozen-lockfile
          
      - name: ğŸ”¨ Build Chrome Extension (Production)
        run: |
          cd frontend
          echo "ğŸ”¨ Building Chrome Extension for production..."
          bun run build:prod
          
      - name: ğŸ“Š Bundle Size Analysis
        run: |
          echo "ğŸ“Š Analyzing bundle size..."
          cd dist
          
          # æ˜¾ç¤ºæ–‡ä»¶å¤§å°åˆ†å¸ƒ
          echo "ğŸ“¦ Extension files size distribution:"
          find . -type f -exec ls -lah {} \; | awk '{print $5 "\t" $9}' | sort -hr
          
          # è®¡ç®—æ€»å¤§å°
          TOTAL_SIZE_KB=$(du -sk . | cut -f1)
          TOTAL_SIZE_MB=$((TOTAL_SIZE_KB / 1024))
          
          echo "ğŸ“¦ Total extension size: ${TOTAL_SIZE_KB}KB (${TOTAL_SIZE_MB}MB)"
          
          # Chromeæ‰©å±•å¤§å°é™åˆ¶æ£€æŸ¥ (é€šå¸¸å»ºè®®<10MBï¼Œè­¦å‘Š>5MB)
          if [ $TOTAL_SIZE_KB -gt 10240 ]; then
            echo "âŒ Extension size exceeds 10MB limit!"
            exit 1
          elif [ $TOTAL_SIZE_KB -gt 5120 ]; then
            echo "âš ï¸ Extension size exceeds 5MB (recommended limit)"
          else
            echo "âœ… Extension size within recommended limits"
          fi
          
      - name: ğŸª Chrome Extension Structure Validation
        run: |
          cd dist
          echo "ğŸª Validating Chrome Extension structure..."
          
          # æ£€æŸ¥å¿…éœ€æ–‡ä»¶
          echo "ğŸ“‹ Checking required files..."
          required_files=("manifest.json" "background.js")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Missing required file: $file"
              exit 1
            else
              echo "âœ… Found: $file"
            fi
          done
          
          # æ£€æŸ¥HTMLé¡µé¢æ–‡ä»¶
          html_files=("popup.html" "management.html" "side-panel.html")
          for file in "${html_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… Found HTML page: $file"
            else
              echo "âš ï¸ Optional HTML page missing: $file"
            fi
          done
          
          # éªŒè¯manifest.jsonæ ¼å¼å’Œå†…å®¹
          echo "ğŸ“ Validating manifest.json..."
          if command -v jq > /dev/null; then
            # JSONæ ¼å¼æ£€æŸ¥
            if ! jq empty manifest.json; then
              echo "âŒ Invalid manifest.json format"
              exit 1
            fi
            
            # æ£€æŸ¥å…³é”®å­—æ®µ
            VERSION=$(jq -r '.version' manifest.json)
            NAME=$(jq -r '.name' manifest.json)
            MANIFEST_VERSION=$(jq -r '.manifest_version' manifest.json)
            
            echo "ğŸ“‹ Extension Info:"
            echo "  - Name: $NAME"
            echo "  - Version: $VERSION" 
            echo "  - Manifest Version: $MANIFEST_VERSION"
            
            # æ£€æŸ¥manifestç‰ˆæœ¬
            if [ "$MANIFEST_VERSION" != "3" ]; then
              echo "âš ï¸ Manifest v3 recommended for new extensions"
            fi
            
            echo "âœ… manifest.json structure is valid"
          else
            echo "âš ï¸ jq not available, skipping detailed manifest validation"
          fi
          
          # æ£€æŸ¥å›¾æ ‡æ–‡ä»¶
          echo "ğŸ–¼ï¸ Checking icon files..."
          if [ -d "images" ]; then
            icon_files=$(find images -name "icon*.png" | wc -l)
            echo "âœ… Found $icon_files icon files"
          else
            echo "âš ï¸ Icons directory not found"
          fi
          
      - name: ğŸ§ª Extension Load Test (Manifest Validation)
        run: |
          echo "ğŸ§ª Testing extension manifest validity..."
          cd dist
          
          # æ¨¡æ‹ŸChromeæ‰©å±•åŠ è½½éªŒè¯
          if [ -f "manifest.json" ]; then
            # æ£€æŸ¥manifestä¸­çš„æ–‡ä»¶å¼•ç”¨æ˜¯å¦éƒ½å­˜åœ¨
            echo "ğŸ” Checking file references in manifest..."
            
            # æå–å¹¶æ£€æŸ¥background script
            if command -v jq > /dev/null; then
              BACKGROUND_SCRIPT=$(jq -r '.background.service_worker // .background.scripts[0] // empty' manifest.json)
              if [ ! -z "$BACKGROUND_SCRIPT" ] && [ "$BACKGROUND_SCRIPT" != "null" ]; then
                if [ -f "$BACKGROUND_SCRIPT" ]; then
                  echo "âœ… Background script found: $BACKGROUND_SCRIPT"
                else
                  echo "âŒ Background script missing: $BACKGROUND_SCRIPT"
                  exit 1
                fi
              fi
            fi
            
            echo "âœ… Extension structure validation passed"
          fi
          
      - name: ğŸ“¤ Upload Extension Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: chrome-extension-build-${{ github.sha }}
          path: dist/
          retention-days: 30

  # ===============================
  # âš¡ æ€§èƒ½ä¸è´¨é‡æµ‹è¯•
  # ===============================
  performance-check:
    name: âš¡ Performance & Quality Check
    runs-on: ubuntu-latest
    needs: build-validation
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Bun Runtime
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
          
      - name: ğŸ“¦ Install Dependencies
        run: |
          cd frontend && bun install --frozen-lockfile
          cd ../backend && bun install --frozen-lockfile
          
      - name: ğŸš€ Backend Development Server Test
        run: |
          echo "ğŸš€ Testing backend development server..."
          cd backend
          
          # å¯åŠ¨åç«¯æœåŠ¡å™¨ï¼ˆç”¨äºå¼€å‘è¾…åŠ©ï¼‰
          bun run start &
          SERVER_PID=$!
          
          # ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨
          sleep 3
          
          # å¥åº·æ£€æŸ¥
          if curl -f http://localhost:3000/health 2>/dev/null; then
            echo "âœ… Backend server is running correctly"
          else
            echo "âš ï¸ Backend server not responding (this is OK for extension-only mode)"
          fi
          
          # æ¸…ç†è¿›ç¨‹
          kill $SERVER_PID 2>/dev/null || true
          
      - name: ğŸ“Š Build Size Analysis Report
        run: |
          echo "ğŸ“Š Generating build analysis report..."
          cd frontend
          
          # ç”Ÿæˆæ„å»ºåˆ†æï¼ˆå¦‚æœæ”¯æŒï¼‰
          if grep -q "build:analyze" package.json; then
            echo "ğŸ” Running build analysis..."
            bun run build:analyze
          fi
          
          echo "âœ… Performance check completed"

  # ===============================
  # ğŸš€ è‡ªåŠ¨åŒ–éƒ¨ç½² (ä»…mainåˆ†æ”¯)
  # ===============================
  deploy:
    name: ğŸš€ Chrome Extension Deployment
    needs: [quality-gate, build-validation, performance-check]
    runs-on: ubuntu-latest
    # ä»…åœ¨æ¨é€åˆ°mainåˆ†æ”¯æ—¶éƒ¨ç½²
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Bun Runtime
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
          
      - name: ğŸ“¦ Install Dependencies
        run: |
          cd frontend
          bun install --frozen-lockfile
          
      - name: ğŸ”¨ Build for Chrome Web Store
        run: |
          cd frontend
          echo "ğŸ”¨ Building for Chrome Web Store release..."
          NODE_ENV=production bun run build:prod
          
      - name: ğŸ“¦ Create Extension Package
        run: |
          echo "ğŸ“¦ Creating extension package..."
          cd dist
          
          # åˆ›å»ºæ—¶é—´æˆ³ç‰ˆæœ¬çš„zipåŒ…
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          ZIP_NAME="acuity-bookmarks-v${GITHUB_RUN_NUMBER}-${TIMESTAMP}.zip"
          
          # æ‰“åŒ…æ‰©å±•
          zip -r "../${ZIP_NAME}" . -x "*.DS_Store" "*.gitkeep"
          
          echo "âœ… Extension package created: $ZIP_NAME"
          echo "ZIP_FILE=${ZIP_NAME}" >> $GITHUB_ENV
          
      - name: ğŸª Deploy to Chrome Web Store
        # ä»…åœ¨é…ç½®äº†Chrome Web Storeå¯†é’¥æ—¶è¿è¡Œ
        if: ${{ secrets.CHROME_CLIENT_ID && secrets.CHROME_CLIENT_SECRET }}
        uses: mobilefirstllc/cws-publish@latest
        with:
          action: 'publish'
          client_id: ${{ secrets.CHROME_CLIENT_ID }}
          client_secret: ${{ secrets.CHROME_CLIENT_SECRET }}
          refresh_token: ${{ secrets.CHROME_REFRESH_TOKEN }}
          extension_id: ${{ secrets.CHROME_EXTENSION_ID }}
          zip_file: './${{ env.ZIP_FILE }}'
          
      - name: ğŸ“ Create GitHub Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          name: ğŸš€ AcuityBookmarks v${{ github.run_number }}
          body: |
            ## ğŸš€ AcuityBookmarks Chrome Extension Release
            
            ### ğŸ“¦ Release Information
            - **Version**: v${{ github.run_number }}
            - **Commit**: ${{ github.sha }}
            - **Build Date**: ${{ github.event.head_commit.timestamp }}
            - **Author**: ${{ github.event.head_commit.author.name }}
            
            ### ğŸ”§ Technical Details
            - **Framework**: Vue 3 + TypeScript + IndexedDB
            - **Build Tool**: Vite + Bun
            - **Architecture**: Chrome Extension Manifest V3
            
            ### ğŸ“‹ Recent Changes
            ${{ github.event.head_commit.message }}
            
            ### ğŸš€ Installation
            1. Download the `acuity-bookmarks-*.zip` file
            2. Extract to a local directory
            3. Open Chrome Extensions (`chrome://extensions/`)
            4. Enable "Developer mode"
            5. Click "Load unpacked" and select the extracted folder
            
          files: ${{ env.ZIP_FILE }}
          draft: false
          prerelease: false

  # ===============================
  # ğŸ“¢ çŠ¶æ€é€šçŸ¥
  # ===============================
  notification:
    name: ğŸ“¢ Build Status Notification
    needs: [quality-gate, build-validation, performance-check, deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“Š Build Summary
        run: |
          echo "ğŸ“Š Build Summary for commit ${{ github.sha }}"
          echo "================================="
          
          echo "ğŸ” Quality Gate: ${{ needs.quality-gate.result }}"
          echo "ğŸ”¨ Build Validation: ${{ needs.build-validation.result }}"
          echo "âš¡ Performance Check: ${{ needs.performance-check.result }}"
          
          if [ "${{ needs.deploy.result }}" != "skipped" ]; then
            echo "ğŸš€ Deployment: ${{ needs.deploy.result }}"
          else
            echo "ğŸš€ Deployment: Skipped (not main branch)"
          fi
          
          # æ€»ä½“çŠ¶æ€åˆ¤æ–­
          if [ "${{ needs.quality-gate.result }}" == "success" ] && \
             [ "${{ needs.build-validation.result }}" == "success" ] && \
             [ "${{ needs.performance-check.result }}" == "success" ]; then
            echo "âœ… Overall Status: SUCCESS"
            echo "ğŸ‰ Chrome Extension is ready for use!"
          else
            echo "âŒ Overall Status: FAILED"
            echo "ğŸ”§ Please check the failed steps above"
            exit 1
          fi
