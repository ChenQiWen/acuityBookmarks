# ===================================================================
# ğŸš€ Enhanced CIé…ç½®æ–‡ä»¶çš„è¯¦ç»†æ³¨é‡Šè¯´æ˜å’Œé—®é¢˜åˆ†æ
# ===================================================================
#
# ğŸ“‹ åŸå§‹æ–‡ä»¶ç›®çš„ï¼šåŠŸèƒ½å®Œæ•´çš„CI/CDç®¡é“ï¼ŒåŒ…å«ä»£ç è´¨é‡ã€å¤šç»´æµ‹è¯•ã€æ€§èƒ½åˆ†æç­‰
#
# âŒ å‘ç°çš„ä¸»è¦é—®é¢˜ï¼š
# 1. å¤§é‡æµ‹è¯•è„šæœ¬ä¸å­˜åœ¨ï¼ˆtest:unit, test:integration, test:apiç­‰ï¼‰
# 2. æ„å»ºå‘½ä»¤é”™è¯¯ï¼ˆbuild:prodä¸å­˜åœ¨ï¼‰
# 3. åç«¯æœåŠ¡å™¨é€»è¾‘ä¸ç¬¦åˆChromeæ‰©å±•é¡¹ç›®ç‰¹æ€§
# 4. Chrome Web Storeéƒ¨ç½²é…ç½®è¿‡äºå¤æ‚ä¸”å¯èƒ½æœ‰é—®é¢˜
# 5. æ€§èƒ½æµ‹è¯•å‡è®¾äº†HTTPæœåŠ¡å™¨å­˜åœ¨

name: Enhanced CI/CD Pipeline (éœ€è¦å¤§å¹…æ›´æ–°)

on:
  push:
    branches: [main, develop]  # âœ… åˆ†æ”¯é…ç½®åˆç†
  pull_request:
    branches: [main]  # âœ… PRé…ç½®åˆç†

env:
  BUN_VERSION: "latest"  # âœ… ç¯å¢ƒå˜é‡ä½¿ç”¨åˆç†
  NODE_VERSION: "20.x"

jobs:
  # âœ… ä»£ç è´¨é‡æ£€æŸ¥æ•´ä½“æ€è·¯æ­£ç¡®ï¼Œä½†æœ‰å°é—®é¢˜
  quality-gate:
    name: ğŸ” Quality Gate
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4  # âœ… ç‰ˆæœ¬æ­£ç¡®
        
      - name: ğŸ”§ Setup Bun
        uses: oven-sh/setup-bun@v1  # âœ… Bunè®¾ç½®æ­£ç¡®
        with:
          bun-version: ${{ env.BUN_VERSION }}
          
      - name: ğŸ“¦ Install Frontend Dependencies
        run: |
          cd frontend
          bun install --frozen-lockfile  # âœ… ä½¿ç”¨frozen-lockfileå¾ˆå¥½
          
      - name: ğŸ“¦ Install Backend Dependencies
        run: |
          cd backend
          bun install --frozen-lockfile
          
      # âœ… å®‰å…¨å®¡è®¡å¾ˆå¥½
      - name: ğŸ” Security Audit
        run: |
          echo "ğŸ” Running security audit..."
          cd frontend && bun audit --audit-level moderate
          cd ../backend && bun audit --audit-level moderate
          
      # âœ… TypeScriptæ£€æŸ¥å­˜åœ¨ä¸”æ­£ç¡®
      - name: ğŸ“ TypeScript Check
        run: |
          cd frontend
          bun run type-check  # âœ… è¿™ä¸ªè„šæœ¬å­˜åœ¨
          
      # âš ï¸ Lintæ£€æŸ¥è¢«æ³¨é‡Šæ‰ï¼Œä½†å®é™…ä¸Šlintè„šæœ¬å­˜åœ¨
      # - name: ğŸ§¹ Lint Check
      #   run: |
      #     cd frontend
      #     bun run lint

  # âŒ æµ‹è¯•çŸ©é˜µé—®é¢˜å¾ˆå¤§ï¼šæ‰€æœ‰æµ‹è¯•è„šæœ¬éƒ½ä¸å­˜åœ¨
  test-matrix:
    name: ğŸ§ª Test Suite (${{ matrix.test-type }})
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        test-type: [unit, integration, api]  # âŒ è¿™äº›æµ‹è¯•ç±»å‹çš„è„šæœ¬éƒ½ä¸å­˜åœ¨
        
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
          
      - name: ğŸ“¦ Install Dependencies
        run: |
          cd frontend && bun install --frozen-lockfile
          cd ../backend && bun install --frozen-lockfile
          
      # âŒ ä»¥ä¸‹æµ‹è¯•è„šæœ¬éƒ½ä¸å­˜åœ¨ï¼Œä¼šå¯¼è‡´CIå¤±è´¥
      - name: ğŸ§ª Run ${{ matrix.test-type }} Tests (Frontend)
        run: |
          cd frontend
          bun run test:${{ matrix.test-type }}  # âŒ test:unit, test:integration, test:apiéƒ½ä¸å­˜åœ¨
          
      - name: ğŸ§ª Run ${{ matrix.test-type }} Tests (Backend)
        run: |
          cd backend
          bun run test:${{ matrix.test-type }}  # âŒ åŒæ ·ä¸å­˜åœ¨
          
      # âš ï¸ ä»£ç è¦†ç›–ç‡ä¸Šä¼ æœ‰æ„ä¹‰ï¼Œä½†å‰ææ˜¯è¦æœ‰æµ‹è¯•
      - name: ğŸ“Š Upload Coverage Reports
        uses: codecov/codecov-action@v3
        with:
          files: ./frontend/coverage/lcov.info,./backend/coverage/lcov.info
          fail_ci_if_error: false
          name: coverage-${{ matrix.test-type }}

  # ğŸ”¨ æ„å»ºåˆ†æéƒ¨åˆ†æœ‰å¥½æƒ³æ³•ä½†æœ‰é”™è¯¯
  build-analysis:
    name: ğŸ”¨ Build & Bundle Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
          
      - name: ğŸ“¦ Install Dependencies
        run: |
          cd frontend && bun install --frozen-lockfile
          
      # âŒ æ„å»ºå‘½ä»¤é”™è¯¯
      - name: ğŸ”¨ Build Production
        run: |
          cd frontend
          bun run build:prod  # âŒ åº”è¯¥æ˜¯ build:prodï¼Œä½†package.jsonä¸­å­˜åœ¨
          
      # âœ… åŒ…å¤§å°åˆ†ææ€è·¯å¾ˆå¥½
      - name: ğŸ“Š Analyze Bundle Size
        run: |
          cd frontend
          echo "ğŸ“¦ Bundle size analysis:"
          du -sh ../dist/* | sort -hr
          
          # æ£€æŸ¥æ€»åŒ…å¤§å° (ç›®æ ‡: <1MB)
          TOTAL_SIZE=$(du -s ../dist | cut -f1)
          echo "Total bundle size: ${TOTAL_SIZE}KB"
          
          if [ $TOTAL_SIZE -gt 1024 ]; then
            echo "âš ï¸ Bundle size exceeds 1MB target"  # âš ï¸ 1MBå¯¹Chromeæ‰©å±•æ¥è¯´å¯èƒ½å¤ªå°
          else
            echo "âœ… Bundle size within target"
          fi
          
      # âœ… Chromeæ‰©å±•éªŒè¯æ€è·¯æ­£ç¡®ä½†å¯ä»¥æ›´å®Œå–„
      - name: ğŸª Validate Extension Package
        run: |
          cd dist
          
          # æ£€æŸ¥å¿…éœ€æ–‡ä»¶
          echo "ğŸ” Checking required files..."
          test -f manifest.json || { echo "âŒ manifest.json missing"; exit 1; }
          test -f background.js || { echo "âŒ background.js missing"; exit 1; }
          test -d assets || { echo "âŒ assets directory missing"; exit 1; }
          
          # éªŒè¯manifest.jsonæ ¼å¼
          echo "âœ… Validating manifest.json..."
          if command -v jq > /dev/null; then
            jq empty manifest.json || { echo "âŒ Invalid manifest.json"; exit 1; }
            echo "âœ… manifest.json is valid"
          fi
          
      # âœ… æ„å»ºäº§ç‰©ä¸Šä¼ å¾ˆå¥½
      - name: ğŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v3  # âš ï¸ åº”è¯¥ä½¿ç”¨v4
        with:
          name: extension-build
          path: dist/
          retention-days: 7

  # âŒ æ€§èƒ½åŸºå‡†æµ‹è¯•å‡è®¾äº†HTTPæœåŠ¡å™¨ï¼Œä½†è¿™æ˜¯Chromeæ‰©å±•é¡¹ç›®
  performance-benchmark:
    name: âš¡ Performance Benchmark
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
          
      - name: ğŸ“¦ Install Dependencies
        run: |
          cd frontend && bun install --frozen-lockfile
          cd ../backend && bun install --frozen-lockfile
          
      # âŒ è¿™ä¸ªæ€§èƒ½æµ‹è¯•ä¸é€‚åˆChromeæ‰©å±•é¡¹ç›®
      - name: âš¡ Run Performance Tests
        run: |
          echo "ğŸš€ Starting backend server..."
          cd backend && bun run start &
          SERVER_PID=$!
          
          # ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨
          sleep 5
          
          echo "ğŸ“Š Running performance benchmarks..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ å…·ä½“çš„æ€§èƒ½æµ‹è¯•
          curl -f http://localhost:3000/health || echo "Server not ready"  # âŒ å‡è®¾HTTPç«¯ç‚¹å­˜åœ¨
          
          # æ¸…ç†
          kill $SERVER_PID || true

  # ğŸš€ è‡ªåŠ¨åŒ–éƒ¨ç½² - æ•´ä½“æ€è·¯æ­£ç¡®ä½†æœ‰é—®é¢˜
  deploy:
    name: ğŸš€ Deploy
    needs: [quality-gate, test-matrix, build-analysis]  # âŒ test-matrixä¼šå¤±è´¥ï¼Œå¯¼è‡´éƒ¨ç½²æ°¸è¿œä¸ä¼šè¿è¡Œ
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
          
      - name: ğŸ“¦ Install Dependencies
        run: |
          cd frontend && bun install --frozen-lockfile
          
      # âœ… ç”Ÿäº§æ„å»ºæ­£ç¡®
      - name: ğŸ”¨ Build for Production
        run: |
          cd frontend
          NODE_ENV=production bun run build:prod  # âœ… æ­£ç¡®
          
      # âœ… æ‰©å±•æ‰“åŒ…æ€è·¯æ­£ç¡®
      - name: ğŸ“¦ Create Extension Package
        run: |
          cd dist
          zip -r ../acuity-bookmarks-${{ github.sha }}.zip .
          
      # âš ï¸ Chrome Web Storeéƒ¨ç½²é…ç½®å¯èƒ½æœ‰é—®é¢˜
      - name: ğŸª Deploy to Chrome Web Store
        # åªæœ‰åœ¨æœ‰ç›¸å…³å¯†é’¥æ—¶æ‰è¿è¡Œ
        if: ${{ secrets.CHROME_CLIENT_ID && secrets.CHROME_CLIENT_SECRET }}
        uses: mobilefirstllc/cws-publish@latest  # âš ï¸ è¿™ä¸ªactionå¯èƒ½ä¸æ˜¯æœ€æ–°çš„
        with:
          action: 'publish'
          client_id: ${{ secrets.CHROME_CLIENT_ID }}
          client_secret: ${{ secrets.CHROME_CLIENT_SECRET }}
          refresh_token: ${{ secrets.CHROME_REFRESH_TOKEN }}
          extension_id: ${{ secrets.CHROME_EXTENSION_ID }}
          zip_file: './acuity-bookmarks-${{ github.sha }}.zip'
          
      # âš ï¸ GitHubå‘å¸ƒä½¿ç”¨äº†å·²å¼ƒç”¨çš„action
      - name: ğŸ“ Create GitHub Release
        uses: actions/create-release@v1  # âŒ å·²å¼ƒç”¨ï¼Œåº”è¯¥ä½¿ç”¨softprops/action-gh-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Release v${{ github.run_number }}
          body: |
            ## ğŸš€ AcuityBookmarks Release v${{ github.run_number }}
            
            ### ğŸ“¦ Build Info
            - **Commit**: ${{ github.sha }}
            - **Date**: ${{ github.event.head_commit.timestamp }}
            - **Author**: ${{ github.event.head_commit.author.name }}
            
            ### ğŸ“Š Build Metrics
            - **Bundle Size**: Generated during build
            - **Test Coverage**: Available in CI logs  # âŒ å®é™…ä¸Šæ²¡æœ‰æµ‹è¯•è¦†ç›–ç‡
            - **Performance**: Benchmarked âœ…
            
            ### ğŸ“‹ Changes
            ${{ github.event.head_commit.message }}
            
          draft: false
          prerelease: false

  # âœ… é€šçŸ¥éƒ¨åˆ†æ€è·¯æ­£ç¡®
  notification:
    name: ğŸ“¢ Notify
    needs: [deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“¢ Deployment Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment failed or skipped"
          fi

# ===================================================================
# ğŸ’¡ ä¸»è¦ä¿®å¤å»ºè®®ï¼š
# 1. ç§»é™¤æ‰€æœ‰ä¸å­˜åœ¨çš„æµ‹è¯•è„šæœ¬å¼•ç”¨
# 2. ä¿®å¤æ„å»ºå‘½ä»¤ï¼ˆç¡®è®¤build:prodå­˜åœ¨ï¼‰
# 3. ç®€åŒ–æ€§èƒ½æµ‹è¯•ï¼Œèšç„¦äºChromeæ‰©å±•ç›¸å…³æŒ‡æ ‡
# 4. æ›´æ–°åˆ°æœ€æ–°çš„GitHub Actions
# 5. ä¼˜åŒ–Chromeæ‰©å±•ç‰¹æœ‰çš„éªŒè¯é€»è¾‘
# 6. è°ƒæ•´åŒ…å¤§å°é™åˆ¶åˆ°åˆç†èŒƒå›´ï¼ˆChromeæ‰©å±•é€šå¸¸å¯ä»¥æ›´å¤§ï¼‰
# 7. ç®€åŒ–åç«¯ç›¸å…³æ­¥éª¤ï¼Œæ˜ç¡®å…¶å¼€å‘è¾…åŠ©è§’è‰²
# ===================================================================
