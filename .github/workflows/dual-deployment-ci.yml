# ===============================================
# ğŸš€ AcuityBookmarks åŒç«¯éƒ¨ç½²CI/CDç®¡é“
# ===============================================
# 
# ğŸ¯ é¡¹ç›®æ¶æ„ï¼š
#   å‰ç«¯ï¼šVue 3 Chromeæ‰©å±• â†’ Chrome Web Store
#   åç«¯ï¼šBunæœåŠ¡å™¨ (AI LLM + æŠ“åŒ…) â†’ Vercel Serverless
# 
# ğŸ“‹ æ ¸å¿ƒåŠŸèƒ½ï¼š
#   âœ… å‰ç«¯Chromeæ‰©å±•è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ
#   âœ… åç«¯Serverless APIè‡ªåŠ¨éƒ¨ç½²  
#   âœ… åŒç«¯åŒæ­¥ç‰ˆæœ¬ç®¡ç†
#   âœ… å®Œæ•´çš„è´¨é‡ä¿è¯æµç¨‹
# 
# ğŸ”§ æŠ€æœ¯æ ˆï¼š
#   - Bun (åŒ…ç®¡ç†å™¨å’Œæ„å»ºå·¥å…·)
#   - Vue 3 + TypeScript + IndexedDB
#   - Vercel Serverless Functions
#   - GitHub Actions CI/CD
# 
# ğŸ’¡ ä¼˜åŠ¿ï¼š
#   - é’ˆå¯¹åŒç«¯æ¶æ„ä¸“é—¨ä¼˜åŒ–
#   - Chromeæ‰©å±•ç‰¹æœ‰éªŒè¯
#   - Serverlesséƒ¨ç½²æ”¯æŒ
#   - å®Œæ•´çš„ç›‘æ§å’ŒæŠ¥å‘Š
# ===============================================

name: ğŸš€ Dual Deployment CI/CD (Chrome Extension + Serverless)

# ğŸš€ è§¦å‘æ¡ä»¶ï¼šä»£ç æ¨é€å’Œæ‹‰å–è¯·æ±‚
on:
  push:
    branches: [main, develop]  # æ¨é€åˆ°ä¸»åˆ†æ”¯æˆ–å¼€å‘åˆ†æ”¯æ—¶è§¦å‘
  pull_request:
    branches: [main]  # åˆ›å»ºåˆ°mainåˆ†æ”¯çš„PRæ—¶è§¦å‘

# ğŸŒ å…¨å±€ç¯å¢ƒå˜é‡ï¼šç»Ÿä¸€ç‰ˆæœ¬ç®¡ç†
env:
  BUN_VERSION: "latest"    # Bunè¿è¡Œæ—¶ç‰ˆæœ¬ (å¿«é€ŸåŒ…ç®¡ç†)
  NODE_VERSION: "20.x"     # Node.jsç‰ˆæœ¬ (Vercelå…¼å®¹æ€§)

jobs:
  # ===============================
  # ğŸ” ä»£ç è´¨é‡æ£€æŸ¥ (å‰åç«¯)
  # ===============================
  quality-gate:
    name: ğŸ” Quality Gate & Security Audit
    runs-on: ubuntu-latest  # ä½¿ç”¨Ubuntuæœ€æ–°ç‰ˆæœ¬çš„GitHubæ‰˜ç®¡è¿è¡Œå™¨
    
    steps:
      # ğŸ“¥ æ£€å‡ºæºä»£ç ï¼šè·å–å®Œæ•´çš„é¡¹ç›®ä»£ç åº“
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4  # ä½¿ç”¨æœ€æ–°çš„checkout action
        
      # ğŸ”§ è®¾ç½®Bunè¿è¡Œæ—¶ï¼šé«˜æ€§èƒ½JavaScriptè¿è¡Œæ—¶å’ŒåŒ…ç®¡ç†å™¨
      - name: ğŸ”§ Setup Bun Runtime Environment
        uses: oven-sh/setup-bun@v1  # å®˜æ–¹Bunè®¾ç½®action
        with:
          bun-version: ${{ env.BUN_VERSION }}  # ä½¿ç”¨å…¨å±€å®šä¹‰çš„Bunç‰ˆæœ¬
          
      # ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–ï¼šVue 3 Chromeæ‰©å±•ç›¸å…³åŒ…
      - name: ğŸ“¦ Install Frontend Dependencies (Chrome Extension)
        run: |
          echo "ğŸ“¦ Installing frontend dependencies for Chrome Extension..."
          cd frontend
          # ä½¿ç”¨frozen-lockfileç¡®ä¿ç‰ˆæœ¬ä¸€è‡´æ€§ï¼Œé¿å…ä¾èµ–ç‰ˆæœ¬æ¼‚ç§»
          bun install --frozen-lockfile
          echo "âœ… Frontend dependencies installed successfully"
          
      # ğŸ“¦ å®‰è£…åç«¯ä¾èµ–ï¼šServerless APIç›¸å…³åŒ…
      - name: ğŸ“¦ Install Backend Dependencies (Serverless API)  
        run: |
          echo "ğŸ“¦ Installing backend dependencies for Serverless functions..."
          cd backend
          # åŒæ ·ä½¿ç”¨frozen-lockfileä¿è¯ä¾èµ–ç‰ˆæœ¬ä¸€è‡´æ€§
          bun install --frozen-lockfile
          echo "âœ… Backend dependencies installed successfully"
          
      # ğŸ” å‰ç«¯å®‰å…¨å®¡è®¡ï¼šæ£€æŸ¥å·²çŸ¥å®‰å…¨æ¼æ´
      - name: ğŸ” Security Audit - Frontend (Chrome Extension)
        run: |
          echo "ğŸ” Running security audit for Chrome Extension..."
          cd frontend
          # moderateçº§åˆ«ï¼šæ£€æŸ¥ä¸­ç­‰åŠä»¥ä¸Šä¸¥é‡æ€§çš„å®‰å…¨æ¼æ´
          bun audit --audit-level moderate
          echo "âœ… Frontend security audit completed"
          
      # ğŸ” åç«¯å®‰å…¨å®¡è®¡ï¼šæ£€æŸ¥Serverless APIçš„å®‰å…¨æ€§
      - name: ğŸ” Security Audit - Backend (Serverless API)
        run: |
          echo "ğŸ” Running security audit for Serverless backend..."
          cd backend
          # æ£€æŸ¥åç«¯ä¾èµ–çš„å®‰å…¨æ¼æ´ï¼Œç‰¹åˆ«å…³æ³¨AI LLMå’Œç½‘ç»œè¯·æ±‚ç›¸å…³åŒ…
          bun audit --audit-level moderate
          echo "âœ… Backend security audit completed"
          
      # ğŸ“ TypeScriptç±»å‹æ£€æŸ¥ï¼šç¡®ä¿å‰ç«¯ä»£ç ç±»å‹å®‰å…¨
      - name: ğŸ“ TypeScript Type Safety Check
        run: |
          echo "ğŸ“ Running TypeScript type checking for Chrome Extension..."
          cd frontend
          # Vue 3 + TypeScripté¡¹ç›®çš„ç±»å‹æ£€æŸ¥
          bun run type-check
          echo "âœ… TypeScript type checking passed"
          
      # ğŸ§¹ å‰ç«¯ä»£ç è´¨é‡æ£€æŸ¥ï¼šESLintè§„åˆ™éªŒè¯
      - name: ğŸ§¹ Code Quality Check - Frontend (ESLint)
        run: |
          echo "ğŸ§¹ Running ESLint code quality check for frontend..."
          cd frontend
          # æ£€æŸ¥Vue 3ç»„ä»¶ã€TypeScriptä»£ç è§„èŒƒå’Œæœ€ä½³å®è·µ
          bun run lint:check
          echo "âœ… Frontend code quality check passed"
          
      # ğŸ§¹ åç«¯ä»£ç è´¨é‡æ£€æŸ¥ï¼šç¡®ä¿APIä»£ç è´¨é‡
      - name: ğŸ§¹ Code Quality Check - Backend (ESLint)
        run: |
          echo "ğŸ§¹ Running ESLint code quality check for backend..."
          cd backend
          # æ£€æŸ¥Bun/Node.jsæœåŠ¡å™¨ä»£ç ï¼ŒAIé›†æˆå’Œç½‘ç»œå¤„ç†é€»è¾‘
          bun run lint:check
          echo "âœ… Backend code quality check passed"

  # ===============================
  # ğŸ”¨ Chromeæ‰©å±•æ„å»ºéªŒè¯
  # ===============================
  chrome-extension-build:
    name: ğŸ”¨ Chrome Extension Build & Validation
    runs-on: ubuntu-latest  # ä½¿ç”¨GitHubæ‰˜ç®¡çš„Ubuntuè¿è¡Œå™¨
    needs: quality-gate  # ä¾èµ–è´¨é‡æ£€æŸ¥ä»»åŠ¡å®Œæˆ
    
    steps:
      # ğŸ“¥ æ£€å‡ºä»£ç ï¼šè·å–æœ€æ–°çš„æºä»£ç 
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      # ğŸ”§ è®¾ç½®Bunç¯å¢ƒï¼šChromeæ‰©å±•æ„å»ºæ‰€éœ€çš„è¿è¡Œæ—¶
      - name: ğŸ”§ Setup Bun Runtime Environment
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}  # ä½¿ç”¨å…¨å±€å®šä¹‰çš„Bunç‰ˆæœ¬
          
      # ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–ï¼šVue 3 + TypeScript + Viteæ„å»ºé“¾
      - name: ğŸ“¦ Install Frontend Dependencies (Vue 3 + Vite)
        run: |
          echo "ğŸ“¦ Installing Chrome Extension build dependencies..."
          cd frontend
          # ç¡®ä¿ä¾èµ–ç‰ˆæœ¬é”å®šï¼Œä¿è¯æ„å»ºä¸€è‡´æ€§
          bun install --frozen-lockfile
          echo "âœ… All build dependencies installed"
          
      # ğŸ”¨ æ„å»ºChromeæ‰©å±•ï¼šç”Ÿäº§ç¯å¢ƒä¼˜åŒ–æ„å»º
      - name: ğŸ”¨ Build Chrome Extension (Production)
        run: |
          echo "ğŸ”¨ Building Chrome Extension for production deployment..."
          cd frontend
          # è®¾ç½®ç”Ÿäº§ç¯å¢ƒå˜é‡ï¼Œå¯ç”¨æ‰€æœ‰ä¼˜åŒ–
          NODE_ENV=production bun run build:prod
          echo "âœ… Chrome Extension built successfully"
          
      # ğŸ“Š æ‰©å±•å¤§å°åˆ†æï¼šç¡®ä¿ç¬¦åˆChrome Storeè¦æ±‚
      - name: ğŸ“Š Chrome Extension Size Analysis & Validation
        run: |
          echo "ğŸ“Š Analyzing Chrome Extension package size..."
          cd dist  # è¿›å…¥æ„å»ºè¾“å‡ºç›®å½•
          
          # ğŸ“¦ æ˜¾ç¤ºè¯¦ç»†çš„æ–‡ä»¶å¤§å°åˆ†å¸ƒ
          echo "ğŸ“¦ Extension files size breakdown (Top 20 largest):"
          find . -type f -exec ls -lah {} \; | awk '{print $5 "\t" $9}' | sort -hr | head -20
          
          # ğŸ“Š è®¡ç®—æ€»å¤§å° (KBå’ŒMB)
          TOTAL_SIZE_KB=$(du -sk . | cut -f1)
          TOTAL_SIZE_MB=$((TOTAL_SIZE_KB / 1024))
          
          echo ""
          echo "ğŸ“Š Extension Package Summary:"
          echo "   Total Size: ${TOTAL_SIZE_KB}KB (~${TOTAL_SIZE_MB}MB)"
          
          # ğŸš¨ Chrome Web Storeå¤§å°é™åˆ¶æ£€æŸ¥
          # Chrome Storeé™åˆ¶ï¼š20MB (ç¡¬é™åˆ¶)
          # å»ºè®®å¤§å°ï¼š<10MB (ç”¨æˆ·ä½“éªŒæœ€ä½³)
          # è­¦å‘Šå¤§å°ï¼š>5MB (å¼€å§‹å½±å“åŠ è½½é€Ÿåº¦)
          if [ $TOTAL_SIZE_KB -gt 20480 ]; then
            echo "âŒ CRITICAL: Extension exceeds Chrome Store 20MB hard limit!"
            echo "   Chrome Web Store will reject packages >20MB"
            echo "   Current size: ${TOTAL_SIZE_MB}MB"
            exit 1
          elif [ $TOTAL_SIZE_KB -gt 10240 ]; then
            echo "âš ï¸ WARNING: Extension size exceeds 10MB recommended limit"
            echo "   Consider optimizing assets, removing unused dependencies"
            echo "   Current size: ${TOTAL_SIZE_MB}MB (limit: 10MB)"
          elif [ $TOTAL_SIZE_KB -gt 5120 ]; then
            echo "ğŸ’¡ INFO: Extension size exceeds 5MB"
            echo "   Still acceptable but monitor for future growth"
            echo "   Current size: ${TOTAL_SIZE_MB}MB"
          else
            echo "âœ… EXCELLENT: Extension size within optimal range"
            echo "   Current size: ${TOTAL_SIZE_MB}MB (<5MB recommended)"
          fi
          
      - name: ğŸª Chrome Extension Structure Validation
        run: |
          cd dist
          echo "ğŸª Validating Chrome Extension structure..."
          
          # æ£€æŸ¥å¿…éœ€æ–‡ä»¶
          required_files=("manifest.json" "background.js")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Missing required file: $file"
              exit 1
            else
              echo "âœ… Found: $file"
            fi
          done
          
          # éªŒè¯manifest.json
          if command -v jq > /dev/null; then
            echo "ğŸ“ Validating manifest.json..."
            jq empty manifest.json || { echo "âŒ Invalid manifest.json"; exit 1; }
            
            VERSION=$(jq -r '.version' manifest.json)
            NAME=$(jq -r '.name' manifest.json)
            MANIFEST_VERSION=$(jq -r '.manifest_version' manifest.json)
            
            echo "ğŸ“‹ Extension Info:"
            echo "  - Name: $NAME"
            echo "  - Version: $VERSION"
            echo "  - Manifest Version: $MANIFEST_VERSION"
            
            # æ£€æŸ¥æƒé™é…ç½®
            PERMISSIONS=$(jq -r '.permissions[]?' manifest.json 2>/dev/null | wc -l)
            echo "  - Permissions count: $PERMISSIONS"
            
            echo "âœ… manifest.json is valid"
          fi
          
      - name: ğŸ“¦ Create Chrome Extension Package
        run: |
          cd dist
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          ZIP_NAME="chrome-extension-${TIMESTAMP}.zip"
          zip -r "../${ZIP_NAME}" . -x "*.DS_Store" "*.gitkeep"
          echo "ğŸ“¦ Extension package created: $ZIP_NAME"
          echo "CHROME_ZIP_FILE=${ZIP_NAME}" >> $GITHUB_ENV
          
      - name: ğŸ“¤ Upload Chrome Extension Artifact
        uses: actions/upload-artifact@v4
        with:
          name: chrome-extension-${{ github.sha }}
          path: ${{ env.CHROME_ZIP_FILE }}
          retention-days: 30

  # ===============================
  # âš¡ Serverlessåç«¯æ„å»ºéªŒè¯
  # ===============================
  serverless-backend-build:
    name: âš¡ Serverless Backend Build & Test
    runs-on: ubuntu-latest
    needs: quality-gate
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Bun Runtime
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
          
      - name: ğŸ“¦ Install Backend Dependencies
        run: |
          cd backend
          bun install --frozen-lockfile
          
      - name: ğŸ”¨ Backend Build Test
        run: |
          cd backend
          echo "ğŸ”¨ Testing backend build..."
          # Bun nativeé¡¹ç›®é€šå¸¸ä¸éœ€è¦æ„å»ºï¼Œä½†å¯ä»¥åšè¯­æ³•æ£€æŸ¥
          bun run build
          
      - name: ğŸš€ Backend Function Test
        run: |
          cd backend
          echo "ğŸš€ Testing backend functionality..."
          
          # å¯åŠ¨æœåŠ¡å™¨è¿›è¡Œå¥åº·æ£€æŸ¥
          timeout 30s bun run start &
          SERVER_PID=$!
          
          # ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨
          sleep 5
          
          # å¥åº·æ£€æŸ¥
          if curl -f http://localhost:3000/health 2>/dev/null; then
            echo "âœ… Backend server responding correctly"
          else
            echo "âš ï¸ Backend server not responding (check configuration)"
          fi
          
          # æ¸…ç†
          kill $SERVER_PID 2>/dev/null || true
          
      - name: ğŸ“Š Backend Performance Benchmark
        run: |
          cd backend
          echo "ğŸ“Š Running backend performance tests..."
          
          # å¦‚æœæœ‰benchmarkè„šæœ¬å°±è¿è¡Œ
          if grep -q "benchmark" package.json; then
            echo "ğŸƒâ€â™‚ï¸ Running performance benchmarks..."
            timeout 60s bun run benchmark || echo "âš ï¸ Benchmark timeout or not available"
          else
            echo "â„¹ï¸ No benchmark script found"
          fi
          
      - name: ğŸ“‹ Serverless Compatibility Check
        run: |
          cd backend
          echo "ğŸ“‹ Checking Vercel/Serverless compatibility..."
          
          # æ£€æŸ¥æ˜¯å¦æœ‰vercelé…ç½®
          if [ -f "vercel.json" ]; then
            echo "âœ… Found vercel.json configuration"
            cat vercel.json | head -20
          else
            echo "âš ï¸ No vercel.json found - will use default Vercel settings"
          fi
          
          # æ£€æŸ¥mainå…¥å£æ–‡ä»¶
          MAIN_FILE=$(jq -r '.main' package.json)
          if [ -f "$MAIN_FILE" ]; then
            echo "âœ… Main entry file exists: $MAIN_FILE"
          else
            echo "âš ï¸ Main entry file not found: $MAIN_FILE"
          fi

  # ===============================
  # ğŸš€ Chromeæ‰©å±•éƒ¨ç½²
  # ===============================
  deploy-chrome-extension:
    name: ğŸš€ Deploy Chrome Extension
    needs: [chrome-extension-build, serverless-backend-build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Bun Runtime
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
          
      - name: ğŸ“¦ Install Frontend Dependencies
        run: |
          cd frontend
          bun install --frozen-lockfile
          
      - name: ğŸ”¨ Build Chrome Extension for Release
        run: |
          cd frontend
          NODE_ENV=production bun run build:prod
          
      - name: ğŸ“¦ Create Release Package
        run: |
          cd dist
          RELEASE_VERSION="v${{ github.run_number }}"
          ZIP_NAME="acuity-bookmarks-${RELEASE_VERSION}.zip"
          zip -r "../${ZIP_NAME}" . -x "*.DS_Store" "*.gitkeep"
          echo "RELEASE_ZIP=${ZIP_NAME}" >> $GITHUB_ENV
          
      - name: ğŸª Deploy to Chrome Web Store
        if: ${{ secrets.CHROME_CLIENT_ID && secrets.CHROME_CLIENT_SECRET }}
        uses: mobilefirstllc/cws-publish@latest
        with:
          action: 'publish'
          client_id: ${{ secrets.CHROME_CLIENT_ID }}
          client_secret: ${{ secrets.CHROME_CLIENT_SECRET }}
          refresh_token: ${{ secrets.CHROME_REFRESH_TOKEN }}
          extension_id: ${{ secrets.CHROME_EXTENSION_ID }}
          zip_file: './${{ env.RELEASE_ZIP }}'
          
      - name: ğŸ“ Create GitHub Release for Chrome Extension
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: chrome-v${{ github.run_number }}
          name: ğŸ”— Chrome Extension v${{ github.run_number }}
          body: |
            ## ğŸ”— AcuityBookmarks Chrome Extension Release
            
            ### ğŸ“¦ Chrome Extension Package
            - **Version**: v${{ github.run_number }}
            - **Build**: ${{ github.sha }}
            - **Release Date**: ${{ github.event.head_commit.timestamp }}
            
            ### ğŸ“‹ Installation Instructions
            1. Download the attached ZIP file
            2. Extract to local directory
            3. Open Chrome Extensions (chrome://extensions/)
            4. Enable Developer Mode
            5. Click "Load unpacked" and select extracted folder
            
            ### ğŸ”— Chrome Web Store
            This extension is also available on the Chrome Web Store (pending approval).
            
            ### ğŸ“‹ Recent Changes
            ${{ github.event.head_commit.message }}
            
          files: ${{ env.RELEASE_ZIP }}
          draft: false
          prerelease: false

  # ===============================
  # âš¡ Serverlessåç«¯éƒ¨ç½²
  # ===============================
  deploy-serverless-backend:
    name: âš¡ Deploy Serverless Backend to Vercel
    needs: [chrome-extension-build, serverless-backend-build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Bun Runtime
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
          
      - name: ğŸ“¦ Install Backend Dependencies
        run: |
          cd backend
          bun install --frozen-lockfile
          
      - name: ğŸ”¨ Prepare Backend for Deployment
        run: |
          cd backend
          echo "ğŸ”¨ Preparing backend for Vercel deployment..."
          
          # å¦‚æœéœ€è¦æ„å»ºæ­¥éª¤ï¼Œåœ¨è¿™é‡Œæ‰§è¡Œ
          bun run build
          
          # ç¡®ä¿vercelé…ç½®å­˜åœ¨
          if [ ! -f "vercel.json" ]; then
            echo "âš ï¸ Creating default vercel.json..."
            cat > vercel.json << 'EOF'
            {
              "version": 2,
              "builds": [
                {
                  "src": "*.js",
                  "use": "@vercel/node"
                }
              ],
              "routes": [
                {
                  "src": "/(.*)",
                  "dest": "/server-bun-native.js"
                }
              ]
            }
            EOF
          fi
          
      - name: ğŸš€ Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          vercel-args: '--prod'
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}
          working-directory: ./backend
          
      - name: ğŸ“ Create GitHub Release for Backend
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: backend-v${{ github.run_number }}
          name: âš¡ Serverless Backend v${{ github.run_number }}
          body: |
            ## âš¡ AcuityBookmarks Serverless Backend Release
            
            ### ğŸš€ Deployment Information
            - **Version**: v${{ github.run_number }}
            - **Platform**: Vercel Serverless
            - **Build**: ${{ github.sha }}
            - **Deploy Date**: ${{ github.event.head_commit.timestamp }}
            
            ### ğŸ”§ Backend Services
            - **AI LLM Integration**: Ready for Chrome Extension calls
            - **Network Processing**: Web scraping and data processing
            - **Serverless Functions**: Optimized for Vercel platform
            
            ### ğŸŒ API Endpoints
            Backend services are deployed and accessible via Vercel URLs.
            
            ### ğŸ“‹ Recent Changes
            ${{ github.event.head_commit.message }}
            
          draft: false
          prerelease: false

  # ===============================
  # ğŸ“¢ éƒ¨ç½²çŠ¶æ€é€šçŸ¥
  # ===============================
  # ===============================
  # ğŸ“¢ åŒç«¯éƒ¨ç½²çŠ¶æ€ç›‘æ§ä¸é€šçŸ¥
  # ===============================
  deployment-notification:
    name: ğŸ“¢ Dual Deployment Status Summary & Notification
    # ğŸ”— ä¾èµ–ï¼šç­‰å¾…åŒç«¯éƒ¨ç½²ä»»åŠ¡å®Œæˆ (æˆåŠŸæˆ–å¤±è´¥éƒ½ä¼šæ‰§è¡Œ)
    needs: [deploy-chrome-extension, deploy-serverless-backend]
    runs-on: ubuntu-latest
    # ğŸ¯ æ‰§è¡Œæ¡ä»¶ï¼š
    #   - always(): æ— è®ºå‰ç½®ä»»åŠ¡æˆåŠŸæˆ–å¤±è´¥éƒ½æ‰§è¡Œ
    #   - mainåˆ†æ”¯ï¼šåªåœ¨ä¸»åˆ†æ”¯éƒ¨ç½²æ—¶ç”ŸæˆæŠ¥å‘Š
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
      # ğŸ“Š ç”Ÿæˆè¯¦ç»†çš„åŒç«¯éƒ¨ç½²çŠ¶æ€æŠ¥å‘Š
      - name: ğŸ“Š Generate Comprehensive Deployment Report
        run: |
          echo "================================================"
          echo "ğŸ“Š AcuityBookmarks åŒç«¯éƒ¨ç½²çŠ¶æ€æŠ¥å‘Š"
          echo "================================================"
          echo ""
          
          # ğŸ“‹ åŸºæœ¬éƒ¨ç½²ä¿¡æ¯
          echo "ğŸ” éƒ¨ç½²åŸºæœ¬ä¿¡æ¯:"
          echo "   Commit SHA: ${{ github.sha }}"
          echo "   Branch: ${{ github.ref }}"
          echo "   Trigger Event: ${{ github.event_name }}"
          echo "   Deploy Time: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "   Workflow Run: #${{ github.run_number }}"
          echo ""
          
          # ğŸ“Š åŒç«¯éƒ¨ç½²çŠ¶æ€æ¦‚è§ˆ
          echo "ğŸš€ åŒç«¯éƒ¨ç½²çŠ¶æ€æ¦‚è§ˆ:"
          echo "   ğŸ”— Chrome Extension: ${{ needs.deploy-chrome-extension.result }}"
          echo "   âš¡ Serverless Backend: ${{ needs.deploy-serverless-backend.result }}"
          echo ""
          
          # ğŸ¯ è·å–éƒ¨ç½²çŠ¶æ€ç”¨äºè¯¦ç»†åˆ†æ
          CHROME_STATUS="${{ needs.deploy-chrome-extension.result }}"
          BACKEND_STATUS="${{ needs.deploy-serverless-backend.result }}"
          
          # ğŸ“ˆ è¯¦ç»†çŠ¶æ€åˆ†æä¸å»ºè®®
          echo "ğŸ” è¯¦ç»†çŠ¶æ€åˆ†æ:"
          echo "================================================"
          
          if [ "$CHROME_STATUS" == "success" ] && [ "$BACKEND_STATUS" == "success" ]; then
            echo "âœ… ğŸ‰ å®Œå…¨éƒ¨ç½²æˆåŠŸ (COMPLETE SUCCESS)"
            echo ""
            echo "ğŸ¯ éƒ¨ç½²æˆæœ:"
            echo "   âœ… Chrome Extension: å·²å‘å¸ƒåˆ°Chrome Web Store"
            echo "   âœ… Serverless Backend: å·²éƒ¨ç½²åˆ°Vercelå¹³å°"
            echo "   âœ… APIé›†æˆ: Chrome Extension â†” Vercel Serverless"
            echo "   âœ… ç‰ˆæœ¬åŒæ­¥: å‰åç«¯ç‰ˆæœ¬v${{ github.run_number }}å·²å¯¹é½"
            echo ""
            echo "ğŸš€ ç”¨æˆ·è®¿é—®è·¯å¾„:"
            echo "   1. Chrome Web Store â†’ ä¸‹è½½æ‰©å±•"
            echo "   2. Chrome Extension â†’ è°ƒç”¨Vercel API"
            echo "   3. Vercel Serverless â†’ å¤„ç†AI LLM + æŠ“åŒ…è¯·æ±‚"
            echo ""
            echo "ğŸ‰ æ­å–œï¼AcuityBookmarkså·²å®Œå…¨éƒ¨ç½²å¹¶å¯ä¾›ç”¨æˆ·ä½¿ç”¨ï¼"
            
          elif [ "$CHROME_STATUS" == "success" ] || [ "$BACKEND_STATUS" == "success" ]; then
            echo "âš ï¸ ğŸ”„ éƒ¨åˆ†éƒ¨ç½²æˆåŠŸ (PARTIAL SUCCESS)"
            echo ""
            echo "ğŸ“Š éƒ¨ç½²çŠ¶æ€è¯¦æƒ…:"
            echo "   Chrome Extension: $CHROME_STATUS"
            echo "   Serverless Backend: $BACKEND_STATUS"
            echo ""
            echo "ğŸ”§ éœ€è¦æ‰‹åŠ¨å¹²é¢„:"
            if [ "$CHROME_STATUS" != "success" ]; then
              echo "   âŒ Chrome Extensionéƒ¨ç½²å¤±è´¥"
              echo "      â†’ æ£€æŸ¥Chrome Web Store APIé…ç½®"
              echo "      â†’ éªŒè¯æ‰©å±•åŒ…æ ¼å¼å’Œå¤§å°"
              echo "      â†’ ç¡®è®¤Chrome Storeå¼€å‘è€…è´¦æˆ·çŠ¶æ€"
            fi
            if [ "$BACKEND_STATUS" != "success" ]; then
              echo "   âŒ Serverless Backendéƒ¨ç½²å¤±è´¥"
              echo "      â†’ æ£€æŸ¥Vercel API Tokenå’Œæƒé™"
              echo "      â†’ éªŒè¯vercel.jsoné…ç½®"
              echo "      â†’ ç¡®è®¤Vercelé¡¹ç›®è®¾ç½®"
            fi
            echo ""
            echo "ğŸ’¡ å»ºè®®æ“ä½œ:"
            echo "   1. æŸ¥çœ‹å¤±è´¥ä»»åŠ¡çš„è¯¦ç»†æ—¥å¿—"
            echo "   2. ä¿®å¤é…ç½®æˆ–ä»£ç é—®é¢˜"
            echo "   3. é‡æ–°è§¦å‘éƒ¨ç½² (git push æˆ–æ‰‹åŠ¨è¿è¡Œ)"
            
          else
            echo "âŒ ğŸš¨ å®Œå…¨éƒ¨ç½²å¤±è´¥ (COMPLETE FAILURE)"
            echo ""
            echo "ğŸ“Š åŒç«¯éƒ¨ç½²éƒ½å¤±è´¥äº†:"
            echo "   Chrome Extension: $CHROME_STATUS"
            echo "   Serverless Backend: $BACKEND_STATUS"
            echo ""
            echo "ğŸš¨ ç´§æ€¥å¤„ç†æ¸…å•:"
            echo "   1. ğŸ” æ£€æŸ¥GitHub Actionsæ—¥å¿—"
            echo "   2. ğŸ”§ éªŒè¯æ‰€æœ‰GitHub Secretsé…ç½®"
            echo "   3. ğŸ§ª åœ¨æœ¬åœ°ç¯å¢ƒæµ‹è¯•æ„å»ºè¿‡ç¨‹"
            echo "   4. ğŸ“‹ ç¡®è®¤package.jsonè„šæœ¬é…ç½®"
            echo "   5. ğŸ” æ£€æŸ¥APIå¯†é’¥å’Œæƒé™è®¾ç½®"
            echo ""
            echo "ğŸ“ æ•…éšœæ’é™¤æ­¥éª¤:"
            echo "   â†’ è¿è¡Œ 'bun run build:prod' æœ¬åœ°æµ‹è¯•"
            echo "   â†’ æ£€æŸ¥ GitHub Secrets æ˜¯å¦æ­£ç¡®é…ç½®"
            echo "   â†’ éªŒè¯ Chrome Web Store å’Œ Vercel è´¦æˆ·çŠ¶æ€"
            echo "   â†’ æŸ¥çœ‹å¤±è´¥ä»»åŠ¡çš„å®Œæ•´æ—¥å¿—è¾“å‡º"
            echo ""
            # ğŸš¨ éƒ¨ç½²å¤±è´¥æ—¶è®¾ç½®éé›¶é€€å‡ºç ï¼Œæ ‡è®°å·¥ä½œæµå¤±è´¥
            exit 1
          fi
          
          echo "================================================"
          echo "ğŸ“‹ éƒ¨ç½²æŠ¥å‘Šç”Ÿæˆå®Œæ¯•"
          echo "ğŸ“… æŠ¥å‘Šæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ”— å·¥ä½œæµè¯¦æƒ…: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "================================================"
