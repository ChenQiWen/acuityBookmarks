name: Enhanced CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  BUN_VERSION: "latest"
  NODE_VERSION: "20.x"

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality-gate:
    name: ğŸ” Quality Gate
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
          
      - name: ğŸ“¦ Install Frontend Dependencies
        run: |
          cd frontend
          bun install --frozen-lockfile
          
      - name: ğŸ“¦ Install Backend Dependencies
        run: |
          cd backend
          bun install --frozen-lockfile
          
      - name: ğŸ” Security Audit
        run: |
          echo "ğŸ” Running security audit..."
          cd frontend && bun audit --audit-level moderate
          cd ../backend && bun audit --audit-level moderate
          
      - name: ğŸ“ TypeScript Check
        run: |
          cd frontend
          bun run type-check
          
      # - name: ğŸ§¹ Lint Check
      #   run: |
      #     cd frontend
      #     bun run lint

  # å¤šç»´åº¦æµ‹è¯•çŸ©é˜µ
  test-matrix:
    name: ğŸ§ª Test Suite (${{ matrix.test-type }})
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        test-type: [unit, integration, api]
        
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
          
      - name: ğŸ“¦ Install Dependencies
        run: |
          cd frontend && bun install --frozen-lockfile
          cd ../backend && bun install --frozen-lockfile
          
      - name: ğŸ§ª Run ${{ matrix.test-type }} Tests (Frontend)
        run: |
          cd frontend
          bun run test:${{ matrix.test-type }}
          
      - name: ğŸ§ª Run ${{ matrix.test-type }} Tests (Backend)
        run: |
          cd backend
          bun run test:${{ matrix.test-type }}
          
      - name: ğŸ“Š Upload Coverage Reports
        uses: codecov/codecov-action@v3
        with:
          files: ./frontend/coverage/lcov.info,./backend/coverage/lcov.info
          fail_ci_if_error: false
          name: coverage-${{ matrix.test-type }}

  # æ„å»ºå’ŒåŒ…å¤§å°åˆ†æ
  build-analysis:
    name: ğŸ”¨ Build & Bundle Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
          
      - name: ğŸ“¦ Install Dependencies
        run: |
          cd frontend && bun install --frozen-lockfile
          
      - name: ğŸ”¨ Build Production
        run: |
          cd frontend
          bun run build:prod
          
      - name: ğŸ“Š Analyze Bundle Size
        run: |
          cd frontend
          echo "ğŸ“¦ Bundle size analysis:"
          du -sh ../dist/* | sort -hr
          
          # æ£€æŸ¥æ€»åŒ…å¤§å° (ç›®æ ‡: <1MB)
          TOTAL_SIZE=$(du -s ../dist | cut -f1)
          echo "Total bundle size: ${TOTAL_SIZE}KB"
          
          if [ $TOTAL_SIZE -gt 1024 ]; then
            echo "âš ï¸ Bundle size exceeds 1MB target"
          else
            echo "âœ… Bundle size within target"
          fi
          
      - name: ğŸª Validate Extension Package
        run: |
          cd dist
          
          # æ£€æŸ¥å¿…éœ€æ–‡ä»¶
          echo "ğŸ” Checking required files..."
          test -f manifest.json || { echo "âŒ manifest.json missing"; exit 1; }
          test -f background.js || { echo "âŒ background.js missing"; exit 1; }
          test -d assets || { echo "âŒ assets directory missing"; exit 1; }
          
          # éªŒè¯manifest.jsonæ ¼å¼
          echo "âœ… Validating manifest.json..."
          if command -v jq > /dev/null; then
            jq empty manifest.json || { echo "âŒ Invalid manifest.json"; exit 1; }
            echo "âœ… manifest.json is valid"
          fi
          
      - name: ğŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: extension-build
          path: dist/
          retention-days: 7

  # æ€§èƒ½åŸºå‡†æµ‹è¯•
  performance-benchmark:
    name: âš¡ Performance Benchmark
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
          
      - name: ğŸ“¦ Install Dependencies
        run: |
          cd frontend && bun install --frozen-lockfile
          cd ../backend && bun install --frozen-lockfile
          
      - name: âš¡ Run Performance Tests
        run: |
          echo "ğŸš€ Starting backend server..."
          cd backend && bun run start &
          SERVER_PID=$!
          
          # ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨
          sleep 5
          
          echo "ğŸ“Š Running performance benchmarks..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ å…·ä½“çš„æ€§èƒ½æµ‹è¯•
          curl -f http://localhost:3000/health || echo "Server not ready"
          
          # æ¸…ç†
          kill $SERVER_PID || true

  # è‡ªåŠ¨åŒ–éƒ¨ç½²
  deploy:
    name: ğŸš€ Deploy
    needs: [quality-gate, test-matrix, build-analysis]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
          
      - name: ğŸ“¦ Install Dependencies
        run: |
          cd frontend && bun install --frozen-lockfile
          
      - name: ğŸ”¨ Build for Production
        run: |
          cd frontend
          NODE_ENV=production bun run build:prod
          
      - name: ğŸ“¦ Create Extension Package
        run: |
          cd dist
          zip -r ../acuity-bookmarks-${{ github.sha }}.zip .
          
      - name: ğŸª Deploy to Chrome Web Store
        # åªæœ‰åœ¨æœ‰ç›¸å…³å¯†é’¥æ—¶æ‰è¿è¡Œ
        if: ${{ secrets.CHROME_CLIENT_ID && secrets.CHROME_CLIENT_SECRET }}
        uses: mobilefirstllc/cws-publish@latest
        with:
          action: 'publish'
          client_id: ${{ secrets.CHROME_CLIENT_ID }}
          client_secret: ${{ secrets.CHROME_CLIENT_SECRET }}
          refresh_token: ${{ secrets.CHROME_REFRESH_TOKEN }}
          extension_id: ${{ secrets.CHROME_EXTENSION_ID }}
          zip_file: './acuity-bookmarks-${{ github.sha }}.zip'
          
      - name: ğŸ“ Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Release v${{ github.run_number }}
          body: |
            ## ğŸš€ AcuityBookmarks Release v${{ github.run_number }}
            
            ### ğŸ“¦ Build Info
            - **Commit**: ${{ github.sha }}
            - **Date**: ${{ github.event.head_commit.timestamp }}
            - **Author**: ${{ github.event.head_commit.author.name }}
            
            ### ğŸ“Š Build Metrics
            - **Bundle Size**: Generated during build
            - **Test Coverage**: Available in CI logs
            - **Performance**: Benchmarked âœ…
            
            ### ğŸ“‹ Changes
            ${{ github.event.head_commit.message }}
            
          draft: false
          prerelease: false

  # é€šçŸ¥
  notification:
    name: ğŸ“¢ Notify
    needs: [deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“¢ Deployment Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment failed or skipped"
          fi
