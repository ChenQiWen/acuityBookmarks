# ===============================================
# âš¡ Cloudflare Workers è‡ªåŠ¨éƒ¨ç½²å·¥ä½œæµ
# ===============================================
# ç›®æ ‡ï¼šå½“ main åˆ†æ”¯æ¨é€ä¸” backend æœåŠ¡ç«¯ä»£ç å‘ç”Ÿå˜æ›´æ—¶ï¼Œè‡ªåŠ¨éƒ¨ç½² Cloudflare Workersã€‚
# è¿è¡Œæ—¶ï¼šçº¯ Bunï¼ˆä½¿ç”¨ bunx æ‰§è¡Œ Wranglerï¼‰
# ä¾èµ–ï¼š
#   - ä»“åº“ Secretsï¼š
#       CLOUDFLARE_API_TOKEN   # éœ€è¦ Cloudflare çš„ API Tokenï¼Œå…·æœ‰ Workers ç¼–è¾‘æƒé™
#       CLOUDFLARE_ACCOUNT_ID  # ä½ çš„ Cloudflare è´¦å· ID
#   - backend/wrangler.toml å·²é…ç½® name/main/compatibility_date
# ===============================================

name: âš¡ Cloudflare Workers è‡ªåŠ¨éƒ¨ç½²

on:
  push:
    branches:
      - main
    # ä»…å½“ backend ç›®å½•æœ‰æ”¹åŠ¨æ—¶è§¦å‘ï¼ˆä¸èƒ½åŒæ—¶ä½¿ç”¨ paths ä¸ paths-ignoreï¼‰
    paths:
      - 'backend/**'
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

permissions:
  contents: read
  deployments: write

env:
  BUN_VERSION: 'latest'

jobs:
  deploy-workers:
    name: ğŸš€ éƒ¨ç½² Cloudflare Workers
    runs-on: ubuntu-latest
    concurrency:
      group: cloudflare-workers-deploy-${{ github.ref }}
      cancel-in-progress: true
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4

      - name: ğŸ”§ è®¾ç½® Bun è¿è¡Œæ—¶ç¯å¢ƒ
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ğŸ“¦ å®‰è£…åç«¯ä¾èµ–
        working-directory: backend
        run: bun install --frozen-lockfile

      - name: ğŸ§ª Wrangler æ‰“åŒ…é¢„æ£€æŸ¥ (Dry Run)
        working-directory: backend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: bunx wrangler deploy --dry-run --verbose
        continue-on-error: true

      - name: ğŸš€ æ­£å¼éƒ¨ç½²åˆ° Cloudflare Workers
        working-directory: backend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: bunx wrangler deploy --var KEEP_ENV=true

      - name: ğŸ“„ æŸ¥çœ‹éƒ¨ç½²å†å²ï¼ˆå¯é€‰ï¼‰
        working-directory: backend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: bunx wrangler deployments list || true

      - name: âœ… ç»“æœæç¤º
        if: success()
        run: |
          echo "âœ… Cloudflare Workers éƒ¨ç½²ä»»åŠ¡æ‰§è¡Œå®Œæˆ"
          echo "â„¹ï¸ è¯·åœ¨ Cloudflare Dashboard æˆ– wrangler å‘½ä»¤è¾“å‡ºä¸­æŸ¥çœ‹å…·ä½“è®¿é—® URL"

      - name: âŒ æ•…éšœæ’é™¤ä¿¡æ¯
        if: failure()
        working-directory: backend
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¾“å‡º wrangler.toml ä¸æ—¥å¿—è¾…åŠ©æ’æŸ¥"
          echo "------- wrangler.toml -------"
          cat wrangler.toml || true
          echo "------- æ–‡ä»¶åˆ—è¡¨ -------"
          ls -la || true
          echo "------- Bun/Wrangler ç‰ˆæœ¬ -------"
          bun --version || true
          bunx wrangler --version || true