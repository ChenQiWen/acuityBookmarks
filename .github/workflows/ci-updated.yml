# ===================================================================
# ğŸ”„ åŸCIé…ç½®æ–‡ä»¶çš„è¯¦ç»†æ³¨é‡Šè¯´æ˜å’Œé—®é¢˜åˆ†æ
# ===================================================================
#
# ğŸ“‹ åŸå§‹æ–‡ä»¶ç›®çš„ï¼šåŸºç¡€çš„CI/CDç®¡é“ï¼Œç”¨äºæµ‹è¯•ã€æ„å»ºå’Œéƒ¨ç½²
#
# âŒ å‘ç°çš„ä¸»è¦é—®é¢˜ï¼š
# 1. æµ‹è¯•è„šæœ¬ä¸å­˜åœ¨ï¼šä½¿ç”¨äº† bun run test:runï¼Œä½†package.jsonä¸­æ²¡æœ‰è¿™ä¸ªè„šæœ¬
# 2. åç«¯è§’è‰²ä¸æ¸…ï¼šè¿™æ˜¯Chromeæ‰©å±•é¡¹ç›®ï¼Œåç«¯åªç”¨äºå¼€å‘è¾…åŠ©
# 3. éƒ¨ç½²ç›®æ ‡é”™è¯¯ï¼šChromeæ‰©å±•åº”éƒ¨ç½²åˆ°Chrome Web Storeï¼Œè€ŒéVercel
# 4. ç¼ºå°‘Chromeæ‰©å±•ç‰¹æœ‰çš„éªŒè¯æ­¥éª¤

name: CI/CD Pipeline (éœ€è¦æ›´æ–°)

on:
  push:
    branches: [ main, bun ]  # âœ… è§¦å‘åˆ†æ”¯é…ç½®åˆç†
  pull_request:
    branches: [ main, bun ]  # âœ… PRè§¦å‘é…ç½®åˆç†

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]  # âœ… Nodeç‰ˆæœ¬é€‰æ‹©åˆç†

    steps:
    - uses: actions/checkout@v4  # âœ… æœ€æ–°ç‰ˆæœ¬

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1  # âœ… Bunè®¾ç½®æ­£ç¡®
      with:
        bun-version: latest

    - name: Setup Node.js  # âš ï¸ æœ‰Bunçš„æƒ…å†µä¸‹å¯èƒ½ä¸éœ€è¦Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'  # âŒ åº”è¯¥ä½¿ç”¨bunç¼“å­˜è€Œénpm

    - name: Install frontend dependencies
      run: |
        cd frontend
        bun install  # âš ï¸ åº”è¯¥ä½¿ç”¨ --frozen-lockfile ç¡®ä¿ç‰ˆæœ¬ä¸€è‡´æ€§

    - name: Install backend dependencies  # âš ï¸ åç«¯åœ¨æ­¤é¡¹ç›®ä¸­è§’è‰²ä¸æ˜ç¡®
      run: |
        cd backend
        bun install

    # âŒ é—®é¢˜ï¼šä»¥ä¸‹æµ‹è¯•è„šæœ¬åœ¨package.jsonä¸­ä¸å­˜åœ¨
    - name: Run frontend tests  
      run: |
        cd frontend
        bun run test:run  # âŒ è„šæœ¬ä¸å­˜åœ¨ï¼Œä¼šå¯¼è‡´CIå¤±è´¥

    - name: Run backend tests
      run: |
        cd backend  
        bun run test:run  # âŒ è„šæœ¬ä¸å­˜åœ¨ï¼Œä¼šå¯¼è‡´CIå¤±è´¥

    # âœ… æ„å»ºæ­¥éª¤åŸºæœ¬æ­£ç¡®ï¼Œä½†å¯ä»¥ä¼˜åŒ–
    - name: Build frontend
      run: |
        cd frontend
        bun run build  # âœ… å­˜åœ¨ï¼Œä½†åº”è¯¥ä½¿ç”¨ build:prod

    - name: Build backend  # âš ï¸ åç«¯æ„å»ºåœ¨Chromeæ‰©å±•ä¸­æ„ä¹‰ä¸å¤§
      run: |
        cd backend
        bun run build  # âš ï¸ è¿™åªæ˜¯echoå‘½ä»¤ï¼Œå®é™…ä¸åšä»»ä½•äº‹

  # âŒ éƒ¨ç½²é˜¶æ®µé—®é¢˜å¾ˆå¤š
  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Install dependencies
      run: |
        cd frontend && bun install
        cd ../backend && bun install

    - name: Build for production
      run: |
        cd frontend && bun run build  # âŒ åº”è¯¥ä½¿ç”¨ build:prod
        cd ../backend && bun run build  # âŒ æ— å®é™…ä½œç”¨

    - name: Deploy to Vercel  # âŒ å®Œå…¨é”™è¯¯çš„éƒ¨ç½²ç›®æ ‡
      run: |
        # è¿™é‡Œå¯ä»¥æ·»åŠ Verceléƒ¨ç½²å‘½ä»¤
        echo "Ready for Vercel deployment"
        # âŒ Chromeæ‰©å±•åº”è¯¥éƒ¨ç½²åˆ°Chrome Web Storeï¼Œè€Œä¸æ˜¯Vercel

# ===================================================================
# ğŸ’¡ å»ºè®®çš„ä¿®å¤æ–¹æ¡ˆï¼š
# 1. ç§»é™¤ä¸å­˜åœ¨çš„æµ‹è¯•è„šæœ¬ï¼Œæˆ–æ·»åŠ å®é™…çš„æµ‹è¯•
# 2. ç®€åŒ–åç«¯æ„å»ºæµç¨‹ï¼Œæ˜ç¡®å…¶å¼€å‘è¾…åŠ©è§’è‰²
# 3. æ›´æ”¹éƒ¨ç½²ç›®æ ‡ä¸ºChrome Web Store
# 4. æ·»åŠ Chromeæ‰©å±•ç‰¹æœ‰çš„éªŒè¯æ­¥éª¤ï¼ˆmanifestéªŒè¯ã€åŒ…å¤§å°æ£€æŸ¥ç­‰ï¼‰
# 5. ä½¿ç”¨frozen-lockfileç¡®ä¿ä¾èµ–ç‰ˆæœ¬ä¸€è‡´æ€§
# 6. æ·»åŠ TypeScriptç±»å‹æ£€æŸ¥å’Œä»£ç è´¨é‡æ£€æŸ¥
# ===================================================================
