<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据恢复测试</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #da190b;
        }
        #result {
            margin-top: 20px;
            padding: 12px;
            background: #e8f5e9;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 14px;
        }
        .warning {
            background: #fff3cd;
            padding: 16px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
        }
        .info {
            background: #e3f2fd;
            padding: 16px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>🏥 数据恢复测试工具</h1>
        <p>这个页面用于测试 AcuityBookmarks 的数据健康检查和恢复功能</p>
    </div>

    <div class="info">
        <strong>📝 使用说明：</strong>
        <ol>
            <li>首先点击"检查数据健康"查看当前状态</li>
            <li>如果数据有问题，点击"自动恢复数据"</li>
            <li>恢复完成后，刷新 Management 页面查看效果</li>
        </ol>
    </div>

    <div class="card">
        <h2>操作区域</h2>
        <div>
            <button onclick="checkHealth()">检查数据健康</button>
            <button onclick="autoRecover()">自动恢复数据</button>
            <button onclick="manualRecover()">手动强制恢复</button>
            <button class="danger" onclick="clearConsole()">清空控制台</button>
        </div>
        <div id="result"></div>
    </div>

    <div class="warning">
        <strong>⚠️ 注意：</strong>
        <ul>
            <li>此工具需要在 Chrome 扩展环境中使用</li>
            <li>请确保已安装并启用 AcuityBookmarks 扩展</li>
            <li>恢复数据可能需要几秒钟时间，请耐心等待</li>
        </ul>
    </div>

    <script>
        const resultEl = document.getElementById('result');

        function log(message) {
            console.log(message);
            const timestamp = new Date().toLocaleTimeString();
            resultEl.textContent += `[${timestamp}] ${message}\n`;
        }

        function clearConsole() {
            resultEl.textContent = '';
            console.clear();
            log('✅ 控制台已清空');
        }

        async function checkHealth() {
            try {
                log('📊 开始检查数据健康...');
                
                if (!chrome?.runtime?.sendMessage) {
                    log('❌ 错误：Chrome runtime API 不可用');
                    log('   请确保此页面在扩展环境中运行');
                    return;
                }

                const response = await chrome.runtime.sendMessage({
                    type: 'CHECK_DATA_HEALTH'
                });

                log('📋 检查结果：');
                log(JSON.stringify(response, null, 2));

                if (response?.success && response?.result) {
                    const result = response.result;
                    log(`\n状态摘要：`);
                    log(`  ✓ 健康状态: ${result.healthy ? '✅ 健康' : '❌ 有问题'}`);
                    log(`  ✓ 书签数量: ${result.bookmarkCount}`);
                    log(`  ✓ 需要恢复: ${result.needsRecovery ? '是' : '否'}`);
                    if (result.issues && result.issues.length > 0) {
                        log(`  ✓ 问题列表:`);
                        result.issues.forEach(issue => log(`    - ${issue}`));
                    }
                }
            } catch (error) {
                log(`❌ 检查失败: ${error.message}`);
                console.error(error);
            }
        }

        async function autoRecover() {
            try {
                log('🔄 开始自动恢复数据...');
                
                if (!chrome?.runtime?.sendMessage) {
                    log('❌ 错误：Chrome runtime API 不可用');
                    return;
                }

                const response = await chrome.runtime.sendMessage({
                    type: 'AUTO_CHECK_AND_RECOVER'
                });

                log('📋 恢复结果：');
                log(JSON.stringify(response, null, 2));

                if (response?.success) {
                    if (response.recovered) {
                        log('\n✅ 数据已成功恢复！');
                        log('   请刷新 Management 页面查看恢复的数据');
                    } else {
                        log('\n✅ 数据健康，无需恢复');
                    }
                }
            } catch (error) {
                log(`❌ 恢复失败: ${error.message}`);
                console.error(error);
            }
        }

        async function manualRecover() {
            if (!confirm('确定要强制恢复数据吗？这将从 Chrome 书签 API 重新同步所有书签。')) {
                return;
            }

            try {
                log('⚠️ 开始强制恢复数据...');
                
                if (!chrome?.runtime?.sendMessage) {
                    log('❌ 错误：Chrome runtime API 不可用');
                    return;
                }

                const response = await chrome.runtime.sendMessage({
                    type: 'RECOVER_DATA'
                });

                log('📋 恢复结果：');
                log(JSON.stringify(response, null, 2));

                if (response?.success) {
                    log(`\n✅ 数据已成功恢复！`);
                    log(`   恢复了 ${response.bookmarkCount} 条书签`);
                    log('   请刷新 Management 页面查看恢复的数据');
                }
            } catch (error) {
                log(`❌ 恢复失败: ${error.message}`);
                console.error(error);
            }
        }

        // 页面加载时自动检查
        window.addEventListener('load', () => {
            log('🚀 测试工具已加载');
            log('   Chrome 扩展 API 可用: ' + (!!chrome?.runtime?.sendMessage ? '✅' : '❌'));
        });
    </script>
</body>
</html>

