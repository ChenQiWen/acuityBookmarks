#!/usr/bin/env sh

echo "ğŸ”§ pre-commit: è‡ªåŠ¨æ ¼å¼åŒ–ä¸ä»£ç è´¨é‡æ£€æŸ¥..."

# è·å–æš‚å­˜çš„æ–‡ä»¶åˆ—è¡¨
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo "âš ï¸  æ²¡æœ‰æš‚å­˜çš„æ–‡ä»¶éœ€è¦å¤„ç†"
    exit 0
fi

echo "ğŸ“„ æ£€æµ‹åˆ° $(echo "$STAGED_FILES" | wc -l | tr -d ' ') ä¸ªæš‚å­˜æ–‡ä»¶"

# 1. è¿è¡Œ Prettier æ ¼å¼åŒ– (format)
echo "ğŸ¨ æ­¥éª¤ 1/3: è¿è¡Œ Prettier æ ¼å¼åŒ–..."
if ! bun run format; then
    echo "âŒ Prettier æ ¼å¼åŒ–å¤±è´¥"
    exit 1
fi
echo "âœ… Prettier æ ¼å¼åŒ–å®Œæˆ"

# 2. è¿è¡Œ Stylelint è‡ªåŠ¨ä¿®å¤ (stylelint:fix)
echo "ğŸ’… æ­¥éª¤ 2/3: è¿è¡Œ Stylelint è‡ªåŠ¨ä¿®å¤..."
STYLE_FILES=$(echo "$STAGED_FILES" | grep -E '\.(vue|css|scss)$' || true)
if [ -n "$STYLE_FILES" ]; then
    if ! bun run stylelint:fix; then
        echo "âŒ Stylelint ä¿®å¤å¤±è´¥"
        exit 1
    fi
    echo "âœ… Stylelint ä¿®å¤å®Œæˆ"
else
    echo "â„¹ï¸  æ²¡æœ‰æ ·å¼æ–‡ä»¶éœ€è¦ Stylelint æ£€æŸ¥"
fi

# 3. è¿è¡Œ ESLint è‡ªåŠ¨ä¿®å¤ (lint:fix)
echo "ğŸ” æ­¥éª¤ 3/3: è¿è¡Œ ESLint è‡ªåŠ¨ä¿®å¤..."
LINT_FILES=$(echo "$STAGED_FILES" | grep -E '\.(js|ts|vue)$' || true)
if [ -n "$LINT_FILES" ]; then
    if ! bun run lint:fix; then
        echo "âŒ ESLint ä¿®å¤å¤±è´¥"
        exit 1
    fi
    echo "âœ… ESLint ä¿®å¤å®Œæˆ"
else
    echo "â„¹ï¸  æ²¡æœ‰ JS/TS/Vue æ–‡ä»¶éœ€è¦ ESLint æ£€æŸ¥"
fi

# 4. é‡æ–°æ·»åŠ ä¿®å¤åçš„æ–‡ä»¶åˆ°æš‚å­˜åŒº
echo "ğŸ“ é‡æ–°æ·»åŠ ä¿®å¤åçš„æ–‡ä»¶åˆ°æš‚å­˜åŒº..."
echo "$STAGED_FILES" | xargs git add

echo "ğŸ‰ æ‰€æœ‰ä»£ç è´¨é‡æ£€æŸ¥å®Œæˆï¼Œå¯ä»¥å®‰å…¨æäº¤ï¼"