---
alwaysApply: true
---

# AcuityBookmarks é¡¹ç›®è§„åˆ™

ç”¨ä¸­æ–‡å›å¤

## ğŸ”´ å·¥ä½œæµè§„èŒƒï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰

### 1. æ–‡æ¡£ç”Ÿæˆè§„åˆ™
- âŒ **ç¦æ­¢ä¸»åŠ¨ç”Ÿæˆä»»ä½•æ ¼å¼ç±»å‹çš„æ–‡æ¡£**ï¼ˆé™¤éç”¨æˆ·æ˜ç¡®è¦æ±‚ï¼‰
- âŒ ç¦æ­¢åˆ›å»º `.md`ã€`.txt`ã€`.doc` ç­‰æ–‡æ¡£æ–‡ä»¶
- âœ… åªåœ¨ç”¨æˆ·æ˜ç¡®è¦æ±‚æ—¶æ‰ç”Ÿæˆæ–‡æ¡£

### 2. ä»£ç ä¿®æ”¹åå¿…é¡»æ£€æŸ¥
**æ¯æ¬¡ä¿®æ”¹ä»£ç åï¼Œå¿…é¡»ç«‹å³è¿è¡Œä»¥ä¸‹å‘½ä»¤æ£€æŸ¥æ˜¯å¦äº§ç”Ÿæ–°é”™è¯¯ï¼š**

```bash
bun run typecheck:force    # TypeScript ç±»å‹æ£€æŸ¥
bun run lint:all          # ESLint + Stylelint æ£€æŸ¥
```

- âœ… å¦‚æœæœ‰é”™è¯¯ï¼Œå¿…é¡»ç«‹å³ä¿®å¤
- âœ… ç¡®è®¤æ— é”™è¯¯åæ‰ç®—å®Œæˆä¿®æ”¹

## ğŸ“š å¿…è¯»æ–‡æ¡£
- **äº§å“æ–‡æ¡£ï¼ˆæœ€é‡è¦ï¼‰**ï¼š`æ–‡æ¡£/äº§å“æ–‡æ¡£/AcuityBookmarks-äº§å“æ–‡æ¡£-v3.0.md`
- æ¶æ„å˜æ›´å¿…é¡»åŒæ­¥æ›´æ–°äº§å“æ–‡æ¡£

## ğŸš¨ æ ¸å¿ƒæ¶æ„åŸåˆ™ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰

### 1. å•å‘æ•°æ®æµï¼ˆç¦æ­¢è¿åï¼‰
```
Chrome API â†’ Background Script â†’ IndexedDB â†’ Pinia Store â†’ Vue Components
     â†‘                                                           â†“
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ chrome.runtime.sendMessage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é“å¾‹ï¼š**
- âœ… IndexedDB æ˜¯å”¯ä¸€æ•°æ®æº
- âœ… Background Script æ˜¯å”¯ä¸€ç›‘å¬è€…ï¼ˆ`background/bookmarks.ts`ï¼‰
- âœ… å‰ç«¯ç¦æ­¢ç›´æ¥è®¿é—® Chrome API
- âŒ ç¦æ­¢å‰ç«¯ç›´æ¥è°ƒç”¨ `chrome.bookmarks.*`

### 2. DDD åˆ†å±‚æ¶æ„ï¼ˆä¸¥æ ¼æ‰§è¡Œï¼‰
```
presentation/ â†’ application/ â†’ core/ â†’ infrastructure/
```
- âŒ `presentation/` ä¸èƒ½ç›´æ¥è®¿é—® `infrastructure/`
- âŒ `core/` ä¸èƒ½ä¾èµ– `infrastructure/`

### 3. IndexedDB ç®¡ç†å™¨ï¼ˆå”¯ä¸€å…¥å£ï¼‰
- è·¯å¾„ï¼š`frontend/src/infrastructure/indexeddb/manager.ts`
- âœ… æ‰€æœ‰ IndexedDB æ“ä½œå¿…é¡»é€šè¿‡ `indexedDBManager` å®ä¾‹
- âŒ ç¦æ­¢ç›´æ¥ä½¿ç”¨ `indexedDB.open()` æˆ–åŸç”Ÿ API

## ğŸ’¾ å­˜å‚¨æ–¹æ¡ˆèŒè´£åˆ’åˆ†

| å­˜å‚¨ç±»å‹ | ç”Ÿå‘½å‘¨æœŸ | ä½¿ç”¨åœºæ™¯ |
|---|---|---|
| IndexedDB | æ°¸ä¹… | ä¹¦ç­¾æ•°æ®ï¼ˆ2ä¸‡+ï¼‰ã€çˆ¬å–å…ƒæ•°æ® |
| chrome.storage.local | æ°¸ä¹… | ç”¨æˆ·åå¥½ã€æ‰©å±•é…ç½® |
| chrome.storage.session | ä¼šè¯çº§ | ä¸´æ—¶æ•°æ®ã€UI çŠ¶æ€ã€åŒæ­¥çŠ¶æ€ |
| Pinia Store | é¡µé¢çº§ | é«˜é¢‘ UI çŠ¶æ€ã€è®¡ç®—å±æ€§ |

**å†³ç­–æ ‘ï¼š**
1. æ•°æ®é‡ > 1000 æ¡ï¼Ÿâ†’ IndexedDB
2. éœ€è¦æµè§ˆå™¨å…³é—­åä¿ç•™ï¼Ÿâ†’ chrome.storage.local
3. éœ€è¦è·¨é¡µé¢å…±äº«ä½†ä¼šè¯ç»“æŸæ¸…é™¤ï¼Ÿâ†’ chrome.storage.session
4. ä»…å½“å‰é¡µé¢ä½¿ç”¨ä¸”åˆ·æ–°åå¯é‡å»ºï¼Ÿâ†’ Pinia Store

## ğŸ” é‡è¦ï¼šæœç´¢ vs ç­›é€‰

### âš ï¸ æœ¬é¡¹ç›®ä¸­ç»Ÿä¸€ä½¿ç”¨"ç­›é€‰"æ¦‚å¿µ

**ä¸ºä»€ä¹ˆä¸å«"æœç´¢"ï¼Ÿ**
- âœ… æ‰€æœ‰æ•°æ®éƒ½åœ¨æœ¬åœ° IndexedDBï¼ˆ2ä¸‡+ ä¹¦ç­¾ï¼‰
- âœ… ä¸å­˜åœ¨ç½‘ç»œè¯·æ±‚
- âœ… ä»å·²æœ‰é›†åˆä¸­è¿‡æ»¤ç¬¦åˆæ¡ä»¶çš„ä¹¦ç­¾
- âœ… è¿™æ˜¯"ç­›é€‰ï¼ˆFilterï¼‰"çš„å®šä¹‰ï¼Œè€Œé"æœç´¢ï¼ˆSearchï¼‰"

**æœ¯è¯­è§„èŒƒï¼š**
- âœ… å¯¹å¤–ï¼ˆUIã€APIã€æ–‡æ¡£ï¼‰ï¼š**ç­›é€‰ï¼ˆFilterï¼‰**
- âœ… å¯¹å†…ï¼ˆæŠ€æœ¯å®ç°ã€ä»£ç æ³¨é‡Šï¼‰ï¼šsearch/filter éƒ½å¯ä»¥
- âŒ ç¦æ­¢åœ¨ UI æ–‡æ¡ˆä¸­ä½¿ç”¨"æœç´¢"

**ç›¸å…³ç»„ä»¶ï¼š**
- `BookmarkFilter` ç»„ä»¶ï¼šä¹¦ç­¾ç­›é€‰ç»„ä»¶
- `useBookmarkFilter` Composableï¼šä¹¦ç­¾ç­›é€‰ hook
- `searchAppService`ï¼šåº•å±‚ç­›é€‰æœåŠ¡ï¼ˆæŠ€æœ¯æœ¯è¯­ä¿ç•™ï¼‰

## ğŸ› ï¸ æŠ€æœ¯æ ˆè§„èŒƒ

### å…³é”®å·¥å…·
- **Immer**ï¼š`updateMap(nodes, draft => {...})`ï¼ˆä¸å¯å˜çŠ¶æ€æ›´æ–°ï¼‰
- **mitt**ï¼š`emitEvent('bookmark:created', {...})`ï¼ˆäº‹ä»¶æ€»çº¿ï¼‰
- **VueUse**ï¼šä¼˜å…ˆä½¿ç”¨ `useEventListener`ã€`useDebounceFn`ã€`useTimeoutFn`
- **Zod**ï¼šæ‰€æœ‰å¤–éƒ¨æ•°æ®å¿…é¡»æ ¡éªŒ

### TypeScript è§„èŒƒ
- âŒ æ°¸ä¹…ç¦æ­¢ `any`ã€`as any`
- âœ… å¿…é¡»ä½¿ç”¨ Zod æ ¡éªŒå¤–éƒ¨æ•°æ®
- âœ… å¿…é¡»æ·»åŠ  JSDoc æ³¨é‡Šï¼ˆä¸­æ–‡ï¼‰

### Vue ç»„ä»¶è§„èŒƒ
- âœ… å¿…é¡»ä½¿ç”¨ `defineOptions({ name: 'ComponentName' })`
- âŒ ç¦æ­¢ç»„ä»¶å†…ç›´æ¥è°ƒç”¨ `chrome.bookmarks.*`
- âŒ ç¦æ­¢ç»„ä»¶å†…ç›´æ¥è°ƒç”¨ `indexedDB.open()`

## âš ï¸ å¸¸è§é”™è¯¯ï¼ˆç¦æ­¢ï¼ï¼‰

### 1. æ•°æ®æµé”™è¯¯
```typescript
// âŒ å‰ç«¯ç›´æ¥è°ƒç”¨ Chrome API
await chrome.bookmarks.create({ title: 'æ–°ä¹¦ç­¾' })

// âœ… é€šè¿‡ Background Script
await chrome.runtime.sendMessage({ type: 'CREATE_BOOKMARK', title: 'æ–°ä¹¦ç­¾' })
```

### 2. çŠ¶æ€æ›´æ–°é”™è¯¯
```typescript
// âŒ ç›´æ¥ä¿®æ”¹ Mapï¼ˆVue æ— æ³•æ£€æµ‹ï¼‰
nodes.value.set('123', newNode)

// âœ… ä½¿ç”¨ Immer
updateMap(nodes, draft => { draft.set('123', newNode) })
```

### 3. Service Worker å…¼å®¹æ€§é”™è¯¯ï¼ˆé‡è¦ï¼ï¼‰

**Background Script è¿è¡Œåœ¨ Service Worker ç¯å¢ƒï¼Œæ²¡æœ‰ `window`ã€`document`ã€`localStorage`ï¼**

| æ­£ç¡® âœ… | é”™è¯¯ âŒ |
|-----|-----|
| `setTimeout()` | `window.setTimeout()` |
| `fetch()` | `window.fetch()` |
| `chrome.storage.*` | `localStorage.*` |
| `ReturnType<typeof setTimeout>` | `number` (ç±»å‹) |

```typescript
// âŒ é”™è¯¯
private timer: number | null = null
this.timer = window.setTimeout(() => {...}, 1000)

// âœ… æ­£ç¡®
private timer: ReturnType<typeof setTimeout> | null = null
this.timer = setTimeout(() => {...}, 1000)
```

**å—å½±å“æ–‡ä»¶ï¼š**
- `frontend/src/background/**/*.ts`
- `frontend/src/services/**/*.ts`ï¼ˆå¦‚ `bookmark-sync-service.ts`ï¼‰

### 4. IndexedDB è·¯å¾„é”™è¯¯
```typescript
// âŒ æ—§è·¯å¾„
import { indexedDBManager } from '@/utils-legacy/indexeddb-manager'

// âœ… æ–°è·¯å¾„
import { indexedDBManager } from '@/infrastructure/indexeddb/manager'
```

### 5. ç¼ºå°‘ Zod æ ¡éªŒ
```typescript
// âŒ ç›´æ¥ä½¿ç”¨å¤–éƒ¨æ•°æ®
const bookmarks = await indexedDBManager.getAllBookmarks()

// âœ… å…ˆæ ¡éªŒ
const validated = BookmarkRecordArraySchema.parse(bookmarks)
```

### 6. æœ¯è¯­é”™è¯¯
```vue
<!-- âŒ UI ä¸­ä½¿ç”¨"æœç´¢" -->
<p>æœç´¢ä¹¦ç­¾...</p>
<Button>æœç´¢</Button>

<!-- âœ… ä½¿ç”¨"ç­›é€‰" -->
<p>ç­›é€‰ä¹¦ç­¾...</p>
<Button>ç­›é€‰</Button>
```

## âš¡ æ€§èƒ½è¦æ±‚

**ç›®æ ‡ï¼šæ”¯æŒ 2 ä¸‡ä¹¦ç­¾æµç•…æ“ä½œ**

- âœ… è™šæ‹Ÿæ»šåŠ¨ï¼šä½¿ç”¨ `@tanstack/vue-virtual`
- âœ… æ‰¹é‡æ“ä½œï¼šIndexedDB åˆ†æ‰¹ï¼ˆ2000/æ‰¹ï¼‰
- âœ… ç¼“å­˜æ ‘ç»“æ„ï¼š`flattenTreeToMap` è½¬ Mapï¼ˆO(1) æŸ¥æ‰¾ï¼‰
- âŒ ç¦æ­¢å…¨æ ‘é€’å½’éå†

## â±ï¸ é•¿è€—æ—¶ä»»åŠ¡è®¾è®¡åŸåˆ™

### æ ¸å¿ƒå“²å­¦
**çœŸå®è¿›åº¦ > å‡è¿›åº¦ > æ— åé¦ˆ**

### ä¸šåŠ¡åˆ†çº§
- ğŸ”´ **æ ¸å¿ƒä¸šåŠ¡**ï¼ˆä¹¦ç­¾åŒæ­¥ã€å¯¼å…¥ï¼‰ï¼šåŒæ­¥æ‰§è¡Œ + çœŸå®è¿›åº¦åé¦ˆ
  - å¿…é¡»æ˜¾ç¤ºï¼šé˜¶æ®µæŒ‡ç¤ºå™¨ + ç™¾åˆ†æ¯” + å½“å‰/æ€»æ•° + é¢„è®¡å‰©ä½™æ—¶é—´
  - åˆ†æ‰¹å†™å…¥ï¼šæ¯æ‰¹å `setTimeout(0)` è®©å‡ºä¸»çº¿ç¨‹
  
- ğŸŸ¡ **è¾…åŠ©ä¸šåŠ¡**ï¼ˆçˆ¬è™«ã€AI æ ‡ç­¾ã€å¥åº·æ‰«æï¼‰ï¼šWorker å¼‚æ­¥ + é˜Ÿåˆ—è°ƒåº¦
  - ä¼˜å…ˆçº§æ’åº + å¹¶å‘æ§åˆ¶ + å¯æš‚åœ/å–æ¶ˆ

**ç¦æ­¢ï¼š**
- âŒ æ ¸å¿ƒä¸šåŠ¡æ”¾åˆ° Workerï¼ˆæ•°æ®ä¸å®Œæ•´æ—¶æ— æ³•ä½¿ç”¨ï¼‰
- âŒ åªæœ‰è½¬åœˆåœˆï¼Œæ²¡æœ‰ç™¾åˆ†æ¯”å’Œé¢„è®¡æ—¶é—´
- âŒ å‡è¿›åº¦æ¡ï¼ˆä¸åŸºäºçœŸå®æ•°æ®ï¼‰

## ğŸ”§ å·¥å…·å‘½ä»¤

```bash
bun run typecheck:force          # ç±»å‹æ£€æŸ¥ï¼ˆæäº¤å‰å¿…é¡»ï¼‰
bun run lint:fix:enhanced        # ä»£ç è´¨é‡æ£€æŸ¥
bun run format                   # æ ¼å¼åŒ–
bun run build:hot                # çƒ­æ„å»º
```

## ğŸš€ æ ¸å¿ƒè¦ç‚¹æ€»ç»“

**è®°ä½è¿™ 5 ç‚¹ï¼Œé¿å… 95% çš„é”™è¯¯ï¼š**

1. **å•å‘æ•°æ®æµ**ï¼šChrome API â†’ Background â†’ IndexedDB â†’ UI
2. **IndexedDB å”¯ä¸€æ•°æ®æº**ï¼šæ‰€æœ‰ UI ä» IndexedDB è¯»å–
3. **ç¦æ­¢å‰ç«¯ç›´æ¥è®¿é—® Chrome API**ï¼šå¿…é¡»é€šè¿‡ Background Script
4. **Service Worker å…¼å®¹**ï¼šç¦æ­¢ä½¿ç”¨ `window.*`ã€`document.*`ã€`localStorage.*`
5. **æœ¯è¯­è§„èŒƒ**ï¼šUI ä¸­ä½¿ç”¨"ç­›é€‰"è€Œé"æœç´¢"

---

_æœ€åæ›´æ–°ï¼š2025-10-27_

