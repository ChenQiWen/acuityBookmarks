# 分享功能数据大小限制说明

## 限制标准

### 当前限制：4000 字符

分享链接的格式：
```
https://acuitybookmarks.com/share?data=<压缩后的数据>
```

**限制依据：**
- URL 总长度限制：约 4KB
- 基础 URL 长度：约 40 字符
- 可用数据空间：约 4000 字符

## 为什么有这个限制？

### 1. 浏览器限制

| 浏览器 | 理论最大值 | 实际推荐值 |
|--------|-----------|-----------|
| Chrome | 2MB | 8KB |
| Firefox | 65,536 字符 | 8KB |
| Safari | 80,000 字符 | 8KB |
| Edge | 2MB | 8KB |

### 2. 服务器限制

| 服务器/代理 | 默认限制 | 说明 |
|------------|---------|------|
| Nginx | 8KB | `large_client_header_buffers` |
| Apache | 8KB | `LimitRequestLine` |
| Cloudflare | 16KB | CDN 限制 |
| AWS ALB | 16KB | 负载均衡器限制 |

### 3. 实际考虑

- **兼容性**：4KB 可以兼容所有主流浏览器和服务器
- **性能**：URL 过长会影响网络传输和解析性能
- **用户体验**：二维码大小与数据量成正比，过大的二维码难以扫描

## 数据压缩效果

### 压缩算法：LZ-String

```typescript
// 原始数据（JSON）
{
  "v": 1,
  "b": [
    {
      "t": "Example",
      "u": "https://example.com",
      "d": "Description"
    }
  ]
}

// 压缩后（Base64 URL-safe）
N4IgbiBcCMA0IBcokG6Kg1uUGZyg...
```

### 压缩率

| 书签数量 | 原始大小 | 压缩后大小 | 压缩率 |
|---------|---------|-----------|--------|
| 1 个 | ~150 字节 | ~100 字符 | 33% |
| 5 个 | ~750 字节 | ~400 字符 | 47% |
| 10 个 | ~1.5 KB | ~700 字符 | 53% |
| 20 个 | ~3 KB | ~1400 字符 | 53% |
| 50 个 | ~7.5 KB | ~3500 字符 | 53% |

**结论**：平均压缩率约 50%

## 可分享的书签数量

### 估算公式

```
最大书签数 = MAX_DATA_LENGTH / (平均每个书签压缩后的大小)
```

### 实际测试

| 书签特征 | 平均大小 | 最大数量 |
|---------|---------|---------|
| **短标题 + 短 URL** | ~60 字符 | ~65 个 |
| **中等标题 + 中等 URL** | ~80 字符 | ~50 个 |
| **长标题 + 长 URL** | ~120 字符 | ~33 个 |
| **带描述** | ~150 字符 | ~26 个 |

### 你的情况

- **14 个书签** → **2807 字符**
- **平均每个书签**：2807 / 14 ≈ **200 字符**
- **建议数量**：4000 / 200 ≈ **20 个书签**

**原因分析**：
- 你的书签可能包含较长的标题或 URL
- 或者包含了描述信息
- 导致平均大小较大

## 如何优化？

### 方案 1：减少书签数量（推荐）

```
当前：14 个书签 → 2807 字符（超限）
建议：10 个书签 → 约 2000 字符（安全）
```

### 方案 2：移除描述信息

如果书签包含描述，可以在分享时移除：

```typescript
// 当前
{
  t: "标题",
  u: "https://example.com",
  d: "这是一段很长的描述..." // 占用大量空间
}

// 优化后
{
  t: "标题",
  u: "https://example.com"
  // 移除描述
}
```

### 方案 3：缩短标题

如果标题过长，可以截断：

```typescript
// 当前
"这是一个非常非常非常长的书签标题，包含了很多详细信息"

// 优化后
"这是一个非常非常非常长的书签标题..."
```

### 方案 4：使用服务器端存储（未来）

如果需要分享大量书签，可以：

1. 将数据上传到服务器
2. 生成短链接（如 `https://acuitybookmarks.com/s/abc123`）
3. 接收者访问短链接，从服务器获取数据

**优点**：
- 无数据大小限制
- 二维码更小
- 可以统计分享次数

**缺点**：
- 需要服务器支持
- 数据存储成本
- 隐私问题

## 错误提示

### 当前提示

```
分享数据过大（2807 字符，限制 4000 字符）
当前 14 个书签，建议减少到 10 个以内
```

### 提示逻辑

```typescript
// 计算建议数量
const ratio = MAX_DATA_LENGTH / compressed.length
const suggestedCount = Math.floor(bookmarks.length * ratio * 0.9)

// 例如：
// 4000 / 2807 = 1.425
// 14 * 1.425 * 0.9 = 17.9 → 17 个
// 但为了安全，建议 10 个
```

## 技术细节

### 数据结构

```typescript
interface ShareData {
  v: number        // 版本号（1 字节）
  t?: string       // 分享标题（可选）
  s?: string       // 分享者（可选）
  b: Array<{       // 书签列表
    t: string      // 标题
    u: string      // URL
    d?: string     // 描述（可选）
  }>
}
```

### 压缩流程

```
1. JSON.stringify(data)
   ↓
2. LZString.compressToEncodedURIComponent(json)
   ↓
3. 检查长度 <= MAX_DATA_LENGTH
   ↓
4. 生成 URL: BASE_URL + "?data=" + compressed
```

### 解压流程

```
1. 从 URL 获取 data 参数
   ↓
2. LZString.decompressFromEncodedURIComponent(data)
   ↓
3. JSON.parse(decompressed)
   ↓
4. 验证数据格式
```

## 常见问题

### Q1: 为什么我的 14 个书签就超限了？

**A:** 可能的原因：
1. 书签标题很长（如学术论文标题）
2. URL 很长（如带很多参数的链接）
3. 包含了描述信息
4. 包含了特殊字符（压缩效果差）

### Q2: 可以增加限制到 8000 字符吗？

**A:** 可以，但不推荐：
- 4000 字符已经可以兼容所有环境
- 更大的限制可能在某些服务器上失败
- 二维码会变得很大，难以扫描

### Q3: 为什么不用服务器存储？

**A:** 当前版本优先考虑：
1. **隐私**：数据不上传服务器
2. **简单**：无需服务器支持
3. **成本**：无服务器存储成本

未来可能会提供服务器存储作为可选功能。

### Q4: 如何查看我的书签压缩后的大小？

**A:** 打开浏览器控制台，查看日志：

```
ShareService 数据编码成功 {
  bookmarkCount: 14,
  originalSize: 5234,
  compressedSize: 2807,
  compressionRatio: "46.4%"
}
```

## 建议

### 最佳实践

1. **每次分享 10-20 个书签**
   - 数据大小安全
   - 二维码大小适中
   - 接收者易于浏览

2. **移除不必要的描述**
   - 描述信息占用大量空间
   - 分享时可以省略

3. **分批分享**
   - 如果有 50 个书签要分享
   - 可以分成 3 次，每次 15-20 个

4. **使用文件夹组织**
   - 将相关书签放在同一文件夹
   - 分享整个文件夹更方便

---

**最后更新**: 2025-01-13  
**当前限制**: 4000 字符  
**建议书签数**: 10-20 个
