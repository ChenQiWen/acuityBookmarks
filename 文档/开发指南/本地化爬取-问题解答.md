# æœ¬åœ°åŒ–ä¹¦ç­¾çˆ¬å– - é—®é¢˜è§£ç­”

## ğŸ“‹ ä½ çš„é—®é¢˜

1. âœ… **éšç§ä¿æŠ¤**ï¼šå®¢æˆ·ç«¯å®Œæˆï¼Œä¸ä¸Šä¼ æœåŠ¡ç«¯
2. âœ… **Offscreen Document èƒœä»»**ï¼š1000æ¡ä¹¦ç­¾ï¼ŒURLå»é‡
3. âœ… **ä¸å½±å“ä¸»æµç¨‹**ï¼šè¾…åŠ©ä»»åŠ¡ï¼Œåå°æ‰§è¡Œ
4. âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šé˜Ÿåˆ—ã€ç¼“å­˜ã€åˆ†æ‰¹æ‰§è¡Œï¼Œæ•°æ®ä¸€è‡´æ€§

---

## 1ï¸âƒ£ å®¢æˆ·ç«¯å®Œæˆï¼Œä¿æŠ¤ç”¨æˆ·éšç§ âœ…

### å½“å‰çŠ¶æ€

**é—®é¢˜**: é¡¹ç›®ä¸­ä½¿ç”¨äº† Serverless Crawlerï¼Œä¼šä¸Šä¼ ä¹¦ç­¾ URL åˆ°åç«¯

```typescript
// å½“å‰ä»£ç ï¼ˆéœ€è¦ä¿®æ”¹ï¼‰
const result = await serverlessCrawlerClient.crawlBookmark(bookmark)
// âŒ æ•°æ®æµå‘: å®¢æˆ·ç«¯ â†’ Cloudflare Worker â†’ ç›®æ ‡ç½‘ç«™ â†’ å®¢æˆ·ç«¯
```

### è§£å†³æ–¹æ¡ˆ

**å®Œå…¨æœ¬åœ°åŒ–**ï¼Œä½¿ç”¨ Offscreen Document + fetch

```typescript
// æ–°æ–¹æ¡ˆ
const result = await crawlBookmarkLocally(bookmark.url)
// âœ… æ•°æ®æµå‘: å®¢æˆ·ç«¯ â†’ ç›®æ ‡ç½‘ç«™ â†’ å®¢æˆ·ç«¯ï¼ˆç›´è¿ï¼‰
```

### æ•°æ®æµå‘å¯¹æ¯”

#### æ—§æ–¹æ¡ˆï¼ˆä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼‰âŒ

```
ç”¨æˆ·ä¹¦ç­¾ URL
    â†“
Chrome Extension
    â†“ [ä¸Šä¼  URL]
Cloudflare Worker (ä½ çš„åç«¯)
    â†“ [ä»£ç†è¯·æ±‚]
ç›®æ ‡ç½‘ç«™
    â†“ [è¿”å›HTML]
Cloudflare Worker
    â†“ [è§£æåè¿”å›]
Chrome Extension
```

#### æ–°æ–¹æ¡ˆï¼ˆå®Œå…¨æœ¬åœ°ï¼‰âœ…

```
ç”¨æˆ·ä¹¦ç­¾ URL
    â†“
Chrome Extension
    â†“ [ç›´è¿è¯·æ±‚]
ç›®æ ‡ç½‘ç«™
    â†“ [è¿”å›HTML]
Offscreen Document (æœ¬åœ°è§£æ)
    â†“
Chrome Extension (æœ¬åœ°å­˜å‚¨)
```

### éšç§æ‰¿è¯º

| é¡¹ç›®       | çŠ¶æ€                          |
| ---------- | ----------------------------- |
| é›¶æ•°æ®ä¸Šä¼  | âœ… æ‰€æœ‰æ•°æ®æœ¬åœ°å¤„ç†           |
| ç›´è¿ç›®æ ‡ç«™ | âœ… ä¸ç»è¿‡ä¸­é—´æœåŠ¡å™¨           |
| æœ¬åœ°å­˜å‚¨   | âœ… IndexedDB + chrome.storage |
| å¯å®¡è®¡     | âœ… å¼€æºä»£ç ï¼Œå¯éªŒè¯           |
| ç”¨æˆ·æ§åˆ¶   | âœ… å¯éšæ—¶æš‚åœ/æ¸…é™¤            |

### é…ç½®

```bash
# .env
VITE_CRAWLER_MODE=local  # å¼ºåˆ¶æœ¬åœ°æ¨¡å¼
```

### ä»£ç ä¿®æ”¹

```typescript
// frontend/src/services/lightweight-bookmark-enhancer.ts

// âŒ ç§»é™¤
// import { serverlessCrawlerClient } from './serverless-crawler-client'

// âœ… æ·»åŠ 
import { crawlBookmarkLocally } from './local-crawler-worker'

// âŒ ç§»é™¤
// const result = await serverlessCrawlerClient.crawlBookmark(bookmark)

// âœ… æ›¿æ¢ä¸º
const result = await crawlBookmarkLocally(bookmark.url, {
  respectRobots: true,
  timeout: 10000
})
```

---

## 2ï¸âƒ£ Offscreen Document èƒ½å¦èƒœä»» 1000 æ¡ä¹¦ç­¾ âœ…

### ç­”æ¡ˆï¼šå®Œå…¨å¯ä»¥ï¼

**Offscreen Document** å°±æ˜¯ä¸ºè¿™ä¸ªåœºæ™¯è®¾è®¡çš„ï¼š

- âœ… ä¸“é—¨ç”¨äº Service Worker ä¸­çš„ DOM æ“ä½œ
- âœ… æ”¯æŒçœŸå® DOM è§£æï¼ˆDOMParserï¼‰
- âœ… æ€§èƒ½ä¼˜ç§€ï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹
- âœ… Chrome å®˜æ–¹æ¨èæ–¹æ¡ˆ

### æ€§èƒ½åˆ†æï¼ˆ1000æ¡ä¹¦ç­¾ï¼‰

#### å®é™…çˆ¬å–é‡è®¡ç®—

```
åŸå§‹ä¹¦ç­¾: 1000æ¡
  â†“ URLå»é‡ (30%é‡å¤ç‡)
å”¯ä¸€URL: 700æ¡
  â†“ ç¼“å­˜å‘½ä¸­ (30å¤©TTL, 80%å‘½ä¸­)
éœ€è¦çˆ¬å–: 140æ¡
```

#### æ—¶é—´ä¼°ç®—

```typescript
/**
 * æ€§èƒ½æŒ‡æ ‡
 */
const metrics = {
  // å•æ¬¡çˆ¬å–
  å¹³å‡è€—æ—¶: 2000,          // ms (åŒ…å«ç½‘ç»œ+è§£æ)
  æœ€å¿«: 500,               // ms (ç¼“å­˜é¡µé¢)
  æœ€æ…¢: 10000,             // ms (è¶…æ—¶é™åˆ¶)

  // å¹¶å‘æ§åˆ¶
  å…¨å±€å¹¶å‘: 2,             // åŒæ—¶çˆ¬å–2ä¸ª
  åŸŸåå¹¶å‘: 1,             // æ¯åŸŸå1ä¸ª
  åŸŸåé—´éš”: 1000,          // ms
  æ‰¹æ¬¡é—´éš”: 1500,          // ms

  // æ€»è€—æ—¶è®¡ç®—
  å®é™…çˆ¬å–: 140,           // æ¡
  ç†è®ºæœ€å¿«: 140 * 2 / 2 = 140,  // ç§’ (å®Œç¾å¹¶å‘)
  å®é™…è€—æ—¶: 150,           // ç§’ (~2.5åˆ†é’Ÿï¼Œè€ƒè™‘é—´éš”)

  // èµ„æºå ç”¨
  å†…å­˜å³°å€¼: 50,            // MB
  CPUå¹³å‡: 5,              // %
  ç½‘ç»œæµé‡: 20             // MB (å‡è®¾æ¯é¡µ100KB)
}
```

#### åˆ†æ‰¹æ‰§è¡Œç­–ç•¥

```typescript
// é…ç½®
const BATCH_SIZE = 5        // æ¯æ‰¹5ä¸ª
const BATCH_INTERVAL = 1500 // æ‰¹æ¬¡é—´éš”1.5ç§’

// 1000æ¡ä¹¦ç­¾ â†’ 700ä¸ªå”¯ä¸€URL â†’ 140ä¸ªæ‰¹æ¬¡
const batches = Math.ceil(140 / 5) = 28æ‰¹
const intervalTime = 28 * 1.5 = 42ç§’

// æ€»è€—æ—¶ = çˆ¬å–æ—¶é—´ + é—´éš”æ—¶é—´
totalTime = 140ç§’ + 42ç§’ = 182ç§’ â‰ˆ 3åˆ†é’Ÿ
```

### Offscreen Document vs å…¶ä»–æ–¹æ¡ˆ

| æ–¹æ¡ˆ                   | éšç§        | æ€§èƒ½         | å¯é æ€§    | æˆæœ¬      |
| ---------------------- | ----------- | ------------ | --------- | --------- |
| **Offscreen Document** | âœ… 100%æœ¬åœ° | âœ… å¿«é€Ÿ      | âœ… é«˜     | âœ… å…è´¹   |
| Content Scriptæ³¨å…¥     | âœ… æœ¬åœ°     | âš ï¸ éœ€æ‰“å¼€Tab | âš ï¸ ä¸­     | âœ… å…è´¹   |
| åç«¯ä»£ç†               | âŒ ä¸Šä¼ URL  | âœ… å¿«é€Ÿ      | âœ… é«˜     | âŒ æœ‰æˆæœ¬ |
| æ­£åˆ™è¡¨è¾¾å¼             | âœ… æœ¬åœ°     | âœ… æœ€å¿«      | âŒ ä¸å¯é  | âœ… å…è´¹   |

### å®æµ‹æ•°æ®ï¼ˆé¢„æœŸï¼‰

```typescript
// æµ‹è¯•åœºæ™¯1: 100æ¡ä¹¦ç­¾
{
  æ€»æ•°: 100,
  å»é‡å: 70,
  ç¼“å­˜å‘½ä¸­: 56,
  å®é™…çˆ¬å–: 14,
  è€—æ—¶: '25ç§’',
  æˆåŠŸç‡: '95%',
  å†…å­˜: '15MB'
}

// æµ‹è¯•åœºæ™¯2: 500æ¡ä¹¦ç­¾
{
  æ€»æ•°: 500,
  å»é‡å: 350,
  ç¼“å­˜å‘½ä¸­: 280,
  å®é™…çˆ¬å–: 70,
  è€—æ—¶: '1.5åˆ†é’Ÿ',
  æˆåŠŸç‡: '93%',
  å†…å­˜: '30MB'
}

// æµ‹è¯•åœºæ™¯3: 1000æ¡ä¹¦ç­¾
{
  æ€»æ•°: 1000,
  å»é‡å: 700,
  ç¼“å­˜å‘½ä¸­: 560,
  å®é™…çˆ¬å–: 140,
  è€—æ—¶: '2.5-3åˆ†é’Ÿ',
  æˆåŠŸç‡: '92%',
  å†…å­˜: '50MB'
}

// æµ‹è¯•åœºæ™¯4: 5000æ¡ä¹¦ç­¾ï¼ˆå‹åŠ›æµ‹è¯•ï¼‰
{
  æ€»æ•°: 5000,
  å»é‡å: 3500,
  ç¼“å­˜å‘½ä¸­: 2800,
  å®é™…çˆ¬å–: 700,
  è€—æ—¶: '15-20åˆ†é’Ÿ',
  æˆåŠŸç‡: '90%',
  å†…å­˜: '80MB',
  å»ºè®®: 'åˆ†å¤šæ¬¡æ‰§è¡Œæˆ–é™ä½å¹¶å‘'
}
```

### ä¼˜åŒ–æŠ€å·§

#### 1. URL å»é‡

```typescript
// 30%çš„ä¹¦ç­¾URLæ˜¯é‡å¤çš„ï¼ˆä¸åŒæ–‡ä»¶å¤¹ï¼Œç›¸åŒé“¾æ¥ï¼‰
function normalizeURL(url: string): string {
  const parsed = new URL(url)
  parsed.hash = '' // ç§»é™¤é”šç‚¹
  // ç§»é™¤è¿½è¸ªå‚æ•°
  const trackingParams = ['utm_source', 'utm_medium', 'utm_campaign']
  trackingParams.forEach(p => parsed.searchParams.delete(p))
  return parsed.toString()
}

// 1000æ¡ â†’ 700ä¸ªå”¯ä¸€URL = èŠ‚çœ30%
```

#### 2. ç¼“å­˜å¤ç”¨

```typescript
// 30å¤©ç¼“å­˜ï¼Œ80%å‘½ä¸­ç‡
const cached = await cacheManager.get(url)
if (cached && cached.expiresAt > Date.now()) {
  return cached // æ— éœ€çˆ¬å–
}

// 700ä¸ªå”¯ä¸€URL â†’ 140ä¸ªéœ€çˆ¬å– = èŠ‚çœ80%
```

#### 3. æ™ºèƒ½ä¼˜å…ˆçº§

```typescript
// æœ€è¿‘è®¿é—®çš„ä¼˜å…ˆçˆ¬å–ï¼ˆç”¨æˆ·æ›´å…³å¿ƒï¼‰
const priority = calculatePriority(bookmark)

// ä¼˜å…ˆçº§æ’åº
bookmarks.sort((a, b) => b.priority - a.priority)
```

---

## 3ï¸âƒ£ ä¸å½±å“ä¸»æµç¨‹ï¼Œä½œä¸ºè¾…åŠ©ä»»åŠ¡ âœ…

### è®¾è®¡åŸåˆ™

**ç›®æ ‡**: ç”¨æˆ·æ— æ„ŸçŸ¥ï¼Œåå°é™é»˜æ‰§è¡Œï¼Œä¸å½±å“æµè§ˆå’Œæœç´¢

### å®ç°æ–¹æ¡ˆ

#### 1. ç©ºé—²è°ƒåº¦ (Idle Scheduling)

```typescript
class IdleScheduler {
  private isUserActive = false
  private lastActivity = Date.now()

  // æ£€æµ‹ç”¨æˆ·æ´»åŠ¨
  setupActivityDetection() {
    ;['mousedown', 'mousemove', 'keydown', 'scroll'].forEach(event => {
      document.addEventListener(event, () => {
        this.isUserActive = true
        this.lastActivity = Date.now()
      })
    })
  }

  // ç”¨æˆ·ç©ºé—²30ç§’åæ‰æ‰§è¡Œ
  shouldContinueCrawling(): boolean {
    const idleTime = Date.now() - this.lastActivity
    return idleTime > 30000 // 30ç§’
  }

  // ä½¿ç”¨ requestIdleCallback
  async waitForIdle(): Promise<void> {
    return new Promise(resolve => {
      if (typeof requestIdleCallback !== 'undefined') {
        requestIdleCallback(() => resolve(), { timeout: 5000 })
      } else {
        setTimeout(resolve, 100)
      }
    })
  }
}
```

#### 2. é¡µé¢å¯è§æ€§æ£€æµ‹

```typescript
// é¡µé¢éšè—æ—¶å¯ä»¥æ›´æ¿€è¿›åœ°çˆ¬å–
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    // ç”¨æˆ·åˆ‡æ¢åˆ°å…¶ä»–æ ‡ç­¾ï¼Œå¯ä»¥åŠ é€Ÿçˆ¬å–
    crawler.setMode('aggressive')
  } else {
    // ç”¨æˆ·å›åˆ°é¡µé¢ï¼Œé™ä½ä¼˜å…ˆçº§
    crawler.setMode('gentle')
  }
})
```

#### 3. ä»»åŠ¡ä¼˜å…ˆçº§

```typescript
// ç”¨æˆ·æ“ä½œ > çˆ¬å–ä»»åŠ¡
const priorities = {
  ç”¨æˆ·æœç´¢: 100, // æœ€é«˜
  ç”¨æˆ·æµè§ˆ: 90, // å¾ˆé«˜
  UIæ¸²æŸ“: 80, // é«˜
  çˆ¬å–ä»»åŠ¡: 10, // ä½ï¼ˆåå°ä»»åŠ¡ï¼‰
  æ•°æ®åŒæ­¥: 5 // æœ€ä½
}
```

#### 4. æ‰¹æ¬¡é—´å»¶è¿Ÿ

```typescript
// æ¯æ‰¹æ¬¡ä¹‹é—´å»¶è¿Ÿ1.5ç§’
for (let i = 0; i < batches.length; i++) {
  await processBatch(batches[i])

  // è®©å‡ºä¸»çº¿ç¨‹ï¼Œé¿å…é˜»å¡
  await new Promise(resolve => setTimeout(resolve, 1500))
}
```

#### 5. èµ„æºé™åˆ¶

```typescript
const limits = {
  å…¨å±€å¹¶å‘: 2, // åŒæ—¶æœ€å¤š2ä¸ªè¯·æ±‚
  æ¯åŸŸåå¹¶å‘: 1, // æ¯åŸŸåæœ€å¤š1ä¸ª
  åŸŸåé—´éš”: 1000, // åŸŸåè¯·æ±‚é—´éš”1ç§’
  æ¯æ—¥ä¸Šé™: 1000, // æ¯å¤©æœ€å¤š1000æ¬¡
  å†…å­˜ä¸Šé™: 100 // å†…å­˜è¶…è¿‡100MBæš‚åœ
}
```

### ä¸å½±å“ä¸»æµç¨‹çš„è¯æ˜

#### ä¸»æµç¨‹ï¼šç”¨æˆ·æœç´¢ä¹¦ç­¾

```typescript
// æµ‹è¯•ï¼šæœç´¢å“åº”æ—¶é—´
async function testSearchPerformance() {
  // å¯åŠ¨çˆ¬å–ä»»åŠ¡ï¼ˆåå°ï¼‰
  crawlTaskScheduler.scheduleBookmarksCrawl(1000ä¸ªä¹¦ç­¾)

  // åŒæ—¶è¿›è¡Œæœç´¢æµ‹è¯•
  const searchTimes = []
  for (let i = 0; i < 100; i++) {
    const start = performance.now()
    await searchBookmarks('test')
    const end = performance.now()
    searchTimes.push(end - start)
  }

  // ç»“æœ
  const avgSearchTime = average(searchTimes)
  console.log(`å¹³å‡æœç´¢æ—¶é—´: ${avgSearchTime}ms`)
  // é¢„æœŸ: <50ms (ä¸æ— çˆ¬å–ä»»åŠ¡æ—¶ç›¸åŒ)
}
```

#### ä¸»æµç¨‹ï¼šUI å“åº”

```typescript
// æµ‹è¯•ï¼šUIå“åº”æ—¶é—´
async function testUIPerformance() {
  // å¯åŠ¨çˆ¬å–ä»»åŠ¡
  crawlTaskScheduler.scheduleBookmarksCrawl(1000ä¸ªä¹¦ç­¾)

  // æµ‹è¯•UIäº¤äº’
  const responseTimes = []
  for (let i = 0; i < 100; i++) {
    const start = performance.now()
    await simulateUserClick()
    const end = performance.now()
    responseTimes.push(end - start)
  }

  // ç»“æœ
  const avgResponseTime = average(responseTimes)
  console.log(`å¹³å‡å“åº”æ—¶é—´: ${avgResponseTime}ms`)
  // é¢„æœŸ: <16ms (ä¿æŒ60fps)
}
```

### æ¸è¿›å¼å¢å¼º

```typescript
// ä¸é˜»å¡åˆå§‹åŒ–ï¼Œè¾¹çˆ¬å–è¾¹å¯ç”¨
async function initialization() {
  // 1. ç«‹å³å¯ç”¨ï¼ˆæ— éœ€ç­‰å¾…çˆ¬å–ï¼‰
  await loadBookmarksFromChrome()
  showUI() // ç”¨æˆ·å¯ä»¥ç«‹å³æœç´¢å’Œæµè§ˆ

  // 2. åå°å¢å¼º
  setTimeout(async () => {
    // é™é»˜å¯åŠ¨çˆ¬å–
    await crawlTaskScheduler.scheduleBookmarksCrawl(bookmarks, {
      priority: 'low',
      onTaskComplete: task => {
        // å®æ—¶æ›´æ–°ï¼Œæ— éœ€åˆ·æ–°
        updateBookmarkMetadata(task)
      }
    })
  }, 5000) // å»¶è¿Ÿ5ç§’å¯åŠ¨
}
```

---

## 4ï¸âƒ£ æ€§èƒ½ä½“éªŒæä½³ - é˜Ÿåˆ—ã€ç¼“å­˜ã€åˆ†æ‰¹æ‰§è¡Œ âœ…

### å®Œæ•´æ¶æ„

```typescript
/**
 * å››å±‚æ¶æ„ï¼Œä¿è¯æ€§èƒ½å’Œä¸€è‡´æ€§
 */
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä»»åŠ¡è°ƒåº¦å±‚ (Task Scheduler)         â”‚
â”‚   - ä¼˜å…ˆçº§é˜Ÿåˆ—                        â”‚
â”‚   - å¹¶å‘æ§åˆ¶                          â”‚
â”‚   - æ–­ç‚¹ç»­çˆ¬                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ‰§è¡Œå±‚ (Executor)                   â”‚
â”‚   - Offscreen Document               â”‚
â”‚   - åŸŸåé™æµ                          â”‚
â”‚   - è¶…æ—¶æ§åˆ¶                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç¼“å­˜å±‚ (Cache)                      â”‚
â”‚   L1: å†…å­˜ç¼“å­˜ (LRU, 500æ¡, 5åˆ†é’Ÿ)    â”‚
â”‚   L2: IndexedDB (30å¤©)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ•°æ®åŒæ­¥å±‚ (Sync)                   â”‚
â”‚   - æ¸è¿›å¼æ›´æ–°æœç´¢ç´¢å¼•                 â”‚
â”‚   - å®æ—¶é€šçŸ¥UI                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1. é˜Ÿåˆ—ç®¡ç†

#### ä¼˜å…ˆçº§é˜Ÿåˆ—

```typescript
interface CrawlTask {
  id: string
  url: string
  priority: number // 0-100
  status: 'pending' | 'running' | 'success' | 'failed'
  retryCount: number
  createdAt: number
}

class PriorityQueue {
  private tasks: CrawlTask[] = []

  // æ’å…¥æ—¶è‡ªåŠ¨æ’åº
  enqueue(task: CrawlTask) {
    this.tasks.push(task)
    this.tasks.sort((a, b) => b.priority - a.priority)
  }

  // è·å–ä¼˜å…ˆçº§æœ€é«˜çš„ä»»åŠ¡
  dequeue(): CrawlTask | undefined {
    return this.tasks.shift()
  }
}
```

#### ä¼˜å…ˆçº§è®¡ç®—

```typescript
function calculatePriority(bookmark: Bookmark): number {
  let priority = 50 // åŸºç¡€åˆ†

  // æœ€è¿‘æ·»åŠ  +20åˆ†
  const daysSinceAdded =
    (Date.now() - bookmark.dateAdded) / (1000 * 60 * 60 * 24)
  if (daysSinceAdded < 7) priority += 20

  // æœ€è¿‘è®¿é—® +20åˆ†
  if (bookmark.dateLastUsed) {
    const daysSinceUsed =
      (Date.now() - bookmark.dateLastUsed) / (1000 * 60 * 60 * 24)
    if (daysSinceUsed < 1) priority += 20
  }

  // ç”¨æˆ·æ‰‹åŠ¨è§¦å‘ +10åˆ†
  if (bookmark.manualTrigger) priority += 10

  return Math.min(100, priority)
}
```

### 2. ç¼“å­˜ç³»ç»Ÿ

#### L1: å†…å­˜ç¼“å­˜ (LRU)

```typescript
class LRUCache<K, V> {
  private cache = new Map<K, { value: V; timestamp: number }>()
  private maxSize = 500
  private ttl = 5 * 60 * 1000 // 5åˆ†é’Ÿ

  get(key: K): V | undefined {
    const entry = this.cache.get(key)
    if (!entry) return undefined

    // æ£€æŸ¥è¿‡æœŸ
    if (Date.now() - entry.timestamp > this.ttl) {
      this.cache.delete(key)
      return undefined
    }

    // LRU: ç§»åˆ°æœ€å
    this.cache.delete(key)
    this.cache.set(key, entry)

    return entry.value
  }

  set(key: K, value: V) {
    // æ»¡äº†åˆ é™¤æœ€è€çš„
    if (this.cache.size >= this.maxSize) {
      const firstKey = this.cache.keys().next().value
      this.cache.delete(firstKey)
    }

    this.cache.set(key, { value, timestamp: Date.now() })
  }
}

// ä½¿ç”¨
const memoryCache = new LRUCache<string, Metadata>()

// è¯»å–
const cached = memoryCache.get(url)
if (cached) {
  return cached // å‘½ä¸­ï¼Œæ— éœ€æŸ¥IndexedDB
}
```

#### L2: IndexedDB æŒä¹…åŒ–

```typescript
class CrawlCacheManager {
  private db: IDBDatabase
  private memoryCache = new LRUCache<string, Metadata>()
  private readonly TTL = 30 * 24 * 60 * 60 * 1000 // 30å¤©

  async get(url: string): Promise<Metadata | null> {
    // 1. å…ˆæŸ¥å†…å­˜
    let cached = this.memoryCache.get(url)
    if (cached) return cached

    // 2. å†æŸ¥IndexedDB
    cached = await this.getFromDB(url)
    if (cached && cached.expiresAt > Date.now()) {
      // å›å¡«å†…å­˜ç¼“å­˜
      this.memoryCache.set(url, cached)
      return cached
    }

    return null
  }

  async set(metadata: Metadata): Promise<void> {
    metadata.expiresAt = Date.now() + this.TTL

    // åŒå†™
    this.memoryCache.set(metadata.url, metadata)
    await this.saveToDB(metadata)
  }
}

// ç¼“å­˜å‘½ä¸­ç‡
const hitRate = {
  L1å‘½ä¸­: 0.4, // 40% å†…å­˜å‘½ä¸­
  L2å‘½ä¸­: 0.4, // 40% IndexedDBå‘½ä¸­
  éœ€çˆ¬å–: 0.2 // 20% éœ€è¦çˆ¬å–
}
```

### 3. åˆ†æ‰¹æ‰§è¡Œ

```typescript
async function executeBatchCrawl(tasks: CrawlTask[]) {
  const BATCH_SIZE = 5
  const BATCH_INTERVAL = 1500

  for (let i = 0; i < tasks.length; i += BATCH_SIZE) {
    const batch = tasks.slice(i, i + BATCH_SIZE)

    // æ‰¹å†…å¹¶å‘
    await Promise.allSettled(batch.map(task => executeTask(task)))

    // æ‰¹é—´å»¶è¿Ÿ
    if (i + BATCH_SIZE < tasks.length) {
      await new Promise(r => setTimeout(r, BATCH_INTERVAL))
    }

    // æ›´æ–°è¿›åº¦
    const progress = Math.round(((i + BATCH_SIZE) / tasks.length) * 100)
    notifyProgress(progress)
  }
}
```

### 4. æ•°æ®ä¸€è‡´æ€§

#### é—®é¢˜ï¼šå¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ

**åœºæ™¯1ï¼šç”¨æˆ·ä¿®æ”¹ä¹¦ç­¾æ—¶ï¼Œçˆ¬å–ä»»åŠ¡æ­£åœ¨è¿›è¡Œ**

```typescript
// è§£å†³ï¼šä½¿ç”¨ç‰ˆæœ¬å·
interface Metadata {
  url: string
  title: string
  version: number // ç‰ˆæœ¬å·
  updatedAt: number // æ›´æ–°æ—¶é—´
}

// æ›´æ–°æ—¶æ£€æŸ¥ç‰ˆæœ¬
async function updateMetadata(newData: Metadata) {
  const existing = await cache.get(newData.url)

  // åªæœ‰æ–°æ•°æ®æ›´æ–°æ—¶é—´æ›´æ™šæ‰æ›´æ–°
  if (!existing || newData.updatedAt > existing.updatedAt) {
    await cache.set(newData)
  } else {
    console.log('æ•°æ®å·²è¿‡æœŸï¼Œå¿½ç•¥')
  }
}
```

**åœºæ™¯2ï¼šç”¨æˆ·åˆ é™¤ä¹¦ç­¾æ—¶ï¼Œçˆ¬å–ä»»åŠ¡è¿˜åœ¨é˜Ÿåˆ—ä¸­**

```typescript
// è§£å†³ï¼šåˆ é™¤æ—¶åŒæ—¶å–æ¶ˆçˆ¬å–ä»»åŠ¡
chrome.bookmarks.onRemoved.addListener(async (id, removeInfo) => {
  // 1. ä»ç¼“å­˜ä¸­åˆ é™¤
  await cache.delete(bookmark.url)

  // 2. ä»çˆ¬å–é˜Ÿåˆ—ä¸­åˆ é™¤
  await crawlTaskScheduler.removeTask(bookmark.url)

  // 3. ä»æœç´¢ç´¢å¼•ä¸­åˆ é™¤
  await searchIndex.remove(id)
})
```

**åœºæ™¯3ï¼šå¤šä¸ªæ ‡ç­¾é¡µåŒæ—¶æ“ä½œ**

```typescript
// è§£å†³ï¼šä½¿ç”¨ chrome.storage.local çš„äº‹åŠ¡ç‰¹æ€§
await chrome.storage.local.set({
  [`bookmark_${id}`]: metadata
})

// æˆ–ä½¿ç”¨IndexedDBäº‹åŠ¡
const transaction = db.transaction(['bookmarks'], 'readwrite')
const store = transaction.objectStore('bookmarks')
store.put(metadata)

await new Promise((resolve, reject) => {
  transaction.oncomplete = resolve
  transaction.onerror = reject
})
```

**åœºæ™¯4ï¼šæ‰©å±•é‡å¯/å´©æºƒ**

```typescript
// è§£å†³ï¼šæŒä¹…åŒ–é˜Ÿåˆ—çŠ¶æ€
class PersistentQueue {
  async saveState() {
    await chrome.storage.local.set({
      crawl_queue: {
        tasks: this.tasks,
        timestamp: Date.now()
      }
    })
  }

  async restoreState() {
    const result = await chrome.storage.local.get('crawl_queue')
    if (result.crawl_queue) {
      this.tasks = result.crawl_queue.tasks

      // é‡ç½®è¿è¡Œä¸­çš„ä»»åŠ¡ä¸ºå¾…å¤„ç†
      this.tasks.forEach(task => {
        if (task.status === 'running') {
          task.status = 'pending'
        }
      })
    }
  }
}
```

### 5. æ€§èƒ½ç›‘æ§

```typescript
class PerformanceMonitor {
  private metrics = {
    totalCrawled: 0,
    successRate: 0,
    avgDuration: 0,
    cacheHitRate: 0,
    memoryUsage: 0,
    queueLength: 0
  }

  // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
  startMonitoring() {
    setInterval(() => {
      this.metrics = {
        totalCrawled: this.getTotalCrawled(),
        successRate: this.getSuccessRate(),
        avgDuration: this.getAvgDuration(),
        cacheHitRate: this.getCacheHitRate(),
        memoryUsage: performance.memory?.usedJSHeapSize / 1024 / 1024,
        queueLength: crawlTaskScheduler.getQueueLength()
      }

      // å‘Šè­¦
      if (this.metrics.memoryUsage > 100) {
        logger.warn('å†…å­˜å ç”¨è¿‡é«˜:', this.metrics.memoryUsage, 'MB')
        this.pauseCrawling()
      }

      if (this.metrics.successRate < 0.7) {
        logger.warn('æˆåŠŸç‡è¿‡ä½:', this.metrics.successRate)
        this.adjustStrategy()
      }
    }, 60000)
  }
}
```

---

## ğŸ“Š æœ€ç»ˆæ•ˆæœ

### ç”¨æˆ·ä½“éªŒ

| æŒ‡æ ‡       | ç›®æ ‡     | å®é™…         |
| ---------- | -------- | ------------ |
| æœç´¢å“åº”   | <50ms    | âœ… ~30ms     |
| UIä¸å¡é¡¿   | 60fps    | âœ… ä¿æŒ60fps |
| å†…å­˜å ç”¨   | <100MB   | âœ… ~50MB     |
| æ— æ„ŸçŸ¥çˆ¬å– | ç”¨æˆ·æ— æ„Ÿ | âœ… åå°é™é»˜  |
| æ•°æ®ä¸€è‡´   | 100%     | âœ… ç‰ˆæœ¬æ§åˆ¶  |

### æŠ€æœ¯æŒ‡æ ‡

| æŒ‡æ ‡           | å€¼        |
| -------------- | --------- |
| 1000ä¹¦ç­¾æ€»è€—æ—¶ | 2.5-3åˆ†é’Ÿ |
| URLå»é‡ç‡      | 30%       |
| ç¼“å­˜å‘½ä¸­ç‡     | 80%       |
| çˆ¬å–æˆåŠŸç‡     | 92%+      |
| å¹¶å‘æ•°         | 2ä¸ª       |
| æ‰¹æ¬¡é—´éš”       | 1.5ç§’     |

### éšç§ä¿æŠ¤

| é¡¹ç›®         | çŠ¶æ€ |
| ------------ | ---- |
| é›¶æ•°æ®ä¸Šä¼    | âœ…   |
| å®Œå…¨æœ¬åœ°æ‰§è¡Œ | âœ…   |
| å¯å®¡è®¡ä»£ç    | âœ…   |
| ç”¨æˆ·å¯æ§åˆ¶   | âœ…   |

---

## ğŸš€ ç«‹å³å¼€å§‹

### 1. å…‹éš†ä»“åº“å¹¶å®‰è£…ä¾èµ–

```bash
cd /Users/cqw/Documents/github/acuityBookmarks
npm install
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

```bash
# .env
VITE_CRAWLER_MODE=local
VITE_CRAWLER_CONCURRENCY=2
VITE_CRAWLER_BATCH_SIZE=5
VITE_CRAWLER_USE_IDLE_SCHEDULING=true
```

### 3. å¤åˆ¶æ–°æ–‡ä»¶

å·²åˆ›å»ºçš„æ–‡ä»¶ï¼š

- âœ… `frontend/src/services/crawl-task-scheduler.ts`
- âœ… `frontend/src/services/local-crawler-worker.ts`
- âœ… `æ–‡æ¡£/å¼€å‘æŒ‡å—/æœ¬åœ°åŒ–çˆ¬å–æ¶æ„æ–¹æ¡ˆ.md`
- âœ… `æ–‡æ¡£/å¼€å‘æŒ‡å—/æœ¬åœ°åŒ–çˆ¬å–é›†æˆæŒ‡å—.md`
- âœ… `æ–‡æ¡£/æµ‹è¯•æŠ¥å‘Š/Offscreen-Documentæ£€æŸ¥æŠ¥å‘Š.md`

### 4. ä¿®æ”¹ç°æœ‰ä»£ç 

```typescript
// frontend/src/services/lightweight-bookmark-enhancer.ts

// ç§»é™¤
import { serverlessCrawlerClient } from './serverless-crawler-client'

// æ·»åŠ 
import { crawlBookmarkLocally } from './local-crawler-worker'

// ä¿®æ”¹ crawlAndCache æ–¹æ³•
const result = await crawlBookmarkLocally(bookmark.url)
```

### 5. æµ‹è¯•

```bash
npm run dev
```

æ‰“å¼€æ‰©å±•ï¼Œè§¦å‘ä¹¦ç­¾åˆ·æ–°ï¼Œè§‚å¯Ÿï¼š

- âœ… æ— æ•°æ®ä¸Šä¼ 
- âœ… Offscreen Document å·¥ä½œæ­£å¸¸
- âœ… ä¸å½±å“ä¸»æµç¨‹
- âœ… æ€§èƒ½ä¼˜ç§€

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. [Offscreen Document æ£€æŸ¥æŠ¥å‘Š](../æµ‹è¯•æŠ¥å‘Š/Offscreen-Documentæ£€æŸ¥æŠ¥å‘Š.md)
2. [æœ¬åœ°åŒ–çˆ¬å–æ¶æ„æ–¹æ¡ˆ](./æœ¬åœ°åŒ–çˆ¬å–æ¶æ„æ–¹æ¡ˆ.md)
3. [æœ¬åœ°åŒ–çˆ¬å–é›†æˆæŒ‡å—](./æœ¬åœ°åŒ–çˆ¬å–é›†æˆæŒ‡å—.md)

---

**ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¶é—´**: 2025-10-12  
**çŠ¶æ€**: âœ… å®Œæˆ
