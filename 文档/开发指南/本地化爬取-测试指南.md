# æœ¬åœ°åŒ–çˆ¬å– - æµ‹è¯•æŒ‡å—

## ğŸ¯ æµ‹è¯•ç›®æ ‡

éªŒè¯æœ¬åœ°åŒ–çˆ¬å–åŠŸèƒ½çš„å®Œæ•´æ€§ï¼š

- âœ… Offscreen Document æ˜¯å¦æ­£å¸¸å·¥ä½œ
- âœ… æ•°æ®æ˜¯å¦æ­£ç¡®ä¿å­˜åˆ° IndexedDB
- âœ… é˜Ÿåˆ—å’Œå¹¶å‘æ§åˆ¶æ˜¯å¦æœ‰æ•ˆ
- âœ… å¤§æ‰¹é‡ä¹¦ç­¾æ€§èƒ½è¡¨ç°

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹å¼ä¸€ï¼šæµè§ˆå™¨æ§åˆ¶å°ï¼ˆæ¨èï¼‰

#### 1. åŠ è½½æ‰©å±•

```bash
# æ„å»ºæ‰©å±•
cd /Users/cqw/Documents/github/acuityBookmarks/frontend
npm run build

# Chrome æµè§ˆå™¨
# æ‰“å¼€ chrome://extensions
# å¯ç”¨"å¼€å‘è€…æ¨¡å¼"
# ç‚¹å‡»"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"
# é€‰æ‹© dist æ–‡ä»¶å¤¹
```

#### 2. æ‰“å¼€æ§åˆ¶å°

```
æ–¹å¼ A: å³é”®æ‰©å±•å›¾æ ‡ â†’ æ£€æŸ¥å¼¹å‡ºå†…å®¹
æ–¹å¼ B: è¿›å…¥ Management é¡µé¢ â†’ F12 æ‰“å¼€æ§åˆ¶å°
æ–¹å¼ C: chrome://extensions â†’ Service Worker â†’ æ§åˆ¶å°
```

#### 3. å¯¼å…¥æµ‹è¯•æ¨¡å—

```javascript
// åœ¨æ§åˆ¶å°ä¸­æ‰§è¡Œ
const {
  crawlSingleBookmark,
  crawlMultipleBookmarks,
  getCrawlStatistics,
  getBookmarkMetadata
} = await import('./assets/app-services.CvlJmFwV.js')

// æˆ–è€…ä½¿ç”¨å…¨å±€å¿«æ·æ–¹å¼ï¼ˆå¦‚æœå·²æš´éœ²ï¼‰
const crawler = window.bookmarkCrawler
```

---

## ğŸ“ æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1: æµ‹è¯•å•ä¸ª URL

```javascript
// æµ‹è¯•çˆ¬å–ä¸€ä¸ª URL
await crawler.testUrl('https://github.com')

// æŸ¥çœ‹ç»“æœ
const metadata = await crawler.getStats()
console.log('çˆ¬å–ç»Ÿè®¡:', metadata)
```

**é¢„æœŸç»“æœ**ï¼š

- âœ… æ§åˆ¶å°æ˜¾ç¤ºçˆ¬å–è¿›åº¦
- âœ… æ˜¾ç¤ºæå–çš„æ ‡é¢˜ã€æè¿°ã€keywords
- âœ… æ— é”™è¯¯ä¿¡æ¯

---

### åœºæ™¯ 2: çˆ¬å–å•ä¸ªçœŸå®ä¹¦ç­¾

```javascript
// 1. è·å–ä¸€ä¸ªä¹¦ç­¾
const bookmarks = await chrome.bookmarks.search({ url: 'https://github.com' })
const bookmark = bookmarks[0]

console.log('å¾…æµ‹è¯•ä¹¦ç­¾:', bookmark)

// 2. çˆ¬å–
const { crawlSingleBookmark } = await import(
  './services/local-bookmark-crawler'
)
await crawlSingleBookmark(bookmark, { priority: 'high' })

// 3. æ£€æŸ¥ç»“æœ
const { getBookmarkMetadata } = await import(
  './services/local-bookmark-crawler'
)
const metadata = await getBookmarkMetadata(bookmark.id)

console.log('çˆ¬å–å…ƒæ•°æ®:', metadata)
console.log('âœ… é¡µé¢æ ‡é¢˜:', metadata?.pageTitle)
console.log('âœ… æè¿°:', metadata?.description)
console.log('âœ… å…³é”®è¯:', metadata?.keywords)
console.log('âœ… OG å›¾ç‰‡:', metadata?.ogImage)
```

**é¢„æœŸç»“æœ**ï¼š

```javascript
{
  bookmarkId: "123",
  url: "https://github.com",
  pageTitle: "GitHub: Let's build from here",
  description: "GitHub is where over 100 million developers...",
  keywords: "git,github,code,repository",
  ogTitle: "GitHub",
  ogDescription: "...",
  ogImage: "https://github.githubassets.com/...",
  status: "success",
  httpStatus: 200,
  lastCrawled: 1697123456789,
  crawlSuccess: true
}
```

---

### åœºæ™¯ 3: æ‰¹é‡çˆ¬å–ï¼ˆ10æ¡ï¼‰

```javascript
// 1. è·å– 10 ä¸ªä¹¦ç­¾
const allBookmarks = await chrome.bookmarks.search({})
const testBookmarks = allBookmarks
  .filter(b => b.url) // åªè¦æœ‰ URL çš„
  .slice(0, 10)

console.log(`ğŸ“š å‡†å¤‡çˆ¬å– ${testBookmarks.length} ä¸ªä¹¦ç­¾`)

// 2. æ‰¹é‡çˆ¬å–
const { crawlMultipleBookmarks } = await import(
  './services/local-bookmark-crawler'
)

await crawlMultipleBookmarks(testBookmarks, {
  priority: 'normal',
  onProgress: (completed, total) => {
    console.log(`ğŸ“Š è¿›åº¦: ${completed}/${total}`)
  },
  onComplete: results => {
    const success = results.filter(r => r.success).length
    console.log(`âœ… å®Œæˆ: ${success}/${results.length}`)
    console.log('è¯¦ç»†ç»“æœ:', results)
  }
})

// 3. æŸ¥çœ‹ç»Ÿè®¡
const { getCrawlStatistics } = await import('./services/local-bookmark-crawler')
const stats = await getCrawlStatistics()
console.log('ğŸ“Š çˆ¬å–ç»Ÿè®¡:', stats)
```

**é¢„æœŸè¾“å‡º**ï¼š

```
ğŸ“š å‡†å¤‡çˆ¬å– 10 ä¸ªä¹¦ç­¾
ğŸ“Š è¿›åº¦: 1/10
ğŸ“Š è¿›åº¦: 2/10
...
ğŸ“Š è¿›åº¦: 10/10
âœ… å®Œæˆ: 9/10

ğŸ“Š çˆ¬å–ç»Ÿè®¡: {
  total: 10,
  withMetadata: 9,
  failed: 1,
  pending: 0,
  expired: 0
}
```

---

### åœºæ™¯ 4: å¢é‡çˆ¬å–æœªå¤„ç†çš„ä¹¦ç­¾

```javascript
// ä½¿ç”¨è§¦å‘å™¨å·¥å…·
const { crawlUnprocessedBookmarks, getCrawlStatus } = await import(
  './services/bookmark-crawler-trigger'
)

// 1. æŸ¥çœ‹å½“å‰çŠ¶æ€
const status = await getCrawlStatus()
console.log('ğŸ“Š å½“å‰çŠ¶æ€:', status)
/*
{
  total: 1523,          // æ€»ä¹¦ç­¾æ•°
  withMetadata: 234,    // å·²æœ‰å…ƒæ•°æ®
  pending: 1289,        // å¾…çˆ¬å–
  expired: 45,          // è¿‡æœŸéœ€é‡æ–°çˆ¬å–
  successRate: 95.5     // æˆåŠŸç‡
}
*/

// 2. çˆ¬å–å‰ 100 ä¸ªæœªå¤„ç†çš„
await crawlUnprocessedBookmarks(100)

// 3. å†æ¬¡æ£€æŸ¥çŠ¶æ€
const newStatus = await getCrawlStatus()
console.log('ğŸ“Š æ›´æ–°åçŠ¶æ€:', newStatus)
```

**é¢„æœŸè¡Œä¸º**ï¼š

- âœ… åªçˆ¬å–æ²¡æœ‰å…ƒæ•°æ®æˆ–è¿‡æœŸçš„ä¹¦ç­¾
- âœ… è·³è¿‡å·²æœ‰å…ƒæ•°æ®çš„ä¹¦ç­¾
- âœ… è¿›åº¦å®æ—¶æ˜¾ç¤º

---

### åœºæ™¯ 5: æ€§èƒ½æµ‹è¯•ï¼ˆå¤§æ‰¹é‡ï¼‰

```javascript
// âš ï¸ æ³¨æ„ï¼šè¿™ä¼šçˆ¬å–å¤§é‡ä¹¦ç­¾ï¼Œå»ºè®®åœ¨ç©ºé—²æ—¶æµ‹è¯•

// 1. è·å–æ‰€æœ‰ä¹¦ç­¾
const allBookmarks = await chrome.bookmarks.search({})
const urlBookmarks = allBookmarks.filter(b => b.url)

console.log(`ğŸ“š å…± ${urlBookmarks.length} ä¸ªä¹¦ç­¾`)

// 2. åˆ†æ‰¹æµ‹è¯•ï¼ˆæ¯æ¬¡ 50 ä¸ªï¼‰
const batchSize = 50
for (
  let i = 0;
  i < Math.min(10, Math.ceil(urlBookmarks.length / batchSize));
  i++
) {
  const batch = urlBookmarks.slice(i * batchSize, (i + 1) * batchSize)

  console.log(`\nğŸ”„ æ‰¹æ¬¡ ${i + 1}: ${batch.length} ä¸ªä¹¦ç­¾`)
  const startTime = Date.now()

  await crawlMultipleBookmarks(batch, {
    priority: 'low',
    onProgress: (completed, total) => {
      if (completed % 10 === 0) {
        console.log(`  ğŸ“Š ${completed}/${total}`)
      }
    }
  })

  const duration = Date.now() - startTime
  console.log(`  â±ï¸ è€—æ—¶: ${(duration / 1000).toFixed(1)}ç§’`)
  console.log(`  âš¡ å¹³å‡: ${(duration / batch.length).toFixed(0)}ms/ä¸ª`)

  // æ‰¹æ¬¡é—´éš” 5 ç§’
  await new Promise(resolve => setTimeout(resolve, 5000))
}

// 3. æœ€ç»ˆç»Ÿè®¡
const finalStats = await getCrawlStatistics()
console.log('\nğŸ“Š æœ€ç»ˆç»Ÿè®¡:', finalStats)
```

**æ€§èƒ½åŸºå‡†**ï¼ˆå‚è€ƒï¼‰ï¼š

- å•ä¸ªä¹¦ç­¾: 500-2000ms
- 50 ä¸ªä¹¦ç­¾: 30-60 ç§’
- 1000 ä¸ªä¹¦ç­¾: 10-20 åˆ†é’Ÿ

---

### åœºæ™¯ 6: éªŒè¯æ•°æ®æŒä¹…åŒ–

```javascript
// 1. çˆ¬å–ä¸€ä¸ªä¹¦ç­¾
const bookmark = (await chrome.bookmarks.search({}))[0]
await crawlSingleBookmark(bookmark)

// 2. æ£€æŸ¥ crawlMetadata è¡¨
const { indexedDBManager } = await import('./infrastructure/indexeddb/manager')
await indexedDBManager.initialize()

const metadata = await indexedDBManager.getCrawlMetadata(bookmark.id)
console.log('âœ… crawlMetadata è¡¨:', metadata)

// 3. æ£€æŸ¥ bookmarks è¡¨çš„å…³è”å­—æ®µ
const bookmarkRecord = await indexedDBManager.getBookmarkById(bookmark.id)
console.log('âœ… bookmarks è¡¨å…³è”å­—æ®µ:')
console.log('  hasMetadata:', bookmarkRecord.hasMetadata)
console.log('  metadataUpdatedAt:', new Date(bookmarkRecord.metadataUpdatedAt))
console.log('  metaTitleLower:', bookmarkRecord.metaTitleLower)
console.log('  metaDescriptionLower:', bookmarkRecord.metaDescriptionLower)
console.log('  metaKeywordsTokens:', bookmarkRecord.metaKeywordsTokens)
console.log('  metaBoost:', bookmarkRecord.metaBoost)

// 4. éªŒè¯æœç´¢å¢å¼º
const searchResults = await indexedDBManager.searchBookmarks({
  query: bookmarkRecord.metaKeywordsTokens[0], // ç”¨ç¬¬ä¸€ä¸ªå…³é”®è¯æœç´¢
  limit: 10
})
console.log('âœ… æœç´¢å¢å¼ºæµ‹è¯•:', searchResults.length, 'ä¸ªç»“æœ')
```

**é¢„æœŸç»“æœ**ï¼š

- âœ… `crawlMetadata` è¡¨æœ‰å®Œæ•´æ•°æ®
- âœ… `bookmarks` è¡¨çš„ `hasMetadata` = true
- âœ… æ´¾ç”Ÿå­—æ®µï¼ˆmetaTitleLower ç­‰ï¼‰å·²å¡«å……
- âœ… ä½¿ç”¨å…³é”®è¯å¯ä»¥æœç´¢åˆ°è¯¥ä¹¦ç­¾

---

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹ Offscreen Document çŠ¶æ€

```javascript
// æ£€æŸ¥ Offscreen Document æ˜¯å¦åˆ›å»º
chrome.offscreen.hasDocument().then(exists => {
  console.log('Offscreen Document å­˜åœ¨:', exists)
})
```

### 2. ç›‘æ§çˆ¬å–æ—¥å¿—

```javascript
// å¯ç”¨è¯¦ç»†æ—¥å¿—
localStorage.setItem('logLevel', 'debug')

// æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
console.log(window.__logs || [])
```

### 3. æ£€æŸ¥é˜Ÿåˆ—çŠ¶æ€

```javascript
// æŸ¥çœ‹ä»»åŠ¡è°ƒåº¦å™¨çŠ¶æ€
const { crawlTaskScheduler } = await import('./services/crawl-task-scheduler')

console.log('é˜Ÿåˆ—çŠ¶æ€:')
console.log('  æ’é˜Ÿä¸­:', crawlTaskScheduler.getPendingCount())
console.log('  æ‰§è¡Œä¸­:', crawlTaskScheduler.getRunningCount())
console.log('  å·²å®Œæˆ:', crawlTaskScheduler.getCompletedCount())
```

### 4. æ¸…é™¤ç¼“å­˜é‡æ–°æµ‹è¯•

```javascript
// æ¸…é™¤ç‰¹å®šä¹¦ç­¾çš„å…ƒæ•°æ®
const { deleteBookmarkMetadata } = await import(
  './services/local-bookmark-crawler'
)
await deleteBookmarkMetadata('bookmark-id-here')

// æ¸…é™¤æ‰€æœ‰çˆ¬å–æ•°æ®
const allMetadata = await indexedDBManager.getAllCrawlMetadata()
for (const meta of allMetadata) {
  await indexedDBManager.deleteCrawlMetadata(meta.bookmarkId)
}
console.log('âœ… å·²æ¸…é™¤æ‰€æœ‰çˆ¬å–æ•°æ®')
```

---

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1: çˆ¬å–æ²¡æœ‰ååº”

**æ’æŸ¥æ­¥éª¤**ï¼š

```javascript
// 1. æ£€æŸ¥ Offscreen Document
const hasOffscreen = await chrome.offscreen.hasDocument()
console.log('Offscreen å­˜åœ¨:', hasOffscreen)

// 2. æ£€æŸ¥æƒé™
console.log('Offscreen æƒé™:', chrome.offscreen !== undefined)

// 3. æ‰‹åŠ¨æµ‹è¯• Offscreen
const { extractMetaInOffscreen } = await import('./page-fetcher')
const html = '<html><head><title>Test</title></head></html>'
const result = await extractMetaInOffscreen(html)
console.log('Offscreen æµ‹è¯•:', result)
```

### é—®é¢˜ 2: æ•°æ®æ²¡æœ‰ä¿å­˜

**æ’æŸ¥æ­¥éª¤**ï¼š

```javascript
// 1. æ£€æŸ¥ IndexedDB åˆå§‹åŒ–
const { indexedDBManager } = await import('./infrastructure/indexeddb/manager')
await indexedDBManager.initialize()
console.log('IndexedDB å·²åˆå§‹åŒ–')

// 2. æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
const health = await indexedDBManager.checkDatabaseHealth()
console.log('æ•°æ®åº“å¥åº·:', health)

// 3. æ‰‹åŠ¨ä¿å­˜æµ‹è¯•
await indexedDBManager.saveCrawlMetadata({
  bookmarkId: 'test-123',
  url: 'https://test.com',
  pageTitle: 'Test Title',
  description: 'Test Description',
  source: 'crawler',
  status: 'success',
  updatedAt: Date.now(),
  version: '2.0'
})
console.log('âœ… æ‰‹åŠ¨ä¿å­˜æˆåŠŸ')

// 4. è¯»å–éªŒè¯
const saved = await indexedDBManager.getCrawlMetadata('test-123')
console.log('è¯»å–ç»“æœ:', saved)
```

### é—®é¢˜ 3: çˆ¬å–å¾ˆæ…¢æˆ–å¡ä½

**æ’æŸ¥æ­¥éª¤**ï¼š

```javascript
// 1. æ£€æŸ¥é…ç½®
const { CRAWLER_CONFIG } = await import('./config/constants')
console.log('çˆ¬å–é…ç½®:', CRAWLER_CONFIG)

// 2. è°ƒæ•´å¹¶å‘
CRAWLER_CONFIG.CONCURRENCY = 5 // å¢åŠ å¹¶å‘æ•°
CRAWLER_CONFIG.BATCH_SIZE = 20 // å¢åŠ æ‰¹é‡å¤§å°

// 3. ç¦ç”¨ç©ºé—²è°ƒåº¦ï¼ˆæµ‹è¯•ç”¨ï¼‰
CRAWLER_CONFIG.USE_IDLE_SCHEDULING = false

// 4. æŸ¥çœ‹æ€§èƒ½ç»Ÿè®¡
const { crawlTaskScheduler } = await import('./services/crawl-task-scheduler')
const stats = crawlTaskScheduler.getStatistics()
console.log('æ€§èƒ½ç»Ÿè®¡:', stats)
```

---

## ğŸ“Š æµ‹è¯•æ£€æŸ¥æ¸…å•

### åŸºç¡€åŠŸèƒ½ âœ…

- [ ] å•ä¸ª URL çˆ¬å–æˆåŠŸ
- [ ] æ‰¹é‡çˆ¬å–ï¼ˆ10ä¸ªï¼‰æˆåŠŸ
- [ ] æ•°æ®ä¿å­˜åˆ° `crawlMetadata` è¡¨
- [ ] `bookmarks` è¡¨å…³è”å­—æ®µæ›´æ–°
- [ ] æœç´¢åŠŸèƒ½å¢å¼ºç”Ÿæ•ˆ

### æ€§èƒ½æµ‹è¯• âœ…

- [ ] 50 ä¸ªä¹¦ç­¾ < 60 ç§’
- [ ] 100 ä¸ªä¹¦ç­¾ < 3 åˆ†é’Ÿ
- [ ] 1000 ä¸ªä¹¦ç­¾ < 20 åˆ†é’Ÿ
- [ ] å†…å­˜å ç”¨ < 100MB

### è¾¹ç•Œæµ‹è¯• âœ…

- [ ] æ— æ•ˆ URL æ­£ç¡®å¤„ç†
- [ ] 404/500 é”™è¯¯å¤„ç†
- [ ] è¶…æ—¶å¤„ç†
- [ ] CORS é”™è¯¯å¤„ç†
- [ ] é‡å¤ URL å»é‡

### æ•°æ®ä¸€è‡´æ€§ âœ…

- [ ] æ–­ç‚¹ç»­çˆ¬ï¼ˆåˆ·æ–°é¡µé¢åç»§ç»­ï¼‰
- [ ] å¹¶å‘å†™å…¥æ— å†²çª
- [ ] æ•°æ®ä¸ä¸¢å¤±
- [ ] å…³è”å…³ç³»æ­£ç¡®

---

## ğŸ¯ è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬

```javascript
// å®Œæ•´æµ‹è¯•å¥—ä»¶
async function runFullTest() {
  console.log('ğŸ§ª å¼€å§‹å®Œæ•´æµ‹è¯•...\n')

  // å¯¼å…¥æ¨¡å—
  const { crawlSingleBookmark, crawlMultipleBookmarks, getCrawlStatistics } =
    await import('./services/local-bookmark-crawler')
  const { indexedDBManager } = await import(
    './infrastructure/indexeddb/manager'
  )
  await indexedDBManager.initialize()

  // 1. å•ä¸ªçˆ¬å–æµ‹è¯•
  console.log('ğŸ“ æµ‹è¯• 1: å•ä¸ªçˆ¬å–')
  const bookmarks = await chrome.bookmarks.search({})
  const testBookmark = bookmarks.find(b => b.url)

  if (testBookmark) {
    await crawlSingleBookmark(testBookmark)
    const metadata = await indexedDBManager.getCrawlMetadata(testBookmark.id)
    console.log(metadata ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥')
  }

  // 2. æ‰¹é‡çˆ¬å–æµ‹è¯•
  console.log('\nğŸ“ æµ‹è¯• 2: æ‰¹é‡çˆ¬å–')
  const batchBookmarks = bookmarks.filter(b => b.url).slice(0, 5)
  await crawlMultipleBookmarks(batchBookmarks)

  let batchSuccess = 0
  for (const b of batchBookmarks) {
    const meta = await indexedDBManager.getCrawlMetadata(b.id)
    if (meta) batchSuccess++
  }
  console.log(`âœ… ${batchSuccess}/${batchBookmarks.length} æˆåŠŸ`)

  // 3. ç»Ÿè®¡æµ‹è¯•
  console.log('\nğŸ“ æµ‹è¯• 3: ç»Ÿè®¡ä¿¡æ¯')
  const stats = await getCrawlStatistics()
  console.log('ğŸ“Š ç»Ÿè®¡:', stats)
  console.log(stats.total > 0 ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥')

  // 4. æ•°æ®ä¸€è‡´æ€§æµ‹è¯•
  console.log('\nğŸ“ æµ‹è¯• 4: æ•°æ®ä¸€è‡´æ€§')
  if (testBookmark) {
    const bookmark = await indexedDBManager.getBookmarkById(testBookmark.id)
    console.log('hasMetadata:', bookmark.hasMetadata)
    console.log('metaTitleLower:', bookmark.metaTitleLower)
    console.log(bookmark.hasMetadata ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥')
  }

  console.log('\nğŸ‰ æµ‹è¯•å®Œæˆï¼')
}

// æ‰§è¡Œæµ‹è¯•
runFullTest().catch(console.error)
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æœ¬åœ°åŒ–çˆ¬å–æ¶æ„æ–¹æ¡ˆ](./æœ¬åœ°åŒ–çˆ¬å–æ¶æ„æ–¹æ¡ˆ.md)
- [æœ¬åœ°åŒ–çˆ¬å–-é—®é¢˜è§£ç­”](./æœ¬åœ°åŒ–çˆ¬å–-é—®é¢˜è§£ç­”.md)
- [æœ¬åœ°åŒ–çˆ¬å–-å®æ–½å®ŒæˆæŠ¥å‘Š](./æœ¬åœ°åŒ–çˆ¬å–-å®æ–½å®ŒæˆæŠ¥å‘Š.md)

---

**æµ‹è¯•æ„‰å¿«ï¼ğŸ‰**
