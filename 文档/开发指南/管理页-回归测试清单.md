# 管理页 回归测试清单（含 MCP 步骤模板）

本清单覆盖管理页的核心功能：初始化、目录展开/检索、右侧提案树的增删改、批量操作、计划执行与索引刷新、批量真实数据生成/删除、外部更新提示与刷新，以及清理（Cleanup）扫描。

建议在独立的测试 Profile 中运行，且扩展已通过“加载已解压”方式加载 `dist/`。

## 前置步骤

- 构建：在项目根执行前端生产构建，确保 dist 准备就绪
- 在测试 Chrome 实例中加载 dist
- 打开管理页：`chrome-extension://<ext-id>/management.html`
- 等待页面顶部 Overlay 消失，`data-testid=progress-text` 不再显示

> 若使用 MCP，请参考《MCP-自动化端到端指南》完成连接与 artifacts 产物保存。

---

## 一、页面初始化与基础交互

1. 初始化加载

- 预期：Overlay 出现后消失，左/右树均有内容
- 产物：截图保存

2. 左/右面板一键展开/收起

- 操作：点击各自 header 的折叠/展开按钮
- 预期：遮罩文案变化为“正在展开/正在收起…”，完成后恢复；无控制台报错

3. 面板内联搜索打开/关闭与聚焦

- 操作：点击搜索按钮，输入任意关键字，再清空并失焦
- 预期：
  - 首次输入时记录并展开全部
  - 清空后恢复此前展开态
  - 右侧悬停快捷标签浮层（CleanupTagPicker）在有数据时出现/隐藏正确

---

## 二、右侧提案树：增删改与选择

1. 打开“新增”对话框（文件夹内部）

- 操作：在右侧树某文件夹触发“新增”（依赖组件工具栏按钮）
- 预期：弹出“新增”对话框，Tab 切换 Bookmark/Folder 正常

2. 新增 Bookmark 表单校验

- 输入：空标题、非法 URL 时应阻止提交并提示
- 预期：修正后能提交，新增节点出现在路径末尾，并自动高亮/滚动定位

3. 编辑 Bookmark/Folder

- 操作：在节点上触发编辑，修改标题/URL 或标题，提交
- 预期：
  - Bookmark 保存需校验合法 URL
  - 保存后在右树正确更新

4. 删除 Bookmark/Folder

- Bookmark：直接删除
- Folder：若包含书签，则先出现确认对话框，展示计数；确认后删除
- 预期：右树结构与计数正确更新

5. 多选与面板底部批量删除

- 操作：在右侧树选择多个节点（包含 Folder/Bookmark），点击底部“删除”
- 预期：删除后更新计数与结构；若未选择应禁用或无操作

---

## 三、计划与执行（Staged → Apply）

1. 暂存若干修改（新增/删除/移动/编辑）

- 预期：页面右中区域“应用”按钮可用，stagedEdits 内有记录

2. 点击“应用”进行 plan+execute

- 进度：`executionProgress` 跟随更新
- 预期：
  - 执行成功提示（或部分失败的警告）
  - 视图刷新（调用 initialize）
  - 搜索索引同步策略：有 create 或删除文件夹 → 全量重建；否则增量 applyPatch

---

## 四、批量真实数据（Chrome API）

1. 生成测试数据

- 操作：点击 `data-testid=btn-generate` 打开对话框 `dlg-generate`
- 输入：`gen-total=100`（或 10000）、其余默认；确认 `btn-generate-confirm`
- 预期：
  - 进度文案变化，操作完成后刷新 IndexedDB + 搜索索引
  - 成功 toast 包含条数与速率

2. 随机删除测试数据

- 操作：`btn-delete` → `dlg-delete`：`del-target=50`、勾选 `del-clean-empty`
- 预期：
  - 进度与成功提示正确
  - 清理空文件夹计数在提示文本中体现

3. 幂等性与重试

- 弱网/高延时场景下（MCP emulation）：仍可完成；失败时有指数回退重试

---

## 五、外部更新提示与刷新

- 模拟：通过背景脚本或另一页面改动书签
- 预期：弹出“外部已更新书签”提示（非批量期）；确认后刷新 IndexedDB 与搜索索引

---

## 六、清理（Cleanup）扫描

1. 通过 URL 参数激活筛选

- 打开：`management.html?filter=duplicate`（或 404/empty/invalid）
- 预期：初始化清理状态并自动扫描；首个匹配项被选中与定位

2. 在页面内切换筛选器并重扫

- 操作：勾选/取消多个过滤器，执行扫描
- 预期：任务列表进度更新、结果 Map 刷新

3. 执行清理

- 操作：根据扫描结果触发删除（引用 cleanupAppService）
- 预期：完成后数据刷新、索引刷新

---

## MCP 步骤模板（关键片段）

以下片段可嵌入到你的自动化脚本中（方法名对应 MCP 工具）：

- 打开管理页并等待加载
  - navigate_page → `chrome-extension://<id>/management.html`
  - wait_for → `progress-text` 消失（或出现→消失的序列）
  - take_screenshot → `artifacts/screenshots/<ts>_management_loaded.png`

- 生成 100 条测试数据
  - click `btn-generate` → fill `gen-total=100`
  - click `btn-generate-confirm`
  - wait_for → 文案包含“正在刷新本地数据…”，随后消失
  - list_console_messages / list_network_requests → 保存至 artifacts

- 删除 50 条并清理空文件夹
  - click `btn-delete` → fill `del-target=50` + 勾选 `del-clean-empty`
  - click `btn-delete-confirm`
  - wait_for → 成功 toast 文案（或使用 evaluate_script 断言 DOM 中包含“已删除 50 条书签”）

- 计划执行
  - 使用 evaluate_script 模拟在右树内进行若干暂存：例如触发 UI 按钮或（必要时）调用页面暴露的测试钩子（若后续补充）
  - click 文本“应用”（或使用 evaluate_script 定位按钮并点击）
  - wait_for → 控制台出现“执行完成”日志；截图保存

- 性能回归（可选）
  - emulate_network=Slow 4G，emulate_cpu=4x
  - performance_start_trace → 执行“生成 10000” → performance_stop_trace
  - performance_analyze_insight → 保存摘要

> 备注：右树内的细粒度点击（如某节点工具栏按钮）若缺少 data-testid，可采用 evaluate_script 在页面上下文内查询 DOM 并触发 click；必要时可补充少量测试钩子以提升可达性。

---

## 通过/失败判据（抽样）

- 初始化：Overlay 正常显示/隐藏，无报错
- 搜索：左右树内联搜索可展开/恢复
- CRUD：新增/编辑/删除均更新右树且有校验提示
- 批量：对话框参数生效，速率统计合理（非零），清理空文件夹可选
- 计划执行：成功/部分失败路径均有明确反馈，视图与索引同步
- 外部更新：提示出现且确认后正确刷新
- 清理：筛选器控制扫描，执行清理后数据与索引刷新

---

如需我把上面的 MCP 片段固化为“可直接调用”的脚本模板（带 artifacts 输出与稳健等待），请告诉我，我会放到 `scripts/` 并附使用说明。
