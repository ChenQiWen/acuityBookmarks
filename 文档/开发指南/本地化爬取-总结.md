# æœ¬åœ°åŒ–çˆ¬å– - æ€»ç»“

## ğŸ¯ ä½ çš„ä¸¤ä¸ªå…³æ³¨ç‚¹

### 1ï¸âƒ£ ä»£ç å†²çªä¸æ¸…ç†

#### ç°çŠ¶åˆ†æ

```
ç°æœ‰å®ç°ï¼ˆæœ‰é—®é¢˜ï¼‰:
â”œâ”€â”€ serverless-crawler-client.ts      âŒ ä¸Šä¼ æ•°æ®åˆ°æœåŠ¡å™¨
â”œâ”€â”€ lightweight-bookmark-enhancer.ts  âŒ ä½¿ç”¨ Serverless
â”‚   â”œâ”€â”€ ç‹¬ç«‹ IndexedDB                âŒ AcuityBookmarks_LightweightCache
â”‚   â””â”€â”€ ç‹¬ç«‹æ•°æ®è¡¨                    âŒ bookmark_metadata
â””â”€â”€ æ•°æ®æœªå…³è”                        âŒ ä¸ bookmarks è¡¨åˆ†ç¦»
```

#### æ–°æ¶æ„ï¼ˆå®Œå…¨æœ¬åœ°ï¼‰

```
æ–°å®ç°ï¼ˆå®Œå…¨æœ¬åœ°ï¼‰:
â”œâ”€â”€ local-crawler-worker.ts          âœ… Offscreen Documentï¼Œ100%æœ¬åœ°
â”œâ”€â”€ crawl-task-scheduler.ts          âœ… é˜Ÿåˆ—ã€å¹¶å‘ã€è°ƒåº¦
â”œâ”€â”€ local-bookmark-crawler.ts        âœ… ç»Ÿä¸€å…¥å£ï¼Œæ•°æ®ä¿å­˜
â””â”€â”€ ç»Ÿä¸€ IndexedDB: AcuityBookmarksDB
    â”œâ”€â”€ crawlMetadata è¡¨             âœ… çˆ¬å–å…ƒæ•°æ®
    â””â”€â”€ bookmarks è¡¨                 âœ… å…³è”å­—æ®µï¼ˆhasMetadataç­‰ï¼‰
```

#### éœ€è¦åˆ é™¤çš„ä»£ç 

| æ–‡ä»¶/ä»£ç                             | åŸå›              | æ“ä½œ                                 |
| ------------------------------------ | ---------------- | ------------------------------------ |
| `serverless-crawler-client.ts`       | ä¸Šä¼ æ•°æ®åˆ°æœåŠ¡å™¨ | **å®Œå…¨åˆ é™¤**                         |
| `lightweight-bookmark-enhancer.ts`   | ç‹¬ç«‹ IndexedDB   | **é‡æ„ç®€åŒ–**                         |
| ç‹¬ç«‹ IndexedDB ä»£ç                   | ä¸ä¸»åº“åˆ†ç¦»       | **åˆ é™¤ï¼Œç»Ÿä¸€ä½¿ç”¨ AcuityBookmarksDB** |
| `serverlessCrawlerClient` çš„æ‰€æœ‰å¼•ç”¨ | æ—§å®ç°           | **æ›¿æ¢ä¸ºæ–° API**                     |

#### æ¸…ç†åçš„æ•ˆæœ

- âœ… **é›¶å†—ä½™**ï¼šæ‰€æœ‰ Serverless ä»£ç å·²åˆ é™¤
- âœ… **é›¶æ··æ·†**ï¼šåªæœ‰ä¸€å¥—æœ¬åœ°çˆ¬å–é€»è¾‘
- âœ… **é›¶å†²çª**ï¼šæ–°æ—§ä»£ç å®Œå…¨åˆ†ç¦»

---

### 2ï¸âƒ£ æ•°æ®ä¿å­˜ä¸å…³è”

#### æ•°æ®æµå‘

```
çˆ¬å–æµç¨‹:
  ç”¨æˆ·è§¦å‘
    â†“
  crawlSingleBookmark()
    â†“
  crawlBookmarkLocally() â† Offscreen Document
    â†“
  saveCrawlResult()
    â†“
  â”œâ”€â†’ crawlMetadata è¡¨ï¼ˆçˆ¬å–å…ƒæ•°æ®ï¼‰
    â†“   bookmarkId: '123'
    â†“   pageTitle: 'é¡µé¢æ ‡é¢˜'
    â†“   description: 'æè¿°'
    â†“   keywords: 'å…³é”®è¯'
    â†“   ...
    â†“
  â””â”€â†’ bookmarks è¡¨ï¼ˆæ›´æ–°å…³è”ï¼‰
        hasMetadata: true
        metadataUpdatedAt: 1234567890
        metaTitleLower: 'é¡µé¢æ ‡é¢˜'
        metaBoost: 1.5
```

#### æ•°æ®è¡¨è®¾è®¡

**è¡¨1: `crawlMetadata`** - å­˜å‚¨çˆ¬å–çš„å…ƒæ•°æ®

```typescript
interface CrawlMetadataRecord {
  bookmarkId: string // ä¸»é”®ï¼Œå…³è”åˆ° bookmarks.id
  url: string // åŸå§‹ URL

  // çˆ¬å–çš„å…ƒæ•°æ®
  pageTitle?: string // ç½‘é¡µæ ‡é¢˜
  description?: string // æè¿°
  keywords?: string // å…³é”®è¯
  ogTitle?: string // Open Graph æ ‡é¢˜
  ogDescription?: string
  ogImage?: string
  ogSiteName?: string

  // çŠ¶æ€
  source: 'crawler'
  status: 'success' | 'failed'
  httpStatus?: number
  lastCrawled?: number

  // ç»´æŠ¤
  updatedAt: number
  version: string
}
```

**è¡¨2: `bookmarks`** - æ›´æ–°å…³è”å­—æ®µ

```typescript
interface BookmarkRecord {
  id: string
  title: string
  url?: string

  // å…ƒæ•°æ®å…³è”ï¼ˆè‡ªåŠ¨æ›´æ–°ï¼‰
  hasMetadata?: boolean // âœ… æ˜¯å¦æœ‰å…ƒæ•°æ®
  metadataUpdatedAt?: number // âœ… å…ƒæ•°æ®æ›´æ–°æ—¶é—´
  metadataSource?: 'crawler' // âœ… æ¥æº

  // æ´¾ç”Ÿå­—æ®µï¼ˆç”¨äºæœç´¢å¢å¼ºï¼‰
  metaTitleLower?: string // âœ… å°å†™æ ‡é¢˜
  metaDescriptionLower?: string // âœ… å°å†™æè¿°
  metaKeywordsTokens?: string[] // âœ… å…³é”®è¯æ•°ç»„
  metaBoost?: number // âœ… æœç´¢æƒé‡
}
```

#### æ•°æ®ä¿å­˜é€»è¾‘

```typescript
// åœ¨ local-bookmark-crawler.ts ä¸­

export async function saveCrawlResult(
  bookmarkId: string,
  url: string,
  result: CrawlResult
): Promise<void> {
  // 1. ä¿å­˜åˆ° crawlMetadata è¡¨
  await indexedDBManager.saveCrawlMetadata({
    bookmarkId,
    url,
    pageTitle: result.metadata.title,
    description: result.metadata.description
    // ... å…¶ä»–å­—æ®µ
  })

  // 2. æ›´æ–° bookmarks è¡¨çš„å…³è”å­—æ®µ
  await indexedDBManager.updateBookmark(bookmarkId, {
    hasMetadata: true,
    metadataUpdatedAt: Date.now(),
    metadataSource: 'crawler',
    metaTitleLower: result.metadata.title.toLowerCase()
    // ... å…¶ä»–æ´¾ç”Ÿå­—æ®µ
  })
}
```

#### ä¸šåŠ¡ä½¿ç”¨ç¤ºä¾‹

**ç¤ºä¾‹1: æœç´¢å¢å¼º**

```typescript
// æœç´¢æ—¶ï¼Œå…ƒæ•°æ®ä¼šè‡ªåŠ¨å‚ä¸åŒ¹é…
const results = await searchBookmarks('å…³é”®è¯')

// ç»“æœä¼šåŒ…å«ï¼š
// - bookmark.title (ä¹¦ç­¾åŸæ ‡é¢˜)
// - bookmark.metaTitleLower (ç½‘é¡µå®é™…æ ‡é¢˜)
// - bookmark.metaDescriptionLower (ç½‘é¡µæè¿°)
// - bookmark.metaKeywordsTokens (ç½‘é¡µå…³é”®è¯)
```

**ç¤ºä¾‹2: æ˜¾ç¤ºå…ƒæ•°æ®**

```typescript
// è·å–ä¹¦ç­¾çš„å®Œæ•´ä¿¡æ¯
const bookmark = await indexedDBManager.getBookmarkById('123')

if (bookmark.hasMetadata) {
  // è·å–çˆ¬å–çš„å…ƒæ•°æ®
  const metadata = await indexedDBManager.getCrawlMetadata(bookmark.id)

  console.log('ç½‘é¡µæ ‡é¢˜:', metadata.pageTitle)
  console.log('ç½‘é¡µæè¿°:', metadata.description)
  console.log('å…³é”®è¯:', metadata.keywords)
}
```

**ç¤ºä¾‹3: æ‰¹é‡æŸ¥è¯¢**

```typescript
// æ‰¹é‡è·å–å¤šä¸ªä¹¦ç­¾çš„å…ƒæ•°æ®
const metadataMap = await indexedDBManager.getBatchCrawlMetadata([
  'id1',
  'id2',
  'id3'
])

metadataMap.forEach((metadata, bookmarkId) => {
  console.log(`${bookmarkId}: ${metadata.pageTitle}`)
})
```

**ç¤ºä¾‹4: åˆ·æ–°è¿‡æœŸæ•°æ®**

```typescript
// è·å–éœ€è¦åˆ·æ–°çš„ä¹¦ç­¾
const bookmarks = await getBookmarksNeedingCrawl()

console.log(`éœ€è¦åˆ·æ–°: ${bookmarks.length} ä¸ªä¹¦ç­¾`)

// æ‰¹é‡åˆ·æ–°
await crawlMultipleBookmarks(bookmarks, {
  skipExisting: false, // å¼ºåˆ¶åˆ·æ–°
  onProgress: stats => {
    console.log(`è¿›åº¦: ${stats.progress}%`)
  }
})
```

---

## ğŸ“Š å…³é”®æ•°æ®å…³ç³»

### ä¸€å¯¹ä¸€å…³ç³»

```
bookmarks (1) â†â†’ (0..1) crawlMetadata
   id                     bookmarkId

ä¸€ä¸ªä¹¦ç­¾ â†’ æœ€å¤šä¸€æ¡çˆ¬å–å…ƒæ•°æ®
ä¸€æ¡çˆ¬å–å…ƒæ•°æ® â†’ å¯¹åº”ä¸€ä¸ªä¹¦ç­¾
```

### æŸ¥è¯¢æ¨¡å¼

#### æ¨¡å¼1: ä»ä¹¦ç­¾æŸ¥å…ƒæ•°æ®

```typescript
// 1. æŸ¥è¯¢ä¹¦ç­¾
const bookmark = await indexedDBManager.getBookmarkById('123')

// 2. æ£€æŸ¥æ˜¯å¦æœ‰å…ƒæ•°æ®
if (bookmark.hasMetadata) {
  // 3. æŸ¥è¯¢å…ƒæ•°æ®
  const metadata = await indexedDBManager.getCrawlMetadata('123')
}
```

#### æ¨¡å¼2: æœç´¢æ—¶è‡ªåŠ¨åŒ¹é…

```typescript
// æœç´¢å¼•æ“ä¼šè‡ªåŠ¨ä½¿ç”¨æ´¾ç”Ÿå­—æ®µ
// æ— éœ€æ‰‹åŠ¨joinï¼Œæ€§èƒ½æ›´å¥½

const results = await searchBookmarks('React')

// ä¼šåŒ¹é…ï¼š
// - bookmark.titleLower
// - bookmark.metaTitleLower        â† æ¥è‡ªçˆ¬å–
// - bookmark.metaDescriptionLower  â† æ¥è‡ªçˆ¬å–
// - bookmark.metaKeywordsTokens    â† æ¥è‡ªçˆ¬å–
```

#### æ¨¡å¼3: ç»Ÿè®¡å’Œåˆ†æ

```typescript
// è·å–çˆ¬å–ç»Ÿè®¡
const stats = await getCrawlStatistics()

console.log({
  æ€»ä¹¦ç­¾æ•°: stats.total,
  å·²çˆ¬å–: stats.withMetadata,
  æœªçˆ¬å–: stats.withoutMetadata,
  å¤±è´¥: stats.failed,
  è¿‡æœŸ: stats.expired
})
```

---

## ğŸ”§ IndexedDB Manager æ–°å¢æ–¹æ³•

åœ¨ `frontend/src/utils-legacy/indexeddb-manager.ts` ä¸­æ·»åŠ ï¼š

```typescript
// 1. ä¿å­˜çˆ¬å–å…ƒæ•°æ®
async saveCrawlMetadata(record: CrawlMetadataRecord): Promise<void>

// 2. è·å–çˆ¬å–å…ƒæ•°æ®
async getCrawlMetadata(bookmarkId: string): Promise<CrawlMetadataRecord | null>

// 3. æ‰¹é‡è·å–
async getBatchCrawlMetadata(bookmarkIds: string[]): Promise<Map<string, CrawlMetadataRecord>>

// 4. åˆ é™¤å…ƒæ•°æ®
async deleteCrawlMetadata(bookmarkId: string): Promise<void>
```

---

## âœ… æœ€ç»ˆæ•ˆæœ

### ä»£ç å±‚é¢

| æŒ‡æ ‡     | æ—§å®ç°  | æ–°å®ç°  |
| -------- | ------- | ------- |
| æ–‡ä»¶æ•°   | 2ä¸ªç‹¬ç«‹ | 3ä¸ªåä½œ |
| æ•°æ®åº“   | 2ä¸ªåˆ†ç¦» | 1ä¸ªç»Ÿä¸€ |
| æ•°æ®ä¸Šä¼  | âŒ æ˜¯   | âœ… å¦   |
| ä»£ç å†—ä½™ | âŒ æœ‰   | âœ… æ—    |
| å…³è”æ¸…æ™° | âŒ å¦   | âœ… æ˜¯   |

### æ•°æ®å±‚é¢

| æŒ‡æ ‡       | æ—§å®ç°    | æ–°å®ç°         |
| ---------- | --------- | -------------- |
| å…ƒæ•°æ®å­˜å‚¨ | ç‹¬ç«‹è¡¨    | crawlMetadata  |
| ä¹¦ç­¾å…³è”   | âŒ æ—      | âœ… hasMetadata |
| æœç´¢å¢å¼º   | âŒ æ—      | âœ… æ´¾ç”Ÿå­—æ®µ    |
| æŸ¥è¯¢æ€§èƒ½   | âš ï¸ éœ€join | âœ… é¢„è®¡ç®—      |

### ç”¨æˆ·ä½“éªŒ

| æŒ‡æ ‡     | æ•ˆæœ              |
| -------- | ----------------- |
| éšç§ä¿æŠ¤ | âœ… 100%æœ¬åœ°       |
| æœç´¢è´¨é‡ | âœ… å…ƒæ•°æ®å¢å¼º     |
| æ€§èƒ½     | âœ… 1000ä¹¦ç­¾<3åˆ†é’Ÿ |
| æ•°æ®ä¸€è‡´ | âœ… è‡ªåŠ¨åŒæ­¥       |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¬¬ä¸€æ­¥ï¼šæ·»åŠ  IndexedDB æ–¹æ³•

```bash
# ç¼–è¾‘æ–‡ä»¶
code frontend/src/utils-legacy/indexeddb-manager.ts

# æ·»åŠ å››ä¸ªæ–°æ–¹æ³•ï¼ˆè§ä¸Šæ–‡ï¼‰
```

### ç¬¬äºŒæ­¥ï¼šé‡æ„ lightweight-bookmark-enhancer.ts

```bash
# ç¼–è¾‘æ–‡ä»¶
code frontend/src/services/lightweight-bookmark-enhancer.ts

# æ›¿æ¢ä¸ºç®€åŒ–ç‰ˆï¼ˆè§å®æ–½æ­¥éª¤æ–‡æ¡£ï¼‰
```

### ç¬¬ä¸‰æ­¥ï¼šåˆ é™¤ Serverless Crawler

```bash
rm frontend/src/services/serverless-crawler-client.ts
```

### ç¬¬å››æ­¥ï¼šæµ‹è¯•

```bash
cd frontend
npm run build
npm run test
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. [æœ¬åœ°åŒ–çˆ¬å–æ¶æ„æ–¹æ¡ˆ](./æœ¬åœ°åŒ–çˆ¬å–æ¶æ„æ–¹æ¡ˆ.md) - å®Œæ•´æ¶æ„è®¾è®¡
2. [æœ¬åœ°åŒ–çˆ¬å–é›†æˆæŒ‡å—](./æœ¬åœ°åŒ–çˆ¬å–é›†æˆæŒ‡å—.md) - ä½¿ç”¨ç¤ºä¾‹
3. [æœ¬åœ°åŒ–çˆ¬å–æ¸…ç†é›†æˆæ–¹æ¡ˆ](./æœ¬åœ°åŒ–çˆ¬å–-æ¸…ç†é›†æˆæ–¹æ¡ˆ.md) - æ¸…ç†è®¡åˆ’
4. [æœ¬åœ°åŒ–çˆ¬å–å®æ–½æ­¥éª¤](./æœ¬åœ°åŒ–çˆ¬å–-å®æ–½æ­¥éª¤.md) - è¯¦ç»†æ­¥éª¤

---

## ğŸ¯ æ ¸å¿ƒè¦ç‚¹

### âœ… å…³äºå†²çªå’Œæ¸…ç†

1. **å®Œå…¨åˆ é™¤** `serverless-crawler-client.ts`
2. **é‡æ„ç®€åŒ–** `lightweight-bookmark-enhancer.ts`
3. **ç»Ÿä¸€ä½¿ç”¨** `AcuityBookmarksDB`
4. **é›¶æ··æ·†** - åªæœ‰ä¸€å¥—æœ¬åœ°çˆ¬å–é€»è¾‘

### âœ… å…³äºæ•°æ®ä¿å­˜å’Œå…³è”

1. **å…ƒæ•°æ®ä¿å­˜** - `crawlMetadata` è¡¨ï¼Œ`bookmarkId` ä¸ºä¸»é”®
2. **è‡ªåŠ¨å…³è”** - `bookmarks.hasMetadata` ç­‰å­—æ®µè‡ªåŠ¨æ›´æ–°
3. **æœç´¢å¢å¼º** - æ´¾ç”Ÿå­—æ®µï¼ˆmetaTitleLower ç­‰ï¼‰é¢„è®¡ç®—
4. **ä¸€å¯¹ä¸€å…³ç³»** - ä¹¦ç­¾ â†” çˆ¬å–å…ƒæ•°æ®

---

**ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¶é—´**: 2025-10-12  
**é¢„è®¡å·¥æ—¶**: 1.5-2å°æ—¶  
**çŠ¶æ€**: âœ… å¯æ‰§è¡Œ
