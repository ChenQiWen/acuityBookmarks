# 主题自动跟随系统说明

## 功能概述

插件现在支持自动跟随操作系统主题设置。当用户在设置页面开启"自动跟随系统主题"开关后，插件会实时监控系统主题变化，并自动切换明暗主题。

## 功能特性

### 1. 设置页面新增开关

- **位置**: 设置页 > 通用 > 自动跟随系统主题
- **默认状态**: 关闭
- **说明**: 开启后，插件主题将自动跟随系统主题变化

### 2. 系统主题监控

- **技术实现**: 使用 `window.matchMedia('(prefers-color-scheme: dark)')` API
- **实时响应**: 当系统主题变化时，插件立即切换对应主题
- **条件触发**: 仅在用户开启"自动跟随系统主题"时才会监控并响应

### 3. 优先级规则

当"自动跟随系统主题"开启时：

1. 初始化时使用系统主题
2. 系统主题变化时自动切换
3. 手动切换主题按钮仍然可用，但会被下次系统主题变化覆盖

当"自动跟随系统主题"关闭时：

1. 使用用户保存的主题设置
2. 不响应系统主题变化
3. 手动切换主题正常工作并持久化

## 技术实现

### 1. 全局状态管理

**文件**: `frontend/src/infrastructure/global-state/global-state-manager.ts`

新增状态字段：

```typescript
interface GlobalState {
  // ... 其他字段
  autoFollowSystemTheme: boolean // 是否自动跟随系统主题
}
```

新增方法：

- `getAutoFollowSystemTheme()`: 获取自动跟随设置
- `setAutoFollowSystemTheme(autoFollow: boolean)`: 设置自动跟随

### 2. ThemeToggle 组件增强

**文件**: `frontend/src/components/base/ThemeToggle/ThemeToggle.vue`

主要功能：

1. **系统主题监控**

   ```typescript
   // 启动监控
   const systemThemeQuery = window.matchMedia('(prefers-color-scheme: dark)')
   systemThemeQuery.addEventListener('change', handleSystemThemeChange)

   // 处理系统主题变化
   const handleSystemThemeChange = async (e: MediaQueryListEvent) => {
     const autoFollow = globalStateManager.getAutoFollowSystemTheme()
     if (!autoFollow) return

     const systemTheme = e.matches ? 'dark' : 'light'
     applyTheme(systemTheme)
     await globalStateManager.setTheme(systemTheme)
   }
   ```

2. **动态启停监控**
   - 监听全局状态变化
   - 当 `autoFollowSystemTheme` 变为 `true` 时启动系统主题监控
   - 当 `autoFollowSystemTheme` 变为 `false` 时停止监控

3. **初始化逻辑**
   - 如果开启了自动跟随，使用系统主题
   - 否则使用保存的用户偏好主题
   - 默认为明亮主题

### 3. 设置页面 UI

**文件**: `frontend/src/pages/settings/sections/GeneralSettings.vue`

新增内容：

```vue
<div class="row">
  <div class="label">自动跟随系统主题</div>
  <div class="field">
    <Switch
      v-model="autoFollowSystemTheme"
      size="md"
      @change="handleAutoFollowChange"
    />
  </div>
</div>
```

处理逻辑：

- 从 `globalStateManager` 加载初始状态
- 切换时保存到 `chrome.storage.local`
- 显示操作成功/失败提示

## 用户使用指南

### 开启自动跟随

1. 打开插件设置页面
2. 找到"通用"设置卡片
3. 打开"自动跟随系统主题"开关
4. 插件将立即使用系统当前主题，并持续监控系统主题变化

### 关闭自动跟随

1. 关闭"自动跟随系统主题"开关
2. 插件停止监控系统主题变化
3. 可以使用主题切换按钮手动切换主题
4. 手动选择的主题会被持久化保存

## 兼容性

### 浏览器支持

- ✅ Chrome 76+
- ✅ Edge 79+
- ✅ Firefox 67+
- ✅ Safari 12.1+

### API 兼容性

- 使用 `matchMedia` API（现代浏览器原生支持）
- 兼容旧版 `addListener` / `removeListener` 方法

### Service Worker 环境

- 已处理 Service Worker 环境下 `window` 和 `document` 不可用的情况
- 通过 `typeof window !== 'undefined'` 检查确保安全

## 调试信息

所有关键操作都会输出日志，便于调试：

- `ThemeToggle` 组件的初始化、主题切换、监控启停
- 系统主题变化检测和响应
- 全局状态管理器的设置读写

查看日志：

```javascript
// 浏览器控制台
// 筛选 "ThemeToggle" 或 "GlobalStateManager" 查看相关日志
```

## 测试场景

### 1. 开启自动跟随

1. 开启"自动跟随系统主题"
2. 切换操作系统主题（Mac: 系统偏好设置 > 通用 > 外观）
3. 验证插件主题立即跟随系统变化

### 2. 关闭自动跟随

1. 关闭"自动跟随系统主题"
2. 手动切换插件主题
3. 切换操作系统主题
4. 验证插件主题不受影响

### 3. 跨页面一致性

1. 开启自动跟随
2. 在不同页面（popup、settings、management）验证主题一致
3. 切换系统主题，验证所有页面同步更新

## 注意事项

1. **手动切换与自动跟随的关系**
   - 开启自动跟随后，手动切换主题按钮仍可使用
   - 但下次系统主题变化时会覆盖手动设置
   - 建议开启自动跟随后不使用手动切换

2. **初始化顺序**
   - 组件先设置全局状态监听器
   - 再初始化主题
   - 最后根据设置决定是否启动系统监控
   - 确保不会遗漏任何状态变化

3. **性能考虑**
   - 系统主题变化事件非常低频（用户手动切换）
   - 监听器开销极小
   - 关闭自动跟随时会立即移除监听器

## 未来优化方向

1. **更细粒度的控制**
   - 可以考虑添加"仅在白天/夜晚自动切换"
   - 支持自定义时间段的主题切换

2. **过渡动画**
   - 主题切换时添加平滑过渡效果
   - 提升用户体验

3. **多端同步**
   - 考虑将自动跟随设置同步到 `chrome.storage.sync`
   - 实现跨设备一致体验
