# AcuityBookmarks - å®Œæ•´äº§å“æ–‡æ¡£ v3.0

> ğŸ“˜ **æ–‡æ¡£ç›®æ ‡**ï¼šä¸º AI ç¼–ç¨‹åŠ©æ‰‹ï¼ˆCursor/Copilotï¼‰æä¾›å®Œæ•´çš„é¡¹ç›®ä¸Šä¸‹æ–‡ï¼Œç¡®ä¿ç”Ÿæˆçš„ä»£ç ç¬¦åˆé¡¹ç›®æ¶æ„å’Œè§„èŒƒã€‚
>
> ğŸ¯ **æœ€åæ›´æ–°**ï¼š2025-10-26  
> ğŸ“¦ **é¡¹ç›®ç‰ˆæœ¬**ï¼šv1.0  
> ğŸ—ï¸ **æ¶æ„ç‰ˆæœ¬**ï¼šv3.0ï¼ˆDDD + å•å‘æ•°æ®æµ + ç°ä»£æŠ€æœ¯æ ˆï¼‰

---

## ğŸ“‹ ç›®å½•

- [ç¬¬ä¸€éƒ¨åˆ†ï¼šäº§å“æ¦‚è¿°](#ç¬¬ä¸€éƒ¨åˆ†äº§å“æ¦‚è¿°)
- [ç¬¬äºŒéƒ¨åˆ†ï¼šæŠ€æœ¯æ¶æ„](#ç¬¬äºŒéƒ¨åˆ†æŠ€æœ¯æ¶æ„)
- [ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ ¸å¿ƒåŠŸèƒ½](#ç¬¬ä¸‰éƒ¨åˆ†æ ¸å¿ƒåŠŸèƒ½)
- [ç¬¬å››éƒ¨åˆ†ï¼šå¼€å‘è§„èŒƒ](#ç¬¬å››éƒ¨åˆ†å¼€å‘è§„èŒƒ)
- [ç¬¬äº”éƒ¨åˆ†ï¼šæ•°æ®æµè®¾è®¡](#ç¬¬äº”éƒ¨åˆ†æ•°æ®æµè®¾è®¡)
- [ç¬¬å…­éƒ¨åˆ†ï¼šå­˜å‚¨æ–¹æ¡ˆ](#ç¬¬å…­éƒ¨åˆ†å­˜å‚¨æ–¹æ¡ˆ)
- [ç¬¬ä¸ƒéƒ¨åˆ†ï¼šå…³é”®å®ç°ç»†èŠ‚](#ç¬¬ä¸ƒéƒ¨åˆ†å…³é”®å®ç°ç»†èŠ‚)
- [ç¬¬å…«éƒ¨åˆ†ï¼šæµ‹è¯•ä¸è´¨é‡ä¿éšœ](#ç¬¬å…«éƒ¨åˆ†æµ‹è¯•ä¸è´¨é‡ä¿éšœ)

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šäº§å“æ¦‚è¿°

### 1.1 äº§å“å®šä½

**AcuityBookmarks** æ˜¯ä¸€æ¬¾åŸºäº AI æŠ€æœ¯çš„ Chrome æµè§ˆå™¨æ‰©å±•ï¼Œä¸“ä¸ºè§£å†³ä¹¦ç­¾æ··ä¹±ã€æŸ¥æ‰¾å›°éš¾ç­‰é—®é¢˜è€Œè®¾è®¡ã€‚

#### æ ¸å¿ƒä»·å€¼ä¸»å¼ 

- **æ™ºèƒ½åŒ–ç®¡ç†**ï¼šAI é©±åŠ¨çš„ä¹¦ç­¾è‡ªåŠ¨åˆ†ç±»å’Œå†…å®¹ç†è§£
- **é«˜æ€§èƒ½**ï¼šæ”¯æŒ 2 ä¸‡+ ä¹¦ç­¾çš„æµç•…ç®¡ç†
- **æœ¬åœ°ä¼˜å…ˆ**ï¼šæ ¸å¿ƒåŠŸèƒ½ç¦»çº¿å¯ç”¨ï¼Œéšç§å®‰å…¨
- **ç°ä»£åŒ–æ¶æ„**ï¼šé‡‡ç”¨ DDD + å•å‘æ•°æ®æµ + ç°ä»£å‰ç«¯æŠ€æœ¯æ ˆ

### 1.2 ç›®æ ‡ç”¨æˆ·

- **çŸ¥è¯†å·¥ä½œè€…**ï¼šç ”ç©¶å‘˜ã€å­¦è€…ã€å’¨è¯¢å¸ˆ
- **å†…å®¹åˆ›ä½œè€…**ï¼šåšä¸»ã€è®°è€…ã€è®¾è®¡å¸ˆ
- **é‡åº¦ç½‘ç»œç”¨æˆ·**ï¼šIT ä»ä¸šè€…ã€äº§å“ç»ç†
- **å­¦ç”Ÿç¾¤ä½“**ï¼šéœ€è¦æ•´ç†å­¦ä¹ èµ„æ–™çš„åœ¨æ ¡å­¦ç”Ÿ

### 1.3 æ ¸å¿ƒåŠŸèƒ½

#### 1.3.1 ä¹¦ç­¾å¯è§†åŒ–ç®¡ç†

- **åŒé¢æ¿å¸ƒå±€**ï¼šå·¦ä¾§åŸå§‹ç»“æ„ï¼Œå³ä¾§ç¼–è¾‘åç»“æ„
- **æ‹–æ‹½é‡ç»„**ï¼šæ”¯æŒä¹¦ç­¾å’Œæ–‡ä»¶å¤¹çš„ç›´è§‚æ‹–æ‹½ç§»åŠ¨
- **è™šæ‹Ÿæ»šåŠ¨**ï¼šåŸºäº `@tanstack/vue-virtual`ï¼Œæ”¯æŒå¤§é‡ä¹¦ç­¾æµç•…æ¸²æŸ“

#### 1.3.2 æ™ºèƒ½æœç´¢

- **å¤šæ¨¡å¼æœç´¢**ï¼šå…³é”®è¯ã€è¯­ä¹‰ã€å†…å®¹å…¨æ–‡æœç´¢
- **å®æ—¶é«˜äº®**ï¼šæœç´¢ç»“æœå…³é”®è¯é«˜äº®
- **æœç´¢å†å²**ï¼šè®°å½•æœç´¢å†å²ï¼Œæ”¯æŒå¿«é€Ÿé‡å¤æœç´¢

#### 1.3.3 ä¹¦ç­¾å¥åº·æ‰«æ

- **æ­»é“¾æ£€æµ‹**ï¼šè‡ªåŠ¨æ£€æµ‹å¤±æ•ˆä¹¦ç­¾
- **é‡å¤æ£€æµ‹**ï¼šè¯†åˆ«é‡å¤æ”¶è—
- **å¥åº·æ ‡ç­¾**ï¼šä¸ºä¹¦ç­¾æ·»åŠ å¥åº·çŠ¶æ€æ ‡è®°

#### 1.3.4 AI æ™ºèƒ½åˆ†ç±»

- **å†…å®¹çˆ¬å–**ï¼šè‡ªåŠ¨è·å–ä¹¦ç­¾ç½‘é¡µå†…å®¹
- **LLM åˆ†æ**ï¼šåˆ©ç”¨å¤§è¯­è¨€æ¨¡å‹ç†è§£ç½‘é¡µè¯­ä¹‰
- **è‡ªåŠ¨å½’ç±»**ï¼šæ™ºèƒ½æ¨èä¹¦ç­¾åˆ†ç±»ä½ç½®

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šæŠ€æœ¯æ¶æ„

### 2.1 æŠ€æœ¯æ ˆæ¦‚è§ˆ

#### 2.1.1 å‰ç«¯æŠ€æœ¯æ ˆ

```typescript
{
  // ğŸ”· æ ¸å¿ƒæ¡†æ¶
  vue: "3.5.18",                    // å“åº”å¼æ¡†æ¶
  pinia: "3.0.3",                   // çŠ¶æ€ç®¡ç†
  typescript: "5.8.3",              // ç±»å‹å®‰å…¨
  vite: "7.1.2",                    // æ„å»ºå·¥å…·

  // ğŸ”· ç°ä»£åº“ï¼ˆv3.0 æ–°å¢ï¼‰
  "@tanstack/vue-query": "5.90.5",  // å¼‚æ­¥çŠ¶æ€ç®¡ç†
  "@tanstack/vue-virtual": "3.13.12", // è™šæ‹Ÿæ»šåŠ¨
  "@vueuse/core": "14.0.0",         // Vue Composables å·¥å…·é›†
  "immer": "10.2.0",                // ä¸å¯å˜çŠ¶æ€æ›´æ–°
  "mitt": "3.0.1",                  // äº‹ä»¶æ€»çº¿
  "zod": "3.25.8",                  // è¿è¡Œæ—¶æ•°æ®æ ¡éªŒ

  // ğŸ”· æœç´¢ä¸å·¥å…·
  "fuse.js": "6.6.2",               // æ¨¡ç³Šæœç´¢å¼•æ“
  "p-queue": "8.0.1",               // å¹¶å‘æ§åˆ¶

  // ğŸ”· æµ‹è¯•æ¡†æ¶
  "vitest": "2.1.1",                // å•å…ƒæµ‹è¯•
  "@testing-library/vue": "8.1.0"   // ç»„ä»¶æµ‹è¯•
}
```

#### 2.1.2 åç«¯æŠ€æœ¯æ ˆ

```typescript
{
  // Cloudflare Workers
  runtime: "Bun 1.2.21+",           // é«˜æ€§èƒ½ JavaScript è¿è¡Œæ—¶
  platform: "Cloudflare Workers",   // Serverless å¹³å°
  ai: "Cloudflare AI (Workers AI)", // LLM æ¨ç†
  database: "Cloudflare D1"         // SQLite æ•°æ®åº“
}
```

#### 2.1.3 Chrome Extension

```json
{
  "manifest_version": 3,
  "minimum_chrome_version": "100",
  "service_worker": "background.js" // Manifest V3
}
```

### 2.2 DDD åˆ†å±‚æ¶æ„

AcuityBookmarks ä¸¥æ ¼éµå¾ª **é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰** çš„åˆ†å±‚æ¶æ„ï¼š

```
frontend/src/
â”œâ”€â”€ presentation/         # è¡¨ç°å±‚ï¼ˆUI ç»„ä»¶ï¼‰
â”‚   â”œâ”€â”€ pages/           # é¡µé¢çº§ç»„ä»¶
â”‚   â””â”€â”€ components/      # å¯å¤ç”¨ç»„ä»¶
â”‚
â”œâ”€â”€ application/         # åº”ç”¨å±‚ï¼ˆä¸šåŠ¡æµç¨‹åè°ƒï¼‰
â”‚   â”œâ”€â”€ bookmark/        # ä¹¦ç­¾ç›¸å…³åº”ç”¨æœåŠ¡
â”‚   â”œâ”€â”€ search/          # æœç´¢åº”ç”¨æœåŠ¡
â”‚   â”œâ”€â”€ cleanup/         # æ¸…ç†åº”ç”¨æœåŠ¡
â”‚   â””â”€â”€ settings/        # è®¾ç½®åº”ç”¨æœåŠ¡
â”‚
â”œâ”€â”€ core/                # æ ¸å¿ƒå±‚ï¼ˆé¢†åŸŸé€»è¾‘ï¼‰
â”‚   â”œâ”€â”€ bookmark/        # ä¹¦ç­¾é¢†åŸŸæ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ domain/      # é¢†åŸŸå®ä½“å’Œå€¼å¯¹è±¡
â”‚   â”‚   â”œâ”€â”€ repositories/ # ä»“å‚¨æ¥å£
â”‚   â”‚   â””â”€â”€ services/    # é¢†åŸŸæœåŠ¡
â”‚   â””â”€â”€ search/          # æœç´¢é¢†åŸŸé€»è¾‘
â”‚
â”œâ”€â”€ infrastructure/      # åŸºç¡€è®¾æ–½å±‚ï¼ˆæŠ€æœ¯å®ç°ï¼‰
â”‚   â”œâ”€â”€ indexeddb/       # IndexedDB ç®¡ç†
â”‚   â”œâ”€â”€ storage/         # Chrome Storage API
â”‚   â”œâ”€â”€ events/          # äº‹ä»¶æ€»çº¿ï¼ˆmittï¼‰
â”‚   â”œâ”€â”€ query/           # TanStack Query é…ç½®
â”‚   â”œâ”€â”€ state/           # Immer çŠ¶æ€æ›´æ–°å·¥å…·
â”‚   â””â”€â”€ logging/         # æ—¥å¿—ç³»ç»Ÿ
â”‚
â”œâ”€â”€ background/          # åå°è„šæœ¬ï¼ˆChrome Extensionï¼‰
â”‚   â”œâ”€â”€ bookmarks.ts     # ä¹¦ç­¾å˜åŒ–ç›‘å¬
â”‚   â”œâ”€â”€ messaging.ts     # æ¶ˆæ¯é€šä¿¡
â”‚   â”œâ”€â”€ crawler-manager.ts # çˆ¬è™«ç®¡ç†å™¨
â”‚   â””â”€â”€ state.ts         # å…¨å±€çŠ¶æ€ç®¡ç†
â”‚
â”œâ”€â”€ stores/              # Pinia çŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ bookmarkStore.ts      # ä¹¦ç­¾çŠ¶æ€
â”‚   â”œâ”€â”€ ui-store.ts           # UI çŠ¶æ€
â”‚   â”œâ”€â”€ search/               # æœç´¢çŠ¶æ€
â”‚   â””â”€â”€ cleanup/              # æ¸…ç†çŠ¶æ€
â”‚
â””â”€â”€ services/            # æœåŠ¡å±‚ï¼ˆè·¨å±‚åè°ƒï¼‰
    â”œâ”€â”€ bookmark-sync-service.ts  # ä¹¦ç­¾åŒæ­¥æœåŠ¡
    â”œâ”€â”€ modern-bookmark-service.ts # ç°ä»£ä¹¦ç­¾æœåŠ¡
    â”œâ”€â”€ bookmark-trait-service.ts # ä¹¦ç­¾ç‰¹å¾è®¡ç®—æœåŠ¡
    â””â”€â”€ trait-detection-service.ts # ç‰¹å¾æ£€æµ‹ Worker æœåŠ¡
```

#### åˆ†å±‚èŒè´£ä¸è§„åˆ™

| å±‚çº§               | èŒè´£                        | ç¦æ­¢                                    |
| ------------------ | --------------------------- | --------------------------------------- |
| **Presentation**   | UI æ¸²æŸ“ã€ç”¨æˆ·äº¤äº’ã€äº‹ä»¶ç»‘å®š | ç›´æ¥è®¿é—® Chrome APIã€ç›´æ¥è®¿é—® IndexedDB |
| **Application**    | ä¸šåŠ¡æµç¨‹åè°ƒã€è·¨é¢†åŸŸç¼–æ’    | åŒ…å« UI é€»è¾‘ã€ç›´æ¥æ“ä½œ DOM              |
| **Core**           | é¢†åŸŸæ¨¡å‹ã€ä¸šåŠ¡è§„åˆ™ã€çº¯å‡½æ•°  | ä¾èµ–å¤–éƒ¨ APIã€ä¾èµ–æ¡†æ¶                  |
| **Infrastructure** | æŠ€æœ¯å®ç°ã€å¤–éƒ¨ API å°è£…     | åŒ…å«ä¸šåŠ¡é€»è¾‘                            |

### 2.3 å•å‘æ•°æ®æµæ¶æ„

**ğŸš¨ æ¶æ„æ ¸å¿ƒåŸåˆ™**ï¼šIndexedDB æ˜¯æ•´ä¸ªç³»ç»Ÿçš„**å”¯ä¸€æ•°æ®æº**ã€‚

```mermaid
graph LR
    A[Chrome Bookmarks API] -->|ç›‘å¬å˜åŒ–| B[Background Script]
    B -->|åŒæ­¥å†™å…¥| C[IndexedDB]
    C -->|è¯»å–| D[Pinia Store]
    D -->|æ•°æ®ç»‘å®š| E[Vue Components]
    E -->|ç”¨æˆ·æ“ä½œ| F[Application Service]
    F -->|å‘é€æ¶ˆæ¯| B
    B -->|è°ƒç”¨ Chrome API| A
```

#### æ•°æ®æµè§„åˆ™

1. **Chrome API â†’ Background Script**
   - ğŸŸ¢ Background Script æ˜¯å”¯ä¸€ç›‘å¬ `chrome.bookmarks.on*` äº‹ä»¶çš„åœ°æ–¹
   - ğŸŸ¢ æ‰€æœ‰ Chrome API çš„ CRUD æ“ä½œå¿…é¡»é€šè¿‡ Background Script

2. **Background Script â†’ IndexedDB**
   - ğŸŸ¢ Background Script è´Ÿè´£å°† Chrome ä¹¦ç­¾æ•°æ®åŒæ­¥åˆ° IndexedDB
   - ğŸŸ¢ æ”¯æŒå…¨é‡åŒæ­¥ï¼ˆ`syncAllBookmarks`ï¼‰å’Œå¢é‡åŒæ­¥ï¼ˆ`syncIncremental`ï¼‰

3. **IndexedDB â†’ UI**
   - ğŸŸ¢ å‰ç«¯é¡µé¢ä» IndexedDB è¯»å–æ•°æ®
   - ğŸ”´ ç¦æ­¢å‰ç«¯é¡µé¢ç›´æ¥è¯»å– Chrome API

4. **UI â†’ Background Script**
   - ğŸŸ¢ å‰ç«¯é€šè¿‡ `chrome.runtime.sendMessage` å‘é€ CRUD è¯·æ±‚
   - ğŸŸ¢ Background Script æ‰§è¡Œ Chrome API æ“ä½œåè‡ªåŠ¨è§¦å‘åŒæ­¥

#### æ•°æ®åŒæ­¥æœºåˆ¶

```typescript
// ç¤ºä¾‹ï¼šBackground Script ç›‘å¬ä¹¦ç­¾åˆ›å»ºäº‹ä»¶
chrome.bookmarks.onCreated.addListener(async (id, bookmark) => {
  logger.info('ä¹¦ç­¾å·²åˆ›å»º:', bookmark.title)

  // 1. å¢é‡åŒæ­¥åˆ° IndexedDB
  await bookmarkSyncService.syncIncremental('created', id)

  // 2. å¹¿æ’­æ¶ˆæ¯åˆ°æ‰€æœ‰å‰ç«¯é¡µé¢
  chrome.runtime.sendMessage({
    type: 'acuity-bookmarks-db-synced',
    eventType: 'created',
    bookmarkId: id,
    timestamp: Date.now()
  })
})
```

### 2.4 æ„å»ºä¸éƒ¨ç½²

#### 2.4.1 å¼€å‘ç¯å¢ƒ

```bash
# å®‰è£…ä¾èµ–
bun install

# å‰ç«¯å¼€å‘ï¼ˆçƒ­æ›´æ–°ï¼‰
bun run dev:frontend

# å‰ç«¯æ„å»ºï¼ˆå¸¦çƒ­é‡è½½ï¼‰
bun run build:hot

# ç±»å‹æ£€æŸ¥
bun run typecheck:force
```

#### 2.4.2 ä»£ç è´¨é‡

```bash
# ESLint æ£€æŸ¥ä¸ä¿®å¤
bun run lint:fix:enhanced

# Stylelint æ£€æŸ¥ä¸ä¿®å¤
bun run stylelint:fix:enhanced

# æ ¼å¼åŒ–ä»£ç 
bun run format
```

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ ¸å¿ƒåŠŸèƒ½

### 3.1 ä¹¦ç­¾ç®¡ç†ï¼ˆManagement Pageï¼‰

#### 3.1.1 åŒé¢æ¿å¯¹æ¯”è§†å›¾

**é¡µé¢è·¯å¾„**ï¼š`frontend/src/pages/management/Management.vue`

- **å·¦ä¾§é¢æ¿**ï¼šåŸå§‹ä¹¦ç­¾ç»“æ„ï¼ˆ`SimpleBookmarkTree`ï¼‰
- **å³ä¾§é¢æ¿**ï¼šç¼–è¾‘åç»“æ„ï¼ˆ`SimpleBookmarkTree`ï¼‰
- **æ•°æ®æº**ï¼šç»Ÿä¸€ä» IndexedDB åŠ è½½

```typescript
// Management.vue å…³é”®é€»è¾‘
const managementStore = useBookmarkManagementStore()

onMounted(async () => {
  // åˆå§‹åŒ–ï¼šä» IndexedDB åŠ è½½æ•°æ®
  await managementStore.initialize()

  // ç›‘å¬æ•°æ®åŒæ­¥äº‹ä»¶ï¼ˆé€šè¿‡ mitt äº‹ä»¶æ€»çº¿ï¼‰
  const unsubscribeDbSynced = onEvent('data:synced', handleDbSynced)

  onUnmounted(() => {
    unsubscribeDbSynced()
  })
})
```

#### 3.1.2 è™šæ‹Ÿæ»šåŠ¨

**ç»„ä»¶è·¯å¾„**ï¼š`frontend/src/components/composite/SimpleBookmarkTree/SimpleBookmarkTree.vue`

ä½¿ç”¨ `@tanstack/vue-virtual` å®ç°è™šæ‹Ÿæ»šåŠ¨ï¼š

```vue
<script setup lang="ts">
import { useVirtualizer } from '@tanstack/vue-virtual'

const virtualizer = useVirtualizer({
  count: flattenedNodes.value.length,
  getScrollElement: () => scrollContainerRef.value,
  estimateSize: () => 32, // æ¯ä¸ªèŠ‚ç‚¹é«˜åº¦ 32px
  overscan: 10 // é¢„æ¸²æŸ“ 10 ä¸ªèŠ‚ç‚¹
})
</script>
```

#### 3.1.3 æ‹–æ‹½é‡ç»„

æ”¯æŒä¹¦ç­¾å’Œæ–‡ä»¶å¤¹çš„æ‹–æ‹½ç§»åŠ¨ï¼š

- **æ‹–æ‹½åº“**ï¼šåŸç”Ÿ HTML5 Drag & Drop API
- **é™åˆ¶**ï¼šåªèƒ½åœ¨åŒä¸€é¢æ¿å†…æ‹–æ‹½ï¼Œä¸æ”¯æŒè·¨é¢æ¿
- **æ•°æ®æ›´æ–°**ï¼šæ‹–æ‹½å®Œæˆåé€šè¿‡ Application Service å‘é€æ¶ˆæ¯åˆ° Background Script

### 3.2 æ™ºèƒ½æœç´¢

#### 3.2.1 æœç´¢æ¶æ„

**æ ¸å¿ƒæ–‡ä»¶**ï¼š`frontend/src/core/search/unified-search-service.ts`

æ”¯æŒä¸‰ç§æœç´¢æ¨¡å¼ï¼š

1. **å…³é”®è¯æœç´¢**ï¼šåŸºäº IndexedDB ç´¢å¼•çš„ç²¾ç¡®åŒ¹é…
2. **æ¨¡ç³Šæœç´¢**ï¼šåŸºäº Fuse.js çš„æ¨¡ç³ŠåŒ¹é…
3. **è¯­ä¹‰æœç´¢**ï¼šåŸºäº LLM çš„è¯­ä¹‰ç†è§£ï¼ˆéœ€è¦åç«¯æ”¯æŒï¼‰

```typescript
// æœç´¢æµç¨‹
class UnifiedSearchService {
  async search(query: string, options: SearchOptions) {
    // 1. ä» IndexedDB è·å–å€™é€‰ç»“æœ
    const candidates = await indexedDBManager.searchBookmarks(query, options)

    // 2. å¦‚æœå¯ç”¨æ¨¡ç³Šæœç´¢ï¼Œä½¿ç”¨ Fuse.js å†æ¬¡è¿‡æ»¤
    if (options.fuzzyMatch) {
      return this.fuseSearch(candidates, query)
    }

    // 3. è¿”å›ç»“æœ
    return candidates
  }
}
```

#### 3.2.2 æœç´¢æ€§èƒ½ä¼˜åŒ–

- **ç´¢å¼•ä¼˜åŒ–**ï¼šIndexedDB ä¸­ä¸º `titleLower`ã€`urlLower`ã€`domain`ã€`keywords`ã€`tags` å»ºç«‹ç´¢å¼•
- **ç»“æœç¼“å­˜**ï¼šä½¿ç”¨ `query-cache.ts` ç¼“å­˜æœç´¢ç»“æœ
- **é˜²æŠ–**ï¼šä½¿ç”¨ VueUse çš„ `useDebounceFn` é˜²æŠ–ç”¨æˆ·è¾“å…¥

### 3.3 ä¹¦ç­¾ç‰¹å¾æ£€æµ‹

#### 3.3.1 ç‰¹å¾æ ‡ç­¾ç³»ç»Ÿ

**æ ¸å¿ƒæ–‡ä»¶**ï¼š`frontend/src/services/bookmark-trait-service.ts`

æ”¯æŒçš„ç‰¹å¾æ ‡ç­¾ï¼š

- `invalid`ï¼šå¤±æ•ˆä¹¦ç­¾ï¼ˆHTTP 404/500 æˆ–æ— æ•ˆ URLï¼‰
- `duplicate`ï¼šé‡å¤ URL
- `internal`ï¼šæµè§ˆå™¨å†…éƒ¨é“¾æ¥ï¼ˆchrome://ã€file:// ç­‰ï¼‰

```typescript
// ç‰¹å¾æ£€æµ‹æµç¨‹
async function evaluateBookmarkTraits(bookmarkId: string) {
  const bookmark = await indexedDBManager.getBookmarkById(bookmarkId)
  if (!bookmark?.url) return

  const traitTags: string[] = []

  // 1. æ£€æŸ¥æ˜¯å¦ä¸ºæµè§ˆå™¨å†…éƒ¨åè®®
  if (isInternalProtocol(bookmark.url)) {
    traitTags.push('internal')
  }
  // 2. å¯¹äºéå†…éƒ¨åè®®çš„ä¹¦ç­¾ï¼Œè¿›è¡Œè¿›ä¸€æ­¥æ£€æŸ¥
  else {
    // 2.1 URLæ ¼å¼æ£€æµ‹
    if (!isValidBookmarkUrl(bookmark.url)) {
      traitTags.push('invalid')
    }
    // 2.2 HTTPé”™è¯¯æ£€æµ‹
    else {
      const crawlMetadata = await indexedDBManager.getCrawlMetadata(bookmarkId)
      if (crawlMetadata && isHttpFailure(crawlMetadata)) {
        traitTags.push('invalid')
      }
    }
  }

  // 3. é‡å¤ä¹¦ç­¾æ£€æµ‹
  const duplicates = await indexedDBManager.getBookmarksByUrl(bookmark.url)
  if (duplicates.length > 1) {
    traitTags.push('duplicate')
  }

  // 4. æ›´æ–°ç‰¹å¾æ ‡ç­¾åˆ° IndexedDB
  await indexedDBManager.updateBookmarksTraits([
    {
      id: bookmarkId,
      traitTags,
      traitMetadata: traitTags.map(tag => ({
        tag,
        detectedAt: Date.now(),
        source: 'worker'
      }))
    }
  ])
}
```

### 3.4 æœ¬åœ°åŒ–çˆ¬å–

#### 3.4.1 çˆ¬å–æ¶æ„

**æ ¸å¿ƒæ–‡ä»¶**ï¼š`frontend/src/services/local-bookmark-crawler.ts`

- **çˆ¬å–æ–¹å¼**ï¼šé€šè¿‡ `fetch` API ç›´æ¥è¯·æ±‚ä¹¦ç­¾ URL
- **å¹¶å‘æ§åˆ¶**ï¼šä½¿ç”¨ `p-queue` é™åˆ¶å¹¶å‘æ•°ï¼ˆé»˜è®¤ 5ï¼‰
- **æ•°æ®å­˜å‚¨**ï¼šçˆ¬å–å…ƒæ•°æ®å­˜å‚¨åœ¨ IndexedDB çš„ `crawl_metadata` è¡¨

```typescript
class LocalBookmarkCrawler {
  private queue = new PQueue({ concurrency: 5 })

  async crawlBookmark(bookmarkId: string, url: string) {
    return this.queue.add(async () => {
      try {
        const response = await fetch(url, { method: 'HEAD' })

        // å­˜å‚¨çˆ¬å–å…ƒæ•°æ®
        await indexedDBManager.saveCrawlMetadata({
          bookmarkId,
          url,
          httpStatus: response.status,
          lastCrawled: Date.now()
        })
      } catch (error) {
        logger.error('çˆ¬å–å¤±è´¥', { bookmarkId, url, error })
      }
    })
  }
}
```

---

## ç¬¬å››éƒ¨åˆ†ï¼šå¼€å‘è§„èŒƒ

### 4.1 ä»£ç è§„èŒƒ

#### 4.1.1 TypeScript è§„èŒƒ

- âœ… **ç¦æ­¢ä½¿ç”¨ `any`**ï¼šæ‰€æœ‰ç±»å‹å¿…é¡»æ˜ç¡®å£°æ˜
- âœ… **ä½¿ç”¨ Zod è¿›è¡Œè¿è¡Œæ—¶æ ¡éªŒ**ï¼šå¯¹å¤–éƒ¨æ•°æ®ï¼ˆIndexedDBã€Chrome APIï¼‰è¿›è¡Œæ ¡éªŒ
- âœ… **JSDoc æ³¨é‡Š**ï¼šæ‰€æœ‰å…¬å¼€å‡½æ•°å’Œç±»å¿…é¡»æœ‰ä¸­æ–‡ JSDoc æ³¨é‡Š

```typescript
/**
 * ä» IndexedDB åŠ è½½æ‰€æœ‰ä¹¦ç­¾
 *
 * @returns ä¹¦ç­¾èŠ‚ç‚¹æ•°ç»„
 * @throws {Error} å¦‚æœæ•°æ®åº“æœªåˆå§‹åŒ–
 */
async function loadAllBookmarks(): Promise<BookmarkNode[]> {
  const records = await indexedDBManager.getAllBookmarks()
  return BookmarkRecordArraySchema.parse(records)
}
```

#### 4.1.2 Vue ç»„ä»¶è§„èŒƒ

- âœ… **ä½¿ç”¨ `<script setup>` + Composition API**
- âœ… **ç»„ä»¶å‘½åä½¿ç”¨ PascalCase**ï¼š`SimpleBookmarkTree.vue`
- âœ… **å¯¼å‡ºç»„ä»¶å**ï¼š`defineOptions({ name: "SimpleBookmarkTree" })`

```vue
<script setup lang="ts">
import { defineOptions } from 'vue'

defineOptions({
  name: 'SimpleBookmarkTree'
})

// ç»„ä»¶é€»è¾‘
</script>
```

#### 4.1.3 Pinia Store è§„èŒƒ

- âœ… **ä½¿ç”¨ Composition API é£æ ¼**ï¼š`const store = defineStore('name', () => { ... })`
- âœ… **ä½¿ç”¨ Immer æ›´æ–°å¤æ‚çŠ¶æ€**ï¼š`updateMap(nodes.value, draft => { ... })`
- âœ… **æ˜ç¡®å¯¼å‡º API**ï¼šåœ¨ `return` ä¸­æ˜ç¡®å¯¼å‡ºå“ªäº›çŠ¶æ€å’Œæ–¹æ³•

```typescript
export const useBookmarkStore = defineStore('bookmarks', () => {
  const nodes = ref<Map<string, BookmarkNode>>(new Map())

  function addNode(node: BookmarkNode) {
    updateMap(nodes.value, draft => {
      draft.set(node.id, node)
    })
  }

  return {
    // State
    nodes: readonly(nodes),
    // Actions
    addNode
  }
})
```

### 4.2 æ–‡ä»¶ç»„ç»‡è§„èŒƒ

#### 4.2.1 ç»„ä»¶ç›®å½•ç»“æ„

```
components/
â”œâ”€â”€ base/              # åŸºç¡€ç»„ä»¶ï¼ˆButton, Input, Dialogï¼‰
â”‚   â”œâ”€â”€ Button/
â”‚   â”‚   â”œâ”€â”€ Button.vue
â”‚   â”‚   â”œâ”€â”€ Button.d.ts       # TypeScript ç±»å‹å®šä¹‰
â”‚   â”‚   â””â”€â”€ Button.README.md  # ç»„ä»¶æ–‡æ¡£
â”‚   â””â”€â”€ ...
â””â”€â”€ composite/         # å¤åˆç»„ä»¶ï¼ˆä¸šåŠ¡ç»„ä»¶ï¼‰
    â”œâ”€â”€ SimpleBookmarkTree/
    â””â”€â”€ ...
```

#### 4.2.2 ç±»å‹å®šä¹‰æ–‡ä»¶

æ‰€æœ‰ç±»å‹å®šä¹‰é›†ä¸­åœ¨ `frontend/src/types/` ç›®å½•ï¼š

```
types/
â”œâ”€â”€ domain/            # é¢†åŸŸæ¨¡å‹ç±»å‹
â”‚   â”œâ”€â”€ bookmark.ts
â”‚   â””â”€â”€ search.ts
â”œâ”€â”€ application/       # åº”ç”¨å±‚ç±»å‹
â”œâ”€â”€ infrastructure/    # åŸºç¡€è®¾æ–½å±‚ç±»å‹
â””â”€â”€ index.ts           # ç»Ÿä¸€å¯¼å‡º
```

### 4.3 Git æäº¤è§„èŒƒ

éµå¾ª [Conventional Commits](https://www.conventionalcommits.org/) è§„èŒƒï¼š

```bash
# æ ¼å¼
<type>(<scope>): <subject>

# ç¤ºä¾‹
feat(search): æ·»åŠ è¯­ä¹‰æœç´¢åŠŸèƒ½
fix(store): ä¿®å¤ä¹¦ç­¾æ ‘æ— é™é€’å½’é—®é¢˜
refactor(indexeddb): ä½¿ç”¨ Immer ç®€åŒ–çŠ¶æ€æ›´æ–°
docs(readme): æ›´æ–°å®‰è£…è¯´æ˜
```

**Type ç±»å‹**ï¼š

- `feat`ï¼šæ–°åŠŸèƒ½
- `fix`ï¼šBug ä¿®å¤
- `refactor`ï¼šä»£ç é‡æ„
- `docs`ï¼šæ–‡æ¡£æ›´æ–°
- `style`ï¼šä»£ç æ ¼å¼è°ƒæ•´
- `test`ï¼šæµ‹è¯•ç›¸å…³
- `chore`ï¼šæ„å»º/å·¥å…·é“¾ç›¸å…³

---

## ç¬¬äº”éƒ¨åˆ†ï¼šæ•°æ®æµè®¾è®¡

### 5.1 å•å‘æ•°æ®æµè¯¦è§£

#### 5.1.1 å®Œæ•´æ•°æ®æµå›¾

```
[ç”¨æˆ·æ“ä½œ UI]
      â†“
[Vue Component]
      â†“
[Application Service] â”€â”€â”€â”€å‘é€æ¶ˆæ¯â”€â”€â”€â†’ [Background Script]
                                              â†“
                                      [è°ƒç”¨ Chrome API]
                                              â†“
                                      [Chrome Bookmarks]
                                              â†“
                                  [è§¦å‘ chrome.bookmarks.on* äº‹ä»¶]
                                              â†“
                                  [Background Script ç›‘å¬å™¨]
                                              â†“
                              [åŒæ­¥åˆ° IndexedDBï¼ˆå…¨é‡/å¢é‡ï¼‰]
                                              â†“
                              [å¹¿æ’­æ¶ˆæ¯åˆ°æ‰€æœ‰å‰ç«¯é¡µé¢]
                                              â†“
                                  [å‰ç«¯ç›‘å¬ mitt äº‹ä»¶]
                                              â†“
                              [ä» IndexedDB åˆ·æ–°æ•°æ®]
                                              â†“
                                  [æ›´æ–° Pinia Store]
                                              â†“
                                  [Vue å“åº”å¼æ›´æ–° UI]
```

#### 5.1.2 CRUD æ“ä½œæµç¨‹

##### åˆ›å»ºä¹¦ç­¾

```typescript
// 1. å‰ç«¯å‘èµ·è¯·æ±‚
async function createBookmark(parentId: string, title: string, url: string) {
  await chrome.runtime.sendMessage({
    type: 'CREATE_BOOKMARK',
    parentId,
    title,
    url
  })
}

// 2. Background Script å¤„ç†
chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
  if (message.type === 'CREATE_BOOKMARK') {
    chrome.bookmarks.create({
      parentId: message.parentId,
      title: message.title,
      url: message.url
    })
    // æ³¨æ„ï¼šä¸éœ€è¦æ‰‹åŠ¨åŒæ­¥ï¼Œchrome.bookmarks.onCreated ä¼šè‡ªåŠ¨è§¦å‘
  }
})

// 3. chrome.bookmarks.onCreated è‡ªåŠ¨è§¦å‘åŒæ­¥
chrome.bookmarks.onCreated.addListener(async (id, bookmark) => {
  await bookmarkSyncService.syncIncremental('created', id)
  chrome.runtime.sendMessage({
    type: 'acuity-bookmarks-db-synced',
    eventType: 'created',
    bookmarkId: id
  })
})

// 4. å‰ç«¯ç›‘å¬åŒæ­¥æ¶ˆæ¯
onEvent('data:synced', async data => {
  if (data.eventType === 'created') {
    await bookmarkStore.loadFromIndexedDB()
  }
})
```

##### æ›´æ–°ä¹¦ç­¾

```typescript
// å‰ç«¯ â†’ Background â†’ Chrome API â†’ onChanged â†’ åŒæ­¥ â†’ å‰ç«¯åˆ·æ–°
```

##### åˆ é™¤ä¹¦ç­¾

```typescript
// å‰ç«¯ â†’ Background â†’ Chrome API â†’ onRemoved â†’ åŒæ­¥ â†’ å‰ç«¯åˆ·æ–°
```

#### 5.1.3 å¢é‡åŒæ­¥ vs å…¨é‡åŒæ­¥

| åŒæ­¥æ–¹å¼     | è§¦å‘æ—¶æœº                         | æ€§èƒ½                 | æ•°æ®å®Œæ•´æ€§                |
| ------------ | -------------------------------- | -------------------- | ------------------------- |
| **å¢é‡åŒæ­¥** | å•ä¸ªä¹¦ç­¾çš„ CRUD æ“ä½œ             | é«˜ï¼ˆåªæ›´æ–°å•ä¸ªèŠ‚ç‚¹ï¼‰ | ä¸­ï¼ˆä¾èµ– pathIds æ­£ç¡®æ€§ï¼‰ |
| **å…¨é‡åŒæ­¥** | ä¹¦ç­¾å¯¼å…¥ã€ç§»åŠ¨æ“ä½œã€æ•°æ®å¥åº·æ£€æŸ¥ | ä½ï¼ˆé‡å»ºæ•´ä¸ªæ ‘ï¼‰     | é«˜ï¼ˆå®Œå…¨ä¸€è‡´ï¼‰            |

```typescript
// å¢é‡åŒæ­¥
await bookmarkSyncService.syncIncremental('created', bookmarkId)

// å…¨é‡åŒæ­¥
await bookmarkSyncService.syncAllBookmarks()
```

### 5.2 äº‹ä»¶ç³»ç»Ÿï¼ˆmittï¼‰

#### 5.2.1 äº‹ä»¶å®šä¹‰

**æ–‡ä»¶è·¯å¾„**ï¼š`frontend/src/infrastructure/events/event-bus.ts`

```typescript
export interface AppEvents {
  'bookmark:created': { id: string; bookmark: BookmarkNode }
  'bookmark:updated': { id: string; changes: Partial<BookmarkNode> }
  'bookmark:deleted': { id: string }
  'data:synced': { eventType: string; bookmarkId: string; timestamp: number }
  'sync:started': { source: 'background' | 'user' | 'auto' }
  'sync:completed': { duration: number; count: number }
}
```

#### 5.2.2 äº‹ä»¶ä½¿ç”¨

```typescript
// å‘é€äº‹ä»¶
emitEvent('bookmark:created', { id: '123', bookmark: { ... } })

// ç›‘å¬äº‹ä»¶
const unsubscribe = onEvent('bookmark:created', (data) => {
  console.log('ä¹¦ç­¾åˆ›å»º:', data.id)
})

// å–æ¶ˆç›‘å¬
unsubscribe()
```

### 5.3 Chrome æ¶ˆæ¯æ¡¥æ¥

**æ–‡ä»¶è·¯å¾„**ï¼š`frontend/src/infrastructure/events/chrome-message-bridge.ts`

è´Ÿè´£å°† Chrome Runtime æ¶ˆæ¯è½¬æ¢ä¸º mitt äº‹ä»¶ï¼š

```typescript
export function initializeChromeMessageBridge() {
  chrome.runtime.onMessage.addListener(message => {
    if (message.type === 'acuity-bookmarks-db-synced') {
      // å°† Chrome æ¶ˆæ¯è½¬æ¢ä¸º mitt äº‹ä»¶
      emitEvent('data:synced', {
        eventType: message.eventType,
        bookmarkId: message.bookmarkId,
        timestamp: message.timestamp
      })
    }
  })
}
```

---

## ç¬¬å…­éƒ¨åˆ†ï¼šå­˜å‚¨æ–¹æ¡ˆ

### 6.1 å­˜å‚¨å±‚çº§åˆ’åˆ†

AcuityBookmarks ä½¿ç”¨ **å››å±‚å­˜å‚¨æ¶æ„**ï¼Œæ¯å±‚æœ‰æ˜ç¡®çš„èŒè´£ï¼š

| å­˜å‚¨ç±»å‹                   | ç”Ÿå‘½å‘¨æœŸ                   | å®¹é‡é™åˆ¶           | ä½¿ç”¨åœºæ™¯                                    | Chrome ç‰ˆæœ¬è¦æ±‚ |
| -------------------------- | -------------------------- | ------------------ | ------------------------------------------- | --------------- |
| **IndexedDB**              | æ°¸ä¹…ï¼ˆé™¤éç”¨æˆ·æ¸…é™¤ï¼‰       | å¯ç”¨ç£ç›˜ç©ºé—´çš„ 60% | å¤§é‡ä¹¦ç­¾æ•°æ®ï¼ˆ2 ä¸‡+ï¼‰ã€çˆ¬å–å…ƒæ•°æ®ã€æœç´¢å†å² | æ‰€æœ‰ç‰ˆæœ¬        |
| **chrome.storage.local**   | æ°¸ä¹…                       | 10 MB              | ç”¨æˆ·åå¥½è®¾ç½®ã€æ‰©å±•é…ç½®ã€æŒä¹…åŒ–çŠ¶æ€          | æ‰€æœ‰ç‰ˆæœ¬        |
| **chrome.storage.session** | ä¼šè¯çº§ï¼ˆæµè§ˆå™¨å…³é—­åæ¸…é™¤ï¼‰ | 10 MB              | ä¸´æ—¶æ•°æ®ã€UI çŠ¶æ€ã€æœªä¿å­˜è¡¨å•ã€æœç´¢å†å²     | Chrome 102+     |
| **Pinia Store**            | é¡µé¢çº§ï¼ˆé¡µé¢åˆ·æ–°åæ¸…é™¤ï¼‰   | å†…å­˜               | é«˜é¢‘ UI çŠ¶æ€ã€è®¡ç®—å±æ€§ã€ä¸´æ—¶ç¼“å­˜            | N/A             |

### 6.2 IndexedDB è®¾è®¡

#### 6.2.1 æ•°æ®åº“ç»“æ„

**æ•°æ®åº“åç§°**ï¼š`AcuityBookmarksDB`  
**ç‰ˆæœ¬å·**ï¼š`11`

**å¯¹è±¡å­˜å‚¨ï¼ˆObject Storesï¼‰**ï¼š

```typescript
{
  // 1. ä¹¦ç­¾æ•°æ®è¡¨ï¼ˆä¸»è¡¨ï¼‰
  bookmarks: {
    keyPath: 'id',
    indexes: [
      'parentId',           // çˆ¶èŠ‚ç‚¹ ID
      'url',                // URL
      'urlLower',           // URLï¼ˆå°å†™ï¼‰
      'domain',             // åŸŸå
      'titleLower',         // æ ‡é¢˜ï¼ˆå°å†™ï¼‰
      'parentId_index',     // å¤åˆç´¢å¼•ï¼ˆçˆ¶èŠ‚ç‚¹ + æ’åºï¼‰
      'pathIds',            // è·¯å¾„ ID æ•°ç»„ï¼ˆmultiEntryï¼‰
      'keywords',           // å…³é”®è¯ï¼ˆmultiEntryï¼‰
      'tags',               // æ ‡ç­¾ï¼ˆmultiEntryï¼‰
      'traitTags',          // ç‰¹å¾æ ‡ç­¾ï¼ˆmultiEntryï¼‰
      'dateAdded'           // æ·»åŠ æ—¶é—´
    ]
  },

  // 2. å…¨å±€ç»Ÿè®¡è¡¨
  global_stats: {
    keyPath: 'key',
    indexes: ['key', 'updatedAt']
  },

  // 3. è®¾ç½®è¡¨
  settings: {
    keyPath: 'key',
    indexes: ['updatedAt', 'type']
  },

  // 4. æœç´¢å†å²è¡¨
  search_history: {
    keyPath: 'id',
    autoIncrement: true,
    indexes: ['query', 'timestamp', 'source']
  },

  // 5. Favicon ç¼“å­˜è¡¨
  favicon_cache: {
    keyPath: 'domain',
    indexes: ['timestamp', 'lastAccessed', 'bookmarkCount']
  },

  // 6. çˆ¬å–å…ƒæ•°æ®è¡¨
  crawl_metadata: {
    keyPath: 'bookmarkId',
    indexes: ['domain', 'httpStatus', 'lastCrawled']
  },

  // 7. å‘é‡åµŒå…¥è¡¨ï¼ˆAI åŠŸèƒ½ï¼‰
  embeddings: {
    keyPath: 'bookmarkId',
    indexes: ['domain', 'updatedAt']
  },

  // 8. AI ä»»åŠ¡è¡¨
  ai_jobs: {
    keyPath: 'id',
    indexes: ['status', 'type', 'createdAt']
  }
}
```

#### 6.2.2 BookmarkRecord æ•°æ®ç»“æ„

```typescript
interface BookmarkRecord {
  // åŸºç¡€å­—æ®µï¼ˆæ¥è‡ª Chrome APIï¼‰
  id: string
  title: string
  url?: string
  parentId?: string
  index?: number
  dateAdded?: number
  dateGroupModified?: number

  // å¢å¼ºå­—æ®µï¼ˆè‡ªå®šä¹‰ï¼‰
  titleLower: string // æ ‡é¢˜å°å†™ï¼ˆç”¨äºæœç´¢ï¼‰
  urlLower?: string // URL å°å†™ï¼ˆç”¨äºæœç´¢ï¼‰
  domain?: string // åŸŸåï¼ˆæå–è‡ª URLï¼‰
  pathIds: string[] // è·¯å¾„ ID æ•°ç»„ï¼ˆä»æ ¹åˆ°å½“å‰èŠ‚ç‚¹ï¼‰
  keywords: string[] // å…³é”®è¯ï¼ˆæå–è‡ªæ ‡é¢˜å’Œ URLï¼‰
  tags: string[] // ç”¨æˆ·è‡ªå®šä¹‰æ ‡ç­¾

  // ç‰¹å¾ç›¸å…³
  traitTags: string[] // ç‰¹å¾æ ‡ç­¾ï¼ˆduplicate, invalid, internalï¼‰
  traitMetadata: Array<{
    tag: string
    detectedAt: number
    source: 'worker' | 'manual'
    notes?: string
  }>

  // ç»Ÿè®¡ä¿¡æ¯
  visitCount?: number // è®¿é—®æ¬¡æ•°
  lastVisited?: number // æœ€åè®¿é—®æ—¶é—´
}
```

#### 6.2.3 IndexedDB æ€§èƒ½ä¼˜åŒ–

**é’ˆå¯¹ 2 ä¸‡ä¹¦ç­¾çš„ä¼˜åŒ–**ï¼š

1. **æ‰¹é‡æ“ä½œ**ï¼šä½¿ç”¨ `runBatchOperation` åˆ†æ‰¹å†™å…¥ï¼ˆé»˜è®¤ 2000/æ‰¹ï¼‰
2. **ç´¢å¼•ä¼˜åŒ–**ï¼šä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µå»ºç«‹ç´¢å¼•
3. **ç¼“å­˜æ ‘ç»“æ„**ï¼š`bookmarkStore` ä¸­ç¼“å­˜è®¡ç®—å¥½çš„æ ‘ç»“æ„
4. **é€’å½’æ‰å¹³åŒ–**ï¼šä½¿ç”¨ `flattenTreeToMap` å°†æ ‘ç»“æ„æ‰å¹³åŒ–ä¸º Map

```typescript
// æ€§èƒ½å¯¹æ¯”ï¼ˆ2 ä¸‡ä¹¦ç­¾ï¼‰
æ“ä½œ                 | ä¼˜åŒ–å‰   | ä¼˜åŒ–å   | æå‡
---------------------|---------|---------|------
åˆæ¬¡åŠ è½½             | 5-8s    | 1-2s    | 4-5x
æ ‘ç»“æ„è®¡ç®—           | 800ms   | <50ms   | 16x
èŠ‚ç‚¹æŸ¥æ‰¾ï¼ˆMapï¼‰      | O(n)    | O(1)    | 2ä¸‡x
```

### 6.3 chrome.storage ä½¿ç”¨

#### 6.3.1 chrome.storage.sessionï¼ˆä¸´æ—¶æ•°æ®ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`frontend/src/infrastructure/storage/modern-storage.ts`

```typescript
// 1. æ•°æ®åº“å°±ç»ªçŠ¶æ€ï¼ˆä¼šè¯çº§ï¼‰
await modernStorage.setSession('AB_DB_READY', true)

// 2. åŒæ­¥çŠ¶æ€ï¼ˆé˜²æ­¢é‡å¤åŒæ­¥ï¼‰
await modernStorage.setSession('SYNC_STATE', { isSyncing: true })

// 3. çˆ¬å–ä»»åŠ¡çŠ¶æ€
await modernStorage.setSession('CRAWL_RUNNING', true)

// 4. UI çŠ¶æ€ï¼ˆå±•å¼€çš„æ–‡ä»¶å¤¹ï¼‰
await modernStorage.setSession('ORIGINAL_EXPANDED', new Set(['1', '2']))

// 5. æœç´¢å†å²ï¼ˆä¼šè¯çº§ï¼‰
await modernStorage.setSession('SEARCH_HISTORY', ['query1', 'query2'])

// 6. æœªä¿å­˜çš„ç¼–è¾‘è‰ç¨¿
await modernStorage.setSession('EDIT_BOOKMARK_DRAFT', {
  id: '123',
  title: 'æ–°æ ‡é¢˜'
})
```

#### 6.3.2 chrome.storage.localï¼ˆæŒä¹…åŒ–æ•°æ®ï¼‰

```typescript
// 1. ç”¨æˆ·åå¥½è®¾ç½®
await modernStorage.setLocal('USER_PREFERENCES', {
  theme: 'dark',
  language: 'zh-CN'
})

// 2. æ‰©å±•é…ç½®
await modernStorage.setLocal('EXTENSION_CONFIG', {
  apiEndpoint: 'https://api.acuitybookmarks.com',
  enableAI: true
})

// 3. æœç´¢è®¾ç½®
await modernStorage.setLocal('SEARCH_SETTINGS', {
  fuzzyMatch: true,
  maxResults: 100
})

// 4. æ¸…ç†è¿‡æ»¤å™¨ï¼ˆæŒä¹…åŒ–ï¼‰
await modernStorage.setLocal('ACTIVE_FILTERS', ['DEAD_LINK'])
```

### 6.4 Pinia Storeï¼ˆå†…å­˜çŠ¶æ€ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š

- âœ… é«˜é¢‘æ›´æ–°çš„ UI çŠ¶æ€ï¼ˆé€‰ä¸­é¡¹ã€æ‚¬åœçŠ¶æ€ï¼‰
- âœ… è®¡ç®—å±æ€§ï¼ˆè™šæ‹Ÿæ»šåŠ¨çš„æ‰å¹³åŒ–èŠ‚ç‚¹åˆ—è¡¨ï¼‰
- âœ… ä¸´æ—¶ç¼“å­˜ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰

```typescript
// ç¤ºä¾‹ï¼šbookmarkStore
export const useBookmarkStore = defineStore('bookmarks', () => {
  // å†…å­˜ä¸­çš„èŠ‚ç‚¹æ˜ å°„ï¼ˆä» IndexedDB åŠ è½½åç¼“å­˜ï¼‰
  const nodes = ref<Map<string, BookmarkNode>>(new Map())

  // è®¡ç®—å±æ€§ï¼ˆè‡ªåŠ¨å“åº”å¼ï¼‰
  const bookmarkTree = computed(() => buildTreeFromNodes(nodes.value))

  return { nodes, bookmarkTree }
})
```

---

## ç¬¬ä¸ƒéƒ¨åˆ†ï¼šå…³é”®å®ç°ç»†èŠ‚

### 7.1 Immer é›†æˆ

**æ–‡ä»¶è·¯å¾„**ï¼š`frontend/src/infrastructure/state/immer-helpers.ts`

Immer ç”¨äºç®€åŒ–ä¸å¯å˜çŠ¶æ€æ›´æ–°ï¼š

```typescript
import { produce } from 'immer'

/**
 * æ›´æ–° Vue Ref åŒ…è£…çš„ Map
 */
export function updateMap<K, V>(
  mapRef: Ref<Map<K, V>>,
  updater: (draft: Map<K, V>) => void
): void {
  mapRef.value = produce(mapRef.value, updater)
}

/**
 * æ›´æ–° Vue Ref åŒ…è£…çš„æ•°ç»„
 */
export function updateArray<T>(
  arrayRef: Ref<T[]>,
  updater: (draft: T[]) => void
): void {
  arrayRef.value = produce(arrayRef.value, updater)
}

// ä½¿ç”¨ç¤ºä¾‹
const nodes = ref(new Map<string, BookmarkNode>())

updateMap(nodes, draft => {
  draft.set('123', { id: '123', title: 'æ–°ä¹¦ç­¾' })
  draft.delete('456')
})
```

### 7.2 TanStack Query é›†æˆ

**æ–‡ä»¶è·¯å¾„**ï¼š`frontend/src/infrastructure/query/query-client.ts`

TanStack Query ç”¨äºç®¡ç†å¼‚æ­¥æ•°æ®è·å–å’Œç¼“å­˜ï¼š

```typescript
import { QueryClient } from '@tanstack/vue-query'

export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000, // 5 åˆ†é’Ÿç¼“å­˜
      cacheTime: 10 * 60 * 1000, // 10 åˆ†é’Ÿåæ¸…é™¤
      refetchOnWindowFocus: false,
      retry: 1
    }
  }
})
```

**Composable ä½¿ç”¨**ï¼š

```typescript
// frontend/src/composables/useBookmarkQueries.ts
import { useQuery } from '@tanstack/vue-query'

export function useBookmarkQuery(bookmarkId: string) {
  return useQuery({
    queryKey: ['bookmark', bookmarkId],
    queryFn: async () => {
      return await indexedDBManager.getBookmarkById(bookmarkId)
    },
    staleTime: 5 * 60 * 1000
  })
}
```

### 7.3 VueUse å®ç”¨å·¥å…·

**å¸¸ç”¨ VueUse Composables**ï¼š

```typescript
import {
  useEventListener, // è‡ªåŠ¨æ¸…ç†çš„äº‹ä»¶ç›‘å¬
  useDebounceFn, // é˜²æŠ–å‡½æ•°
  useTimeoutFn, // è‡ªåŠ¨æ¸…ç†çš„ setTimeout
  useStorage, // localStorage å“åº”å¼åŒ…è£…
  useToggle, // å¸ƒå°”å€¼åˆ‡æ¢
  useMouse, // é¼ æ ‡ä½ç½®è·Ÿè¸ª
  useIntersectionObserver // å…ƒç´ å¯è§æ€§æ£€æµ‹
} from '@vueuse/core'

// ç¤ºä¾‹ï¼šé˜²æŠ–æœç´¢
const debouncedSearch = useDebounceFn(async (query: string) => {
  await searchService.search(query)
}, 300)
```

### 7.4 Zod æ•°æ®æ ¡éªŒ

**æ–‡ä»¶è·¯å¾„**ï¼š`frontend/src/infrastructure/indexeddb/validation/records.ts`

æ‰€æœ‰ä» IndexedDB è¯»å–çš„æ•°æ®éƒ½éœ€è¦é€šè¿‡ Zod æ ¡éªŒï¼š

```typescript
import { z } from 'zod'

export const BookmarkRecordSchema = z.object({
  id: z.string(),
  title: z.string(),
  url: z.string().url().optional(),
  parentId: z.string().optional(),
  index: z.number().optional(),
  titleLower: z.string(),
  pathIds: z.array(z.string()).default([]),
  keywords: z.array(z.string()).default([]),
  tags: z.array(z.string()).default([]),
  traitTags: z.array(z.string()).default([]),
  traitMetadata: z
    .array(
      z.object({
        tag: z.string(),
        detectedAt: z.number(),
        source: z.enum(['worker', 'manual']),
        notes: z.string().optional()
      })
    )
    .default([])
})

// ä½¿ç”¨
const records = await indexedDBManager.getAllBookmarks()
const validated = BookmarkRecordArraySchema.parse(records)
```

### 7.5 æ€§èƒ½ç›‘æ§

**æ–‡ä»¶è·¯å¾„**ï¼š`frontend/src/components/base/PerformanceMonitor/PerformanceMonitor.vue`

å¼€å‘æ¨¡å¼ä¸‹è‡ªåŠ¨ç›‘æ§æ€§èƒ½æŒ‡æ ‡ï¼š

```typescript
// ç›‘æ§æŒ‡æ ‡
interface PerformanceMetrics {
  // é¡µé¢åŠ è½½
  domContentLoaded: number
  windowLoad: number

  // æ¸²æŸ“æ€§èƒ½
  firstPaint: number
  firstContentfulPaint: number
  largestContentfulPaint: number

  // äº¤äº’æ€§èƒ½
  firstInputDelay: number
  totalBlockingTime: number

  // è‡ªå®šä¹‰æŒ‡æ ‡
  bookmarkTreeBuildTime: number
  indexedDBQueryTime: number
}
```

### 7.6 é•¿è€—æ—¶ä»»åŠ¡è®¾è®¡åŸåˆ™

> ğŸ¯ **è®¾è®¡å“²å­¦**ï¼šçœŸå®è¿›åº¦ > å‡è¿›åº¦ > æ— åé¦ˆ

#### 7.6.1 æ ¸å¿ƒè®¾è®¡åŸåˆ™

##### åŸåˆ™ 1ï¼šä¸šåŠ¡ä¼˜å…ˆçº§å†³å®šæ‰§è¡Œç­–ç•¥

```typescript
ğŸ”´ æ ¸å¿ƒä¸šåŠ¡ï¼ˆåŒæ­¥æ‰§è¡Œ + çœŸå®è¿›åº¦ï¼‰
  - ç”¨æˆ·å¿…é¡»ç­‰å¾…æ‰èƒ½ç»§ç»­æ“ä½œ
  - é˜»å¡ä¸»çº¿ç¨‹ï¼Œä½†æä¾›æ¸…æ™°çš„è¿›åº¦åé¦ˆ
  - å‘Šè¯‰ç”¨æˆ·ï¼š"åœ¨åšä»€ä¹ˆ"ã€"è¿›åº¦å¤šå°‘"ã€"è¿˜è¦å¤šä¹…"

ğŸŸ¡ è¾…åŠ©ä¸šåŠ¡ï¼ˆWorker å¼‚æ­¥ + åå°æ‰§è¡Œï¼‰
  - ä¸å½±å“æ ¸å¿ƒä¹¦ç­¾æ“ä½œ
  - å¯ä»¥åœ¨åå°æ…¢æ…¢æ‰§è¡Œ
  - å¤±è´¥ä¸å½±å“ä¸»è¦åŠŸèƒ½
```

##### åŸåˆ™ 2ï¼šçœŸå®è¿›åº¦åé¦ˆä¼˜äºå‡è£…æµç•…

```typescript
âœ… çœŸå®è¿›åº¦ï¼š50% â†’ ç”¨æˆ·çŸ¥é“è¿˜è¦ç­‰å¤šä¹… â†’ ç”¨æˆ·ä½“éªŒå¥½
âš ï¸ å‡è¿›åº¦ï¼šè½¬åœˆåœˆ â†’ ç”¨æˆ·ç„¦è™‘ä½†èƒ½æ¥å— â†’ ç”¨æˆ·ä½“éªŒä¸€èˆ¬
âŒ æ— åé¦ˆï¼šé¡µé¢å†»ç»“ â†’ ç”¨æˆ·ä»¥ä¸ºå´©æºƒäº† â†’ ç”¨æˆ·ä½“éªŒå·®
```

**ç†ç”±**ï¼š

- å¦‚æœæ•°æ®æ²¡æœ‰å®Œå…¨å½•å…¥ IndexedDBï¼Œç”¨æˆ·æ‰“å¼€ç®¡ç†é¡µé¢ä¹Ÿåšä¸äº†ä»€ä¹ˆ
- Worker å¼‚æ­¥åªæ˜¯"å‡è£…æµç•…"ï¼Œå®é™…å¯æ“ä½œæ—¶é—´ä¸å˜
- è¯šå®çš„è¿›åº¦åé¦ˆ > ç¾å¥½çš„å‡è±¡

#### 7.6.2 ä¸šåŠ¡åˆ†çº§ä¸æ‰§è¡Œç­–ç•¥

##### ğŸ”´ æ ¸å¿ƒä¸šåŠ¡ï¼ˆå¿…é¡»åŒæ­¥æ‰§è¡Œ + å®æ—¶è¿›åº¦ï¼‰

| ä¸šåŠ¡               | è€—æ—¶               | ä¼˜å…ˆçº§ | æ‰§è¡Œç­–ç•¥        | è¿›åº¦è¦æ±‚                 |
| ------------------ | ------------------ | ------ | --------------- | ------------------------ |
| ä¹¦ç­¾å…¨é‡åŒæ­¥       | 1-2s (20,000 ä¹¦ç­¾) | P0     | åŒæ­¥ + åˆ†æ‰¹å†™å…¥ | é˜¶æ®µ + ç™¾åˆ†æ¯” + é¢„è®¡æ—¶é—´ |
| ä¹¦ç­¾å¯¼å…¥           | 2-5s (æ‰¹é‡å¯¼å…¥)    | P0     | åŒæ­¥ + åˆ†æ‰¹å†™å…¥ | å¯¼å…¥è¿›åº¦ + å‰©ä½™æ—¶é—´      |
| åˆæ¬¡æ•°æ®åŠ è½½       | 1-2s               | P0     | åŒæ­¥            | åŠ è½½é˜¶æ®µ + ç™¾åˆ†æ¯”        |
| ä¹¦ç­¾ç§»åŠ¨ï¼ˆä¼˜åŒ–åï¼‰ | 50-100ms           | P0     | åŒæ­¥            | æ— éœ€è¿›åº¦ï¼ˆç¬é—´å®Œæˆï¼‰     |

**å®ç°è¦æ±‚**ï¼š

```typescript
// 1. è¿›åº¦æ•°æ®ç»“æ„
interface SyncProgress {
  phase: 'fetching' | 'converting' | 'writing' | 'indexing' | 'completed'
  current: number
  total: number
  percentage: number
  message: string
  estimatedRemaining?: number  // é¢„è®¡å‰©ä½™æ—¶é—´ï¼ˆmsï¼‰
}

// 2. è¿›åº¦å›è°ƒæœºåˆ¶
type ProgressCallback = (progress: SyncProgress) => void

class BookmarkSyncService {
  private progressCallbacks: Set<ProgressCallback> = new Set()

  onProgress(callback: ProgressCallback): () => void {
    this.progressCallbacks.add(callback)
    return () => this.progressCallbacks.delete(callback)
  }

  private notifyProgress(progress: SyncProgress): void {
    this.progressCallbacks.forEach(cb => cb(progress))
  }
}

// 3. UI ç»„ä»¶è¦æ±‚
<SyncProgressDialog
  :show="syncProgress.show"
  :progress="syncProgress.data"
>
  <!-- å¿…é¡»æ˜¾ç¤ºï¼š-->
  <!-- - å½“å‰é˜¶æ®µï¼ˆfetching/converting/writingï¼‰-->
  <!-- - è¿›åº¦ç™¾åˆ†æ¯”ï¼ˆ43%ï¼‰-->
  <!-- - å½“å‰/æ€»æ•°ï¼ˆ8,523 / 20,000ï¼‰-->
  <!-- - é¢„è®¡å‰©ä½™æ—¶é—´ï¼ˆçº¦ 3 ç§’ï¼‰-->
</SyncProgressDialog>
```

##### ğŸŸ¡ è¾…åŠ©ä¸šåŠ¡ï¼ˆWorker å¼‚æ­¥ + é˜Ÿåˆ—è°ƒåº¦ï¼‰

| ä¸šåŠ¡               | è€—æ—¶            | ä¼˜å…ˆçº§ | æ‰§è¡Œç­–ç•¥          | è°ƒåº¦è¦æ±‚              |
| ------------------ | --------------- | ------ | ----------------- | --------------------- |
| ç½‘é¡µçˆ¬è™«ï¼ˆå…ƒæ•°æ®ï¼‰ | æŒ‰éœ€ï¼Œå•ä¸ª 2-5s | P1     | Worker + é˜Ÿåˆ—     | ä¼˜å…ˆçº§æ’åº + å¹¶å‘æ§åˆ¶ |
| AI æ ‡ç­¾åˆ†ç±»        | æŒ‰éœ€ï¼Œå•ä¸ª 1-3s | P1     | Worker + æ‰¹å¤„ç†   | åå°æ‰§è¡Œ + å¯æš‚åœ     |
| å¥åº·æ‰«æ           | 5-10s           | P2     | Worker + åå°æ‰§è¡Œ | å¯å–æ¶ˆ + è¿›åº¦æ˜¾ç¤º     |
| å…¨æ–‡æœç´¢ç´¢å¼•       | 3-5s            | P1     | Worker + å¢é‡æ„å»º | åå°æ„å»º              |

**å®ç°è¦æ±‚**ï¼š

```typescript
// Worker ä»»åŠ¡è°ƒåº¦å™¨
class WorkerTaskScheduler {
  private queue: WorkerTask[] = []
  private running = new Set<string>()
  private maxConcurrent = 2 // åŒæ—¶æœ€å¤š 2 ä¸ªä»»åŠ¡

  enqueue(task: WorkerTask, onProgress?: ProgressCallback): void {
    this.queue.push(task)
    this.queue.sort((a, b) => b.priority - a.priority) // ä¼˜å…ˆçº§æ’åº
    this.processNext()
  }

  pause(): void {
    this.paused = true
    this.worker?.postMessage({ type: 'pause' })
  }

  resume(): void {
    this.paused = false
    this.processNext()
  }

  cancel(taskId: string): void {
    this.queue = this.queue.filter(t => t.id !== taskId)
    if (this.running.has(taskId)) {
      this.worker?.postMessage({ type: 'cancel', taskId })
    }
  }
}
```

#### 7.6.3 è¿›åº¦æ¡å®ç°æŒ‡å—

##### UI ç»„ä»¶ç»“æ„

```vue
<template>
  <Dialog persistent :hide-close="true">
    <!-- 1. é˜¶æ®µæŒ‡ç¤ºå™¨ -->
    <div class="phase-indicators">
      <div
        v-for="phase in phases"
        :class="{ active: isActive(phase), completed: isCompleted(phase) }"
      >
        <Icon :name="phase.icon" />
        <span>{{ phase.label }}</span>
      </div>
    </div>

    <!-- 2. è¿›åº¦æ¡ -->
    <div class="progress-bar">
      <div class="progress-fill" :style="{ width: `${percentage}%` }" />
    </div>

    <!-- 3. è¯¦ç»†ä¿¡æ¯ -->
    <div class="progress-details">
      <div class="progress-text">{{ message }}</div>
      <div class="progress-stats">
        <span class="percentage">{{ Math.round(percentage) }}%</span>
        <span class="count">{{ current }} / {{ total }}</span>
        <span class="time">å‰©ä½™çº¦ {{ formatTime(estimatedRemaining) }}</span>
      </div>
    </div>
  </Dialog>
</template>
```

##### æ€§èƒ½è¦æ±‚

- **åˆæ¬¡åŠ è½½**ï¼š< 2s
- **å…¨é‡åŒæ­¥**ï¼š< 2sï¼ˆ20,000 ä¹¦ç­¾ï¼‰
- **å•ä¹¦ç­¾æ“ä½œ**ï¼š< 50msï¼ˆå¢é‡æ›´æ–°ï¼‰
- **è¿›åº¦æ›´æ–°é¢‘ç‡**ï¼šæ¯ 100 ä¸ªèŠ‚ç‚¹æŠ¥å‘Šä¸€æ¬¡
- **UI å“åº”æ€§**ï¼šæ¯æ‰¹æ¬¡å `setTimeout(0)` è®©å‡ºä¸»çº¿ç¨‹

#### 7.6.4 æ¶æ„å†³ç­–ç†ç”±

##### ä¸ºä»€ä¹ˆæ ¸å¿ƒä¸šåŠ¡ä¸ç”¨ Workerï¼Ÿ

```typescript
é—®é¢˜ï¼šå¦‚æœ IndexedDB æ²¡æœ‰å®Œæ•´æ•°æ®
  â†“
Management é¡µé¢æ— æ³•å±•ç¤ºä¹¦ç­¾æ ‘
  â†“
ç”¨æˆ·æ— æ³•è¿›è¡Œä»»ä½•æœ‰æ„ä¹‰çš„æ“ä½œ
  â†“
Worker å¼‚æ­¥å¸¦æ¥çš„"UI æµç•…åº¦"æ¯«æ— ä»·å€¼
```

**ç»“è®º**ï¼š

- âœ… æ•°æ®å®Œæ•´æ€§ > UI å“åº”æ€§
- âœ… çœŸå®è¿›åº¦åé¦ˆ > å‡è£…ä¸é˜»å¡
- âœ… åˆ†æ‰¹å†™å…¥ + `setTimeout(0)` = æ—¢æœ‰è¿›åº¦åˆä¸"å†»ç»“"

##### ä¸ºä»€ä¹ˆè¾…åŠ©ä¸šåŠ¡ç”¨ Workerï¼Ÿ

```typescript
åœºæ™¯ï¼šç”¨æˆ·æ­£åœ¨ Management é¡µé¢ç¼–è¾‘ä¹¦ç­¾
  â†“
åå°è§¦å‘å¥åº·æ‰«æï¼ˆ5-10sï¼‰
  â†“
ã€ä¸ç”¨ Workerã€‘ä¸»çº¿ç¨‹é˜»å¡ â†’ é¡µé¢å†»ç»“ â†’ ç”¨æˆ·æ— æ³•æ“ä½œ
ã€ä½¿ç”¨ Workerã€‘ä¸»çº¿ç¨‹ä¸é˜»å¡ â†’ å¯ä»¥ç»§ç»­ç¼–è¾‘ â†’ åå°æ…¢æ…¢æ‰«æ
```

**ç»“è®º**ï¼š

- âœ… ä¸å½±å“æ ¸å¿ƒæ“ä½œæ˜¯å…³é”®
- âœ… å¤±è´¥ä¹Ÿä¸å½±å“ä¸»è¦åŠŸèƒ½
- âœ… å¯ä»¥æä¾›"å–æ¶ˆ"ã€"æš‚åœ"é€‰é¡¹

#### 7.6.5 å½“å‰å®ç°çŠ¶æ€

##### âœ… å·²ç¬¦åˆåŸåˆ™

- çˆ¬è™«ç³»ç»Ÿä½¿ç”¨ Offscreen Documentï¼ˆä¸é˜»å¡ä¸»çº¿ç¨‹ï¼‰
- Management é¡µé¢æœ‰ loading çŠ¶æ€ï¼ˆ`isPageLoading`ï¼‰
- å¥åº·æ‰«ææœ‰ç‹¬ç«‹ loading çŠ¶æ€ï¼ˆ`isCleanupLoading`ï¼‰
- ä¹¦ç­¾åŒæ­¥é‡‡ç”¨å¢é‡ + å…¨é‡æ··åˆç­–ç•¥

##### âŒ éœ€è¦æ”¹è¿›

1. **ä¹¦ç­¾å…¨é‡åŒæ­¥ç¼ºå°‘çœŸå®è¿›åº¦**
   - å½“å‰ï¼šåªæœ‰è½¬åœˆåœˆ
   - æœŸæœ›ï¼šé˜¶æ®µæŒ‡ç¤ºï¼ˆè¯»å– â†’ è½¬æ¢ â†’ å†™å…¥ï¼‰+ ç™¾åˆ†æ¯”ï¼ˆ43%ï¼‰+ é¢„è®¡æ—¶é—´ï¼ˆçº¦ 3 ç§’ï¼‰

2. **ç‰¹å¾æ£€æµ‹æ”¯æŒ Worker å¼‚æ­¥æ‰§è¡Œ**
   - å½“å‰ï¼š`bookmark-trait-service.ts` æä¾›åŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§æ¨¡å¼
   - å·²å®ç°ï¼š`trait-detection-service.ts` æä¾› Worker å¼‚æ­¥æ£€æµ‹ï¼Œæ”¯æŒè¿›åº¦åé¦ˆå’Œå–æ¶ˆæ“ä½œ

3. **ç¼ºå°‘è¿›åº¦ç»„ä»¶**
   - å½“å‰ï¼šé™æ€ Loading æ–‡æœ¬
   - æœŸæœ›ï¼šé€šç”¨çš„ `SyncProgressDialog` ç»„ä»¶ï¼Œå¤ç”¨äºæ‰€æœ‰é•¿è€—æ—¶ä»»åŠ¡

---

## ç¬¬å…«éƒ¨åˆ†ï¼šæµ‹è¯•ä¸è´¨é‡ä¿éšœ

### 8.1 æµ‹è¯•ç­–ç•¥

#### 8.1.1 å•å…ƒæµ‹è¯•

**æ¡†æ¶**ï¼šVitest + @testing-library/vue

```typescript
// ç¤ºä¾‹ï¼šæµ‹è¯• Immer å·¥å…·å‡½æ•°
import { describe, it, expect } from 'vitest'
import { updateMap } from '@/infrastructure/state/immer-helpers'

describe('updateMap', () => {
  it('should update map immutably', () => {
    const mapRef = ref(new Map([['a', 1]]))
    const oldMap = mapRef.value

    updateMap(mapRef, draft => {
      draft.set('b', 2)
    })

    expect(mapRef.value).not.toBe(oldMap) // ä¸å¯å˜
    expect(mapRef.value.get('b')).toBe(2) // æ›´æ–°æˆåŠŸ
  })
})
```

#### 8.1.2 ç»„ä»¶æµ‹è¯•

```typescript
import { mount } from '@vue/test-utils'
import { describe, it, expect } from 'vitest'
import Button from '@/components/base/Button/Button.vue'

describe('Button', () => {
  it('should emit click event', async () => {
    const wrapper = mount(Button, {
      props: { label: 'Click me' }
    })

    await wrapper.trigger('click')
    expect(wrapper.emitted('click')).toBeTruthy()
  })
})
```

#### 8.1.3 E2E æµ‹è¯•

**å·¥å…·**ï¼šPuppeteer

```bash
# è¿è¡Œ E2E æµ‹è¯•
bun run e2e:management --ext $EXT_ID
```

### 8.2 ä»£ç è´¨é‡å·¥å…·

#### 8.2.1 ESLint

```bash
# æ£€æŸ¥ä»£ç 
bun run lint:check

# è‡ªåŠ¨ä¿®å¤
bun run lint:fix:enhanced
```

#### 8.2.2 Stylelint

```bash
# æ£€æŸ¥ CSS
bun run stylelint

# è‡ªåŠ¨ä¿®å¤
bun run stylelint:fix:enhanced
```

#### 8.2.3 TypeScript

```bash
# ç±»å‹æ£€æŸ¥
bun run typecheck:force
```

#### 8.2.4 Prettier

```bash
# æ ¼å¼åŒ–ä»£ç 
bun run format
```

### 8.3 æ€§èƒ½å®¡è®¡

#### 8.3.1 Lighthouse CI

```bash
# è¿è¡Œ Lighthouse å®¡è®¡
bun run audit:lhci

# æŸ¥çœ‹å®¡è®¡æŠ¥å‘Š
bun run audit:lhci:summary
```

### 8.4 Git Hooks

ä½¿ç”¨ Husky åœ¨æäº¤å‰è‡ªåŠ¨æ£€æŸ¥ï¼š

```bash
# .husky/pre-commit
bun run lint:fix:enhanced
bun run typecheck:force
```

---

## é™„å½• Aï¼šå¸¸ç”¨å‘½ä»¤é€ŸæŸ¥è¡¨

```bash
# ========== å¼€å‘ ==========
bun install                     # å®‰è£…ä¾èµ–
bun run dev:frontend            # å‰ç«¯å¼€å‘æœåŠ¡å™¨
bun run build:hot               # å‰ç«¯çƒ­æ„å»ºï¼ˆæ¨èï¼‰
bun run build:hot:no-lint       # è·³è¿‡ ESLint çš„çƒ­æ„å»º

# ========== æ„å»º ==========
bun run build:frontend          # å‰ç«¯æ„å»ºï¼ˆå¼€å‘æ¨¡å¼ï¼‰
bun run build:frontend:fast     # å‰ç«¯æ„å»ºï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰
bun run build:frontend:analyze  # åˆ†ææ„å»ºä½“ç§¯

# ========== ä»£ç è´¨é‡ ==========
bun run typecheck:force         # ç±»å‹æ£€æŸ¥ï¼ˆå¼ºåˆ¶ï¼‰
bun run lint:fix:enhanced       # ESLint è‡ªåŠ¨ä¿®å¤
bun run stylelint:fix:enhanced  # Stylelint è‡ªåŠ¨ä¿®å¤
bun run format                  # Prettier æ ¼å¼åŒ–

# ========== æµ‹è¯• ==========
bun run test                    # è¿è¡Œæ‰€æœ‰æµ‹è¯•
bun run test:coverage           # ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
bun run e2e:management          # E2E æµ‹è¯•

# ========== å®¡è®¡ ==========
bun run audit:lhci              # Lighthouse å®¡è®¡
bun run audit:lhci:summary      # å®¡è®¡æŠ¥å‘Šæ‘˜è¦
```

---

## é™„å½• Bï¼šå…³é”®æ–‡ä»¶è·¯å¾„é€ŸæŸ¥è¡¨

| åŠŸèƒ½             | æ–‡ä»¶è·¯å¾„                                                |
| ---------------- | ------------------------------------------------------- |
| **æ¶æ„æ–‡æ¡£**     |                                                         |
| å•å‘æ•°æ®æµè¯´æ˜   | `/å•å‘æ•°æ®æµæ¶æ„è¯´æ˜.md`                                |
| **å‰ç«¯æ ¸å¿ƒ**     |                                                         |
| ä¹¦ç­¾ Store       | `frontend/src/stores/bookmarkStore.ts`                  |
| ç®¡ç†é¡µé¢         | `frontend/src/pages/management/Management.vue`          |
| ä¹¦ç­¾æ ‘ç»„ä»¶       | `frontend/src/components/composite/SimpleBookmarkTree/` |
| **åŸºç¡€è®¾æ–½**     |                                                         |
| IndexedDB ç®¡ç†å™¨ | `frontend/src/infrastructure/indexeddb/manager.ts`      |
| å­˜å‚¨æŠ½è±¡å±‚       | `frontend/src/infrastructure/storage/modern-storage.ts` |
| äº‹ä»¶æ€»çº¿         | `frontend/src/infrastructure/events/event-bus.ts`       |
| Immer å·¥å…·       | `frontend/src/infrastructure/state/immer-helpers.ts`    |
| **åå°è„šæœ¬**     |                                                         |
| ä¹¦ç­¾ç›‘å¬         | `frontend/src/background/bookmarks.ts`                  |
| æ¶ˆæ¯å¤„ç†         | `frontend/src/background/messaging.ts`                  |
| çˆ¬è™«ç®¡ç†å™¨       | `frontend/src/background/crawler-manager.ts`            |
| **æœåŠ¡å±‚**       |                                                         |
| ä¹¦ç­¾åŒæ­¥æœåŠ¡     | `frontend/src/services/bookmark-sync-service.ts`        |
| ä¹¦ç­¾ç‰¹å¾æœåŠ¡     | `frontend/src/services/bookmark-trait-service.ts`       |
| ç‰¹å¾æ£€æµ‹æœåŠ¡     | `frontend/src/services/trait-detection-service.ts`      |
| æœ¬åœ°çˆ¬å–æœåŠ¡     | `frontend/src/services/local-bookmark-crawler.ts`       |
| **é…ç½®æ–‡ä»¶**     |                                                         |
| Manifest         | `frontend/public/manifest.json`                         |
| Vite é…ç½®        | `frontend/vite.config.ts`                               |
| TypeScript é…ç½®  | `frontend/tsconfig.json`                                |
| ESLint é…ç½®      | `eslint.config.js`                                      |
| Stylelint é…ç½®   | `frontend/stylelint.config.js`                          |

---

## é™„å½• Cï¼šæœ¯è¯­è¡¨

| æœ¯è¯­               | è§£é‡Š                                                    |
| ------------------ | ------------------------------------------------------- |
| **DDD**            | Domain-Driven Designï¼ˆé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼‰                    |
| **å•å‘æ•°æ®æµ**     | Chrome API â†’ Background â†’ IndexedDB â†’ UI çš„å•å‘æ•°æ®æµåŠ¨ |
| **IndexedDB**      | æµè§ˆå™¨ç«¯çš„ NoSQL æ•°æ®åº“ï¼Œæœ¬é¡¹ç›®çš„å”¯ä¸€æ•°æ®æº             |
| **BookmarkRecord** | IndexedDB ä¸­å­˜å‚¨çš„ä¹¦ç­¾æ•°æ®ç»“æ„                          |
| **BookmarkNode**   | å‰ç«¯ Vue ç»„ä»¶ä½¿ç”¨çš„ä¹¦ç­¾èŠ‚ç‚¹æ•°æ®ç»“æ„                     |
| **Pinia Store**    | Vue çš„çŠ¶æ€ç®¡ç†åº“                                        |
| **mitt**           | è½»é‡çº§äº‹ä»¶æ€»çº¿åº“                                        |
| **Immer**          | ä¸å¯å˜çŠ¶æ€æ›´æ–°åº“                                        |
| **TanStack Query** | å¼‚æ­¥çŠ¶æ€ç®¡ç†å’Œç¼“å­˜åº“                                    |
| **VueUse**         | Vue Composition API å®ç”¨å·¥å…·é›†                          |
| **Zod**            | TypeScript è¿è¡Œæ—¶æ•°æ®æ ¡éªŒåº“                             |
| **è™šæ‹Ÿæ»šåŠ¨**       | åªæ¸²æŸ“å¯è§åŒºåŸŸçš„èŠ‚ç‚¹ï¼Œæå‡å¤§åˆ—è¡¨æ€§èƒ½                    |
| **pathIds**        | ä»æ ¹èŠ‚ç‚¹åˆ°å½“å‰èŠ‚ç‚¹çš„æ‰€æœ‰çˆ¶èŠ‚ç‚¹ ID æ•°ç»„                  |
| **traitTags**      | ä¹¦ç­¾ç‰¹å¾æ ‡ç­¾ï¼ˆduplicate, invalid, internalï¼‰            |

---

## é™„å½• Dï¼šFAQ

### Q1: ä¸ºä»€ä¹ˆ IndexedDB æ˜¯å”¯ä¸€æ•°æ®æºï¼Ÿ

**A**: ä¸ºäº†ç¡®ä¿æ•°æ®ä¸€è‡´æ€§å’Œæ¶æ„æ¸…æ™°æ€§ã€‚Chrome API åªè´Ÿè´£æ•°æ®çš„æŒä¹…åŒ–ï¼ŒIndexedDB ä½œä¸ºä¸­é—´å±‚æä¾›ï¼š

- âœ… æ›´å¿«çš„æŸ¥è¯¢æ€§èƒ½ï¼ˆç´¢å¼•æ”¯æŒï¼‰
- âœ… ç¦»çº¿èƒ½åŠ›
- âœ… ç»Ÿä¸€çš„æ•°æ®è®¿é—®æ¥å£
- âœ… é˜²æ­¢å¤šä¸ªé¡µé¢åŒæ—¶è¯»å– Chrome API å¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´

### Q2: ä¸ºä»€ä¹ˆä½¿ç”¨ Immerï¼Ÿ

**A**: Immer ç®€åŒ–äº†å¤æ‚æ•°æ®ç»“æ„çš„ä¸å¯å˜æ›´æ–°ï¼Œç‰¹åˆ«æ˜¯ `Map` å’ŒåµŒå¥—å¯¹è±¡ï¼š

```typescript
// ä¸ä½¿ç”¨ Immerï¼ˆç¹çï¼‰
const newNodes = new Map(nodes.value)
newNodes.set('123', { ...newNodes.get('123'), title: 'æ–°æ ‡é¢˜' })
nodes.value = newNodes

// ä½¿ç”¨ Immerï¼ˆç®€æ´ï¼‰
updateMap(nodes, draft => {
  draft.get('123')!.title = 'æ–°æ ‡é¢˜'
})
```

### Q3: ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ TanStack Queryï¼Ÿ

**A**: TanStack Query é€‚ç”¨äºï¼š

- âœ… éœ€è¦ç¼“å­˜çš„å¼‚æ­¥æ•°æ®ï¼ˆå¦‚å•ä¸ªä¹¦ç­¾è¯¦æƒ…ï¼‰
- âœ… éœ€è¦è‡ªåŠ¨é‡è¯•çš„è¯·æ±‚
- âœ… éœ€è¦ä¹è§‚æ›´æ–°çš„åœºæ™¯

ä¸é€‚ç”¨äºï¼š

- âŒ å…¨å±€çŠ¶æ€ï¼ˆä½¿ç”¨ Piniaï¼‰
- âŒ å¤§é‡æ•°æ®çš„æ‰¹é‡è¯»å–ï¼ˆç›´æ¥ä½¿ç”¨ IndexedDBï¼‰

### Q4: chrome.storage.session å’Œ Pinia Store æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**A**:

| ç‰¹æ€§           | chrome.storage.session           | Pinia Store              |
| -------------- | -------------------------------- | ------------------------ |
| **ç”Ÿå‘½å‘¨æœŸ**   | æµè§ˆå™¨ä¼šè¯çº§ï¼ˆå…³é—­æµè§ˆå™¨åæ¸…é™¤ï¼‰ | é¡µé¢çº§ï¼ˆåˆ·æ–°é¡µé¢åæ¸…é™¤ï¼‰ |
| **è·¨é¡µé¢å…±äº«** | âœ… æ˜¯ï¼ˆæ‰€æœ‰æ‰©å±•é¡µé¢å…±äº«ï¼‰        | âŒ å¦ï¼ˆæ¯ä¸ªé¡µé¢ç‹¬ç«‹ï¼‰    |
| **æ€§èƒ½**       | ä¸­ï¼ˆéœ€è¦å¼‚æ­¥è¯»å†™ï¼‰               | é«˜ï¼ˆå†…å­˜è¯»å†™ï¼‰           |
| **é€‚ç”¨åœºæ™¯**   | ä¸´æ—¶æ•°æ®ã€éœ€è¦è·¨é¡µé¢å…±äº«çš„çŠ¶æ€   | é«˜é¢‘ UI çŠ¶æ€ã€è®¡ç®—å±æ€§   |

### Q5: å¦‚ä½•ç¡®ä¿ä»£ç ç¬¦åˆé¡¹ç›®è§„èŒƒï¼Ÿ

**A**: åœ¨æ¯æ¬¡æäº¤å‰æ‰§è¡Œï¼š

```bash
bun run lint:fix:enhanced  # ESLint è‡ªåŠ¨ä¿®å¤
bun run typecheck:force    # TypeScript æ£€æŸ¥
bun run stylelint:fix      # æ ·å¼æ£€æŸ¥
```

æˆ–è€…ä¾èµ– Git Hooks è‡ªåŠ¨æ‰§è¡Œï¼ˆå·²é…ç½® Huskyï¼‰ã€‚

---

## ç»“è¯­

è¿™ä»½æ–‡æ¡£æ¶µç›–äº† AcuityBookmarks é¡¹ç›®çš„æ‰€æœ‰å…³é”®ä¿¡æ¯ï¼Œæ—¨åœ¨å¸®åŠ© AI ç¼–ç¨‹åŠ©æ‰‹ï¼ˆCursor/Copilotï¼‰ï¼š

1. âœ… **ç†è§£æ¶æ„**ï¼šDDD åˆ†å±‚ã€å•å‘æ•°æ®æµã€å­˜å‚¨æ–¹æ¡ˆ
2. âœ… **éµå¾ªè§„èŒƒ**ï¼šTypeScriptã€Vueã€Piniaã€å‘½åè§„èŒƒ
3. âœ… **æŒæ¡æŠ€æœ¯æ ˆ**ï¼šVue 3, Pinia, TanStack Query, Immer, mitt, VueUse
4. âœ… **ç”Ÿæˆé«˜è´¨é‡ä»£ç **ï¼šç¬¦åˆé¡¹ç›®é£æ ¼ã€æ¶æ„æ¸…æ™°ã€æ€§èƒ½ä¼˜åŒ–

**é‡è¦æç¤º**ï¼š

- ğŸš¨ ç¦æ­¢ç›´æ¥è®¿é—® Chrome APIï¼ˆé™¤ Background Script å¤–ï¼‰
- ğŸš¨ ç¦æ­¢ä½¿ç”¨ `any` ç±»å‹
- ğŸš¨ æ‰€æœ‰å¤–éƒ¨æ•°æ®å¿…é¡»é€šè¿‡ Zod æ ¡éªŒ
- ğŸš¨ å¤æ‚çŠ¶æ€æ›´æ–°ä½¿ç”¨ Immer
- ğŸš¨ æ–°å¢ä»£ç å¿…é¡»æ·»åŠ ä¸­æ–‡ JSDoc æ³¨é‡Š

---

**æ–‡æ¡£ç»´æŠ¤è€…**ï¼šAcuityBookmarks å¼€å‘å›¢é˜Ÿ  
**è”ç³»æ–¹å¼**ï¼šé€šè¿‡ GitHub Issues åé¦ˆé—®é¢˜  
**æœ€åæ›´æ–°**ï¼š2025-10-26

---

Â© 2025 AcuityBookmarks. All Rights Reserved.
