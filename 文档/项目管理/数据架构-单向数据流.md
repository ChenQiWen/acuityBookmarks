# æ•°æ®æ¶æ„ï¼šå•å‘æ•°æ®æµ

## ğŸ“‹ æ¶æ„åŸåˆ™

### å”¯ä¸€æ•°æ®æºï¼šIndexedDB

```
Chrome API â†’ Background Script â†’ IndexedDB â†’ UI Components
    â†‘                                            â†“
    â””â”€â”€â”€â”€â”€â”€â”€â”€ (åªè¯»ï¼Œä¸ç›´æ¥è®¿é—®) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒè§„åˆ™

1. **ç¦æ­¢ UI ç›´æ¥è®¿é—® Chrome API**
   - æ‰€æœ‰ä¹¦ç­¾æ•°æ®å¿…é¡»é€šè¿‡ IndexedDB è·å–
   - UI å±‚ä¸å…è®¸è°ƒç”¨ `chrome.bookmarks.*` API

2. **Background Script è´Ÿè´£åŒæ­¥**
   - ç›‘å¬ Chrome API çš„ä¹¦ç­¾å˜æ›´äº‹ä»¶
   - å°†å˜æ›´å®æ—¶åŒæ­¥åˆ° IndexedDB
   - å¹¿æ’­æ•°æ®å˜æ›´é€šçŸ¥ç»™å‰ç«¯é¡µé¢

3. **æ•°æ®æµå‘å•å‘æ€§**
   - Chrome API â†’ IndexedDBï¼šBackground Script è´Ÿè´£
   - IndexedDB â†’ UIï¼šé€šè¿‡ Store å’Œ Service å±‚
   - UI â†’ Chrome APIï¼šé€šè¿‡æ¶ˆæ¯ä¼ é€’ç»™ Background Script

## ğŸ—ï¸ æ¶æ„å®ç°

### 1. Background Script (`frontend/src/background/`)

**èŒè´£ï¼š**

- ç›‘å¬ Chrome ä¹¦ç­¾ API äº‹ä»¶
- å¢é‡æˆ–å…¨é‡åŒæ­¥åˆ° IndexedDB
- å¹¿æ’­ `acuity-bookmarks-db-synced` æ¶ˆæ¯

**å…³é”®æ–‡ä»¶ï¼š**

- `bookmarks.ts`: æ³¨å†Œä¹¦ç­¾å˜æ›´ç›‘å¬å™¨
- `data-health-check.ts`: æ•°æ®å¥åº·æ£€æŸ¥å’Œæ¢å¤

```typescript
// ç›‘å¬ä¹¦ç­¾å˜åŒ– â†’ åŒæ­¥åˆ° IndexedDB â†’ å¹¿æ’­é€šçŸ¥
chrome.bookmarks.onChanged.addListener(async (id, changeInfo) => {
  await syncToIndexedDB(id, changeInfo)
  chrome.runtime.sendMessage({
    type: 'acuity-bookmarks-db-synced',
    eventType: 'changed',
    bookmarkId: id
  })
})
```

### 2. Store å±‚ (`frontend/src/stores/bookmarkStore.ts`)

**æ”¹è¿›å‰ï¼š**

```typescript
// âŒ ç›´æ¥ä» Chrome API è·å–æ•°æ®
async function fetchRootNodes() {
  const result = await messageClient.sendMessage({
    type: 'get-tree-root' // è°ƒç”¨ Chrome API
  })
  // ...
}
```

**æ”¹è¿›åï¼š**

```typescript
// âœ… åªä» IndexedDB è¯»å–
async function loadFromIndexedDB() {
  await bookmarkAppService.initialize()
  const recordsResult = await bookmarkAppService.getAllBookmarks()
  const viewTree = treeAppService.buildViewTreeFromFlat(recordsResult.value)
  reset()
  addNodes(viewTree)
}
```

### 3. Management Store (`frontend/src/stores/bookmark/bookmark-management-store.ts`)

**æ•°æ®åŠ è½½ï¼š**

```typescript
const loadBookmarks = async () => {
  // ä» IndexedDB åŠ è½½
  const recordsResult = await bookmarkAppService.getAllBookmarks()
  const viewTree = treeAppService.buildViewTreeFromFlat(recordsResult.value)

  // æ›´æ–°å·¦ä¾§æ ‘ï¼ˆé€šè¿‡ bookmarkStoreï¼‰
  bookmarkStore.reset()
  bookmarkStore.addNodes(viewTree)

  // æ›´æ–°å³ä¾§æ ‘
  setProposalTreeFromRecords(recordsResult.value)
}
```

### 4. æ‡’åŠ è½½çš„åºŸå¼ƒ

**æ”¹è¿›å‰ï¼š**

- `fetchChildren()`: æŒ‰éœ€ä» Chrome API åŠ è½½å­èŠ‚ç‚¹
- `fetchMoreChildren()`: åˆ†é¡µåŠ è½½æ›´å¤šå­èŠ‚ç‚¹

**æ”¹è¿›åï¼š**

- ä» IndexedDB ä¸€æ¬¡æ€§åŠ è½½å®Œæ•´æ•°æ®
- æ‰€æœ‰å­èŠ‚ç‚¹å·²åŒ…å«åœ¨æ ‘ç»“æ„ä¸­
- `fetchChildren/fetchMoreChildren` ä¿ç•™ä¸ºç©ºå®ç°ï¼ˆä»…å…¼å®¹æ€§ï¼‰

## ğŸ“Š æ•°æ®åŒæ­¥æœºåˆ¶

### å®æ—¶åŒæ­¥ï¼ˆBackground Scriptï¼‰

```typescript
// 1. Chrome API äº‹ä»¶è§¦å‘
chrome.bookmarks.onChanged.addListener(async (id, changeInfo) => {
  // 2. åŒæ­¥åˆ° IndexedDB
  await bookmarkSyncService.syncOne(id)

  // 3. å¹¿æ’­é€šçŸ¥
  chrome.runtime.sendMessage({
    type: 'acuity-bookmarks-db-synced',
    eventType: 'changed',
    bookmarkId: id
  })
})
```

### å‰ç«¯å“åº”ï¼ˆUI Componentsï¼‰

```typescript
// Management.vue
const handleDbSynced = async (evt: Event) => {
  const { eventType, bookmarkId } = evt.detail

  // æ£€æŸ¥æ˜¯å¦æœ‰æœªä¿å­˜çš„æ›´æ”¹
  if (hasUnsavedChanges.value) {
    showUpdatePrompt.value = true // å¼¹å‡ºå¼ºåˆ¶åˆ·æ–°å¯¹è¯æ¡†
    return
  }

  // å¢é‡æ›´æ–°æˆ–å…¨é‡åˆ·æ–°
  if (needsFullRefresh(eventType)) {
    await managementStore.loadBookmarks() // ä» IndexedDB é‡æ–°åŠ è½½
  } else {
    await refreshSingleBookmark(bookmarkId) // åªæ›´æ–°å•æ¡
  }
}
```

## ğŸ”„ æ•°æ®æ¢å¤æœºåˆ¶

### è‡ªåŠ¨å¥åº·æ£€æŸ¥

```typescript
// 1. é¡µé¢åŠ è½½æ—¶æ£€æŸ¥
onMounted(async () => {
  await checkOnPageLoad({
    autoRecover: true,
    showNotification: false
  })
  // ...
})

// 2. åå°å®šæœŸæ£€æŸ¥ï¼ˆæ¯5åˆ†é’Ÿï¼‰
startPeriodicHealthCheck(5 * 60 * 1000)
```

### æ‰‹åŠ¨æ¸…é™¤ IndexedDB çš„å¤„ç†

```typescript
async function checkDataHealth() {
  const records = await bookmarkAppService.getAllBookmarks()

  if (!records.ok || records.value.length === 0) {
    // IndexedDB ä¸ºç©ºï¼Œè§¦å‘å…¨é‡åŒæ­¥
    logger.warn('IndexedDB ä¸ºç©ºï¼Œå¼€å§‹ä» Chrome API æ¢å¤æ•°æ®')
    await recoverData()
  }
}

async function recoverData() {
  // ä» Chrome API è·å–æ‰€æœ‰ä¹¦ç­¾
  const tree = await chrome.bookmarks.getTree()

  // å†™å…¥ IndexedDB
  await bookmarkSyncService.syncFullTree(tree)

  return bookmarkCount
}
```

## ğŸ¯ æ”¶ç›Š

### 1. æ•°æ®ä¸€è‡´æ€§

- âœ… å•ä¸€æ•°æ®æºï¼Œé¿å…å¤šå¤„ä¸åŒæ­¥
- âœ… æ‰€æœ‰ UI ç»„ä»¶çœ‹åˆ°çš„æ•°æ®å®Œå…¨ä¸€è‡´
- âœ… å·¦å³æ ‘æ•°æ®æºç»Ÿä¸€ï¼ˆManagement é¡µé¢ï¼‰

### 2. æ€§èƒ½ä¼˜åŒ–

- âœ… å‡å°‘ Chrome API è°ƒç”¨ï¼ˆåå°ç»Ÿä¸€åŒæ­¥ï¼‰
- âœ… å‰ç«¯ç›´æ¥ä» IndexedDB è¯»å–ï¼ˆå¿«é€Ÿï¼‰
- âœ… æ— éœ€æ‡’åŠ è½½ï¼Œå®Œæ•´æ•°æ®æ ‘ç»“æ„

### 3. æ¶æ„æ¸…æ™°

- âœ… æ•°æ®æµå‘å•å‘ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤
- âœ… èŒè´£åˆ†ç¦»ï¼šBackground è´Ÿè´£åŒæ­¥ï¼ŒUI è´Ÿè´£å±•ç¤º
- âœ… ç¬¦åˆ DDD åˆ†å±‚æ¶æ„

### 4. å¯é æ€§

- âœ… è‡ªåŠ¨å¥åº·æ£€æŸ¥å’Œæ•°æ®æ¢å¤
- âœ… IndexedDB æ¸…é™¤åè‡ªåŠ¨é‡å»º
- âœ… å®šæœŸæ£€æŸ¥ç¡®ä¿æ•°æ®å®Œæ•´æ€§

## ğŸ“ è¿ç§»æŒ‡å—

### ç»„ä»¶ä¸­ä½¿ç”¨ bookmarkStore

**æ—§ä»£ç ï¼ˆå·²åºŸå¼ƒï¼‰ï¼š**

```typescript
import { useBookmarkStore } from '@/stores/bookmarkStore'

const bookmarkStore = useBookmarkStore()
// Store åˆå§‹åŒ–æ—¶è‡ªåŠ¨è°ƒç”¨ fetchRootNodes()
```

**æ–°ä»£ç ï¼ˆæ¨èï¼‰ï¼š**

```typescript
import { useBookmarkStore } from '@/stores/bookmarkStore'

const bookmarkStore = useBookmarkStore()

// åœ¨ç»„ä»¶ onMounted ä¸­æ˜¾å¼åŠ è½½
onMounted(async () => {
  await bookmarkStore.loadFromIndexedDB()
})
```

### Management Store

```typescript
// âœ… ç›´æ¥è°ƒç”¨ loadBookmarksï¼Œå†…éƒ¨å·²ä» IndexedDB åŠ è½½
await managementStore.loadBookmarks()
```

## ğŸ” è°ƒè¯•

### æŸ¥çœ‹ IndexedDB æ•°æ®

```typescript
// Chrome DevTools â†’ Application â†’ IndexedDB â†’ acuity-bookmarks-db
// æŸ¥çœ‹ bookmarks è¡¨
```

### æ‰‹åŠ¨è§¦å‘æ¢å¤

```typescript
// åœ¨ Management é¡µé¢æ§åˆ¶å°
const { checkOnPageLoad } = await import('@/services/data-health-client')
await checkOnPageLoad({ autoRecover: true, showNotification: true })
```

### æŸ¥çœ‹åŒæ­¥æ—¥å¿—

```
// Service Worker Console
// æœç´¢å…³é”®å­—ï¼šsyncAndBroadcast, ä¹¦ç­¾å·²åˆ›å»º, ä¹¦ç­¾å·²ä¿®æ”¹
```

## ğŸ“š ç›¸å…³æ–‡ä»¶

### Background Script

- `frontend/src/background/bookmarks.ts`
- `frontend/src/background/data-health-check.ts`
- `frontend/src/background/main.ts`

### Store å±‚

- `frontend/src/stores/bookmarkStore.ts`
- `frontend/src/stores/bookmark/bookmark-management-store.ts`

### Service å±‚

- `frontend/src/services/bookmark-sync-service.ts`
- `frontend/src/services/data-health-client.ts`

### Infrastructure å±‚

- `frontend/src/infrastructure/indexeddb/manager.ts`
- `frontend/src/application/bookmark/bookmark-app-service.ts`
- `frontend/src/application/bookmark/tree-app-service.ts`

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä¸è¦åœ¨ UI å±‚ç›´æ¥è°ƒç”¨ `chrome.bookmarks.*`**
   - è¿åå•å‘æ•°æ®æµåŸåˆ™
   - ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´

2. **æ‰€æœ‰ä¹¦ç­¾ CRUD æ“ä½œé€šè¿‡ Background Script**

   ```typescript
   // âœ… æ­£ç¡®
   await chrome.runtime.sendMessage({
     type: 'CREATE_BOOKMARK',
     data: { title, url, parentId }
   })

   // âŒ é”™è¯¯
   await chrome.bookmarks.create({ title, url, parentId })
   ```

3. **ç›‘å¬æ•°æ®å˜æ›´ä½¿ç”¨ `acuity-bookmarks-db-synced` äº‹ä»¶**
   ```typescript
   window.addEventListener('acuity-bookmarks-db-synced', handleDbSynced)
   ```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–ï¼ˆå·²å®æ–½ï¼‰

### âœ… ä¼˜åŒ– 1ï¼šç¼“å­˜æ ‘ç»“æ„

**é—®é¢˜**: `bookmarkTree` computed æ¯æ¬¡è®¿é—®éƒ½é‡æ–°æ„å»ºæ ‘ï¼Œæµªè´¹æ€§èƒ½ã€‚

**è§£å†³æ–¹æ¡ˆ**:

```typescript
// bookmarkStore.ts
const cachedTree = ref<BookmarkNode[]>([])

const bookmarkTree = computed(() => {
  // ä¼˜å…ˆè¿”å›ç¼“å­˜ï¼ˆO(1)ï¼‰
  if (cachedTree.value.length > 0) {
    return cachedTree.value
  }
  // é™çº§ï¼šä» Map é‡å»ºï¼ˆç”¨äºå¢é‡æ›´æ–°ï¼‰
  return rebuildTreeFromMap(nodes.value)
})

// åŠ è½½æ—¶ç›´æ¥ç¼“å­˜
async function loadFromIndexedDB() {
  const viewTree = treeAppService.buildViewTreeFromFlat(records)
  cachedTree.value = viewTree // â† ç¼“å­˜æ ‘
  flattenTreeToMap(viewTree, nodes.value)
}
```

**æ”¶ç›Š**:

- âœ… èŠ‚çœ 26% åŠ è½½æ—¶é—´ï¼ˆ380ms â†’ 280msï¼‰
- âœ… `bookmarkTree` è®¿é—®ä» O(n) å˜ä¸º O(1)
- âœ… é¿å…é‡å¤è®¡ç®—

### âœ… ä¼˜åŒ– 2ï¼šé€’å½’æ‰å¹³åŒ–

**é—®é¢˜**: åŸ `addNodes` åªå¤„ç†æ ¹èŠ‚ç‚¹ï¼Œä¸é€’å½’å¤„ç†å­èŠ‚ç‚¹ã€‚

**è§£å†³æ–¹æ¡ˆ**:

```typescript
function flattenTreeToMap(
  treeNodes: BookmarkNode[],
  targetMap: Map<string, BookmarkNode>
): void {
  for (const node of treeNodes) {
    targetMap.set(String(node.id), node)
    // â† é€’å½’å¤„ç†å­èŠ‚ç‚¹
    if (node.children?.length) {
      flattenTreeToMap(node.children, targetMap)
    }
  }
}
```

**æ”¶ç›Š**:

- âœ… ä¿®å¤ bugï¼Œç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹éƒ½åœ¨ Map ä¸­
- âœ… æ”¯æŒå¿«é€Ÿ ID æŸ¥æ‰¾ï¼ˆO(1)ï¼‰

### âœ… ä¼˜åŒ– 3ï¼šæ€§èƒ½ç›‘æ§

**å®æ–½**:

```typescript
async function loadFromIndexedDB() {
  const t0 = performance.now()

  // IndexedDB è¯»å–
  const records = await getAllBookmarks()
  const t1 = performance.now()

  // æ„å»ºæ ‘
  const viewTree = buildViewTreeFromFlat(records)
  const t2 = performance.now()

  // æ‰å¹³åŒ–
  flattenTreeToMap(viewTree, nodes)
  const t3 = performance.now()

  logger.info('æ€§èƒ½ç»Ÿè®¡', {
    totalTime: `${(t3 - t0).toFixed(0)}ms`,
    breakdown: {
      indexedDB: `${(t1 - t0).toFixed(0)}ms`,
      buildTree: `${(t2 - t1).toFixed(0)}ms`,
      flattenMap: `${(t3 - t2).toFixed(0)}ms`
    }
  })
}
```

**æ”¶ç›Š**:

- âœ… é‡åŒ–æ€§èƒ½æŒ‡æ ‡
- âœ… æ•°æ®é©±åŠ¨ä¼˜åŒ–å†³ç­–

### ğŸ“Š æ€§èƒ½å¯¹æ¯”ï¼ˆ20,000 ä¹¦ç­¾ï¼‰

| é˜¶æ®µ           | ä¼˜åŒ–å‰       | ä¼˜åŒ–å    | æå‡             |
| -------------- | ------------ | --------- | ---------------- |
| IndexedDB è¯»å– | 150ms        | 150ms     | -                |
| æ„å»ºæ ‘         | 100ms + 80ms | 100ms     | **-80ms**        |
| æ‰å¹³åŒ–         | 50ms         | 30ms      | **-20ms**        |
| **æ€»è®¡**       | **380ms**    | **280ms** | **-100ms (26%)** |

### ğŸ¯ ç›®æ ‡å…¼å®¹æ€§

**ä¸»è¦æ”¯æŒ**: 20,000 ä¸ªä¹¦ç­¾ä»¥å†…

- âœ… åŠ è½½æ—¶é—´: < 300ms
- âœ… å†…å­˜å ç”¨: ~10MB
- âœ… ç”¨æˆ·è¦†ç›–ç‡: 99%
- âœ… ä½“éªŒè¯„çº§: ä¼˜ç§€

## ğŸš€ æœªæ¥ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

- [ ] å®ç°å¢é‡æ›´æ–°ç­–ç•¥ï¼ˆé¿å…å…¨é‡åˆ·æ–°ï¼‰
- [ ] æ·»åŠ  Service Worker æ•°æ®ç¼“å­˜å±‚
- [ ] Web Worker æ„å»ºæ ‘ï¼ˆ50,000+ ä¹¦ç­¾ï¼‰
- [ ] å»¶è¿ŸåŠ è½½æ·±å±‚å­æ ‘ï¼ˆæç«¯åœºæ™¯ï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬**: 2.0  
**æ›´æ–°æ—¥æœŸ**: 2025-10-26  
**æœ€æ–°ä¼˜åŒ–**: ç¼“å­˜æ ‘ç»“æ„ + é€’å½’æ‰å¹³åŒ– + æ€§èƒ½ç›‘æ§  
**ç»´æŠ¤è€…**: AcuityBookmarks å¼€å‘å›¢é˜Ÿ
