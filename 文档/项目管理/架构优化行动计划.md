# ⚡ 架构优化行动计划

> **目标**: 为项目优化提供清晰的优先级和可执行的任务清单
> **时间范围**: 6-8 周
> **预期收益**: 代码质量 +50%, 开发效率 +40%, 可维护性 +60%

---

## 🎯 优先级矩阵

```
影响力高 ↑
    │
    │  P1: 立即执行        P2: 重要但不紧急
    │  ┌─────────────┐   ┌─────────────┐
    │  │ 重构utils/   │   │ 性能监控     │
    │  │ 精简Store    │   │ 依赖注入     │
    │  │ 统一错误处理  │   │ 单元测试     │
    │  └─────────────┘   └─────────────┘
    │
    │  P3: 紧急但影响小   P4: 低优先级
    │  ┌─────────────┐   ┌─────────────┐
    │  │ 文档更新     │   │ 代码注释     │
    │  │ 命名规范     │   │ 美化代码     │
    │  └─────────────┘   └─────────────┘
    │
    └────────────────────────────────→ 紧急程度
                                      高
```

---

## 📅 6周冲刺计划

### 🔴 第1-2周：核心架构重构 (P1)

#### Week 1: 建立新架构

**目标**: 创建清晰的分层结构，开始迁移核心模块

**任务清单**:

- [ ] **Day 1**: 创建新目录结构

  ```bash
  mkdir -p frontend/src/{core,infrastructure,application}
  mkdir -p frontend/src/core/{bookmark,search,common}
  mkdir -p frontend/src/infrastructure/{indexeddb,chrome-api,logging}
  mkdir -p frontend/src/application/{bookmark,search}
  ```

  - 验证: `tree frontend/src -L 3 -d`
  - 耗时: 0.5 小时

- [ ] **Day 1-2**: 定义 Result 类型和基础接口
  - 创建 `core/common/result.ts`
  - 创建 `core/common/types.ts`
  - 验证: `bun run type-check`
  - 耗时: 2 小时

- [ ] **Day 2-3**: 迁移 IndexedDB 相关代码
  - `utils/indexeddb-manager.ts` → `infrastructure/indexeddb/manager.ts`
  - `utils/indexeddb-schema.ts` → `infrastructure/indexeddb/schema.ts`
  - 更新所有 import
  - 验证: `bun run build`
  - 耗时: 4 小时

- [ ] **Day 3-4**: 迁移 Chrome API 封装
  - `utils/chrome-api.ts` → `infrastructure/chrome-api/wrapper.ts`
  - 更新所有 import
  - 验证: `bun run build`
  - 耗时: 3 小时

- [ ] **Day 4-5**: 迁移 Logger
  - `utils/logger.ts` → `infrastructure/logging/logger.ts`
  - 更新所有 import
  - 验证: `bun run build`
  - 耗时: 1 小时

**验收标准**:

- ✅ 新目录结构创建完成
- ✅ Result 类型定义完成
- ✅ 基础设施层文件迁移完成
- ✅ 所有 import 路径更新
- ✅ `bun run type-check` 通过
- ✅ `bun run build` 成功

**风险**:

- Import 路径更新可能遗漏 → 使用 VS Code 全局搜索

---

#### Week 2: 迁移核心业务逻辑

**目标**: 将书签核心业务逻辑从 utils 迁移到 core

**任务清单**:

- [ ] **Day 1-2**: 拆分 unified-bookmark-api.ts
  - 数据访问 → `core/bookmark/repositories/bookmark-repository.ts`
  - 应用服务 → `application/bookmark/bookmark-app-service.ts`
  - 创建桥接层保持兼容
  - 验证: 功能测试
  - 耗时: 6 小时

- [ ] **Day 2-3**: 迁移 smart-bookmark-manager.ts
  - → `core/bookmark/services/bookmark-service.ts`
  - 更新调用方
  - 验证: 功能测试
  - 耗时: 4 小时

- [ ] **Day 3-4**: 迁移 smart-bookmark-diff-engine.ts
  - → `core/bookmark/services/bookmark-differ.ts`
  - 更新调用方
  - 验证: 功能测试
  - 耗时: 4 小时

- [ ] **Day 4-5**: 迁移 smart-bookmark-executor.ts
  - → `core/bookmark/services/bookmark-executor.ts`
  - 更新调用方
  - 验证: 功能测试
  - 耗时: 4 小时

**验收标准**:

- ✅ 书签核心逻辑迁移完成
- ✅ 桥接层保持向后兼容
- ✅ 所有功能测试通过
- ✅ `bun run build` 成功

**风险**:

- 破坏现有功能 → 保留桥接层，逐步迁移

---

### 🟡 第3-4周：精简 Store 和统一搜索 (P1)

#### Week 3: 精简 Store

**目标**: Store 只负责 UI 状态，业务逻辑移到服务层

**任务清单**:

- [ ] **Day 1-2**: 重构 management-store.ts
  - 抽取树转换逻辑 → `core/bookmark/services/tree-converter.ts`
  - 抽取缓存逻辑 → `core/bookmark/repositories/cache-repository.ts`
  - 抽取比对逻辑 → `core/bookmark/services/comparer.ts`
  - Store 只保留 UI 状态
  - 验证: Management 页面功能测试
  - 耗时: 8 小时

- [ ] **Day 3**: 重构 popup-store-indexeddb.ts
  - 抽取搜索逻辑到服务层
  - Store 只保留 UI 状态
  - 验证: Popup 页面功能测试
  - 耗时: 4 小时

- [ ] **Day 4-5**: 验证和优化
  - 全面功能测试
  - 性能测试
  - 代码审查
  - 耗时: 4 小时

**验收标准**:

- ✅ management-store.ts < 200 行
- ✅ popup-store.ts < 200 行
- ✅ 业务逻辑独立可测试
- ✅ 所有页面功能正常

**关键指标**:

- Store 代码量减少 60%
- 业务逻辑测试覆盖率 > 60%

---

#### Week 4: 统一搜索系统

**目标**: 单一搜索引擎 + 策略模式

**任务清单**:

- [ ] **Day 1-2**: 创建统一搜索引擎
  - 创建 `core/search/engine.ts`
  - 创建 `core/search/strategies/fuse-strategy.ts`
  - 创建 `core/search/strategies/hybrid-strategy.ts`
  - 验证: 单元测试
  - 耗时: 6 小时

- [ ] **Day 2-3**: 创建搜索应用服务
  - 创建 `application/search/search-app-service.ts`
  - 整合不同搜索策略
  - 验证: 集成测试
  - 耗时: 4 小时

- [ ] **Day 3-4**: 更新所有调用方
  - 更新 SearchPopup.vue
  - 更新 Popup.vue
  - 更新 SidePanel.vue
  - 更新 Management.vue
  - 验证: 功能测试
  - 耗时: 6 小时

- [ ] **Day 5**: 移除旧搜索实现
  - 移除 `services/hybrid-search-engine.ts`
  - 移除 `services/fuse-search.ts`
  - 清理 `composables/useBookmarkSearch.ts`
  - 验证: 构建测试
  - 耗时: 2 小时

**验收标准**:

- ✅ 只有一个搜索引擎入口
- ✅ 搜索策略可灵活切换
- ✅ 所有页面搜索功能正常
- ✅ 旧代码已清理

**关键指标**:

- 搜索相关代码减少 50%
- 搜索性能不下降

---

### 🟢 第5周：统一错误处理和文档 (P1+P3)

#### Week 5: 统一错误处理

**目标**: 所有异步函数使用 Result<T, E> 模式

**任务清单**:

- [ ] **Day 1**: 更新 Infrastructure 层
  - 所有 IndexedDB 操作返回 Result
  - 所有 Chrome API 调用返回 Result
  - 验证: 单元测试
  - 耗时: 4 小时

- [ ] **Day 2**: 更新 Core 层
  - 所有 Repository 方法返回 Result
  - 所有 Service 方法返回 Result
  - 验证: 单元测试
  - 耗时: 4 小时

- [ ] **Day 3**: 更新 Application 层
  - 所有应用服务方法返回 Result
  - 统一错误日志
  - 验证: 集成测试
  - 耗时: 4 小时

- [ ] **Day 4**: 更新 Presentation 层
  - Store 方法处理 Result
  - 统一用户错误提示
  - 验证: 功能测试
  - 耗时: 4 小时

- [ ] **Day 5**: 文档更新
  - 更新 README.md
  - 创建 ARCHITECTURE.md
  - 更新 API 文档
  - 创建迁移指南
  - 耗时: 4 小时

**验收标准**:

- ✅ 所有 async 函数返回 Result
- ✅ 错误处理统一
- ✅ 错误日志完整
- ✅ 文档完整更新

---

### 🔵 第6周：性能优化和清理 (P2+P4)

#### Week 6: 性能优化和代码清理

**目标**: 提升性能，清理技术债

**任务清单**:

- [ ] **Day 1-2**: IndexedDB 优化
  - 实现连接池
  - 优化事务管理
  - 性能测试
  - 耗时: 6 小时

- [ ] **Day 2-3**: 性能监控
  - 添加性能监控点
  - 创建性能基准
  - 性能报告
  - 耗时: 6 小时

- [ ] **Day 4**: 代码清理
  - 移除已废弃代码
  - 清理 \_deprecated 目录
  - 统一代码风格
  - 耗时: 4 小时

- [ ] **Day 5**: 最终验证
  - 全面功能测试
  - 性能测试
  - 代码审查
  - 发布准备
  - 耗时: 4 小时

**验收标准**:

- ✅ IndexedDB 性能提升 30%
- ✅ 性能监控系统完成
- ✅ 废弃代码已清理
- ✅ 所有测试通过

---

## 🎯 每周目标总结

| 周次       | 主要目标        | 关键交付                    | 验收标准       |
| ---------- | --------------- | --------------------------- | -------------- |
| **Week 1** | 建立新架构      | 新目录结构 + 基础设施层迁移 | 构建成功       |
| **Week 2** | 迁移核心逻辑    | 书签核心业务逻辑迁移        | 功能测试通过   |
| **Week 3** | 精简 Store      | Store 只保留 UI 状态        | 代码量减少 60% |
| **Week 4** | 统一搜索        | 单一搜索引擎                | 旧代码已清理   |
| **Week 5** | 错误处理 + 文档 | Result 模式 + 完整文档      | 错误处理统一   |
| **Week 6** | 性能优化        | 连接池 + 监控               | 性能提升 30%   |

---

## 📊 进度跟踪

### 每日站会检查点

- [ ] 今天完成了什么？
- [ ] 遇到了什么问题？
- [ ] 明天计划做什么？
- [ ] 是否需要帮助？

### 每周回顾检查点

- [ ] 本周目标是否达成？
- [ ] 验收标准是否满足？
- [ ] 遗留问题是什么？
- [ ] 下周计划是否清晰？

---

## ⚠️ 风险和应对

### 风险识别

| 风险                 | 可能性 | 影响 | 应对措施                    |
| -------------------- | ------ | ---- | --------------------------- |
| Import 路径更新遗漏  | 高     | 中   | 使用 VS Code 全局搜索和替换 |
| 破坏现有功能         | 中     | 高   | 保留桥接层，逐步迁移        |
| 时间估算不准         | 中     | 中   | 留有缓冲时间，优先级明确    |
| 团队成员不熟悉新架构 | 低     | 中   | 提供文档和培训              |
| 性能下降             | 低     | 高   | 性能测试和监控              |

### 回滚策略

```bash
# 每周末创建备份分支
git checkout -b backup/week-N
git push origin backup/week-N

# 如果出问题，回滚到上周
git checkout backup/week-N-1
```

---

## 🎉 成功标准

### 技术指标

- ✅ utils/ 目录文件数 < 10
- ✅ utils/ 代码量 < 2000 行
- ✅ Store 平均大小 < 200 行
- ✅ 搜索系统只有 1 套
- ✅ 错误处理统一
- ✅ 性能提升 30%

### 质量指标

- ✅ 类型检查 0 错误
- ✅ Lint 0 警告
- ✅ 构建成功
- ✅ 所有功能测试通过
- ✅ 代码审查通过

### 团队指标

- ✅ 新人上手时间 < 2天
- ✅ 团队满意度 > 80%
- ✅ 代码可维护性评分 > 8/10

---

## 📚 参考文档

- 📄 代码架构审核报告.md - 问题详细分析
- 📄 架构优化实施指南.md - 详细实施步骤
- 📄 架构可视化对比.md - 可视化对比
- 📄 架构优化速查表.md - 快速参考

---

## 🚀 立即开始

### 本周任务 (Week 1)

```bash
# 1. 创建新目录结构
cd frontend/src
mkdir -p core/{bookmark,search,common}
mkdir -p infrastructure/{indexeddb,chrome-api,logging}
mkdir -p application/{bookmark,search}

# 2. 定义 Result 类型
# 创建 core/common/result.ts

# 3. 开始迁移基础设施层
# ...
```

### 下周计划 (Week 2)

- 迁移书签核心业务逻辑
- 保持功能稳定性
- 更新文档

---

**准备好了吗？Let's go! 🚀**
